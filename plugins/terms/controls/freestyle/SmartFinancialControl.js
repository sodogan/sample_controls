/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["retail/pmr/promotionaloffers/plugins/terms/controls/freestyle/BorderedPanel","retail/pmr/promotionaloffers/plugins/terms/controls/freestyle/BorderlessToolbar","retail/pmr/promotionaloffers/plugins/terms/controls/freestyle/Separator","retail/pmr/promotionaloffers/plugins/terms/controls/freestyle/FinancialItem","sap/m/Panel","sap/m/PanelRenderer","sap/m/Toolbar","sap/m/VBox","sap/m/Button","sap/ui/layout/form/Form","sap/ui/layout/form/FormContainer","sap/ui/layout/form/FormElement","sap/ui/layout/form/ResponsiveGridLayout","retail/pmr/promotionaloffers/utils/Models","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/utils/Formatter","sap/m/Title","sap/m/Text","sap/m/Label","sap/m/ObjectStatus","sap/m/ObjectAttribute","sap/m/ToolbarSpacer","sap/ui/comp/smartvariants/SmartVariantManagement","sap/ui/comp/smartvariants/PersonalizableInfo","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/ForecastDialog"],function(B,a,S,F,P,b,T,V,c,d,e,f,R,M,U,g,h,i,L,O,j,k,l,m,J,n){"use strict";var o={decimalFormatter:U.decimalFormatter,percentageFormatter:function(A){return this.decimalFormatter(A)+"%";},joinValues:function(A,C){var D=C.map(function(E){return this.decimalFormatter(A[E]);}.bind(this));return D.join(" / ");},currencyFormatter:function(A,C){var D=C&&C.Currency||"";return this.decimalFormatter(A)+" "+D;},financialsFormatter:function(A,C){var D=A.Currency||"";var E=this.decimalFormatter(A[C[0]]);var G=this.decimalFormatter(A[C[1]]);if(!E&&!G&&!D){return"";}return G.length===0?E+" "+D+" / "+G:E+" "+D+" / "+G+"%";}};function p(A,C){var D=A.indexOf(C);return D===(A.length-1);}function q(A){var C=M.getServiceModel();var D=U.getResourceModel();var E=A||[];var G=E.map(function(H){var I=[];I.push(new i({text:H.label,layoutData:new sap.ui.layout.GridData({span:"L12 M12 S12"})}));switch(H.columnType){case"Forecast":I.push(new j({text:H.text,active:"{= ${UIVisiblity>/Version} > 2 }",press:function(){var K={TermId:H.id};n.show(n.Level.Term,K,C,D);},layoutData:new sap.ui.layout.GridData({span:"L12 M12 S12"})}));break;case"ForecastConfidence":I.push(new O({text:g.forecastConfidence(H.text),tooltip:H.text,state:g.forecastConfidenceState(H.text),layoutData:new sap.ui.layout.GridData({span:"L12 M12 S12"})}));break;default:I.push(new L({text:H.text,layoutData:new sap.ui.layout.GridData({span:"L12 M12 S12"})}));}return new f({fields:I});});return new d({layout:new R({labelSpanL:12,labelSpanM:12,labelSpanS:12}),formContainers:[new e({formElements:G})]});}function r(A,C){var D=q(A.Items);var E=new a({design:"Transparent",content:new h({text:U.getResourceModel().getResourceBundle().getText("CreateOffer.Terms.FreestyleOffer.FinancialsText",[A.TermOrReward,A.Identifier])})});return new V({items:!C?[E,D,new S()]:[E,D]});}function s(A){return A.map(function(C,D,I){return r(C,p(I,C));});}function t(A){var C=U.getResourceModel();var D=A.map(function(E){var G=null;if(E.type.indexOf("Decimal")!==-1){G="decimalFormatter";}if(E["sap:unit"]==="Currency"){G="currencyFormatter";}return{property:E.name,label:E["sap:label"],visible:E["sap:visible"]==="false"?false:true,formatter:G};}).reduce(function(E,G){E[G.property]=G;return E;},{});D.ForecastUplift={"property":"ForecastUplift","label":C.getProperty("ManageOffers.ProductDetails.ForecastUplift"),"visible":true,"formatter":"decimalFormatter"};D.ForecastUpliftPer={"property":"ForecastUpliftPer","label":C.getProperty("ManageOffers.ProductDetails.ForecastUpliftPer"),"visible":true,"formatter":"percentageFormatter"};return D;}function u(A,C){return A.indexOf(C)!==-1;}function v(A,C,D){var E=C.map(function(I){return I.getData().keys;}).reduce(function(I,K){return I.concat(K);},[]);var G=[];for(var H in A){if(A.hasOwnProperty(H)){if(E.indexOf(H)===-1&&A[H].visible){G.push({path:H,text:A[H].label,visible:u(D,H),index:A[H].columnIndex});}}}return G;}function w(A,C,D,E){return C.map(function(G){var H=G.getData();return{path:H.keys.join(" - "),text:H.keys.map(function(I){return A[I].label;}).join(" "+H.separator+" "),visible:u(D,H.keys.join(" - ")),index:E[H.keys.join(" - ")]};});}function x(A,C){return C.reduce(function(D,E){var G=E.getData();D[G.keys.join(" - ")]={label:G.keys.map(function(H){return A[H].label;}).join(" "+G.separator+" "),columnIndex:G.columnIndex,properties:G.keys,separator:G.separator,formatter:G.formatter||"joinValues"};return D;},{});}function y(A,C,D,E){var G=x(C,E);return A.map(function(H){return{Identifier:H.Identifier,TermType:H.TermType,TermOrReward:H.TermOrReward,Items:D.map(function(I){var K=!!C[I];if(K){var N=(H.Data||{})[I];var Q=(H.Data||{})["Id"];var W="";if(I==="SystemForecast"&&parseInt(N,10)>0){W="Forecast";}else if(I==="ForecastConfidence"){W="ForecastConfidence";}return{label:C[I].label+":",text:C[I].formatter?o[C[I].formatter](N,H.Data):N,id:Q,columnType:W};}else{var X=G[I];var Y=(X||{}).label+":";var Z="";if(H.Data&&X){Z=o[X.formatter](H.Data,X.properties);}return{label:Y,text:Z};}})};});}var z=B.extend("retail.pmr.promotionaloffers.plugins.terms.controls.freestyle.SmartFinancialControl",{renderer:b.render,metadata:{properties:{financials:{type:"any",defaultValue:[]},persistencyKey:{type:"string",group:"Misc",defaultValue:null},termFinancialItems:{type:"any",defaultValue:[]}},aggregations:{financialItems:{type:"retail.pmr.promotionaloffers.plugins.terms.controls.freestyle.FinancialItem",multiple:true,singularName:"financialItem"}}},initialiseVariantManagement:function(){if(this.variantManagement&&!this.variantInitialized){this.variantInitialized=true;var A=this.getFinancialItems();this.visibleColumns=A.map(function(C){return C.getData().keys.join(" - ");});this.setToolbar();this.renderUI();}},init:function(){B.prototype.init.apply(this,arguments);this.variantManagement=new l({});this.variantManagement.setShowShare(true);var A=M.getServiceModel().getMetaModel();var C=M.getNamespace(M.getServiceModel());this.oEntity=A.getODataEntityType(C+".FinancialDetail");this.metaProperties=t(this.oEntity.property);this.customIndex={};this.visibleColumns=[];},setPersistencyKey:function(A,C){this.setProperty("persistencyKey",A,C);var D=new m({type:"borderedPanel",keyName:"persistencyKey",dataSource:"TODO"});D.setControl(this);this._sOwnerId=U.getComponent().getId();this.variantManagement.addPersonalizableControl(D);this.variantManagement.initialise(this.initialiseVariantManagement,this);},renderUI:function(){var A=this;var C=y(this.getFinancials(),this.metaProperties,this.visibleColumns,this.getFinancialItems());A.setProperty("termFinancialItems",C);A.removeAllContent();s(C).forEach(function(D){A.addContent(D);});},closeFinFields:function(E){E.getSource().close();E.getSource().destroy();},okFinFields:function(E){E.getSource().close();E.getSource().destroy();var A=E.getParameter("payload").columns;if(!A.tableItemsChanged){return;}this.customIndex={};A.tableItems.forEach(function(D){if(this.metaProperties[D.columnKey]){this.metaProperties[D.columnKey].columnIndex=D.index;}else{this.customIndex[D.columnKey]=D.index;}}.bind(this));this.variantManagement.currentVariantSetModified(true);var C=A.selectedItems;this.visibleColumns=C.map(function(D){return D.columnKey;});this.renderUI();},addFinancialItem:function(A){this.addAggregation("financialItems",A);},setFinancials:function(A,C){this.setProperty("financials",A,C);if(A){this.renderUI();}},openPersonalizationDialog:function(){var A=sap.ui.xmlfragment("retail.pmr.promotionaloffers.fragments.FinFields",this);var C=w(this.metaProperties,this.getFinancialItems(),this.visibleColumns,this.customIndex);var D=v(this.metaProperties,this.getFinancialItems(),this.visibleColumns);var E=new J({Fields:C.concat(D)});A.setModel(E);A.open();},setToolbar:function(){var A=new T({height:"3rem"});A.addContent(new h({text:"{i18n>CreateOffer.Terms.Freestyle.Financials}"}));A.addContent(this.variantManagement);A.addContent(new k());A.addContent(new c({icon:"sap-icon://action-settings",press:this.openPersonalizationDialog.bind(this)}));this.setHeaderToolbar(A);},fetchVariant:function(){return{visibleColumns:this.visibleColumns};},applyVariant:function(A){this.visibleColumns=A.visibleColumns||[];this.renderUI();},destroy:function(){d.prototype.destroy.apply(this,arguments);}});return z;});
