/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/utils/Models","retail/pmr/promotionaloffers/utils/FinancialCalculations","retail/pmr/promotionaloffers/utils/Formatter"],function(U,M,C,F){"use strict";function p(a){return a.TermType+"-"+a.Identifier;}function c(a,b){return a.concat(b);}function n(a){return function(){return!a.apply(this,arguments);};}function w(a){var b=p(a);return function(i){return i.ParentId===b;};}function m(a,b){function i(G,H,I){return I.indexOf(G)===H;}function j(G){return G.Terms;}function x(G){return{Key:G,Value:G};}var E=a.map(j).filter(i).map(x).reduce(c,[]);E.push({Key:"All Terms",Value:b.allTermsLabel()});return E;}function d(a,b,i){if(!i){return a.getProperty("/ProductDetails")||[];}var j=i.filter(function(x){return x.Visibility!=="-";});a.setProperty("/ProductDetailsVisible",j);a.setProperty("/ProductDetails",i);a.setProperty("/ProductDetailsFilter",m(i,b));return i;}function u(a,b,i,j){a.forEach(function(x){if(x.ExtProductId===b){x["_PURPOSE_"+i]=j;}});}function e(a){if(!a){return null;}var b=a.filter(function(i){return i.Default;})[0];return b||a[0]||null;}function s(a,e){if(!a){return true;}if(!e){return false;}if(a===e.Id){return true;}return false;}function f(a,b){if(a.ProductId){return a.ProductId===b.ProductId;}if(a.HierarchyId){return a.HierarchyId===b.HierarchyId;}if(a.HierarchyNodeId){return a.HierarchyNodeId===b.HierarchyNodeId;}return false;}function g(a){if(a.results){return a.results;}return a;}function h(a){return U.get(a,["UnitOfMeasures"])||[];}var k=U.compose(g,h);var l=U.compose(e,g,h);function o(a){a.Config=a.Config||{};return function(b){a.Config[b]=a.Config[b]||{};a.Config[b].Editable=false;};}function q(a,b){var i=U.get(a,["Selection","DimensionType"]);if(i==="01"){var j=a.Selection.UserProjection;if(jQuery.isNumeric(j)){b.UserProjection=j;}else{b.UserProjection=null;}return["DiscountValue","SubDiscountValue","UserProjection","LockUserProjection","PromotedUoM","PromoCostPrice","PromoCostPriceCurrency"].forEach(o(b));}if(i==="11"){return["DiscountValue","SubDiscountValue","PromotedUoM"].forEach(o(b));}}function r(a,b,i){var j=b[a]||i[a];if(j){b[a]=j;}}function t(a,b,i){var j=l(a);var x=l(b);r("DiscountValue",a,i);r("SubDiscountValue",a,i);r("UserProjection",a,i);a.UnitOfMeasures=k(b);if(b.hasOwnProperty("isNewItem")&&b.isNewItem==false){var I=false;}else{I=true;}if(I){if(i.Selection&&i.Selection.UnitOfMeasure&&i.Selection.UnitOfMeasure!=''){a.DisplayUoM=i.Selection.UnitOfMeasure;a.PromotedUoM=i.Selection.UnitOfMeasure;}else{a.DisplayUoM=U.get(x,["Id"]);a.PromotedUoM=U.get(x,["Id"]);}}a.ExtProductId=b.ExtNodeId||b.ExtProductId;a.Name=b.Name;q(i,a);return a;}function v(a,b,i){var j={};jQuery.extend(true,j,b);if(b.UnitOfMeasures&&b.UnitOfMeasures.constructor===Array){b.UnitOfMeasures={results:b.UnitOfMeasures};}j.ParentId=p(i);j.ProductId=b.ProductId;j.Terms=a.termOrRewardLabel(i);j.UnitOfMeasures=(b.UnitOfMeasures||{}).results||[];j.DiscountTypeLabel=i.DiscountTypeLabel;j.Config=jQuery.extend(true,{},i.ProductConfig);j.LockUserProjection=!!j.LockUserProjection;for(var x in i.Selection){if(i.Selection.hasOwnProperty(x)){if(i.Selection[x]&&x!=="UserProjection"&&x!=="Financials"){j[x]=j[x]||i.Selection[x];}}}if(jQuery.isNumeric(b.UserProjection)){j.UserProjection=parseFloat(b.UserProjection);}else{j.UserProjection=null;}j.DiscountType=j.DiscountType||i.DiscountType;t(j,b,i);return j;}function y(a,b,i){var x=b.ProductId||b.HierarchyNodeId||b.HierarchyId;for(var j=0;j<a.length;j++){var E=a[j];var G=E.ProductId||E.HierarchyNodeId||E.HierarchyId;if(E.Terms===b.Terms&&x===G){E=jQuery.extend(E,i);break;}}}function P(a){this.model=a;this.i18n=U.getI18NModel().getResourceBundle();}P.prototype.init=function(a,b){var i=this;b=b||[];var j=b.map(function(x){return x.Id;});d(this.model,this,a.map(function(E){if(!E.TermProducts){return[];}return E.TermProducts.map(function(x){var G=jQuery.extend(true,{},x);G.ParentId=p(E);G.Terms=i.termOrRewardLabel(E);G.Name=G.Description;G.UnitOfMeasures=(G.UoMs||[]).map(function(H){return{Name:H.Unit,Id:H.Unit};});G.PromoCostPriceCurrency=G.PromoCostPriceCurrency||G.Currency;(j||[]).forEach(function(H){G["_PURPOSE_"+H]=false;});(G.Purposes||[]).forEach(function(H){if(j.indexOf(H.Id)!==-1){G["_PURPOSE_"+H.Id]=true;}});G.ServerUserProjection=G.ServerUserProjection;if(jQuery.isNumeric(G.UserProjection)){G.UserProjection=parseFloat(G.UserProjection);}else{G.UserProjection=null;}G.DiscountTypeLabel=E.DiscountTypeLabel;G.ForecastConfidenceLabel=F.forecastConfidence((G.Financials||{}).ForecastConfidence||0);G.DiscountType=E.DiscountType||U.get(E,["Selection","DiscountType"]);G.Config=jQuery.extend(true,{},E.ProductConfig);q(E,G);C.extendFinancials(G.Financials);return G;});}).reduce(c,[]));i.model.setProperty("/AllPurposes",b.length&&b[0].Id?b:[]);};P.prototype.getProductDetails=function(){return this.model.getProperty("/ProductDetails")||[];};P.prototype.calculateTotalProducts=function(){var a=0;var b=this.model.getProperty("/Terms")||[];var i=function(G){return G.isWholeOffer;};var j=(this.model.getProperty("/Rewards")||[]).filter(i);var x=b.concat(j);var E=(this.model.getProperty("/ProductDetails")||{}).length||0;x.forEach(function(G){if((G.Selection||{}).hasOwnProperty("Products")){a+=G.Selection.Products;}});this.model.setProperty("/ProductDetailsTotal",a?a:E);};P.prototype.remove=function(a){var b=d(this.model);d(this.model,this,b.filter(n(w(a))));if(a.Selection&&a.Selection.hasOwnProperty("Products")){a.Selection.Products=0;}this.calculateTotalProducts(a);};P.prototype.add=function(a,b){var i=this;var j=a.map(function(x){return v(i,x,b);});d(this.model,this,d(this.model).concat(j));this.calculateTotalProducts();};P.prototype.termOrRewardLabel=function(a){var b;if(a.TermType==="1"){b=this.termLabel(a.Identifier);}else{b=this.rewardLabel(a.Identifier);}return b.trim();};P.prototype.updateIdentifiers=function(a){var b=this;d(this.model,d(this.model).map(function(j){var x=j.ParentId;for(var i=0;i<a.length;i++){if(p(a[i].oldTerm)===x){j.ParentId=p(a[i].newTerm);j.Terms=b.termOrRewardLabel(a[i].newTerm);}}return j;}));};P.prototype.termLabel=function(i){return jQuery.sap.formatMessage(this.i18n.getText("CreateOffer.Terms.Freestyle.TermLabel"),"",i);};P.prototype.rewardLabel=function(i){return jQuery.sap.formatMessage(this.i18n.getText("CreateOffer.Terms.FreestyleOffer.Reward"),i);};P.prototype.allTermsLabel=function(){return this.i18n.getText("CreateOffer.Terms.FreestyleOffer.AllTermFilterLabel");};P.prototype.update=function(a,b,i){var j=d(this.model);var x=w(a);d(this.model,this,j.map(function(E){if(x(E)){E[b]=i;}return E;}));};function z(a,b){var j={UnitOfMeasures:[],Name:""};for(var i=0;i<a.length;i++){var x=a[i];if(x.ProductId===b){j=x;break;}}return j;}function A(a,b){if(a.UnitOfMeasures&&a.UnitOfMeasures.length>0){return a.UnitOfMeasures;}return U.get(b,["UnitOfMeasures","results"])||[];}P.prototype.updateDetailsForEveryProduct=function(a,b){var i=d(this.model);var j=w(a);d(this.model,this,i.map(function(x){if(j(x)){var E=z(b,x.ProductId);x.UnitOfMeasures=A(x,E);x.Name=x.Name?x.Name:E.Name;}return x;}));};P.prototype.updateDetails=function(a,b){var j=d(this.model);d(this.model,this,j.map(function(x){for(var i=0;i<a.length;i++){if(f(a[i],x)){return t(x,a[i],b);}}return x;}));};function B(x,i){return{ParentId:x.ParentId,Index:i};}function D(x){return x.Index;}P.prototype.getIndicesForTerm=function(a){var b=d(this.model);return b.map(B).filter(w(a)).map(D);};P.prototype.subGroupChecked=function(a){var b=this.getProductDetails();var i=U.getSubstringEndText("_PURPOSE_",a.name);u(b,a.data.ExtProductId,i,a.selected);};P.prototype.hideProducts=function(a){var b=d(this.model);var j=this.model.getProperty("/ProductDetailsVisible")||[];for(var i=0;i<a.length;i++){var x=jQuery.extend({},a[i]);var E=j[x.Index];delete x.Index;y(b,E,x);}d(this.model,this,b);};P.prototype.massChange=function(a){var b=d(this.model);var j=this.model.getProperty("/ProductDetailsVisible")||[];for(var i=0;i<a.length;i++){var x=jQuery.extend({},a[i]);var E=j[x.Index];delete x.Index;y(b,E,x);Object.keys(x).forEach(function(G){if(G.indexOf("_PURPOSE_")!==-1){var H=U.getSubstringEndText("_PURPOSE_",G);u(b,E.ExtProductId,H,x[G]);}});}d(this.model,this,b);};P.prototype.validateItem=function(a,b){var i=a[b];var j=U.getI18NModel().getResourceBundle();var x=d(this.model).indexOf(a);var E="/ProductDetails/"+x+"/"+b;var G=j.getText("ManageOffers.ProductDetails."+b);var H="";var I="";if(["UserProjection","PromoCostPrice","DisplayUoMValue"].indexOf(b)>-1){H=j.getText("ManageOffer.ProductDetail.Error.RegularValueValidationError");if(i<0){U.addValidationMessages({message:jQuery.sap.formatMessage(H,G)},E,this.model);}else{U.addValidationMessages({message:null},E,this.model);}}else if(["PromotedUoM","DisplayUoM","PromoCostPriceCurrency"].indexOf(b)>-1){H=j.getText("ManageOffer.ProductDetail.Error.InvalidEntryError");if(i===""||i===null||i===undefined){U.addValidationMessages({message:jQuery.sap.formatMessage(H,G)},E,this.model);I=jQuery.sap.formatMessage(H,G);}else{U.addValidationMessages({message:null},E,this.model);}}return I;};P.prototype.getEditableFields=function(){if(this._editableFields){return this._editableFields;}var a=M.getServiceModel();if(a.isMetadataLoadingFailed()){return[];}var b=M.getNamespace(a);var i=a.getMetaModel().getODataEntityType(b+".TermProduct");this._editableFields=i.property.filter(function(j){return j["sap:creatable"]!=="false"||j["sap:updatable"]!=="false";}).map(function(j){return j.name;});return this._editableFields;};P.prototype.getForTermData=function(a){return d(this.model).filter(w(a));};P.prototype.getForTerm=function(a){var b=this.getEditableFields();return d(this.model).filter(w(a)).map(function(i){var j=false;if(i.PromoCostPrice&&parseFloat(i.PromoCostPrice)>0){j=true;}var x=U.get(i,["UnitOfMeasures","length"])?i.UnitOfMeasures:[{Id:""}];var E=(i.UserProjection||"0")+"";var G=!!i.LockUserProjection;var H=[];Object.keys(i).forEach(function(J){if(J.indexOf("_PURPOSE_")!==-1&&i[J]){H.push({Id:U.getSubstringEndText("_PURPOSE_",J)});}});var I={"Purposes":H.length?H:null,"ProductId":i.ProductId,"Description":i.Name,"ExtProductId":i.ExtProductId,"DiscountValue":i.DiscountValue?i.DiscountValue+"":"0","SubDiscountValue":i.SubDiscountValue?i.SubDiscountValue+"":"0","Currency":i.Currency||"","PromotedUoM":i.PromotedUoM||"","DisplayUoM":i.DisplayUoM||"","DisplayUoMValue":i.DisplayUoMValue?i.DisplayUoMValue+"":"0","PromoCostPrice":i.PromoCostPrice?i.PromoCostPrice+"":"0","PromoCostPriceCurrency":i.PromoCostPriceCurrency||"","UsePromoCostPrice":!!j,"LockUserProjection":G,"UserProjection":E,"ServerUserProjection":i.ServerUserProjection,"Financials":{"Id":""},"UoMs":x.map(function(J){return{Unit:J.Id};})};if(i.hasOwnProperty("Visibility")){I.Visibility=i.Visibility;}b.forEach(function(J){if(!I.hasOwnProperty(J)&&i.hasOwnProperty(J)){I[J]=i[J];}});return I;});};return P;},true);
