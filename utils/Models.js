/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["retail/pmr/promotionaloffers/utils/Utils","sap/ui/comp/odata/MetadataAnalyser"],function(U,M){"use strict";function C(){this.data={};}C.prototype.store=function(e,f){this.data[e.join("-")]=f;};C.prototype.get=function(e){return this.data[e.join("-")];};C.prototype.has=function(){return!!this.get.apply(this,arguments);};function d(){var e=Array.prototype.splice.call(arguments,0);if(!e.length){return["Cached"];}return e;}function w(f,e){e=e||d;var i=new C();return function(){var r=arguments[arguments.length-1];var j=e.apply(this,arguments);if(!r&&i.has(j)){return i.get(j);}var k=f.apply(this,arguments);i.store(j,k);return k.then(null,function(m){i.store(j,null);throw m;});};}function a(e,i){i=i||d;var j=new C();function f(){var k=i.apply(this,arguments);if(j.has(k)){return j.get(k);}var m=e.apply(this,arguments);j.store(k,m);return m.then(null,function(n){j.store(k,null);throw n;});}f.invalidate=function(){var k=i.apply(this,arguments);j.store(k,null);};return f;}function b(f){return function tracedCall(){return f.apply(this,arguments).then(U.identity,function(e){return Promise.reject(e);});};}var l={};var P=[{entityName:"Currency",methodName:"getCurrency"},{entityName:"SalesOrg",methodName:"getSalesOrg"},{entityName:"DistChannel",methodName:"getDistChannel"},{entityName:"ProductStatus",methodName:"getProductStatus",masterdataSystemIndependent:true},{entityName:"ProductUoM",methodName:"getProductUoM",masterdataSystemIndependent:true}];var E=[{"EntitySet":"MasterDataSystemSet","EndPoint":"/MasterdataSystems","Method":"GET"},{"EntitySet":"AttributeSet","Params":{$filter:"Object eq '01'"},"EndPoint":"/Attributes","Method":"GET"},{"EntitySet":"LanguageSet","Params":{EntityType:"'Attribute'",PropertyName:"'Language'"},"EndPoint":"/GetHelpValues","Method":"GET"},{"EntitySet":"Tactics","EndPoint":"/Tactics","Method":"GET"},{"EntitySet":"ProductDimensionsSet","Params":{EntityType:"'Term'",PropertyName:"'ProductDimension'"},"EndPoint":"/GetHelpValues","Method":"GET"},{"EntitySet":"DiscountTypeSet","Params":{EntityType:"'Term'",PropertyName:"'DiscountType'"},"EndPoint":"/GetHelpValues","Method":"GET"},{"EntitySet":"DiscountAssignmentSet","Params":{EntityType:"'Term'",PropertyName:"'DiscountAssignment'"},"EndPoint":"/GetHelpValues","Method":"GET"},{"EntitySet":"DiscountVarietySet","Params":{EntityType:"'Term'",PropertyName:"'Variety'"},"EndPoint":"/GetHelpValues","Method":"GET"},{"EntitySet":"TermStyles","Params":{$expand:"Sections,Sections/Rules,Sections/SectionItems,Sections/SectionItems/SectionItemRules"},"EndPoint":"/TermStyles","Method":"GET"},{"EntitySet":"FeaturesAvailable","EndPoint":"/FeatureSwitches","Method":"GET"},{"EntitySet":"PriceTypes","Params":{EntityType:"'ProductDetail'",PropertyName:"'PriceType'"},"EndPoint":"/GetHelpValues","Method":"GET"},{"EntitySet":"ProductTypes","Params":{EntityType:"'ProductDetail'",PropertyName:"'ProductType'"},"EndPoint":"/GetHelpValues","Method":"GET"},{"EntitySet":"EnforceMultiple","Params":{EntityType:"'Offer'",PropertyName:"'EnforceMultiple'"},"EndPoint":"/GetHelpValues","Method":"GET"},{"EntitySet":"WhenOptions","Params":{EntityType:"'Term'",PropertyName:"'WhenOption'"},"EndPoint":"/GetHelpValues","Method":"GET"},{"EntitySet":"GetOptions","Params":{EntityType:"'Term'",PropertyName:"'GetOption'"},"EndPoint":"/GetHelpValues","Method":"GET"},{"EntitySet":"Weeks","EndPoint":"/Weeks","Method":"GET"},{"EntitySet":"IncentiveDefinitions","EndPoint":"/IncentiveDefinitions","Method":"GET"},{"EntitySet":"Purpose","EndPoint":"/SH_H_DMF_PROC_PURPOSE","Method":"GET"},{"EntitySet":"ForecastConfidence","Params":{"EntityType":"'Offer'","PropertyName":"'ForecastConfidence'"},"EndPoint":"/GetHelpValues","Method":"GET"},{"EntitySet":"CurrencyListSet","Params":{EntityType:"'Term'",PropertyName:"'CurrencyList'"},"EndPoint":"/GetHelpValues","Method":"GET"}];var c=[{"EntitySet":"LinkToSet","Mock":true,"Data":[{"LinkToName":"Default","LinkToId":"1"},{"LinkToName":"Default 2","LinkToId":"2"}]},{"EntitySet":"TypeSet","Mock":true,"Data":[{"AttributeTypeName":"Image","AttributeTypeId":"01"},{"AttributeTypeName":"Text","AttributeTypeId":"02"},{"AttributeTypeName":"Date","AttributeTypeId":"04"}]}];var g={};var p=false;var h={init:function(m){this.model=m;},postponeModelRefresh:function(s){p=s;},isModelRefreshPostponed:function(){return p;},getMetadataAnalyzer:function(){return this.model.getMetaModel().loaded().then(function(){return new M(this.model);}.bind(this));},getInitialData:function(){return g;},valueHelp:function(e,m){var t=this;return function valueHelpFn(f){var i={EntityType:"'Term'",PropertyName:"'"+e+"'"};if(f&&!m){i.MasterdataSystem="'"+f+"'";}var j="/GetHelpValues";return t.read(j,i,function(k){return k;});};},read:function(e,f,r){var m=this.getServiceModel();r=r||U.identity;return new Promise(function(i,j){m.read(e,{urlParameters:f||null,success:function(k){i(r(k));},error:function(k){j(k);}});});},getServiceModel:function(){return this.model;},getNamespace:function(m){try{return m.getServiceMetadata().dataServices.schema[0].namespace;}catch(e){return"OFFER_MANAGEMENT_SRV";}},updateOffer:function(e,s){var t=this;return new Promise(function(r,f){var m=t.getServiceModel();m.setUseBatch(true);m.read(s,{urlParameters:{"$expand":e},success:function(R){r({data:R,response:{}});m.setUseBatch(false);},error:function(i){f(i);m.setUseBatch(false);}});});},fetchDefaultValues:w(function(e){var f="/Offers(binary'0000000000000000')";return this.updateOffer(e,f);},function(){return["OfferDefaults"];}),fetchDataForVendorFund:function(e,v){var s="/VendorFunds('"+v+"')/Offer";var m=this.getServiceModel();var f={$expand:e};return new Promise(function(r,i){m.read(s,{async:true,urlParameters:f,success:function(R,o){r({data:R,response:o});},error:function(j){i(j);}});});},createNewOffer:function(s){var m=this.getServiceModel();return new Promise(function(r,e){m.create("/Offers",jQuery.extend({},s),{async:true,success:function(R,o){r({data:R,response:o});},error:e});});},copyOffer:function(o,e){return this.createNewOffer(e);},updateSelectedOffer:function(e){return this.createNewOffer(e);},getImageInformation:function(i,I){var m=this.getServiceModel();return new Promise(function(r,e){m.read("/Images(binary'"+i+"')",{urlParameters:null,async:false,success:function(f){r(f);},error:function(f){e(f);}});});},getImages:w(function(){return this.read("/Images",{},function(e){return{data:e.results||[]};});}),getAttributeValues:function(s){return this.read("/ATTR_05_"+s+"Values",null,function(e){return{data:e.results||[]};});},getServiceData:w(function(){var m=this.getServiceModel();function s(r){function e(i){if(!i){return[];}if(typeof i.response==="undefined"){return i.data.results;}else{throw new Error(JSON.parse(i.response.body));}}var f={};E.reduce(function(f,i,j){f[i.EntitySet]=e(r.__batchResponses[j]);if(i.EntitySet==="FeaturesAvailable"){var k=f["FeaturesAvailable"].some(function(o){return o.Key==="CouponOffers";});if(!k){var v=f["FeaturesAvailable"].filter(function(o){return o.Key==="VendorFunds";});var n=JSON.parse(JSON.stringify(v));n[0].Key="CouponOffers";f["FeaturesAvailable"].push(n[0]);}}return f;},f);c.reduce(function(f,i){f[i.EntitySet]=i.Data;return f;},f);g=f;return{data:f};}return new Promise(function(r,e){m.metadataLoaded().then(function(){m.setUseBatch(true);m.setDeferredGroups(["batchCalls"]);E.forEach(function(f,i,o){if(f.EntitySet==="Purpose"){var S=m.getMetaModel().getODataEntitySet(f.EndPoint.substring(1));if(S===null){jQuery.sap.log.warning("Entity set "+f.EntitySet+" does not exist in metadata");o.splice(i,1);return;}}m.read(f.EndPoint,{groupId:"batchCalls",urlParameters:f.Params||null});});m.submitChanges({groupId:"batchCalls",success:function(f){var i=s(f);r(i);m.setUseBatch(false);},error:function(o){e(o);m.setUseBatch(false);}});});});}),getVendorFunds:function(e){var f=["__batchResponses",0,"__changeResponses",1,"data","AvailableFunds","results"];return this.batchCallsOffersTwoOperations(e,"/DetermineVendorFunds",f);},getCollision:function(e){var f=["__batchResponses",0,"__changeResponses",1,"data","Collisions","results"];e.Collisions=[];return this.batchCallsOffersTwoOperations(e,"/DetermineCollisions",f);},determineLocations:function(m,e,f,i,s,j){var k={MasterdataSystem:m,LocationNodeId:e,HierarchyId:f,LocationFilters:i,ExcludedNodes:[{Id:"",OfferId:""}],StartOfOffer:j.start,EndOfOffer:j.end};if(s){k.LocationSubgroups=s;}var r=[];return this.batchCallsOffersTwoOperations(k,"/DetermineLocations",r);},mergeVisibleProducts:function(m,k,e,t,f){var i=this.getServiceModel();var s="/Offers";var S=[];if(f.TermProducts){f.TermProducts.forEach(function(y){if(y.Visibility&&y.Visibility!==""){S.push({Id:y.Id,ProductId:y.ProductId,Visibility:y.Visibility});}});}var j={"OfferId":f.OfferId,"Status":"99","Terms":[{"OfferId":f.OfferId,"TermId":f.TermId,"TermProducts":S}]};var n="/TermObjects";var o=10;var q=function nameFilter(K){return(K?"*"+K+"*":"");};var r=function(y){return"MasterdataSystem eq '"+y+"'";};var u=function u(y){return(y?" and Dimension eq '"+y+"'":"");};var v=function(T){return(T?" and Type eq '"+T+"'":"");};var x={$top:o,search:q(k),$filter:r(m)+u(e)+v(t),$expand:"UnitOfMeasures,Children,Children/UnitOfMeasures"};return new Promise(function(y,z){i.setUseBatch(true);i.setRefreshAfterChange(false);i.setDeferredGroups(["batchCalls"]);i.create(s,j,{groupId:"batchCalls",changeSetId:jQuery.sap.uid()});i.read(n,{groupId:"batchCalls",changeSetId:jQuery.sap.uid(),urlParameters:x});i.submitChanges({groupId:"batchCalls",success:function(R){var A=R.__batchResponses[1];y({Products:A.data.results});i.setUseBatch(false);i.setRefreshAfterChange(true);},error:function(A){z(A);i.setUseBatch(false);i.setRefreshAfterChange(true);}});});},getProducts:function(m,k,e,t){var f="/TermObjects";var i=10;var s=function nameFilter(K){return(K?"*"+K+"*":"");};var j=function(r){return"MasterdataSystem eq '"+r+"'";};var n=function n(r){return(r?" and Dimension eq '"+r+"'":"");};var o=function(T){return(T?" and Type eq '"+T+"'":"");};var q={$top:i,search:s(k),$filter:j(m)+n(e)+o(t),$expand:"UnitOfMeasures,Children,Children/UnitOfMeasures"};return this.read(f,q,function(r){return{Products:r.results};});},searchProduct:b(function(m,k,e,t){var f="/TermObjects";var i=1;var s=function(K){return(K?K:"");};var j=function(u){return"MasterdataSystem eq '"+u+"'";};var n=function(K){return(K?" and ExtNodeId eq '"+K+"'":"");};var o=function(u){return(u?" and Dimension eq '"+u+"'":"");};var q=function(T){return(T?" and Type eq '"+T+"'":"");};var r={$top:i,search:s(k),$filter:j(m)+n(k)+o(e)+q(t),$expand:"ProductDetail,UnitOfMeasures,Children,Children/UnitOfMeasures"};return this.read(f,r,function(u){return{Products:u.results};});}),getFeaturesAvailable:b(w(function(){return this.read("/FeatureSwitches",null,function(e){return e.results||[];});})),getTermObjects:b(w(function(m,e){var s="/TermObjects";var f=function(n){return"MasterdataSystem eq '"+n+"'";};var i=function i(n){return(n?" and Dimension eq '"+n+"'":"");};var j=" and Cardinality gt 0";var k={$filter:f(m)+i(e)+j};return this.read(s,k,function(n){return{TermObjects:n.results};});})),getProductById:b(a(function(e,f){var s="/TermObjects";function i(o){return"Id=binary'"+U.base64ToHex(o)+"'";}function j(D){return"Dimension='"+D+"'";}function k(I,D){return s+"("+i(I)+","+j(D)+")";}var m={$expand:"ProductDetail,UnitOfMeasures,Children,Children/UnitOfMeasures"};var n=e?e:"0000000000000000";return this.read(k(n,f),m,function(o){return o;});},function(e,f){return[e,f];})),getProductGroupById:b(function(e){var s="/ProductGroups";function f(I){return s+"('"+I+"')";}var i={$expand:"Rules,Nodes,Included,Excluded,Preview,HierarchyPreview,Filters"};var G=e?e:"0";return this.read(f(G),i,function(j){return j;});}),getProductDimensions:function(){function m(o){return{ProductDimensionName:o.Value,ProductDimensionId:o.Key};}return Promise.resolve({ProductDimensions:this.getInitialData().ProductDimensionsSet.map(m)});},getUnitsOfMeasure:function(e){var u=e.UnitOfMeasures.results;function m(f){return{UoMName:f.Id,UoMId:f.Id,Default:f.Default};}return Promise.resolve({UnitsOfMeasure:u.map(m)});},getDiscountTypes:function(){function m(o){return{DiscountTypeName:o.Value,DiscountTypeId:o.Key};}return Promise.resolve({DiscountTypes:this.getInitialData().DiscountTypeSet.map(m)});},getTermStyles:function(){return Promise.resolve(this.getInitialData().TermStyles);},getEnforceMultiple:function(){return Promise.resolve(this.getInitialData().EnforceMultiple);},getMasterDataSystems:w(function(){var g=this.getInitialData();if(typeof g.MasterDataSystemSet==="undefined"){return this.read("/MasterdataSystems",null,function(e){g.MasterDataSystemSet=e.results;return e.results;});}return Promise.resolve(g.MasterDataSystemSet);}),getMasterDataSystemPersonalizationService:function(){if(!sap.ushell||!sap.ushell.Container||!sap.ushell.Container.getService){return{getPersData:function(){return Promise.resolve(null);}};}var o=sap.ushell.Container.getService("Personalization");return o.getPersonalizer({container:"retail.pmr.promotionaloffers",item:"masterDataSystem"});},getMasterDataSystem:function(){return new Promise(function(r){var u=jQuery.sap.getUriParameters().get("systemId");var i=null;this.getMasterDataSystems().then(function(s){if(u){for(i=0;i<s.length;i++){if(s[i].Id===u){return r(u);}}}this.getMasterDataSystemPersonalizationService().getPersData().then(function(o){if(o){return r(o);}for(i=0;i<s.length;i++){if(s[i].Default===true){return r(s[i].Id);}}return r(s[0].Id);});}.bind(this));}.bind(this));},setMasterDataSystemPersonalization:function(m){var o=this.getMasterDataSystemPersonalizationService();o.setPersData(m);},createOfferSet:function(v){var e={Id:"",Text:v};var m=this.getServiceModel();return new Promise(function(r,f){m.create("/OfferSets",e,{async:true,success:function(R){g.OfferSet.push({Id:R.Id,Text:R.Text});r({data:R});},error:f});});},getOfferSet:function(f){var e=f||null;return this.read("/OfferSets",e,function(r){return{data:r.results||[]};});},manageOfferSet:function(o){var e=o.add;var f=o.remove;var u=o.update;var t=this.getServiceModel();return new Promise(function(r,i){t.setUseBatch(true);t.setRefreshAfterChange(false);t.setDeferredGroups(["batchCalls"]);e.forEach(function(j,k){t.create("/OfferSets",j,{groupId:"batchCalls",changeSetId:"createBatch"+k});});u.forEach(function(j,k){t.update("/OfferSets(binary'"+U.base64ToHex(j.Id)+"')",{Text:j.Text},{groupId:"batchCalls",changeSetId:"updateBatch"+k});});f.forEach(function(j,k){t.remove("/OfferSets(binary'"+U.base64ToHex(j.Id)+"')",{groupId:"batchCalls",changeSetId:"deleteBatch"+k});});t.submitChanges({groupId:"batchCalls",success:function(R){r({returnedData:R});t.setUseBatch(false);t.setRefreshAfterChange(true);},error:function(j){i(j);t.setUseBatch(false);t.setRefreshAfterChange(true);}});});},getDataSet:w(function(e,D,f,m){if(!m){return Promise.resolve(g[e]);}if(f.$filter){f.$filter=f.$filter+" and MasterdataSystem eq '"+m+"'";}else{f.$filter="MasterdataSystem eq '"+m+"'";}return this.read(D,f,function(i){g[e]=i.results;return i.results;});},function(e,D,f,m){return[e,D,f,m];}),getLocationSet:function(m){var e={$filter:"Cardinality gt 0",$expand:"Locations"};return this.getDataSet("LocationSet","/LocationHierarchyNodes",e,m);},_getPromotionTypeSetAndPurchasingGroupSet:w(function(m){var e=this.getServiceModel();return new Promise(function(r,f){e.setUseBatch(true);e.setDeferredGroups(["batchPromotionTypeSetAndPurchasingGroupSet"]);e.read("/PromotionTypes",{groupId:"batchPromotionTypeSetAndPurchasingGroupSet",urlParameters:{$filter:"MasterdataSystem eq '"+m+"'"}});e.read("/GetHelpValues",{groupId:"batchPromotionTypeSetAndPurchasingGroupSet",urlParameters:{EntityType:"'Offer'",PropertyName:"'PurchasingGroup'",MasterdataSystem:"'"+m+"'"}});e.submitChanges({groupId:"batchPromotionTypeSetAndPurchasingGroupSet",success:function(R){var i=R.__batchResponses.map(function(x){return U.get(x,["data","results"])||[];});r(i);e.setUseBatch(false);},error:function(i){f(i);e.setUseBatch(false);}});});}),getPromotionTypeSetAndPurchasingGroupSet:function(m){return this._getPromotionTypeSetAndPurchasingGroupSet(m,false);},readLeadingCategoriesSet:function(m){return new Promise(function(r,e){var o={"$filter":"MasterdataSystem eq '"+m+"'"};this.read("/LeadingCategories",o,function(D){var L=D.results||[];r(L);});}.bind(this));},getLeadingCategoriesSet:function(m){if(!l.hasOwnProperty(m)){l[m]=this.readLeadingCategoriesSet(m);}return l[m];},getPromotionTypeSet:function(m){return this.getDataSet("PromotionTypeSet","/PromotionTypes",{},m,false);},getPurchasingGroupSet:w(function(m){var e={EntityType:"'Offer'",PropertyName:"'PurchasingGroup'",MasterdataSystem:"'"+m+"'"};return this.read("/GetHelpValues",e,function(f){return f.results||[];});},function(m){return[m];}),getTactics:function(){function t(T){return{Name:T.TacticTypeDesc+"/"+T.TacticDesc,Id:T.TacticType+"/"+T.TacticId,TacticId:T.TacticId,TacticType:T.TacticType,TacticDesc:T.TacticDesc,TacticTypeDesc:T.TacticTypeDesc,OfferId:T.OfferId||""};}var g=this.getInitialData();if(g.Tactics){return Promise.resolve(g.Tactics).then(function(r){return r.map(t);});}else{return this.read("/Tactics",null,function(e){g.Tactics=e.results;return g.Tactics.map(t);});}},updateOffers:function(r,s,S){return new Promise(function(e,f){var m=h.getServiceModel();m.setUseBatch(true);m.setDeferredGroups(["batchCalls"]);for(var i=0;i<S.length;i++){var j=S[i].getBindingContextPath();var o=jQuery.extend({},true,r);o.ChangedOn=s[i].ChangedOn;o.OfferId=s[i].OfferId;m.update(j,o,{groupId:"batchCalls"});}m.submitChanges({groupId:"batchCalls",success:function(k){e(k);m.setUseBatch(false);},error:function(k){f(k);m.setUseBatch(false);}});});},getOffer:function(o){this._offerId=U.base64ToHex(o.OfferId);var f={"$expand":"Terms"};return this.read("/Offers(binary'"+U.base64ToHex(o.OfferId)+"')",f,function(r){return{data:r||{}};});},deleteOffers:function(o){var m=this.getServiceModel();m.setUseBatch(true);m.setRefreshAfterChange(false);var G=jQuery.sap.uid();var e=m.getDeferredGroups();e=e.concat([G]);m.setDeferredGroups(e);o.map(function(i){m.remove("/Offers(binary'"+i+"')",{groupId:G,changeSetId:jQuery.sap.uid()});});return new Promise(function(r,f){m.submitChanges({groupId:G,success:function(R,i){m.setUseBatch(false);r({data:R,response:i});},error:function(i){m.setUseBatch(false);f(i);}});});},getOffersActions:function(o,A){var m=this.getServiceModel();m.setUseBatch(true);var G=jQuery.sap.uid();var e=m.getDeferredGroups();e=e.concat([G]);m.setDeferredGroups(e);var f={OfferId:null,Area:A};o.forEach(function(O){f.OfferId=U.base64ToHex(O.OfferId);m.callFunction("/GetActions",{groupId:G,urlParameters:f,changeSetId:jQuery.sap.uid()});});return new Promise(function(r,i){m.submitChanges({groupId:G,success:function(R){var j=R.__batchResponses;j=j.map(function(I){return I.data.results;});r({data:j});m.setUseBatch(false);},error:function(j){i(j);m.setUseBatch(false);}});});},executeMassOfferTransfer:function(o){var m=this.getServiceModel();var v=[];o.forEach(function(f){v.push({OfferId:f.OfferId,ExtOfferId:f.ExtOfferId,MasterdataSystem:f.MasterdataSystem});});var e={"OfferId":o[0].OfferId,"Status":"98","Versions":v};return new Promise(function(r,f){m.create("/Offers",e,{async:true,success:function(R,i){r({data:R,response:i});},error:f});});},getExecuteOffersActions:function(o,A,s){var m=this.getServiceModel();m.setUseBatch(true);m.setRefreshAfterChange(false);var G=jQuery.sap.uid();var e=m.getDeferredGroups();e=e.concat([G]);m.setDeferredGroups(e);var f={OfferId:null,Action:A,Area:s};o.map(function(O){f.OfferId=U.base64ToHex(O.OfferId);m.callFunction("/ExecuteAction",{urlParameters:f,groupId:G,changeSetId:jQuery.sap.uid()});});return new Promise(function(r,i){m.submitChanges({groupId:G,success:function(R,j){m.setUseBatch(false);r({data:R,response:j});},error:function(j){m.setUseBatch(false);i(j);}});});},getNewOfferStatuses:function(e){var f={};if(e){f.OfferId="binary'"+e+"'";}f.Area="'S'";f.random=U.guid();return this.read("/GetActions",f,function(s){var i=s.results.map(function(j){return{Key:j.Status,Value:j.StatusName};});return i;});},getSearchHelpLocationPicker:function(m,e,s){var f={EntityType:"'Term'",PropertyName:"'"+e+"'",MasterdataSystem:"'"+m+"'"};return this.read("/GetHelpValues",f,function(r){var t=r.results.filter(function(i){return i.Value.toLowerCase().indexOf(s.toLowerCase())>-1?true:false;});return{data:t};});},getLocations:function(s,e){return this.read(s,e,function(r){return{data:r.results};});},getLocationSuggestions:function(m,e){var t=10;var D="/LocationHierarchyNodes";var f={$filter:"MasterdataSystem eq '"+m+"'",$top:t};if(e){f.search=e;}return this.getLocations(D,f);},getLocationFiltered:function(m,f,e,i,j){var D="/LocationHierarchyNodes";var k={};if(e){k.search=e;}k.$filter="MasterdataSystem eq '"+m+"'"+(f?" and "+f:"");if(i){k.$expand="Locations";}if(j){k.$expand=(k.$expand?k.$expand+",":"")+"Locations/CustomAttributes";}return this.read(D,k,function(r){return{data:r.results};});},searchTermsObjects:function(s,t,f,n,e){var i=jQuery.extend([],f);var m=this.getServiceModel();if(n){i.unshift({"Id":0,"Attribute":"NO_PRICE","Sign":"I","Option":"EQ","Low":"X"});}var j={"Action":"Search","TermObjects":[{"Id":"","Dimension":"","ProductDetail":{"Id":"","Dimension":""}}],"Filters":i||[]};if(e){j.TermObjects[0].UnitOfMeasures=[{}];}if(s!==null){j.Skip=s;}if(t!==null){j.Top=t;}var k="/TermObjectSearches";return new Promise(function(r,o){m.create(k,j,{async:true,success:r,error:o});}).then(function(o){if(!o.TermObjects){o.TermObject=[];}return o;});},fetchProductsByExternalIds:function(m,i){var e=this.getServiceModel();var f=i.map(function(j,k){return{"Id":k,"Attribute":"ExtId","Sign":"I","Option":"EQ","Low":j};});f.push({"Id":f.length,"Attribute":"PROD_DIM_TCD","Sign":"I","Option":"EQ","Low":"01"});f.push({"Id":f.length,"Attribute":"MD_SYSTEM_REF","Sign":"I","Option":"EQ","Low":m});f.push({"Id":f.length,"Attribute":"NO_PRICE","Sign":"I","Option":"EQ","Low":"X"});if(!i||i.length===0){return Promise.resolve([]);}return new Promise(function(r,j){e.create("/TermObjectSearches",{"Action":"Search","TermObjects":[{"Id":""}],"Filters":f},{async:true,success:function(k){var n=[];if(k.TermObjects){n=k.TermObjects.results;}r(n);},error:j});});},batchCallsOffersTwoOperations:function(e,f,i,j){var t=this.getServiceModel();return new Promise(function(r,k){t.setUseBatch(true);t.setRefreshAfterChange(false);t.setDeferredGroups(["batchCalls"]);t.create(f,null,{groupId:"batchCalls"});var u=j?"/ProductGroups":"/Offers";t.create(u,e,{groupId:"batchCalls"});t.submitChanges({groupId:"batchCalls",success:function(R){var m=U.get(R,i);r({data:m||[],returnedData:R});t.setUseBatch(false);t.setRefreshAfterChange(true);},error:function(o){k(o);t.setUseBatch(false);t.setRefreshAfterChange(true);}});});},getFinancials:function(e){var f=["__batchResponses",0,"__changeResponses",1];return this.batchCallsOffersTwoOperations(e,"/Simulate",f);},getProductsInPG:function(e){var f=["__batchResponses",0,"__changeResponses",1];return this.batchCallsOffersTwoOperations(e,"/Simulate",f,true);},createNewProductGroup:function(s){var m=this.getServiceModel();return new Promise(function(r,e){m.create("/ProductGroups",jQuery.extend({},s),{async:true,success:function(R,o){r({data:R,response:o});},error:e});});},getForecast:function(e){var f=["__batchResponses",0,"__changeResponses",1];return this.batchCallsOffersTwoOperations(e,"/Forecast",f);},getTermObjectAttributes:w(function(){var e={$filter:"Object eq '02' and AttributeType eq '01'"};return this.read("/Attributes",e,function(f){if(f.results){return f.results;}return[];});}),getTargetGroups:function(A,n){var e={};switch(A){case"contains":e={$top:10,$filter:"startswith(Name,'"+n+"')"};break;case"equals":e={$top:1,$filter:"Name eq '"+n+"'"};break;}return this.read("/TargetGroups",e,function(f){return{TargetGroups:f.results};});},getTermPrefixOptions:function(){var g=this.getInitialData();return Promise.resolve({BuyOptions:g.WhenOptions,GetOptions:g.GetOptions});},getPriceTypes:function(){return Promise.resolve(this.getInitialData().PriceTypes);},getProductTypes:function(){return Promise.resolve(this.getInitialData().ProductTypes);},getForecastConfidence:function(){return this.getInitialData().ForecastConfidence;},getWeeks:function(){return Promise.resolve(this.getInitialData().Weeks);},getCoupons:function(m,k,e,t,f){var i="/TermObjects?";var s=function nameFilter(K){return(K?K+"*":"");};var j=function(u){return"MasterdataSystem eq '"+u+"'";};var n=function n(u){return(u?" and Dimension eq '"+u+"'":"");};var o=function(T){return(T?" and Type eq '"+T+"'":"");};var q=f?" and "+f:"";var r={search:s(k),$filter:j(m)+n(e)+o(t)+q,$expand:"ProductDetail"};return this.read(i,r,function(u){return{Coupons:u.results};});},getTermAttributes:w(function(e,t){return this.read("/Attributes",{"$filter":"Object eq '"+e+"' and AttributeType eq '"+t+"'"},function(f){return{data:f.results.map(function(i){return{label:i.AttributeDesc,key:"AttributeId",id:i.AttributeId,object:i.Object,type:i.AttributeType};})};});}),withRetry:function(r,e,f){function i(t){return new Promise(function(k){setTimeout(function(){k();},t);});}function j(f,k,e,t,m){return f.apply(e,k).then(function(n){return n;},function(n){if(m===0){throw n;}return i(t).then(function(){return j(f,k,e,t,m-1);});});}return function retryingFunction(){return j(f,arguments,e,1000,r);};},getPurposes:function(){return Promise.resolve(g.Purpose);},getLocationSubgroups:function(e){var f={$filter:"HierarchyId eq '"+e.HierarchyId+"'"};return this.read("/LocationSubgroups",f,function(i){return i.results||[];});},getReferenceEvent:function(i){var e={$filter:"Id eq '"+i+"'"};return this.read("/Events",e,function(f){return f.results||[];});},getMarketingArea:function(i){var e={$filter:"MKT_AREA_ID eq '"+i+"'"};return this.read("/SH_H_DMF_MKT_AREA_H",e,function(f){return f.results||[];});},setInitialData:function(e){g=e;},getCouponOffers:function(k,s,f){var e=k?k:"";var i=(s==="O01")?"true":"false";var j="IsCouponOffer eq "+i;var m=f?" and "+f:"";var n={search:"COUPONOFFER"+e,$filter:j+m};return this.read("/Offers",n,function(o){return o.results||[];});},getCouponOfferById:function(o){var e=function(){return" IsCouponOffer eq true ";};var f={$filter:e()};return this.read("/Offers(binary'"+U.base64ToHex(o)+"')",f,function(i){return i||{};});},};P.forEach(function(e){h[e.methodName]=w(h.valueHelp(e.entityName,e.masterdataSystemIndependent),function(m){return[m||"masterdataSystemIndependent"];});});return h;},true);
