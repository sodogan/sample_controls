/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/utils/TreeValueHelpDialog","retail/pmr/promotionaloffers/utils/DateHandler","retail/pmr/promotionaloffers/utils/Formatter","retail/pmr/promotionaloffers/plugins/versions/VersionsSelector","retail/pmr/promotionaloffers/utils/controls/ValueHelpDialogTokenizer","retail/pmr/promotionaloffers/utils/Models"],function(C,J,U,T,D,F,V,a,M){"use strict";function d(o){var f=["PurchasingGroupName"];f.forEach(function(b){delete o[b];});}return C.extend("retail.pmr.promotionaloffers.plugins.versions.General",{constructor:function(){this.contentModel=new J();this.dataModel=new J();this.timeModel=new J();this.dateHandler=new D();},onInit:function(){this.getView().setModel(this.contentModel,"Content");this.getView().setModel(this.dataModel);this.getView().setModel(this.timeModel,"Time");var r=U.getResourceModel();this.getView().setModel(r,"i18n");this.contentModel.setProperty("/Editable",true);this.oMessageManager=U.getMessageManager();this.i18nModel=U.getResourceModel();this.dateHandler.attachEvent("dateChanged",function(e){var s=e.getSource();this.dataModel.setProperty("/StartOfOffer",s.getStartDate());this.dataModel.setProperty("/EndOfOffer",s.getEndDate());this.timeModel.setProperty("/StartTime",s.getStartTime());this.timeModel.setProperty("/EndTime",s.getEndTime());this.setWeekForStartOfOffer(s.getStartDate());this.setWeekForEndOfOffer(s.getEndDate());this.timeModel.refresh(true);if(!this.offerData.selectedVersion){this.dateHandler.updateTactics(this.dataModel,this.timeModel);}this.validateForm();}.bind(this));},getTime:function(o){var r=new Date(0);r.setHours(o.getHours());r.setMinutes(o.getMinutes());r.setSeconds(o.getSeconds());return r;},getOfferData:function(){var o=jQuery.extend({},this.dataModel.getData());d(o);var s=o.StartOfOffer;var e=o.EndOfOffer;o.StartOfOffer=s;o.EndOfOffer=e;o.Tactics=(o.Tactics||[]).map(function(t){return{"OfferId":t.OfferId||"","TacticType":t.TacticType,"TacticId":t.TacticId,"StartOfTactic":D.getDate(t.StartOfTactic,t.StartTimeOfTactic),"EndOfTactic":D.getDate(t.EndOfTactic,t.EndTimeOfTactic),"TacticTypeDesc":t.TacticTypeDesc,"TacticDesc":t.TacticDesc};});return o;},setOfferData:function(b,s,o){o.StartOfOffer=new Date(o.StartOfOffer);o.EndOfOffer=new Date(o.EndOfOffer);this.offerData=o;this.snapshotOffer=jQuery.extend(true,{},this.offerData);this.contentModel.setData(s);this.dataModel.setData(b);this.contentModel.setProperty("/Editable",!b.Readonly);this.contentModel.setProperty("/TokenVisible",!o.isTopLevel&&!b.Readonly);this.dataModel.setProperty("/LocationNodeId",b.LocationNodeId);this.contentModel.setProperty("/ExtNodeId",b.ExtNodeId);this.contentModel.setProperty("/ExtLocationNodeId",b.ExtLocationNodeId);var c="";if(b.ExtNodeId){c=jQuery.sap.formatMessage(b.ExtNodeId).trim();}else{c=b.ExtLocationNodeId;}this.manipulateHierarchy(this.offerData,c);var S=this.getTime(b.StartOfOffer);var e=this.getTime(b.EndOfOffer);this.timeModel.setData({Selected:U.isAllDay(b.StartOfOffer,b.EndOfOffer),StartTime:S,EndTime:e,PreviousStartOfOffer:b.StartOfOffer,PreviousEndOfOffer:b.EndOfOffer,PreviousStartTime:S,PreviousEndTime:e,ValidStartOfOffer:b.StartOfOffer?true:false,ValidEndOfOffer:b.EndOfOffer?true:false});this.dateHandler.setStartDate(b.StartOfOffer);this.dateHandler.setEndDate(b.EndOfOffer);this.dateHandler.setStartTime(S);this.dateHandler.setEndTime(e);this.dateHandler.setPrevStartDate(b.StartOfOffer);this.dateHandler.setPrevEndDate(b.EndOfOffer);this.dateHandler.setPrevStartTime(S);this.dateHandler.setPrevEndTime(e);this.setWeekForStartOfOffer(b.StartOfOffer);this.setWeekForEndOfOffer(b.EndOfOffer);if(b.Tactics&&b.Tactics.length){b.Tactics.forEach(function(t){t.StartTimeOfTactic=this.getTime(t.StartOfTactic);t.EndTimeOfTactic=this.getTime(t.EndOfTactic);}.bind(this));}if(b&&b.MasterdataSystem){this.setMasterDataSystemDependentCombos(b.MasterdataSystem);}},setLeadingCategory:function(m){var e=this.contentModel.getProperty("/Editable");if(!e){return;}this.contentModel.setProperty("/LeadingCategoryBusy",true);return M.getLeadingCategoriesSet(m).then(function(l){this.contentModel.setProperty("/LeadingCategoriesSet",l);this.contentModel.setProperty("/LeadingCategoryBusy",false);}.bind(this));},setMasterDataSystemDependentCombos:function(m){this.contentModel.setProperty("/PromotionTypeEnabled",false);this.contentModel.setProperty("/PurchasingGroupEnabled",false);this.contentModel.setProperty("/LeadingCategoriesSet",[]);return M.getPromotionTypeSetAndPurchasingGroupSet(m).then(function(r){var p=r[0];var b=r[1];this.contentModel.setProperty("/PromotionTypeSet",p);this.contentModel.setProperty("/PromotionTypeEnabled",true);this.contentModel.setProperty("/PurchasingGroupSet",b);this.contentModel.setProperty("/PurchasingGroupEnabled",true);}.bind(this));},uncheckAllHierarhy:function(l){var r=function(h){if(!h){return;}h.checked=false;for(var i in h){if(h.hasOwnProperty(i)&&jQuery.isNumeric(i)){r(h[i]);}}};r(l);},manipulateHierarchy:function(o,b){var c=this.offerData;this.expandAll=[];var e=this.contentModel.getProperty("/LocationText");if(o){c=o;}this.uncheckAllHierarhy(c.hierarchy);if(b){e=b;}this.descriptionToUse=e;var l=this.getView().byId("generalLocation");var t=[];var f=[];this.selectedLocations=[];this.currentParent=null;if(this.isLocalNodeForThisVersion(c,e)){var g=this.getUserCreatedNodeChildrens(c.hierarchy,e);f=g.locationArray;this.selectedLocations=g.selectedLocations;}else{this.selectedLocations=this.getSelectedLocations(c.hierarchy);}var n=this.dataModel.getProperty("/Name");var L=this.dataModel.getProperty("/LocationNodeId");if(f&&f.length>0){var h=[];f.forEach(function(m){h.push(m.text);t.push(new sap.m.Token(m));});if(b){l.setTokens(t);}var i=n?n:h.join(";");var j=false;if(i.length>40){i=i.substring(0,37)+"...";j=true;}this.dataModel.setProperty("/Name",i);if(j){this.getEventBus().publish("retail.pmr.promotionaloffers","changeLocationNameInSideTable",{versionName:this.dataModel.getProperty("/Name")});j=false;}this.contentModel.setProperty("/DefaultName",h.join(";"));this.contentModel.setProperty("/LocationText",h.join(";"));}else{if(b){var k=e;if(this.selectedLocations[0].Name){k=this.selectedLocations[0].Name+" ("+k+")";}t.push(new sap.m.Token({text:k,key:L}));l.setTokens(t);this.contentModel.setProperty("/DefaultName",k);}this.dataModel.setProperty("/Name",n?n:e);this.contentModel.setProperty("/LocationText",e);}},isLocalNodeForThisVersion:function(o,b){var i=false;if(o.LocalNodes&&o.LocalNodes.length>0){o.LocalNodes.forEach(function(c){if(c.Description===b){i=true;}});}return i;},getUserCreatedNodeChildrens:function(h,b){var l=[];var s=[];var o=h;var p=null;var t=this;var k=null;var g=function(h,b){if(h&&h.ExtNodeId===b){h.expanding=true;h.checked=true;h.isParent=true;for(k in h){if(h.hasOwnProperty(k)&&jQuery.isNumeric(k)){if(!h[k].excluded){h[k].checked=true;}h[k].isChild=true;h[k].expanding=true;s.push(h[k]);}}if(p){t.expandAllParents(p.ParentId,o,p);}if(t.expandAll.indexOf(h)===-1){t.expandAll.push(h);}var c=h.NodeName.split(";");var e=h.LocationIds.split(";");if(c.length===e.length){for(var i=0;i<c.length;i++){l.push({text:c[i],key:e[i]});}}}if(!l||(l&&l.length<1)){for(k in h){if(h.hasOwnProperty(k)&&jQuery.isNumeric(k)){if(h[k].ExtNodeId===b){p=h;t.currentParent=h;}g(h[k],b);}}}};g(h,b);return{locationArray:l,selectedLocations:s};},getSelectedLocations:function(h){var l=this.dataModel.getProperty("/LocationNodeId");var s=[];var o=h;var t=this;var g=function(h,l){var b=h.NodeId||h.LocationId;if(l===b){s.push(h);h.checked=true;h.expanding=true;if(t.expandAll.indexOf(h)===-1){t.expandAll.push(h);}t.expandAllParents(h.ParentId,o);}if(!s||(s&&s.length<1)){for(var k in h){if(h.hasOwnProperty(k)&&jQuery.isNumeric(k)){g(h[k],l);}}}};g(h,l);this.expandAll=this.expandAll.reverse();return s;},expandAllParents:function(P,o,p){var t=this;var n=o;var e=function(P,h){var c=P;if(!U.isInitial(c)){for(var k in h){if(h.hasOwnProperty(k)&&jQuery.isNumeric(k)){var f=h.NodeId||h.ExtNodeId;n=h[k];if(c===f){h.expanding=true;if(t.expandAll.indexOf(h)===-1){t.expandAll.push(h);}c=h.ParentId;n=o;}e(c,n);}}}};e(P,o);if(p){p.expanding=true;if(t.expandAll.indexOf(p)===-1){t.expandAll.push(p);}this.selectedLocations.forEach(function(i){if(t.expandAll.indexOf(i)===-1){t.expandAll.push(i);}});}var b=this.expandAll.indexOf(o);if(this.expandAll.indexOf(o)!==-1){this.expandAll.splice(b,1);}},timePickerVisible:function(s){return!s?"L6 M6 S6":"L12 M12 S12";},onAllDaySelect:function(e){var s=e.getParameter("selected");if(s){this.dateHandler.onAllDaySelect();}this.timeModel.setProperty("/Selected",s);this.timeModel.refresh(true);},setWeekForStartOfOffer:function(s){if(!s){this.timeModel.setProperty("/StartWeek","");return;}U.getWeek(s).then(function(w){this.timeModel.setProperty("/StartWeek",w.trim());}.bind(this),function(){this.timeModel.setProperty("/StartWeek","");}.bind(this));},setWeekForEndOfOffer:function(e){if(!e){this.timeModel.setProperty("/EndWeek","");return;}U.getWeek(e).then(function(w){this.timeModel.setProperty("/EndWeek",w.trim());}.bind(this),function(){this.timeModel.setProperty("/EndWeek","");}.bind(this));},markErrors:function(){var I=this.getErrorItems();var e=this.buildErrors(I);for(var i=0;i<I.length;i++){U.removeMessagesByPath(I[i].Target);}U.setErrorMessages(this.oMessageManager,e);return e.length;},openLeadingCategoryDialog:function(){T.openDialog({tableFragment:"retail.pmr.promotionaloffers.plugins.general.LeadingCategoryComplexSearch",title:"{i18n>CreateOffer.General.LeadingCategory}",filterProps:["ExtId","Name","HierarchyDescription","ExtHierarchyId"],values:U.buildHierarchy(this.contentModel.getData().LeadingCategoriesSet,"LeadingCategory")}).then(function(s){if(!s){this.dataModel.setProperty("/LeadingCategory",null);this.dataModel.setProperty("/LeadingCategoryName","");return;}this.dataModel.setProperty("/LeadingCategory",s.Id);this.dataModel.setProperty("/LeadingCategoryName",jQuery.sap.formatMessage(s.ExtId," ",s.Name));this.validateLeadingCategory();}.bind(this));},handleLeagingCategoryComplexSearch:function(){var l=this.contentModel.getProperty("/LeadingCategoriesSet")||[];if(!l.length){var m=this.dataModel.getProperty("/MasterdataSystem");this.setLeadingCategory(m).then(function(){this.openLeadingCategoryDialog();}.bind(this));return;}this.openLeadingCategoryDialog();},onLeadingCategorySuggestionSelect:function(e){var s=e.getParameters("selectedItem").selectedItem;var i=s.getProperty("key");var t=s.getProperty("text");this.dataModel.setProperty("/LeadingCategory",i);this.dataModel.setProperty("/LeadingCategoryName",t);this.validateLeadingCategory();},onLeadingCategorySuggest:function(e){var l=this.contentModel.getProperty("/LeadingCategoriesSet")||[];if(l.length||this.contentModel.getProperty("/LeadingCategoryBusy")){return;}var m=this.dataModel.getProperty("/MasterdataSystem");this.setLeadingCategory(m).then(function(){this.validateLeadingCategory();}.bind(this));},leadingCategoryValueChanged:function(e){var v=e.getSource().getValue();this.dataModel.setProperty("/LeadingCategory","");if(!v){this.validateLeadingCategory();return;}function u(){var l=this.contentModel.getProperty("/LeadingCategoriesSet")||[];for(var i=0;i<l.length;i++){var L=l[i];if(L.ExtId===v.toUpperCase()){this.dataModel.setProperty("/LeadingCategory",L.Id);this.dataModel.setProperty("/LeadingCategoryName",jQuery.sap.formatMessage(L.ExtId," ",L.Name));}}this.validateLeadingCategory();}if(!(this.contentModel.getProperty("/LeadingCategoriesSet")||[]).length){var m=this.dataModel.getProperty("/MasterdataSystem");this.setLeadingCategory(m).then(function(){u.call(this);}.bind(this));return;}u.call(this);},validateLeadingCategory:function(){var v=this.dataModel.getProperty("/LeadingCategoryName");var m={message:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralLeadingCategory.Invalid.Title"),description:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralLeadingCategory.Invalid.Description")};return this.validateByPath("/LeadingCategoryName",this.dataModel,m,function(){return(!v||this.dataModel.getProperty("/LeadingCategory"));}.bind(this));},validateByPath:function(p,m,b,n){U.removeMessagesByPath(p);if(n()){return 0;}var e={target:p,type:"Error",processor:m,message:b.message,description:b.description};U.setErrorMessages(this.oMessageManager,[e]);return 1;},setLocationDataFromSnapshot:function(){this.offerData.hierarchy=this.snapshotOffer.hierarchy;},validSelectionExist:function(s){var b=jQuery.extend(true,[],s);var f=b.filter(function(i){return!i.excluded;});if(f&&f.length>0){return true;}return false;},handleLocationComplexSearch:function(){var t=this;var b=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.versions.VersionsTree",this);var o=jQuery.extend(true,{},this.offerData);this.manipulateHierarchy(o,this.descriptionToUse);var s=new V(b,o.hierarchy,this.i18nModel,o.Versions,o.ExcludedNodes,this.selectedLocations);var p={rowContext:this.expandAll[0],expanded:true,isObject:true};s.asyncExpand(p);b.attachToggleOpenState(function(e){var P={rowContext:e.getParameter("rowContext"),expanded:e.getParameter("expanded")};s.asyncExpand(P);});var c={title:this.i18nModel.getResourceBundle().getText("Versions.Location.ValueHelpDialog"),supportMultiselect:true,stretch:sap.ui.Device.system.phone,ok:function(){var e=s.getSelected();var f=null;if(e&&e.length>0){f=s.getParentItem(e[0]);}var g={parent:f,selectedLocations:e};if(t.validSelectionExist(e)){t.getEventBus().publish("retail.pmr.promotionaloffers","onVersionLocationChange",g);this.close();if(t._versionsDialog){t._versionsDialog.destroy();}}else{t.alertNoLocationSelected();}},cancel:function(){this.close();t._versionsDialog.destroy();},selectionChange:function(e){s.selectionChanged(e);}};this._versionsDialog=new a("versionsLocationPickerID",c);this._versionsDialog.addStyleClass("sapUiSizeCompact");this._versionsDialog.setTable(b);b.getModel().setSizeLimit(U.getSizeLimit());b.setVisibleRowCount(s.data.length);s.setVHDialog(this._versionsDialog,{StartOfOffer:this.dataModel.getData().StartOfOffer,EndOfOffer:this.dataModel.getData().EndOfOffer});this._versionsDialog.open();},alertNoLocationSelected:function(){var m=this.i18nModel.getResourceBundle().getText("Versions.NoSelectedLocationMessage");U.getErrorHandler().showError(m);},getEventBus:function(){return sap.ui.getCore().getEventBus();},onLocationChange:function(c){if(c.getParameters().type==="removed"){var s=jQuery.extend(true,[],this.selectedLocations);var t=c.getParameters().token;for(var i=0;i<s.length;i++){var l=s[i].LocationId||s[i].NodeId;var b=t.getKey();if(l===b){s.splice(i,1);}}if(this.validSelectionExist(s)){var e={parent:this.currentParent,selectedLocations:s};this.selectedLocations=s;this.getEventBus().publish("retail.pmr.promotionaloffers","onVersionLocationChange",e);}else{var f=this.getView().byId("generalLocation");var g=f.getTokens()||[];g.push(new sap.m.Token({text:t.getText(),key:t.getKey()}));f.setTokens(g);this.alertNoLocationSelected();}}},onNameChanged:function(){var b=this.contentModel.getProperty("/DefaultName");if(!this.dataModel.getProperty("/Name")){if(b.length>40){b=b.substring(0,37)+"...";}this.dataModel.setProperty("/Name",b);}this.validateForm();this.getEventBus().publish("retail.pmr.promotionaloffers","changeLocationNameInSideTable",{versionName:this.dataModel.getProperty("/Name")});},validateForm:function(){var v=this.markErrors();return v;},getErrorItems:function(){var i=[{Property:"/StartOfOffer",Target:"/StartOfOffer",Mandatory:true,Model:this.dataModel,TargetModel:this.dataModel,ErrorTitle:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralStartDate.Title"),ErrorDescription:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralStartDate.Description"),ErrorTitleInvalidValue:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralStartDate.Invalid.Title"),ErrorDescriptionInvalidValue:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralStartDate.Description"),ErrorDescriptionInvalidDate:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralStartDate.Description")},{Property:"/EndOfOffer",Target:"/EndOfOffer",Mandatory:true,Model:this.dataModel,TargetModel:this.dataModel,ErrorTitle:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralEndDate.Title"),ErrorDescription:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralEndDate.Description"),ErrorTitleInvalidValue:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralEndDate.Invalid.Title"),ErrorDescriptionInvalidValue:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralEndDate.Description"),ErrorDescriptionInvalidDate:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralEndDate.Description")},{Property:"/StartTime",Target:"/StartTime",Mandatory:true,Model:this.timeModel,TargetModel:this.timeModel,ErrorTitle:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralStartTime.Title"),ErrorDescription:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralStartTime.Description")},{Property:"/EndTime",Target:"/EndTime",Mandatory:true,Model:this.timeModel,TargetModel:this.timeModel,ErrorTitle:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralEndTime.Title"),ErrorDescription:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralEndTime.Description")},{Property:"/Name",Target:"/Name",Mandatory:true,Model:this.dataModel,TargetModel:this.dataModel,ErrorTitle:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralOfferName.Title"),ErrorDescription:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralOfferName.Description"),ErrorTitleTooLong:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralOfferName.TitleTooLong"),ErrorDescriptionTooLong:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralOfferName.DescriptionTooLong")},{Property:"/Description",Target:"/Description",Mandatory:false,Model:this.dataModel,TargetModel:this.dataModel,ErrorTitle:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralOfferDescription.Title"),ErrorDescription:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralOfferDescription.Description")},{Property:"/Tactics",Target:"/Tactics",Mandatory:false,Model:this.dataModel,TargetModel:this.dataModel,ErrorTitle:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralOfferTactics.Title"),ErrorDescription:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralOfferTactics.Description")}];return i;},buildErrors:function(b){var v=function(i,c){var E=null;var o=this.offerData;var s=o.StartOfOffer;var f=o.EndOfOffer;var g=this.dataModel.getProperty("/StartOfOffer");var h=this.dataModel.getProperty("/EndOfOffer");var j=this.offerData.selectedVersion;switch(i.Property){case"/Name":if(c.length>40){E={Title:i.ErrorTitleTooLong,Description:i.ErrorDescriptionTooLong};}break;case"/Tactics":if(!c){break;}var k=c.filter(function(t){return g>t.StartOfTactic||h<t.EndOfTactic;});if(k.length&&!j){E={Title:i.ErrorTitle,Description:i.ErrorDescription};}break;case"/Description":if(c&&c.length>255){E={Title:i.ErrorTitle,Description:i.ErrorDescription};}break;case"/StartOfOffer":if(!this.timeModel.getProperty("/ValidStartOfOffer")){E={Title:i.ErrorTitleInvalidValue,Description:i.ErrorDescriptionInvalidValue};}else if(!this.validOfferDate("StartOfOffer")){E={Title:i.ErrorTitleInvalidValue,Description:i.ErrorDescriptionInvalidDate};}else if(!this.offerData.isTopLevel&&s.getTime()>this.dataModel.getProperty("/StartOfOffer").getTime()){E={Title:i.ErrorTitleInvalidValue,Description:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralDateInterval.Description")};}break;case"/EndOfOffer":if(!this.timeModel.getProperty("/ValidEndOfOffer")){E={Title:i.ErrorTitleInvalidValue,Description:i.ErrorDescriptionInvalidValue};}else if(!this.validOfferDate("EndOfOffer")){E={Title:i.ErrorTitleInvalidValue,Description:i.ErrorDescriptionInvalidDate};}else if(!this.offerData.isTopLevel&&f.getTime()<this.dataModel.getProperty("/EndOfOffer").getTime()){E={Title:i.ErrorTitleInvalidValue,Description:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralDateInterval.Description")};}break;}return E;}.bind(this);var e=[];b.forEach(function(i){var c=i.Model.getProperty(i.Property);var m=i.Mandatory;var E=null;if(m&&!c){E={Title:i.ErrorTitle,Description:i.ErrorDescription};}else{E=v(i,c);}if(E){e.push({message:E.Title,description:E.Description,target:i.Target,type:"Error",processor:i.TargetModel});}});return e;},validOfferDate:function(t){var v=true;var s=this.dataModel.getProperty("/StartOfOffer");var e=this.dataModel.getProperty("/EndOfOffer");switch(t){case"StartOfOffer":if(!s){v=false;}else if(e&&s.getTime()>=e.getTime()){v=false;}break;case"EndOfOffer":if(!e){v=false;}else if(s&&s.getTime()>=e.getTime()){v=false;}break;}return v;},onOfferStartDateChange:function(e){var v=e.getParameter("valid");var b=e.getSource().getDateValue();if(!v){this.dataModel.setProperty("/StartOfOffer",new Date(NaN));this.dataModel.setProperty("/StartOfOffer",b);}this.dateHandler.startDateChanged(b,v);this.getEventBus().publish("retail.pmr.promotionaloffers","validateVersions",{});},onOfferEndDateChange:function(e){var v=e.getParameter("valid");var b=e.getSource().getDateValue();if(!v){this.dataModel.setProperty("/EndOfOffer",new Date(NaN));this.dataModel.setProperty("/EndOfOffer",b);}this.dateHandler.endDateChanged(b,v);this.dateHandler.endDateChanged(e.getSource().getDateValue(),e.getParameter("valid"));this.getEventBus().publish("retail.pmr.promotionaloffers","validateVersions",{});},onOfferStartTimeChange:function(e){this.dateHandler.startTimeChanged(new Date(e.getSource().getDateValue()));this.getEventBus().publish("retail.pmr.promotionaloffers","validateVersions",{});},onOfferEndTimeChange:function(e){this.dateHandler.endTimeChanged(e.getSource().getDateValue());this.getEventBus().publish("retail.pmr.promotionaloffers","validateVersions",{});},timeLabelValueFormatter:function(t){return this.dateHandler.getFormatTimePiker(t);},adaptEndDate:function(s){var e=this.dataModel.getProperty("/EndOfOffer");if(!e){return;}var p=this.timeModel.getProperty("/PreviousStartOfOffer");var i=e.getTime()-p.getTime();var n=new Date(s.getTime()+i);this.dataModel.setProperty("/EndOfOffer",n);this.timeModel.setProperty("/PreviousEndOfOffer",n);},setOfferDate:function(p,t){var o=this.dataModel.getProperty(p);var b=this.dateHandler.getDate(o,t);this.dataModel.setProperty(p,b);return b;}});});
