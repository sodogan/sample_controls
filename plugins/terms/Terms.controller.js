/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Models","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/plugins/terms/ConfigurationParser","retail/pmr/promotionaloffers/plugins/terms/styles/StyleBuilder"],function(C,J,M,U,a,S){var v=function(o,m){var s=false;m.forEach(function(c){if(!(o[c]instanceof Function)){s=true;}});if(s){throw new Error("A Terms Offer should implement the following methods: "+m.join(", "));}};var g=function(s,d){var c=(s||{}).Purpose||[];var e=d.map(function(l){return l.Purpose;}).filter(function(f,i,h){return h.indexOf(f)===i;}).map(function(f){var p=c.filter(function(x){return x.PURPOSE_ID===f;})[0]||{};return{Id:f,Name:p.PURPOSE_DESC};});return e.length?e:[{}];};function b(c,d){if(c===null||c===undefined){return d;}return c;}return C.extend("retail.pmr.promotionaloffers.plugins.terms.Terms",{extHookOnsetOfferData:null,extHookOngetOfferData:null,extHookOnvalidate:null,constructor:function(){this.currentController=null;this.model=new J();this.termStyles=new J({Selected:null,TermStyles:[],TermsMap:{}});this.versions=new J({Versions:[]});this.contentModel=new J({EnforceMultiple:[]});},onInit:function(){this.eventBus=sap.ui.getCore().getEventBus();var c=this.getView();this.termStyleContainer=c.byId("termStyleLayoutContainer");c.setModel(this.model);c.setModel(this.termStyles,"TermStyles");c.setModel(this.versions,"Versions");c.setModel(this.contentModel,"ContentModel");this.eventBus.subscribe("retail.pmr.promotionaloffers","resetViews",this.resetView,this);},onExit:function(){this.eventBus.unsubscribe("retail.pmr.promotionaloffers","resetViews",this.resetView,this);},resetView:function(){this.termsStyleComboSelectionChanged();},setFinancialData:function(d){if(this.currentController.setFinancialData){this.currentController.setFinancialData(d);}},setFinancials:function(d){this.currentController.setFinancials(d);},configTermStyles:function(s){var c=this.getOwnerComponent().getTermStyles();var F="retail.pmr.promotionaloffers.plugins.terms.styles.Freestyle";var d="XML";var e=s.reduce(function(i,f){var h=c[f.Id];if(f.ConfigurationBased){i.push({Group:f.Group,GroupDescription:f.GroupDescription,Active:f.Active,Id:f.Id,ViewName:F,ViewType:d,Description:f.Description,ConfigurationBased:true,Type:f.Type,Sections:f.Sections.results.map(function(j){function r(k){delete k.__metadata;return k;}function u(k){for(var l in k){if(!k.hasOwnProperty(l)){continue;}if(k[l].hasOwnProperty("results")){k[l]=k[l].results.map(u);}}return k;}return u(r(j));})});}else if(h){i.push({Group:f.Group,GroupDescription:f.GroupDescription,Active:f.Active,Id:f.Id,ViewName:h.ViewName,ViewType:h.ViewType,Description:f.Description});}return i;},[]);if(e.length===0){U.criticalError(U.getI18NModel(),"No term styles are configured.","Caused by missing implementations for configured term styles","Check that the term styles configured in 'Configuration.js' are implemented.","Other possible cause is that there are no term styles marked as configuration based","Call '/TermStyles' and make sure that at least one style exists and is marked as 'ConfigrationBased'");}return e;},setStaticData:function(s){s=s||{};var p=this.generalDataModel.getDataModel().getProperty("/PackageOffer");var l=this.generalDataModel.getDataModel().getProperty("/LocationSubgroups");var f=U.setupFeatures(s.FeaturesAvailable||[]);var h=f.LocationSubgroups==="X";this.aPurposes=[];if(h){this.aPurposes=g(s,l||[]);}var t=this.configTermStyles(s.Terms||[]);var c=this.termStyles.getData();c.TermStyles=t.filter(function(e){if(p){return(e.Type==="P"&&e.Active);}else{return(e.Type!=="P"&&e.Active);}});c.TermsMap=t.reduce(function(m,e){m[e.Id]=e;return m;},{});this.staticData=s;this.termStyles.refresh();this.termStyles.setProperty("/Selected",p?c.TermStyles[0].Id:"005");this.termsStyleComboSelectionChanged();var d=(s.EnforceMultiple||[]).map(function(i){i.Key=i.Key===""?"No":i.Key;return i;});this.contentModel.setProperty("/EnforceMultiple",d);},validateTermStyleValue:function(){var c=this.termStyles.getProperty("/TermStyleValue")||"";var s=this.termStyles.getProperty("/Selected");var p=U.get(this.termStyles.getData(),["TermsMap",s,"Description"])||"";var m=U.getMessageManager();var i=U.setReuseI18NModel(this);U.removeMessagesByPath("/TermStyleValue");if(c.trim()!==p.trim()){m.addMessages(new sap.ui.core.message.Message({message:i.getResourceBundle().getText("ErrorMessage.TermsStyle.Title"),description:i.getResourceBundle().getText("ErrorMessage.TermsStyle.Description"),type:"Error",target:"/TermStyleValue",processor:this.termStyles}));return 1;}else{return null;}},validateForm:function(){var s=this.termStyles.getProperty("/Selected");var m=U.getMessageManager();var i=U.setReuseI18NModel(this);U.removeMessagesByPath("/TermStyleValue");U.removeMessagesByPath("/EnforceMultipleValue");if(!s){m.addMessages(new sap.ui.core.message.Message({message:i.getResourceBundle().getText("ErrorMessage.TermsStyle.Title"),description:i.getResourceBundle().getText("ErrorMessage.TermsStyle.Description"),type:"Error",target:"/TermStyleValue",processor:this.termStyles}));return 1;}if(!this.contentModel.getProperty("/EnforceMultipleValue")){m.addMessages(new sap.ui.core.message.Message({message:i.getResourceBundle().getText("ErrorMessage.EnforceMultiple.Title"),description:i.getResourceBundle().getText("ErrorMessage.EnforceMultiple.Description"),type:"Error",target:"/EnforceMultipleValue",processor:this.contentModel}));return 1;}var c=this.validateTermStyleValue();if(c){return c;}if(!this.currentController){return 1;}var e=this.currentController.validate();if(isNaN(e)){throw new Error("Validate should return the numbers of errors on the current control");}if(e>0){return e;}if(this.extHookOnvalidate){return this.extHookOnvalidate();}return 0;},switchStyleLayout:function(t,k){var c=this.termStyleContainer,d=null,f=null;try{d=this.createView(t.ViewName,t.ViewType);}catch(e){jQuery.sap.log.error(e);if(!t){return;}throw new Error("Can't load style "+t.ViewName+" of type "+t.ViewType+", "+"it is added to the config file but not implemented. "+"Make sure that you place the style in the same package "+"and of the same type that you specify in the config file.");}f=d.getController();if(f.setRouter){f.setRouter(this.router);}if(f.setGeneralModel){f.setGeneralModel(this.generalDataModel.getDataModel());}if(f.setTermsModel){f.setTermsModel({contentModel:this.contentModel});}if(k){var E=this.contentModel.getProperty("/EnforceMultipleEditable");var l=this.contentModel.getProperty("/LimitEditable");}this.contentModel.setData({EnforceMultiple:this.staticData.EnforceMultiple||[],Editable:this.contentModel.getProperty("/Editable"),Purposes:this.aPurposes,ParentId:this.getView().getId().split("--")[1]});if(k){this.contentModel.setProperty("/EnforceMultipleEditable",E);this.contentModel.setProperty("/LimitEditable",l);}v(f,["getOfferData","setOfferData","validate"]);this.setCurrentController(f);this.attachToContainer(c,d);},termsStyleComboSelectionChanged:function(e){var t=this.termStyles.getData();var s=t.Selected;var c=t.TermsMap;if(!s){this.attachToContainer(this.termStyleContainer,null);this.setCurrentController(null);}else{this.termStyles.setProperty("/TermStyleValue",U.get(t,["TermsMap",s,"Description"])||"");var k=e?false:true;this.switchStyleLayout(c[s],k);this.applyConfigToStyle(this.currentController,c[s]);}if(e&&this.currentController){this.currentController.setOfferData({staticData:this.staticData,Terms:[],Incentives:[]});this.applyConfigToStyle(this.currentController,c[s]);}this.validateForm();},enforceMultipleChanged:function(e){if(this.currentController.updateEnforceMultiple){this.currentController.updateEnforceMultiple(this.contentModel.getProperty("/EnforceMultipleValue"));}this.validateForm();},createView:function(n,t){return S.getView(n,t,this.getView().getId());},attachToContainer:function(c,d){c.removeAllContent();if(d){c.addContent(d);}},onVersionsButtonPress:function(){this.eventBus.publish("CreateOffer.terms.VersionDialog","openVersionDialog",this.versions);},loadTermStyles:function(){return M.getTermStyles();},loadEnforceMultiple:function(){return M.getEnforceMultiple();},setCurrentController:function(c){this.currentController=c;},getFinancials:function(){if(this.currentController){return this.currentController.getFinancials();}return{};},getTermsProductsFinancials:function(){if(this.currentController){return this.currentController.getTermsProductsFinancials();}return{};},getOfferData:function(){var s=this.termStyles.getProperty("/Selected");var t=null;var i=null;if(this.currentController){var o=this.currentController.getOfferData()||{Incentives:[],Terms:[]};t=o.Terms;i=o.Incentives;}var c=this.contentModel.getProperty("/EnforceMultipleVisible");if(c===null||c===undefined){c=true;}var d=this.contentModel.getProperty("/LimitVisible");if(d===null||d===undefined){d=true;}var e={TermStyle:s,Terms:t||[],Incentives:i||[]};var f=this.contentModel.getProperty("/EnforceMultipleValue");if(c&&f!==null){e.EnforceMultiple=f==="No"?"":f;}var l=this.contentModel.getProperty("/LimitValue");if(d&&l!==null){e.Limit=l+"";}var p=this.generalDataModel.getDataModel().getProperty("/PackageOffer");if(p===true){this.contentModel.setProperty("/EnforceMultipleEditable",false);}else if(p===false){this.contentModel.setProperty("/EnforceMultipleEditable",true);}if(this.contentModel.getProperty("/PackageValue")&&p){var h=this.contentModel.getProperty("/PackageValue");var j=this.contentModel.getProperty("/PackageValueVisible");if(j&&l!==null){e.PackageValue=h+"";}}if(this.extHookOngetOfferData){e=this.extHookOngetOfferData(e);}return e;},determineCorrectTermStyle:function(s){if(s){return s;}var i=this.generalDataModel.getDataModel().getProperty("/PackageOffer");if(i){return"011";}else{return"005";}},setOfferData:function(d,s){if(this.extHookOnsetOfferData){d=this.extHookOnsetOfferData(d,s);}M.postponeModelRefresh(true);if(s){this.setStaticData(s);}var t=this.termStyles.getData().TermsMap;var c=this.determineCorrectTermStyle(d.TermStyle);var e=d.Terms||[];var f=d.Incentives||[];this.contentModel.setProperty("/Editable",!d.Readonly);var A=this.termStyles.getData().TermStyles||[];var h=[];var j=this.termStyles.getData();for(var i=0,l=A.length;i<l;i++){if(A[i].Id===j.Selected){A[i].Active=true;}if(A[i].Active){h.push(A[i]);}}this.termStyles.setProperty("/TermStyles",h);this.termStyles.setProperty("/Selected",c);for(var i=0,l=A.length;i<l;i++){if(A[i].Id===j.Selected){this.termStyles.setProperty("/TermStyleValue",A[i].Description||"");this.switchStyleLayout(A[i]);break;}}var k=null;if(d.EnforceMultiple!==null&&d.EnforceMultiple!==undefined){k=d.EnforceMultiple||"No";}else{k=this.contentModel.getProperty("/EnforceMultipleValue")||"No";}var m=d.Limit||this.contentModel.getProperty("/LimitValue");var p=d.PackageValue||this.contentModel.getProperty("/PackageValue");var n=e.length?(parseFloat(e[0].UserProjection)/parseFloat(e[0].Quantity))||0:null;n=n||this.contentModel.getProperty("/UserProjectionValue");this.contentModel.setProperty("/EnforceMultipleValue",k);this.contentModel.setProperty("/LimitValue",m);this.contentModel.setProperty("/PackageValue",p);this.contentModel.setProperty("/UserProjectionValue",n);this.contentModel.setProperty("/Purposes",this.aPurposes);this.currentController.setOfferData({editable:!d.Readonly,Terms:e,Incentives:f,contentModel:this.contentModel,staticData:s});this.applyConfigToStyle(this.currentController,t[c]);M.postponeModelRefresh(false);},applyConfigToStyle:function(c,s){if(!s){U.criticalError(U.getI18NModel(),"The term style configured for current offer is not available","Ensure that it is either implmented as a custom term style","or that the given style is marked as 'ConfigurationBased' so that 'Freestyle' can be used");}if(!s.ConfigurationBased){this.applyHeaderConfigs(null);return;}var d=new a({configs:"Header"});var h=d.parse(s.Sections);this.applyHeaderConfigs(h.configs[0]);c.applyConfigs(s.Sections);},applyHeaderConfigs:function(c){var d={Limit:{},EnforceMultiple:{},PackageValue:{},UserProjection:{}};var e=jQuery.extend(true,{},d,c);var f=this.contentModel.getData();var h={LimitVisible:b(e.Limit.Visible,true),LimitEditable:b(e.Limit.Editable,true),LimitValue:b(e.Limit.DefaultValue,0),EnforceMultiple:f.EnforceMultiple||[],EnforceMultipleVisible:b(e.EnforceMultiple.Visible,true),EnforceMultipleEditable:b(e.EnforceMultiple.Editable,true),EnforceMultipleValue:b(e.EnforceMultiple.DefaultValue,"X"),PackageValueVisible:b(e.PackageValue.Visible,true),PackageValueEditable:b(e.PackageValue.Editable,true),PackageValue:b(e.PackageValue.DefaultValue,null),UserProjectionVisible:b(e.UserProjection.Visible,true),UserProjectionEditable:b(e.UserProjection.Editable,true),UserProjectionValue:b(e.UserProjection.DefaultValue,"0")};Object.keys(h).forEach(function(n){if(f[n]==undefined){f[n]=h[n];}});this.contentModel.setData(f);},resetOfferData:function(){this.setStaticData(this.staticData);this.contentModel.setProperty("/EnforceMultipleValue","X");this.contentModel.setProperty("/LimitValue","0");this.contentModel.setProperty("/PackageValue",null);this.contentModel.setProperty("/Purposes",this.aPurposes);this.currentController.setOfferData({staticData:this.staticData});var d=this.termStyles.getData();this.applyConfigToStyle(this.currentController,d.TermsMap[d.Selected]);},setRouter:function(r){this.router=r;},setGeneralDataModel:function(m){this.generalDataModel=m;this.getView().setModel(m.getDataModel(),"GeneralModel");},processServerErrors:function(m){if(this.currentController&&this.currentController.processServerErrors){this.currentController.processServerErrors(m);}},handlePositiveNumeric:function(e){U.validationHandler("greaterOrEqualValidation",e,"/LimitValue",null,this.contentModel);},updatePackagePrice:function(e){U.validationHandler("greaterOrEqualValidation",e,"/PackageValue",null,this.contentModel);if(this.currentController.updatePackage){this.currentController.updatePackage(function rewardPackageValue(r){return r.PackageValue;});}},updatePackageTotal:function(e){U.validationHandler("greaterOrEqualValidation",e,"/UserProjectionValue",null,this.contentModel);if(this.currentController.updatePackageUserProjection){this.currentController.updatePackageUserProjection(false);}},formatterBool:function(c,d){return c&&d;},labelFormatter:function(e,l,c,d){var f=[];if(e){f.push(l);}if(c){f.push(d);}return f.length>1?f.join(" / "):f.join();},getSelectedTermStyle:function(){return this.termStyles.getProperty("/Selected");}});},true);
