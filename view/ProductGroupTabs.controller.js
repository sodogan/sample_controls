/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/utils/Models","sap/ui/core/routing/History"],function(C,J,U,M,H){"use strict";function c(d){var e={};jQuery.extend(true,e,d);delete e.PreviewCriteria;return e;}function s(d){if(!jQuery.sap.equal(c(d.snapshot),c(d.getProductGroupData()))){return false;}return true;}function a(o){if(s(o.controller)){return Promise.resolve();}function d(r){r();}function e(r,f){f();}return U.createDialogUtil(jQuery.extend(o,{onOk:d,onCancel:e,state:"Warning"}));}function b(v,i){return v.byId(i).getController();}var m=U.getErrorHandler().createMessagePopover();return C.extend("retail.pmr.promotionaloffers.view.ProductGroupTabs",{constructor:function(){this.dataModel=new J();this.contentModel=new J();},onInit:function(){this.getView().setModel(this.dataModel);this.getView().setModel(this.contentModel,"Content");this.basicDataController=b(this,"basicDataView");this.defineInclusionsController=b(this,"defineInclusionsView");this.defineExclusionsController=b(this,"defineExclusionsView");this.previewController=b(this,"previewView");this.i18nBundle=U.getResourceModel();this.oMessageManager=U.getMessageManager();m.setModel(this.oMessageManager.getMessageModel());this.getEventBus().subscribe("retail.pmr.promotionaloffers","onAction",this.triggerRefreshTables,this);this.getEventBus().subscribe("retail.pmr.promotionaloffers","reselectTab",this.reselectCurrentActionTab,this);this.snapshot={};this.getRouter().attachRouteMatched(this.routeMatched,this);this.bNavPressed=false;},routeMatched:function(e){var h=H.getInstance();var l=h.aHistory[h.aHistory.length-1];if(l.indexOf("productGroup")===0&&e.getParameter("name")!=="productGroup"&&!this.bNavPressed){this.resolve({ProductGroup:this.productGroupData,skipCall:!this.isAfterSave});}this.bNavPressed=false;},onExit:function(){this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","onAction",this.triggerRefreshTables,this);this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","reselectTab",this.reselectCurrentActionTab,this);},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this);},getEventBus:function(){return sap.ui.getCore().getEventBus();},onCancel:function(){this.openCancelDialog();},openCancelDialog:function(){var d={controller:this,view:this.getView(),title:"{i18n>CreateOffer.OfferCancelDialogTitle}",message:"{i18n>CreateOffer.OfferCancelDialogDescription}",btnOk:"{i18n>CreateOffer.CreateOfferDialog.Accept}",btnCancel:"{i18n>CreateOffer.CreateOfferDialog.Reject}"};var t=this;a(d).then(function(){window.history.back();t.oMessageManager.removeAllMessages();t.defineInclusionsController.resetProductHierarchy();t.defineExclusionsController.resetProductHierarchy();t.defineInclusionsController.resetProductSearch();t.defineExclusionsController.resetProductSearch();t.previewController.resetModel();t.previewController.resetSearch();if(t.productGroupData){t.resolve({ProductGroup:t.productGroupData,skipCall:!t.isAfterSave});}else{t.resolve(null);}t.isAfterSave=false;t.productGroupData=null;},U.indentity);},onNavButtonPress:function(){this.bNavPressed=true;this.openCancelDialog();},onSave:function(){var t=this;if(!this.verifyValidation()){return;}U.getErrorHandler().showBusy(this.i18nBundle.getResourceBundle().getText("ProductGroupPage.SaveBusyDialog"));var p=this.getProductGroupData();var d=this.createSavePayload(p);d.Rules=this.formatRulesForTheSameGroup(d.Rules.concat(p.HierarchyPayload.Rules));d.Filters=this.getProductGroupFilters()||[];M.createNewProductGroup(d).then(function(e){var r=e.data;t.oMessageManager.removeAllMessages();t.isAfterSave=true;t.getEventBus().publish("retail.pmr.promotionaloffers","afterPGSaved",{dataProductGroup:r});t.setProductGroupData(r,false);U.getErrorHandler().hideBusy();U.getErrorHandler().showToast(t.i18nBundle.getResourceBundle().getText("ProductGroupPage.ToastMessage.SaveCompleted"));},function(e){U.getErrorHandler().hideBusy();});},formatRulesForTheSameGroup:function(r){for(var i=0;i<r.length;i++){var n=i+1;r[i].GroupId=this.dataModel.getProperty("/Id");r[i].Number=n;}return r;},verifyValidation:function(){var t=[];if(this.basicDataController.validateForm()){t.push(this.i18nBundle.getResourceBundle().getText("ProductGroupPage.BasicData.Title"));}if(t.length){var d=this.i18nBundle.getResourceBundle().getText("CreateOffer.SaveOffer.Validate",t.join(", "));U.getErrorHandler().showError(d);return false;}return true;},setResolvers:function(r,d){this.resolve=r;this.cancel=d;},getCurrentMasteDataSystem:function(d){var t=this;M.getMasterDataSystems().then(function(S){if(S.length===0){t.contentModel.setProperty("/CurrentMasterDataSystem","");}S=S.map(function(i){if(i.Id===d){t.contentModel.setProperty("/CurrentMasterDataSystem",i.System||i.Description);}});});},mergePayloads:function(i,e){var t=jQuery.extend({},i);t.Rules=t.Rules.concat(e.Rules);return t;},getProductGroupData:function(){var d=this.defineInclusionsController.getProductGroupData();var e=this.defineExclusionsController.getProductGroupData();var h=this.mergePayloads(d.Payload,e.Payload);return{Basic:{Name:this.basicDataController.getProductGroupData().Name,Description:this.basicDataController.getProductGroupData().Description},Included:d.Included||[],Excluded:e.Excluded||[],HierarchyPayload:h,PreviewCriteria:this.previewController.getProductGroupData()};},getProductGroupFilters:function(){var p=this.defineInclusionsController.getPGFilters();return p;},setProductGroupData:function(p,i){this.productGroupData=jQuery.extend(true,{},p);this.oMessageManager.removeAllMessages();this.dataModel.setData(p);var n=p.Name||p.ExtNodeId||p.ExtHierarchyId||"";this.dataModel.setProperty("/Name",n);this.contentModel.setProperty("/ReadOnly",!!p.Display);this.contentModel.setProperty("/IsNew",i);this.contentModel.setProperty("/NavButtonsEnabled",!p.Display);this.basicDataController.setProductGroupData(p,i);this.defineInclusionsController.setProductGroupData(p,i);this.defineExclusionsController.setProductGroupData(p,i);this.previewController.setProductGroupData(p,true);this.getCurrentMasteDataSystem(p.MasterdataSystem);this.snapshot=jQuery.extend(true,{},this.getProductGroupData());},updateTablesData:function(d,i,e){if(e){return d;}if(i){d.Excluded=this.removeTheSameData(d.Excluded,d.Included);}else{d.Included=this.removeTheSameData(d.Included,d.Excluded);}return d;},removeTheSameData:function(r,k){if(k&&r){k.forEach(function(d){for(var i=0;i<r.length;i++){if(d.Id===r[i].Id){r.splice(i,1);}}});}return r;},triggerRefreshTables:function(d,e,f){var t=this;var p=this.getProductGroupData();var u=this.updateTablesData(p,f.isIncluded,f.isHierarchy);var g=this.createSavePayload(u,f.isPreviewAction);g.Rules=this.formatRulesForTheSameGroup(g.Rules.concat(p.HierarchyPayload.Rules));g.Filters=this.getProductGroupFilters()||[];if(!f.isPreviewAction){t.defineInclusionsController.setTableState(true,f.isHierarchy);t.defineExclusionsController.setTableState(true,f.isHierarchy);}if(f.isPreviewAction&&f.NodeId){g.NodeId=f.NodeId;}else{t.previewController.setTableState(true);}M.getProductsInPG(g).then(function(h){var r=h.data.data;if(f.isPreviewAction){if(f.NodeId){if(f.launchPopUp){t.previewController.launchProductDialog(r);}else{t.previewController.setPopUpData(r);}return;}t.previewController.setProductGroupData(r);jQuery.sap.delayedCall(300,t,function(){t.previewController.setTableState(false);});return;}t.defineInclusionsController.setProductGroupData(r);t.defineExclusionsController.setProductGroupData(r);t.previewController.setProductGroupData(r,true);jQuery.sap.delayedCall(300,t,function(){t.defineInclusionsController.setTableState(false,f.isHierarchy);t.defineExclusionsController.setTableState(false,f.isHierarchy);t.previewController.setTableState(false);});t.dataModel.setData(r);},function(){});},reselectCurrentActionTab:function(d,e,f){var t=this.byId("ObjectPageLayout");var g=t.getScrollingSectionId();if(f.indexSection){g=t.getSections()[f.indexSection].getId();}t.scrollToSection(g);},onMessagesIndicatorPress:function(e){m.openBy(e.getSource());},createSavePayload:function(p,i){this.rules=[];this.createRules(p.Included,true);this.createRules(p.Excluded,false);return{"Id":this.dataModel.getProperty("/Id"),"Skip":i?p.PreviewCriteria.Skip.toString():"0","Top":i?p.PreviewCriteria.Top.toString():"21","Search":p.PreviewCriteria.Search,"Name":p.Basic.Name,"Description":p.Basic.Description,"MasterdataSystem":this.dataModel.getProperty("/MasterdataSystem"),"Rules":this.rules,"Nodes":[],"Included":[],"Excluded":[],"Preview":[],"HierarchyPreview":[]};},createRules:function(p,d){for(var i=0;i<p.length;i++){var n=i+1;var r={"GroupId":"0","Number":n,"Sign":d?"I":"E","Dimension":"01","ReferenceId":p[i].Id};this.rules.push(r);}return this.rules;}});});
