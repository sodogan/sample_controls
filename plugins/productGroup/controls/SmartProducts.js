/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/m/FlexBox","sap/m/Input","sap/m/ComboBox","sap/m/Toolbar","sap/m/Button","sap/m/VBoxRenderer","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Utils","sap/ui/comp/smartvariants/PersonalizableInfo","sap/m/ToolbarSpacer","sap/ui/comp/smartvariants/SmartVariantManagement","sap/ui/model/Filter"],function(F,I,C,T,B,a,J,U,P,b,S,c){"use strict";var d=F.extend("retail.pmr.promotionaloffers.plugins.productGroup.controls.SmartProducts",{renderer:a.render,metadata:{properties:{itemProperty:{type:"string",defaultValue:null},persistencyKey:{type:"string",group:"Misc",defaultValue:null}},aggregations:{table:{type:"sap.m.Table",multiple:false}},events:{rebindTable:{}}},addToolbar:function(t){var o=t.getHeaderToolbar();o.insertContent(this.variantManagement,1);o.addContent(new B({icon:"sap-icon://action-settings",press:this.openPersonalizationDialog.bind(this)}));t.setHeaderToolbar(o);},onAfterRendering:function(){var e=this.getDomRef();jQuery("div.sapMFlexItem",e).first().css("width","100%");},setTable:function(t){if(!t){return;}this.setAggregation("table",t);this.oTable=t;this.addToolbar(t);this.aColumns=this.oTable.getColumns().map(function(e){return{columnKey:e.data("cellData"),visible:e.getVisible(),index:e.getOrder()};});this.aSortItems=[{keyField:"ExtId",operation:"Ascending"}];this.aFilters=[];this.addItem(t);},setPersistencyKey:function(v,i){this.setProperty("persistencyKey",v,i);var p=new P({type:"Control",keyName:"persistencyKey",dataSource:"TODO"});this._sOwnerId=U.getComponent().getId();p.setControl(this);if(this.variantManagement){this.variantManagement.addPersonalizableControl(p);this.variantManagement.initialise(this.initialiseVariantManagement,this);}},initialiseVariantManagement:function(){if(this.variantManagement&&!this.variantInitialized){this.variantInitialized=true;this.defaultCols=this.oTable.getColumns().map(function(e){return{columnKey:e.data("cellData"),text:e.getHeader().getText(),visible:e.getVisible(),index:e.getOrder()};});}},init:function(){this.standardSort=[];this.standardSort.push({keyField:"ExtId",operation:"Ascending"});F.prototype.init.apply(this,arguments);this.variantManagement=new S({});this.variantManagement.setShowShare(true);}});d.prototype.fetchVariant=function(){return{columns:this.aColumns,sortItems:this.aSortItems};};d.prototype.applyVariant=function(v){if(!v.columns){v.columns=this.defaultCols;}this.rebuildTable(v.columns,v.sortItems||this.standardSort);};d.prototype.openPersonalizationDialog=function(){var e=sap.ui.xmlfragment("retail.pmr.promotionaloffers.fragments.ProductsPers",this);var f=this.oTable.getColumns().map(function(g){return{columnKey:g.data("cellData"),text:g.getHeader().getText(),visible:g.getVisible(),index:g.getOrder()};});var p=new J({Fields:f,SortItems:this.aSortItems});e.setModel(U.getI18NModel(),"i18n");e.setModel(p);e.open();};d.prototype.closeProductFields=function(e){e.getSource().close();e.getSource().destroy();};d.prototype.okProductFields=function(e){var f=e.getParameter("payload").columns;var p=e.getSource();var s=p.getPanels()[1];var g=s._getConditions();this.closeProductFields(e);this.aSortItems=g;this.variantManagement.currentVariantSetModified(true);var h=[];var t=f.tableItems;var H=0;for(var i=0;i<t.length;i++){if(t[i].index==undefined){h.push(t[i]);}else if(t[i].index>H){H=t[i].index;}}if(h.length>0){for(i=0;i<h.length;i++){h[i].index=++H;}}this.rebuildTable(f.tableItems);};d.prototype.rebuildTable=function(e,v){this.aColumns=e||[];var f=this.oTable.getColumns();var t=[];this.oTable.removeAllColumns();for(var i=0,l=f.length;i<l;i++){for(var j=0,L=this.aColumns.length;j<L;j++){if(f[i].data("cellData")===this.aColumns[j].columnKey){f[i].setVisible(this.aColumns[j].visible);f[i].setOrder(this.aColumns[j].index);t.push(f[i]);break;}}}t.forEach(this.oTable.addColumn,this.oTable);var o=this.oTable.getBinding("items");if(v){this.aSortItems=v;}var s=[];(this.aSortItems||[]).forEach(function(g){var p=g.keyField;var D=g.operation==="Descending";s.push(new sap.ui.model.Sorter(p,D));});this.oTable.setGrowingThreshold(this.oTable.getItems().length);if(this.oTable._oGrowingDelegate){this.oTable._oGrowingDelegate.reset();}o.sort(s);this.oTable.setGrowingThreshold(20);this.fireRebindTable();};return d;});
