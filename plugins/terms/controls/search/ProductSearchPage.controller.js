/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","retail/pmr/promotionaloffers/utils/Models","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/utils/TreeValueHelpDialog","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/Component"],function(C,M,U,T,J,a){var P="01";var O={bt:function(){return"BT";},cp:function(){return"CP";},endswith:function(){return"CP";},startswith:function(){return"CP";},eq:function(){return"EQ";},nb:function(){return"NB";},ne:function(){return"NE";},np:function(){return"NP";},gt:function(){return"GT";},ge:function(){return"GE";},lt:function(){return"LT";},le:function(){return"LE";}};var g=function(t,c){function e(w){return(w||"").toUpperCase();}function r(){return"I";}function i(){return{"Id":c+1,"Attribute":t.sPath,"Sign":r(),"Option":O.eq(),"Low":e(t.oValue1)};}function k(){return{"Id":c+1,"Attribute":t.sPath,"Sign":"E","Option":O.eq(),"Low":e(t.oValue1)};}function l(){return{"Id":c+1,"Attribute":t.sPath,"Sign":r(),"Option":O.cp(),"Low":e("*"+t.oValue1+"*")};}function m(){return{"Id":c+1,"Attribute":t.sPath,"Sign":r(),"Option":O.bt(),"Low":e(t.oValue1),"High":e(t.oValue2)};}function n(){return{"Id":c+1,"Attribute":t.sPath,"Sign":r(),"Option":O.endswith(),"Low":e("*"+t.oValue1)};}function o(){return{"Id":c+1,"Attribute":t.sPath,"Sign":r(),"Option":O.startswith(),"Low":e(t.oValue1+"*")};}function p(){return{"Id":c+1,"Attribute":t.sPath,"Sign":r(),"Option":O.gt(),"Low":e(t.oValue1)};}function q(){return{"Id":c+1,"Attribute":t.sPath,"Sign":r(),"Option":O.ge(),"Low":e(t.oValue1)};}function s(){return{"Id":c+1,"Attribute":t.sPath,"Sign":r(),"Option":O.lt(),"Low":e(t.oValue1)};}function u(){return{"Id":c+1,"Attribute":t.sPath,"Sign":r(),"Option":O.le(),"Low":e(t.oValue1)};}var v={"EQ":i,"Contains":l,"BT":m,"EndsWith":n,"StartsWith":o,"GT":p,"GE":q,"LT":s,"LE":u,"NE":k};return v[t.sOperator]();};var b=function(c,e,k){if(c.aFilters){for(var i=0;i<c.aFilters.length;i++){b(c.aFilters[i],e++,k);}}else{k.push(g(c,e));}};function h(s,c){s.setValueState("None");c.setValueState("None");if(!c.getValue().length&&s.getValue().length){c.setValueState("Error");}else if(c.getValue().length&&!s.getValue().length){s.setValueState("Error");}}function d(c){var e=c.filter(function(i){return i.Attribute==="TERM";});return!!e.length;}function f(c){var m=c.table.metaProperties;for(var i=0,l=m.length;i<l;i++){if(m[i].property==="Vendor"){m[i].label="{i18n>Terms.Advanced.Product.Source}";}}var t=c;this.termObjectsCall=function(s,e,k,n){return M.searchTermsObjects(s,e,k,n,d(k)).then(function(o){t.table.setMaxCount(o.Total);var p=o.TermObjects;var q=t.data.getProperty("/TermObjects/results");if(p&&p.results){p.results.forEach(function(r){r.isLoadingVisible=n;});}if(q&&p){q.splice(q.length-1,1);p.results=q.concat(p.results);}if(p.results.length<o.Total){p.results.push({});}t.data.setData({TermObjects:p});t.selectAllProducts();t.table.setBusy(false);});};this.pricesCall=function(s,e,k,w){return M.searchTermsObjects(s,e,k,false,d(k)).then(function(p){return(w||Promise.resolve()).then(function(){return p;});}).then(function(n){var o=t.data.getProperty("/TermObjects/results")||[];var p=U.get(n,["TermObjects","results"])||[];o.forEach(function(q){var r=p.filter(function(v){return v.ProductId===q.ProductId;});if(r.length){var u=r[0];q.ProductDetail.Currency=u.ProductDetail.Currency;q.ProductDetail.PurchasePrice=u.ProductDetail.PurchasePrice;q.ProductDetail.RetailPrice=u.ProductDetail.RetailPrice;q.ProductDetail.RetailPriceWithVAT=u.ProductDetail.RetailPriceWithVAT;q.ProductDetail.SalesUom=u.ProductDetail.SalesUom;}q.isLoadingVisible=false;});t.data.setProperty("/TermObjects/results",o);t.selectAllProducts();});};}function j(c){var e=new f(c);var i=true;this.getMore=function(s,t,k){var l=e.termObjectsCall(s,t,k,i);e.pricesCall(s,t,k,l);return l;};}function S(c){var e=new f(c);var i=false;this.getMore=function(s,t,k){return e.termObjectsCall(s,t,k,i);};}return C.extend("retail.pmr.promotionaloffers.plugins.terms.controls.search.ProductSearchPage",{constructor:function(){this.data=new J();this.data.setDefaultBindingMode("OneWay");this.contentModel=new J();this.oConfig=a.getMetadata().getConfig();},onInit:function(F,m,c,i,r,e,k,s){this.oFragment=F;this.dimension=c||P;this.masterdataSystem=m;this.resolve=r;this.reject=e;this.state=U.getComponent().getState();this.oFragment.setModel(this.data,"Data");var D=M.getServiceModel();this.oFragment.setModel(D);this.oFragment.setModel(U.getI18NModel(),"i18n");this.oFragment.setModel(this.contentModel,"Content");this.contentModel.setProperty("/ShowOkButton",k?true:false);this.contentModel.setProperty("/HideTypeFilter",(c==="11"||c==="12")?false:true);this.multiSelect=k;this.selectedProducts=s;this.table=sap.ui.getCore().byId("productSearchTable");this.filterBar=sap.ui.getCore().byId("productSearchSmartFilterBar");this.table.setMode(k?"MultiSelect":"SingleSelectMaster");var t=U.getI18NModel().getResourceBundle().getText(i);var H=this.getHierarchyFilterInput();H.setBusy(true);M.getLeadingCategoriesSet(this.masterdataSystem).then(function(){H.setBusy(false);});if(typeof t==="string"){this.oFragment.setTitle(t);}this.priceFieldsNames=[];var l=this.oConfig.productSearchMultipleCalls;this.getMoreHandler=l?new j(this):new S(this);this.oFragment.open();},onInitialise:function(e){var c=e.getSource()._aFields;for(var i=0,l=c.length;i<l;i++){if(c[i]["sap:unit"]==="Currency"){this.priceFieldsNames.push(c[i].fieldName);this.filterBar.getControlByKey(c[i].fieldName).attachChange(this.handlePriceChange.bind(this));}if(c[i].fieldName.indexOf("AT_00000_"+this.masterdataSystem)===-1&&c[i].fieldName.indexOf("AT_00001_"+this.masterdataSystem)===-1&&c[i].fieldName.indexOf("AT_"+this.masterdataSystem)===-1&&c[i].fieldName.indexOf("AT_")===0){c[i].visible=false;c[i].isVisible=false;c[i].visibleInAdvancedArea=false;c[i].preventInitialDataFetchInValueHelpDialog=false;}}if(this.filterBar.getControlByKey("NetWeight")){this.filterBar.getControlByKey("NetWeight").attachChange(this.onNetWeightChanged.bind(this));}if(this.filterBar.getControlByKey("NetWeightUom")){this.filterBar.getControlByKey("NetWeightUom").attachChange(this.onNetWeightUomChanged.bind(this));}if(this.filterBar.getControlByKey("Currency")){this.filterBar.getControlByKey("Currency").attachChange(this.handlePriceChange.bind(this));}},onNetWeightChanged:function(e){var c=this.filterBar.getControlByKey("NetWeightUom");this.filterBar.addFieldToAdvancedArea("NetWeightUom");var s=e.getSource();h(c,s);},onNetWeightUomChanged:function(e){var c=this.filterBar.getControlByKey("NetWeight");this.filterBar.addFieldToAdvancedArea("NetWeight");var s=e.getSource();h(c,s);},handlePriceChange:function(e){var i=0;var k=this.filterBar.getControlByKey("Currency");function s(m,v){m.forEach(function(c){c.setValueState(v);});}var l=this.priceFieldsNames.map(function(n){var c=this.filterBar.getControlByKey(n);if(c.getValue().length){i++;}return c;}.bind(this));s(l,"None");k.setValueState("None");if(i>1||(!i&&k.getValue().length)){s(l,"Error");}if(i>0&&!k.getValue().length){this.filterBar.addFieldToAdvancedArea("Currency");k.setValueState("Error");}if(i===0&&k.getValue().length){k.setValueState("Error");}},onShowAttributePressed:function(e){var s=e.getSource();var p=s.getParent().getBindingContext("Data").getPath();var m=this.oFragment.getModel();var c=this.table.getModel("Data").getProperty(p).ProductDetail;var i="/TermObjects(Id=binary'"+U.base64ToHex(c.Id)+"',Dimension='"+c.Dimension+"')";var D=sap.ui.xmlfragment("retail.pmr.promotionaloffers.fragments.ShowAttributesDialog",{onClose:function(e){e.getSource().getParent().close();},formatValue:function(v,k){if(k){return k+" ("+v+")";}return v;},formatLabel:function(l){return l+":";}});D.setModel(U.getI18NModel(),"i18n");D.setModel(m);D.bindElement(i);D.open();},onCancelPress:function(){this.oFragment.close();},onClose:function(){this.reject();this.oFragment.destroy();},onOkPress:function(e){this.resolve(this.selectedProducts);this.oFragment.close();},onSelectRow:function(e){var t=this;var s=e.getSource().getSelectedItems();this.selectedProducts=[];this.selectedProducts=this.selectedProducts.concat(this.existingProductsUnchecked);if(s){s.forEach(function(c){var i=c.getBindingContext("Data").getObject();t.selectedProducts.push(i);});}if(!this.multiSelect){var o=e.getSource().getSelectedItem();var i=o.getBindingContext("Data").getObject();this.resolve(i.Id);this.oFragment.close();}},selectAllProducts:function(){var t=this;this.existingProductsUnchecked=[];if(this.selectedProducts){this.selectedProducts.forEach(function(e){t.selectProduct(e);});}},selectProduct:function(e){var c=this.table.getItems();for(var i=0;i<c.length;i++){var p=c[i].getBindingContext("Data").getObject();if(p.Id===e.Id){this.table.setSelectedItem(c[i]);break;}if(i===c.length-1){this.existingProductsUnchecked.push(e);}}},onUpdateStarted:function(e){var r=e.getParameter("reason");var s=e.getParameter("actual");if(this.aFilters&&r==="Growing"){var G=this.table.getGrowingThreshold();this.getMore(s,G,this.aFilters,true);}},searchFunction:function(e){var i=0;var D="100";var p="";var c=[];p=this.filterBar.getControlByKey("PageSize").getValue();if(p===""||parseInt(p,10)<=0){p=D;this.filterBar.getControlByKey("PageSize").setValue(p);}this.table.setGrowingThreshold(parseInt(p,10));this.table.removeSelections(true);if(this.filterBar.getFilters().length){b(this.filterBar.getFilters()[0],i,c);}this.addHierarchyNodeFilters(c);this.fetchData(c);},getExtraFilters:function(c){return c;},fetchData:function(c){if(!c){c=[];}var e=[{"Id":c.length+1,"Attribute":"PROD_DIM_TCD","Sign":"I","Option":"EQ","Low":this.dimension},{"Id":c.length+2,"Attribute":"MD_SYSTEM_REF","Sign":"I","Option":"EQ","Low":this.masterdataSystem}];var s=0;var t=this.table.getGrowingThreshold();var i=c.concat(e);this.getMore(s,t,this.getExtraFilters(i),false);},getMore:function(s,t,c,e){if(!e){this.table.resetGrowing();this.data.setProperty("/TermObjects/results",[]);this.aFilters=c;}var i=this;i.table.setBusy(true);this.getMoreHandler.getMore(s,t,c).then(function(){i.table.setBusy(false);},function(k){i.table.setBusy(false);});},handleHierarchyComplexSearch:function(){var u=function(i,e){var k=U.getItemIndexInArray(i.Id||i,e);if(k!==-1){e.splice(k,1);}else{e.push(i);}return e;};var c=function(t){var i=t.map(function(e){return e.getCustomData()[0].getValue();});return i;};var l=M.getLeadingCategoriesSet(this.masterdataSystem);l.then(function(L){var i=sap.ui.getCore().byId("hierarchyNodeFilter");var t=i.getTokens()||[];var k=c(t);T.openDialog({tableFragment:"retail.pmr.promotionaloffers.plugins.general.LeadingCategoryComplexSearch",title:"{i18n>productHierarchy.Title}",filterProps:["ExtId","Name","HierarchyDescription","ExtHierarchyId"],values:U.buildHierarchy(L,"LeadingCategory"),multiselect:true,styleClass:"sapUiSizeCompact",tokens:t,selectionChange:function(e){var m=e.getSource().getTable();var p=e.getParameter("tableSelectionParams");p.rowIndices.forEach(function(n){var o=m.getContextByIndex(n);if(o){var q=o.getObject();q.currentPath=o.getPath();u(q,k);}});return k;},tokenRemove:function(e){if(!e){k=[];return;}var m=e.getParameters().tokenKeys;m.forEach(function(n){u(n,k);});},ok:function(e){t=k.map(U.createTokenForHierarchy);i.setTokens(t);e.getSource().close();}});});},onHierarchyTokensChange:function(e){var c=this.getHierarchyFilterInput();var t=c.getTokens();c.removeAllCustomData();if(t&&t.length>0){c.addCustomData(new sap.ui.core.CustomData({key:"hasValue",value:true}));}c.fireChangeEvent();},getHierarchyFilterInput:function(){return sap.ui.getCore().byId("hierarchyNodeFilter");},beforeVariantSave:function(e){var c=this.getHierarchyFilterInput();var i=c.getTokens();var k=this.getHierarchiesSelected(i);var o=jQuery.extend(true,{},this.filterBar.getFilterData());o._CUSTOM={"hierarchyFilterSelections":k};this.filterBar.setFilterData(o,true);},afterVariantLoad:function(e){var c=this.getHierarchyFilterInput();var D=this.filterBar.getFilterData();var o=D["_CUSTOM"];c.removeAllTokens();if(o&&o.hierarchyFilterSelections){var i=o.hierarchyFilterSelections.map(function(k){return U.createTokenForHierarchy(k);});if(i.length>0){c.setTokens(i);}}},getHierarchiesSelected:function(c){return c.map(function(t){return jQuery.extend(true,{},t.getCustomData()[0].getValue());});},addHierarchyNodeFilters:function(c){var e=sap.ui.getCore().byId("hierarchyNodeFilter");if(e){var t=e.getTokens();if(t&&t.length>0){t.forEach(function(i){var k={"Id":c.length+1,"Attribute":"HierarchyNode","Sign":"I","Option":"EQ","Low":i.getCustomData()[0].getValue().ExtId,"High":i.getCustomData()[0].getValue().HierarchyId};c.push(k);});}}}});});
