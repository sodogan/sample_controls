/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","retail/pmr/promotionaloffers/utils/Models","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/utils/OfferOperations","retail/pmr/promotionaloffers/utils/Formatter","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/view/CommunicationProcessor","retail/pmr/promotionaloffers/view/CommunicationProcessorWrapper","retail/pmr/promotionaloffers/view/CommunicationServices","sap/ui/core/routing/History","retail/pmr/promotionaloffers/utils/ForecastDialog"],function(C,M,U,O,F,J,a,W,b,H,c){"use strict";var E=U.getErrorHandler().createMessagePopover();var h=(function(){var e=false;return{changes:e};}());function d(m){this.getOfferData=function(){if(!m){return{};}var e=m.generalController.getOfferData();var v=m.vendorFundsController.getOfferData();var t=m.termsController.getOfferData();var i=m.attributesController.getOfferData();var n=m.versionsController.getOfferData();var p={};jQuery.extend(p,e,t,v,i,n);p=m.cleanPaylodForSave(p);p.Financials=[{Id:""}];if(m.extHookOngetOfferData){p=m.extHookOngetOfferData(p);}return p;};this.getOfferWithFinancials=function(){if(!m){return{};}var p={};var e=this.getOfferData();var i=m.termsController.getFinancials();var t=m.termsController.getTermsProductsFinancials();jQuery.extend(p,e,{Financials:i},t);return p;};}function s(e,i){if(i&&e){return false;}return true;}function f(m){var e=U.getErrorHandler();if(e.numOfErrors()>0){e.showError(m);}}function g(o){var e=o.loader;var i=e.getOfferData();o.controller.isForSave=true;o.controller.removeFinancial=true;o.state="Warning";o.controller.isForSave=false;var m=e.hasChanges();if(h.changes){m=true;}if(i&&s(m,!i.Readonly)){return Promise.resolve();}function n(r){r();}function p(r,q){o.controller.cleanIdsFromTerms=true;q();}return U.createDialogUtil(jQuery.extend(o,{onOk:n,onCancel:p}));}function j(o){function e(r){r();}function i(r,m){m();}return U.createDialogUtil(jQuery.extend(o,{onOk:e,onCancel:i}));}function k(v,i){return v.byId(i).getController();}var l=C.extend("retail.pmr.promotionaloffers.view.MainPageTabs",{extHookOndataLoaded:null,extHookOngetOfferData:null,extHookOnvalidate:null,constructor:function(){this.dataModel=new J();this.featuresAvailable=new J();this.contentModel=new J({CollisionEnabled:false});},routeMatched:function(e){if(!this.state){return;}var i=H.getInstance();var m=i.aHistory[i.aHistory.length-1];this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","onMasterDataSystemChange",this.masterDataSystemChange,this);this.pathName=e.getParameter("name");this.state.validate();this.cleanIdsFromTerms=false;if(["create","edit","copy","vendorFundsCreate","display"].indexOf(this.pathName)===-1){return;}if(m.indexOf("productGroup")!==-1){this.generalController.validateForm();this.termsController.validateForm();this.attributesController.validateForm();return;}this.isBackFromVersions=false;if(this.pathName==="create"||this.pathName==="vendorFundsCreate"){this.resetViewsContent();this.state.invalidate();this.getEventBus().subscribe("retail.pmr.promotionaloffers","onMasterDataSystemChange",this.masterDataSystemChange,this);var o=this.getView().byId("ObjectPageLayout");var n=o.getSections()[0];this.getView().byId("ObjectPageLayout").scrollToSection(n.getId());if(this.pathName==="create"){var p=this.generalController.getView().byId("generalName");p.addEventDelegate({onAfterRendering:function(){p.focus();}});}}else{this.getView().byId("versions").setVisible(true);}if(["create","edit","copy","vendorFundsCreate"].indexOf(this.pathName)===-1){this.toggleCollisionBtnListener(false);}else{this.toggleCollisionBtnListener(true);}var q=i.getPreviousHash()||"";if(this.pathName==="edit"&&q==="create"){q="";}var r=false;if(this.pathName==="display"||this.pathName==="edit"||this.pathName==="create"||this.pathName==="vendorFundsCreate"||this.pathName==="copy"||this.pathName==="locationGroups"){r=true;}if(q.indexOf("version")<0&&q.indexOf("locationGroups")<0){if(this.pathName==="edit"||this.pathName==="copy"||this.pathName==="display"){this.state.invalidate();}}else{this.isBackFromVersions=true;r=q.indexOf("locationGroups")>=0;}var t=q.indexOf("create")>-1||q.indexOf("copy")>-1||q.indexOf("vendor-funds")>-1;if(t&&this.pathName==="edit"){this.state.storeValid();this.state.validate();}this.startLoading(this.state,r);this.state.restoreValid();},toggleCollisionBtnListener:function(e){if(e){if(!this.toggleCollisionBtnListenerOn){this.getEventBus().subscribe("retail.pmr.promotionaloffers","toggleCollisionBtn",this.toggleCollisionBtn,this);this.toggleCollisionBtnListenerOn=true;}}else{this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","toggleCollisionBtn",this.toggleCollisionBtn,this);this.toggleCollisionBtnListenerOn=false;}},onInit:function(){this.generalController=k(this,"generalView");this.termsController=k(this,"termsView");this.vendorFundsController=k(this,"vendorFundsView");this.attributesController=k(this,"attributesView");this.versionsController=k(this,"versionsView");var t=this;this.versionsController.setSaveCallback(function(){U.manageVersionsSaveDialog(t.getView()).then(function(){t.onSave(null,true).then(function(e){if(e){t.getEventBus().publish("retail.pmr.promotionaloffers","launchVersionPage",{oData:t.state.getOfferData()});}});},jQuery.noop);});this.termsController.setGeneralDataModel({getDataModel:function(){return this.generalController.dataModel;}.bind(this)});this.oMessageManager=U.getMessageManager();E.setModel(this.oMessageManager.getMessageModel());this.getView().setModel(this.dataModel);this.getView().setModel(this.featuresAvailable,"featuresAvailable");this.getView().setModel(this.contentModel,"Content");this.getEventBus().subscribe("retail.pmr.promotionaloffers","validateOfferForVersion",this.validateOfferForVersion,this);this.getEventBus().subscribe("retail.pmr.promotionaloffers","resetTermsTab",this.resetTermsTab,this);this.getEventBus().subscribe("retail.pmr.promotionaloffers","setLocationSelection",this.setLocationSelection,this);this.getEventBus().subscribe("retail.pmr.promotionaloffers","onVersionDataChange",this.versionDataChange,this);this.state=this.getOwnerComponent().getState();this.toggleCollisionBtnListenerOn=false;this.getRouter().attachRouteMatched(this.routeMatched,this);U.addMasterdataSystemButton(this.getEventBus());this.aFinHeaderFields=["marginField","unitField","salesField","profitField","fundField","forecastField"].map(function(x){return this.getView().byId(x);},this);this.aForecastHeaderFields=["forecastField"].map(function(x){return this.getView().byId(x);},this);this.offerOperations=new O(this.state);},resetTermsTab:function(){this.termsController.resetOfferData();var e=this.termsController.getSelectedTermStyle();var i=this.generalController.isPackageOffer();this.versionsController.resetTermsTab(e,i);},onExit:function(){this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","onMasterDataSystemChange",this.masterDataSystemChange,this);this.toggleCollisionBtnListener(false);this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","validateOfferForVersion",this.validateOfferForVersion,this);this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","resetTermsTab",this.resetTermsTab,this);this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","setLocationSelection",this.setLocationSelection,this);this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","onVersionDataChange",this.versionDataChange,this);},cleanPaylodForSave:function(e){var p=jQuery.extend(true,{},e);if(!this.isForSave){return p;}if(p.Versions){for(var i=0;i<p.Versions.length;i++){var v=p.Versions[i];delete v.LocalNodes;delete v.locationPath;if(this.removeFinancial){U.cleanFinancialsForVersion(v);}else{U.cleanFinancialsForVersion(v,true);}}}if(this.removeFinancial){U.cleanFinancialsForVersion(p);delete p.PurchasingGroupName;}else{U.cleanFinancialsForVersion(p,true);}this.removeFinancial=false;if(this.cleanIdsFromTerms){this.removeAfterFinancialCalc(p);this.cleanIdsFromTerms=false;}if(!p.PackageOffer){delete p.PackageValue;}this.storeLocationHierarchy=p.LocationHierarchy;p.LocationHierarchy=[{Locations:[{}]}];this.isForSave=false;return p;},showForecast:function(e){var i=this.getView().getModel().getProperty("/OfferId");var K={OfferId:i};c.show(c.Level.Offer,K,M.getServiceModel(),U.getResourceModel());},openCancelDialog:function(){var e={loader:this.state,controller:this,view:this.getView(),title:"{i18n>CreateOffer.OfferCancelDialogTitle}",message:"{i18n>CreateOffer.OfferCancelDialogDescription}",btnOk:"{i18n>CreateOffer.CreateOfferDialog.Accept}",btnCancel:"{i18n>CreateOffer.CreateOfferDialog.Reject}"};var t=this;return g(e,this.getView().getModel("i18n").getResourceBundle()).then(function(){var i=H.getInstance().getPreviousHash();if(i){window.history.go(-1);}else{t.getRouter().navTo("manage",true);}t.oMessageManager.removeAllMessages();t.state.storeLocationSubgroups([]);},U.identity);},onCollisionDetection:function(){var p=jQuery.extend(true,{},this.state.getSavePayload());this.isForSave=true;this.removeFinancial=true;p=this.cleanPaylodForSave(p);this.oMessageManager.removeAllMessages();U.getErrorHandler().showBusy();var v=this.getView();var e=this.getView().getModel("i18n").getResourceBundle().getText("CreateOffer.ErrorMessage.Collision");this.offerOperations.detectCollision().then(function(i){this.offerOperations.populateCollisionDetection(i,p,v).then(function(){U.getErrorHandler().hideBusy();f(e);this.contentModel.setProperty("/CollisionEnabled",true);}.bind(this));}.bind(this));},onOfferContent:function(){var i=this.state.getOfferData().OfferId;U.toOfferContent(i,this.getOwnerComponent().getMetadata().getConfig());},onSave:function(o,u){var i=true;if(!this.verifyValidation("{i18n>CreateOffer.SaveOffer.Title}",i)){return;}this.oMessageManager.removeAllMessages();this.isForSave=true;this.removeFinancial=true;var B=this.getView().getModel("i18n").getResourceBundle();var t=this;return this.state.save().then(function(r){U.getErrorHandler().showToast(B.getText("CreateOffer.ToastMessage.SaveCompleted"));var n=false;var e=r.data;if(!u){t.startLoading(t.state,true).then(function(){t.isForSave=false;t.state.processor.storeSnapshot(t.state.processor.createSavePayload());});}else{t.dataRoute=e;}if(U.isReadOnly({Status:e.Status,UIState:e.UIState})){t.getRouter().navTo("display",{path:U.base64ToHex(r.data.OfferId)},true);n=true;}else if(!t.dataModel.getProperty("/ExtOfferId")){t.state.storeBack(true);U.navToEditOffer(t.getRouter(),t.state.getOfferData(),true);n=true;}return{data:e,navigate:n};},function(e){if(e.responseText.indexOf("Marketing area ID")>=0){t.generalController.resetMarketingArea();}U.getErrorHandler().showError(B.getText("CreateOffer.ErrorMessage.Save"));}).then(null,function(e){jQuery.sap.log.error(e);});},verifyValidation:function(t,i){var e=[];var m=this.getView().getModel("i18n").getResourceBundle();if(this.generalController.validateForm()){e.push(m.getText("CreateOffer.Properties.Title"));}if(this.termsController.validateForm()){e.push(m.getText("CreateOffer.Terms.Title"));}if(this.attributesController.validateForm()){e.push(m.getText("CreateOffer.Attributes.Title"));}if(this.extHookOnvalidate){e=e.concat(this.extHookOnvalidate());}var n=i?U.getMessageManager().getMessageModel().getData().filter(function(p){return p.getType()==="Error"&&!p.persistent;}):[];if(e.length||n.length>0){var o=e.length?m.getText("CreateOffer.SaveOffer.Validate",e.join(", ")):m.getText("Offer.Save.UserAction.Needed");U.getErrorHandler().showError(o);return false;}return true;},onCancel:function(){this.state.storeBack(true);this.openCancelDialog().then(function(){this.state.storeBack(false);}.bind(this));},onNavButtonPress:function(){this.openCancelDialog();},onMessagesIndicatorPress:function(e){E.openBy(e.getSource());},dialogOptions:function(e){return{view:this.getView(),loader:e,title:"{i18n>EditOffer.EditOfferDialog.Title}",message:"{i18n>EditOffer.EditOfferDialog.Message}",btnOk:"{i18n>CreateOffer.CreateOfferDialog.Accept}",btnCancel:"{i18n>CreateOffer.CreateOfferDialog.Reject}"};},masterDataSystemChange:function(e,m,n){var t=this;var o=n.MasterdataSystemId;var p=this.dataModel.getProperty("/MasterdataSystem");var q=function q(){var i,L;var u=t.state.getSavePayload();var v=["LocationNodeId","PromotionType","LeadingCategory","PurchasingGroup"];for(i=0,L=v.length;i<L;i++){if(u.hasOwnProperty(v[i])){return true;}}var w=u.Terms;for(i=0,L=w.length;i<L;i++){if(w[i].ProductId){return true;}}return false;};var r=function r(){return U.promptUserForMasterDataSystemChange(o,p,t.getView().getModel("i18n"));};if(q()){return r().then(function(){t.generalController.setSystem(o);M.setMasterDataSystemPersonalization(o);t.state.offerData.MasterdataSystem=o;},function(){t.generalController.resetSystem(p);});}else{setTimeout(function(){t.generalController.setSystem(o);M.setMasterDataSystemPersonalization(o);t.state.offerData.MasterdataSystem=o;});}},toggleCollisionBtn:function(){var G=this.generalController.getOfferData();var t=this.termsController.getOfferData();var e=["LocationNodeId","StartOfOffer","EndOfOffer"].every(function(p){return!!G[p];})&&t.Terms.some(function(i){return i.ProductId||i.HierarchyNodeId||i.DimensionType==="20";});this.contentModel.setProperty("/CollisionEnabled",e);},versionDataChange:function(e,i,m){this.keepSnapshot=true;},loadDataComingFromVersion:function(o){var e={};jQuery.extend(true,e,this.state.getOfferData(),o);e.Versions=o.Versions;e.LocalNodes=o.LocalNodes;this.isBackFromVersions=true;this.setOfferData(e,this.state);},startLoading:function(e,i){return e.load(function(){this.state.storeBack(false);this.dataLoaded(e,i);this.toggleCollisionBtn();}.bind(this)).then(null,function(m){jQuery.sap.log.error(m.stack);var n=this.contentModel.getProperty("/NavButtonsEnabled");this.contentModel.setProperty("/ShowFooter",n||U.errorMessagesExists());}.bind(this));},dataLoaded:function(e,i){var o=e.getOfferData();if(this.keepSnapshot){this.state.store(o,!!o.Readonly);}else if(this.pathName==="display"){this.state.store(o,{Readonly:true});}else{this.state.store(o,{Readonly:false});}var m=e.getOfferData();m=this.cleanPaylodForSave(m);this.setOfferData(m,e,i);},onLoadingPage:function(i,e,m){if(m){return;}var o=U.getErrorHandler();if(i){if(e){var n=U.getResourceModel().getResourceBundle().getText("CreateOffer.LoadingForecast.Message");o.showBusy(n);}else{o.showBusy();}}else{if(e){o.hideBusy();}else{jQuery.sap.delayedCall(300,this,function(){o.hideBusy();});}}},setOfferData:function(o,e,i){this.onLoadingPage(true,false,i);var m=e.getStaticData();this.staticData=m;if(o.MasterdataSystem&&m.MasterDataSystemSet.length===0){U.criticalError(U.getI18NModel(),"Missing Masterdata System","Check that user can get a list of masterdata systems from backend.","Call '/MasterdataSystems' and check it has values");}this.contentModel.setData({Editable:!o.Readonly&&!U.isEditableHeader({Status:o.Status,UIState:o.UIState}),CollisionEnabled:false,NavButtonsEnabled:!o.Readonly,ShowFooter:!o.Readonly||U.errorMessagesExists()});this.dataModel.setData(o);var r=U.setupFeatures(m.FeaturesAvailable);this.featuresAvailable.setData(r);this.featuresAvailable.refresh(true);var n=this.featuresAvailable.getData();this.generalController.setOfferData(o,m,n);this.generalController.setDataProvider(e);this.termsController.setRouter(this.getRouter());this.termsController.setOfferData(o,m);this.attributesController.setOfferData(o,m);this.vendorFundsController.setDataProvider(e);this.vendorFundsController.setOfferData(o,m);this.versionsController.setDataProvider(e);this.versionsController.setOfferData(o);if(this.extHookOndataLoaded){this.extHookOndataLoaded(e,o);}this.onLoadingPage(false,false,i);var p={Status:o.Status,UIState:o.UIState};if((!o.Editable||U.isStatusApprovedSaved(!this.isBackFromVersions,p))&&this.pathName==="edit"){var q="{i18n>ManageOffers.offerNotEditable}";if(U.isStatusApprovedSaved(!this.isBackFromVersions,p)){q="{i18n>ManageOffers.offerNotEditableIsApproved}";}var t=this;U.createDialogUtil({title:"{i18n>ManageOffers.OfferFunctionsErrorDialog.Title}",btnOk:"{i18n>Offer.OK}",message:q,state:"Error",view:this.getView(),onOk:function(u){u();}}).then(function(){t.getRouter().navTo("display",{path:U.base64ToHex(o.OfferId||o.RefOfferId)},true);});}if(i&&this.keepSnapshot){this.keepSnapshot=false;}if(this.pathName==="edit"){this.state.createSnapshot();}},getIndexOfTerm:function(t,e){var m=-1;if(e&&e.length>0){for(var i=0;i<e.length;i++){if(e.TermId&&e.TermId===t){m=i;}}}return m;},updateSnapshotTermProducts:function(e,o){var t=this;for(var i in e){if(i!=="Terms"){e[i]=o[i];}else if(i==="Terms"){var n=e[i];var m=o[i];if(m&&n&&m.length!==n.length){continue;}(n||[]).forEach(function(p){var q=t.getIndexOfTerm(p.TermId,m);if(q!==-1){var r=m[q];for(var u in p){if(u!=="TermProducts"){p[u]=r[u];}}}});}}},removeAfterFinancialCalc:function(p){if(p){(p.Terms||[]).forEach(function(t){delete t.OfferId;delete t.TermId;});}},getEventBus:function(){return sap.ui.getCore().getEventBus();},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this);},resetViewsContent:function(){this.generalController.resetOfferData();this.vendorFundsController.resetView();this.versionsController.resetData();this.attributesController.resetAttributes();this.featuresAvailable.setData({});this.storeLocationHierarchy=null;},setServiceErrors:function(m){var n=m.filter(function(i){if(i.type==="Info"){i.type="Information";}return!i.target;});var G=m.filter(function(i){return i.target&&i.target.indexOf("OfferTerm")===-1&&i.target.indexOf("Attributes")===-1;});var t=m.filter(function(i){return i.target&&i.target.indexOf("OfferTerm")>=0;});var A=m.filter(function(i){return i.target&&i.target.indexOf("Attributes")>=0;});this.generalController.processServerErrors(G);this.termsController.processServerErrors(t);this.attributesController.processServerErrors(A);this.setErrorMessages(n);this.oMessageManager.getMessageModel().refresh();},setErrorMessages:function(m){var e=new J();var i=m.map(function(I){I.processor=e;if(I.type==="Info"){I.type="Information";}return new sap.ui.core.message.Message(I);});this.oMessageManager.addMessages(i);},handleCalcFinancialsPress:function(){h.changes=this.state.hasChanges();if(!this.verifyValidation("{i18n>CreateOffer.SaveOffer.Title}",false)){return;}var e=this.getView().getModel("i18n").getResourceBundle().getText("CreateOffer.ErrorMessage.Calculate");var p=jQuery.extend(true,{},this.state.getSavePayload());this.isForSave=true;this.removeFinancial=true;p=this.cleanPaylodForSave(p);this.oMessageManager.removeAllMessages();this.offerOperations.calculateFinancials(this.aFinHeaderFields,p).then(function(r){f(e);if(r){if(!this.dataModel.getProperty("/ExtOfferId")){r.OfferId="";}r.ChangedOn=this.dataModel.getProperty("/ChangedOn");this.dataModel.setData(this.restoreLocationAfterForecast(r));(r.Versions||[]).forEach(function(v){if(!v.ExtOfferId){v.OfferId="";}});this.setOfferData(r,this.state);}}.bind(this));},onForecastPress:function(){var B=this.getView().getModel("i18n").getResourceBundle();var i={loader:this.state,view:this.getView(),title:"{i18n>CreateOffer.ForecastTitle}",message:"{i18n>CreateOffer.OfferForecastDialogDescription}",state:"Warning",btnOk:"{i18n>CreateOffer.CreateOfferDialog.Accept}",btnCancel:"{i18n>CreateOffer.CreateOfferDialog.Reject}"};var m=function(e){this.onLoadingPage(false);this.offerOperations.setHeaderFieldsBusyState(false,this.aForecastHeaderFields);U.identity(e);}.bind(this);j(i).then(function(){var e=true;if(!this.verifyValidation("{i18n>CreateOffer.SaveOffer.Title}",e)){return;}this.isForSave=true;this.removeFinancial=true;this.oMessageManager.removeAllMessages();this.onLoadingPage(true,true);this.offerOperations.getForecast(this.aForecastHeaderFields).then(function(r){f(B.getText("CreateOffer.ErrorMessage.Forecast"));if(r){this.state.store(this.restoreLocationAfterForecast(r));this.state.storeBack(true);this.startLoading(this.state,true);if(!this.dataModel.getProperty("/ExtOfferId")||this.pathName!=="edit"){this.state.storeBack(true);U.navToEditOffer(this.getRouter(),this.state.getOfferData(),true);}}this.onLoadingPage(false,true);}.bind(this));}.bind(this),m);},setLocationSelection:function(e,i,m){if(m.hierarchy){this.selectedLocationHierarchy=U.buildLocationHierarchyFromVH(m.hierarchy);}},restoreLocationAfterForecast:function(r){if(!r.LocationHierarchy||(r.LocationHierarchy&&r.LocationHierarchy.length<1)||(r.LocationHierarchy&&r.LocationHierarchy.length>0&&!r.LocationHierarchy[0].Cardinality&&r.LocationHierarchy[0].Locations&&r.LocationHierarchy[0].Locations.length<1)){var e=this.selectedLocationHierarchy;if(this.storeLocationHierarchy&&this.storeLocationHierarchy.length>0&&this.storeLocationHierarchy[0].Cardinality){e=this.storeLocationHierarchy;}r.LocationHierarchy=e;}return r;},onOfferFunctionPress:function(e){this.oMessageManager.removeAllMessages();var A=e.getSource().data("area");var o=this.state.getOfferData();if(!this.oSelectDialog){this.oSelectDialog=sap.ui.xmlfragment("retail.pmr.promotionaloffers.fragments.OfferFunctionsDialog",this);this.oSelectDialog.setModel(new J());this.oSelectDialog.setContentHeight("30%");this.getView().addDependent(this.oSelectDialog);}var t=e.getSource().getProperty("text");this.oSelectDialog.getModel().setData({Title:t,Items:[]});M.getOffersActions([o],A).then(function(D){this.oSelectDialog.getModel().setData({Title:t,Items:D.data[0]});this.oSelectDialog.open();}.bind(this),U.handleErrors);},handleOfferFunctionsDialogSearch:function(e){var v=e.getParameter("value");var o=new sap.ui.model.Filter("ActionName",sap.ui.model.FilterOperator.Contains,v);var B=e.getSource().getBinding("items");B.filter([o]);},offerFunctionsConfirmSelectDialog:function(o){var i=U.getErrorHandler();var B=this.getView().getModel("i18n").getResourceBundle();var m=this.state.getOfferData();var S=o.getParameter("selectedItem").getBindingContext().getObject();var n=this.contentModel.getProperty("/NavButtonsEnabled");var p=function(e){i.hideBusy();this.contentModel.setProperty("/ShowFooter",n||U.errorMessagesExists());U.handleErrors(e);}.bind(this);i.showBusy();M.getExecuteOffersActions([m],S.Action,S.Area).then(function(){i.hideBusy();if(i.numOfErrors()>0){i.showError(B.getText("CreateOffer.ErrorMessage.Function"));this.contentModel.setProperty("/ShowFooter",n||U.errorMessagesExists());return;}var e=U.base64ToHex(this.dataModel.getProperty("/OfferId"));M.updateOffer("","/Offers(binary'"+e+"')").then(function(r){if(S.Area==="S"){var q=U.getStatusForStore(r.data);if(q.hasOwnProperty("UIState")){var u=U.get(r,["data","UIState"]);this.dataModel.setProperty("/UIState",u);}this.dataModel.setProperty("/Status",S.Status);this.dataModel.setProperty("/StatusName",S.StatusName);this.state.store(this.state.getOfferData(),{StatusName:S.StatusName,ChangedOn:r.data.ChangedOn,ChangedBy:r.data.ChangedBy,ChangedByName:r.data.ChangedByName},q);}if(S.Area==="T"){this.dataModel.setProperty("/TransferStatusDesc",r.data.TransferStatusDesc);this.dataModel.setProperty("/TransferredOn",r.data.TransferredOn);this.dataModel.setProperty("/ERPPromotionId",r.data.ERPPromotionId);this.state.store(this.state.getOfferData(),{TransferStatusDesc:r.data.TransferStatusDesc,TransferredOn:r.data.TransferredOn,ERPPromotionId:r.data.ERPPromotionId});}this.startLoading(this.state,true);this.onLoadingPage(false,true);}.bind(this),p);M.getServiceModel().refresh(true);this.contentModel.setProperty("/ShowFooter",n||U.errorMessagesExists());}.bind(this),p);},onDeleteOfferPress:function(){U.openDeleteConfirmDiaog(true).then(function(){var o=this.state.getOfferData();var e=U.base64ToHex(o.OfferId);var i=U.getErrorHandler();i.showBusy();M.deleteOffers([e]).then(function(D){i.hideBusy();if(i.numOfErrors()>0){var m=U.getFirstMessage();this.oMessageManager.removeAllMessages();i.showError(m.message);}else{this.getRouter().navTo("manage");}}.bind(this),function(m){i.hideBusy();U.handleErrors(m);});}.bind(this));},onEditOfferPress:function(){var o=this.state.getOfferData();U.navToEditOffer(this.getRouter(),o);},onCopyOfferPress:function(){this.oMessageManager.removeAllMessages();var o=this.state.getOfferData();this.parentOfferData=o;U.navTocopyOffer(this.getRouter(),o);},canBeEdited:function(e,u,i){return e===false&&!U.isReadOnly({Status:i,UIState:u});},validateOfferForVersion:function(e,i,m){var n=false;if(!this.verifyValidation("{i18n>ManageVersions.ManageVersionsButton}",n)){return;}this.getEventBus().publish("retail.pmr.promotionaloffers","launchVersionPage");},getOfferDataProvider:function(){return new d(this);},routeForOfferContent:function(e){var i=this.dataRoute.OfferId;var m=this.getOwnerComponent().getMetadata().getConfig();U.toOfferContent(i,m);},onOfferContentSave:function(){var v=this.getView();U.offerContentSaveDialog(v).then(function(){var e=this.getOwnerComponent().getMetadata().getConfig();this.getRouter().detachRouteMatched(this.routeMatched,this,this);this.getRouter().attachRouteMatched(this.routeForOfferContent,this);this.onSave(null,true).then(function(r){if(r&&r.data&&!r.navigate){var i=this.dataRoute.OfferId;U.toOfferContent(i,e);}this.getRouter().detachRouteMatched(this.routeForOfferContent,this,this);this.getRouter().attachRouteMatched(this.routeMatched,this);}.bind(this));}.bind(this),function(){this.getRouter().detachRouteMatched(this.routeForOfferContent,this);this.getRouter().attachRouteMatched(this.routeMatched,this);}.bind(this));}});return l;});
