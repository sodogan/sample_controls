/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["retail/pmr/promotionaloffers/plugins/terms/TermsBaseController","retail/pmr/promotionaloffers/plugins/terms/styles/FreestyleDataTypes","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","retail/pmr/promotionaloffers/plugins/terms/controls/freestyle/ProductDetailsOperations","retail/pmr/promotionaloffers/plugins/terms/controls/freestyle/ProductDetailsMassChange","retail/pmr/promotionaloffers/utils/Models","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/plugins/terms/styles/ProductController","retail/pmr/promotionaloffers/plugins/terms/styles/ProductGroupController","retail/pmr/promotionaloffers/plugins/terms/styles/ProductHierarchyController","retail/pmr/promotionaloffers/plugins/terms/styles/GenericProductController","retail/pmr/promotionaloffers/plugins/terms/styles/FreestyleViewFormatters","retail/pmr/promotionaloffers/utils/ForecastDialog","retail/pmr/promotionaloffers/utils/FinancialCalculations"],function(T,c,J,F,P,d,M,U,f,g,h,G,k,l,C){function r(a,e){if(M.isModelRefreshPostponed()&&!e){return;}jQuery.sap.delayedCall(0,null,function(){a.refresh(true);});}function o(e,a){return!e?null:e.getBindingContext(a).getObject();}function m(e){return o(e.getSource());}function n(a){return a.getData().Terms;}function p(a){return a.getData().Rewards;}function q(a,b){a.Conditions=b?[]:a.Conditions;a.Selection.ProductId=null;a.Selection.HierarchyId=null;a.Selection.HierarchyNodeId=null;a.Selection.UnitOfMeasure=null;a.Selection.Quantity=null;a.Selection.MinAmount=null;a.Selection.UserProjection=null;a.Selection.PromoCostPrice=null;a.Selection.PromoCostPriceCurrency=null;a.ProductTextValue=null;a.ProductDescriptionValue=null;a.Selection.Products=0;}function s(a,b){if(!a){return;}a.Incentives=b?[]:a.Incentives;if(a.Selection.ProductId){a.Selection.ProductId=null;}if(a.Selection.HierarchyId){a.Selection.HierarchyId=null;}if(a.Selection.HierarchyNodeId){a.Selection.HierarchyNodeId=null;}if(a.Selection.UnitOfMeasure){a.Selection.UnitOfMeasure=null;}if(a.Selection.DiscountType){a.Selection.DiscountType=null;}if(a.Selection.DiscountValue){a.Selection.DiscountValue=null;}if(a.Selection.SubDiscountValue){a.Selection.SubDiscountValue=null;}if(a.Selection.Products){a.Selection.Products=0;}if(a.ForTerm){a.ForTerm.DiscountTypeLabel=null;a.ForTerm.DiscountValue=null;a.ForTerm.SubDiscountValue=null;}a.Type="";a.ProductTextValue=null;a.ProductDescriptionValue=null;}function t(a,b){if(b){a.Selection=b;}if(!b){q(a,true);}if(b&&b.hasOwnProperty("Type")){q(a);a.Selection.DimensionType=b.DimensionType;a.Type=b.Type;}}function u(a,b){if(!b){s(a,true);}if(b&&b.hasOwnProperty("Type")){s(a);a.Type=b.Type;a.TermType="2";a.Selection.DimensionType=b.DimensionType;a.Selection.DiscountAssignment=b.DiscountAssignment||"0";a.Selection.Variety=b.Variety||"0";}var e=Object.keys(a.ProductConfig||{});e.forEach(function(i){if(a.Selection.hasOwnProperty(i)){a.Selection[i]=(a.ProductConfig[i]||{}).DefaultValue;}});}function v(e,i,j,x1){function y1(){var F1=Array.prototype.splice.call(arguments,0);return F1.reduce(function(a,b){return function(x){return a(x)&&b(x);};},U.identity);}function z1(i){return function(a){return a.Type!==i;};}var A1=y1(z1("02"),z1("03"));var B1=y1(z1("01"),z1("03"));var C1=y1(z1("01"),z1("02"));var D1=y1(z1("01"),z1("02"),z1("03"));function E1(a,b){return function(x){if(a==="ForTerm"){if(b){return C1(x);}else{return A1(x);}}else if(a==="WholeOffer"||a==="InsteadOf"){if(b){return D1(x);}else{return B1(x);}}else{return false;}};}e.RewardOptions=j.filter(E1(i,x1));}function w(a){var b=[];for(var i=0;i<a.length;i++){var e=jQuery.sap.extend({},a[i]);a[i].Identifier=(i+1)+"";var j=a[i];b.push({oldTerm:e,newTerm:j});}return b;}function y(a,b){a.forEach(function(e,i){e.OperatorLabel=i>0?b+" ":"";});}function z(a,b){if(a.length===1){t(b,null);}else{a.splice(a.indexOf(b),1);}}function A(a,b){if(a.length===1){u(b,null);}else{a.splice(a.indexOf(b),1);}}function B(a,b,e){var i=a.length+1;if(!e){var j=new c.Term(i+"");j.DimensionTypeText=b("CreateOffer.Terms.FreestyleOffer.Product");j.More={Visible:false};j.Type="01";j.Selection={DimensionType:"01"};}else{j=jQuery.extend(true,{},e);j.Identifier=i+"";}a.push(j);return j;}function D(a,b,e){var i=a.length+1;var j=new c.Reward(a.length+1);j.Selection.DimensionType="01";j.TermType="2";j.DimensionTypeText=b("CreateOffer.Terms.FreestyleOffer.Product");j.More={Visible:false};if(e){var x=jQuery.extend(true,{},e);j.RewardOptions=x.RewardOptions;j.ProductConfig=x.ProductConfig;j.SectionConfig=x.SectionConfig;}a.push(j);return j;}function E(a){for(var i=0;i<a.length;i++){a[i].Applicabilities=[];}}function H(a,b){for(var i=0;i<a.length;i++){for(var j=0;j<a.length;j++){if(a[i]===a[j]){continue;}if((a[j].isWholeOffer&&a[j].Type==="02")||a[j].LinkedReward){var e=a[i].Applicabilities.length;var x="";if(b){x=jQuery.sap.formatMessage(b.getProperty("CreateOffer.Terms.FreestyleOffer.InsteadOfReward"),a[j].Identifier);}a[i].Applicabilities.push(new c.RewardApplicabilityInsteadOf(e,x,a[j]));}}}}function I(a,b,e){var x=e?e.getProperty("CreateOffer.Terms.FreestyleOffer.ForTerm"):"";for(var i=0;i<a.length;i++){for(var j=0;j<b.length;j++){var id=a[i].Applicabilities.length;var x1="";if(e){x1=jQuery.sap.formatMessage(x,b[j].Identifier);}a[i].Applicabilities.push(new c.RewardApplicabilityForTerm(id,x1,b[j]));}}}function K(a,b){if(b){var e=b.getProperty("CreateOffer.Terms.FreestyleOffer.ForWholeOffer");}for(var i=0;i<a.length;i++){var j=a[i].Applicabilities.length;a[i].Applicabilities.push(new c.RewardApplicabilityWholeOffer(j,e));}}function L(a){var b=a.Applicabilities;var e=a.ForTerm;var i=a.isWholeOffer;if(i){if(a.Operation==="2"){b=b.filter(n1);}else{b=b.filter(m1);}}else{b=b.filter(o1(e));}var j=b.map(l1)[0];if(!jQuery.isNumeric(j)){return null;}return j+"";}function N(a,b,e){E(a);I(a,b,e);K(a,e);H(a,e);a.forEach(function(i){var j=L(i);i.Applicability=j;if(j){i.ApplicabilityName=i.Applicabilities[j].Name;}});}function O(a,b){if(!a){return;}var e=b?b.Term:null;if(e){a.ForTerm=e;a.isWholeOffer=false;}else{a.ForTerm=null;a.isWholeOffer=true;}}function Q(a,b){var e=b?b.Reward:null;if(e){e.InsteadOfLinkedReward=a;a.LinkedReward=e;a.isWholeOffer=true;}else{if(a.LinkedReward){a.LinkedReward.InsteadOfLinkedReward=null;a.LinkedReward=null;}}}function R(a,b){b=b||[];a=a||[];for(var i=0;i<a.length;i++){a[i].Error=null;}for(var j=0;j<b.length;j++){b[j].ProductIdError=null;b[j].QuantityError=null;}}function S(a){a=a||[];a.forEach(function(b){if(b.Selection.DimensionType==="01"&&!b.Selection.ProductId){b.ProductIdError="Error";}if(b.Selection.DimensionType==="02"&&!b.Selection.HierarchyId&&!b.Selection.HierarchyNodeId){b.ProductIdError="Error";}if(b.Selection.DimensionType==="03"&&!b.Selection.HierarchyId&&!b.Selection.HierarchyNodeId){b.ProductIdError="Error";}if(!b.Quantity){b.QuantityError="Error";}});}function V(a){function i(a){var b=false;var e=0;var j=0;a.forEach(function(x){if(x.isWholeOffer&&!x.LinkedReward){e++;}if(x.LinkedReward){j++;}});if(e>1&&j>0){b=true;}return b;}if(i(a)){a=a.map(function(b){if(b.isWholeOffer||b.LinkedReward){b.Error="Error";}return b;});}}function W(a){for(var i=0;i<a.length;i++){if(!a[i].ForTerm){continue;}for(var j=0;j<a.length;j++){if(a[i]===a[j]||!a[j].ForTerm){continue;}if(a[i].ForTerm===a[j].ForTerm){a[j].Error="Error";a[i].Error="Error";}}}}function X(a){for(var i=0;i<a.length;i++){for(var j=0;j<a.length;j++){if(a[i]===a[j]){continue;}if(a[i].LinkedReward&&a[i].LinkedReward===a[j].LinkedReward){a[j].Error="Error";a[i].Error="Error";}}}}function Y(a,b){for(var i=0;i<a.length;i++){if(a[i].ForTerm===b){a[i].Error="Error";a[i].ForTerm=null;a[i].Applicability=null;}}}function Z(a,b){for(var i=0;i<a.length;i++){if(a[i]===b.InsteadOfLinkedReward){a[i].Error="Error";a[i].Applicability=null;}}}function _(a){a.forEach(function(b){if(b.LinkedReward&&b.Type!=="02"){b.Error="Error";}});}function a1(a){a.forEach(function(b){if(!b.Applicability){b.Error="Error";}else if(!b.Applicabilities[b.Applicability]){b.Error="Error";}});}function b1(a,b,e,i){W(a);X(a);V(a);S(i);_(a);a1(a);if(b){Y(a,b);}if(e){Z(a,e);}}function c1(a){function i(a,e){return a.some(function(j){return j.Class===e.Class;});}var b=[];a.forEach(function(e){if(!i(b,e)){b.push(e);}});return b;}function d1(i,a){var b=i.indexOf(a);return b===(i.length-1);}function e1(a,b){b=b||[];var e=b.filter(function(e){return e.Key===a;})[0]||{};return e.Value;}function f1(a,b){b=b||[];var e=b.filter(function(i){return i.Key===a;})[0]||{};return e.Value;}function g1(i,a){var b=new c.Term(i);b.Type="01";b.Selection.DimensionType="01";b.Selection.UserProjection=null;b.DimensionTypeText=a("CreateOffer.Terms.FreestyleOffer.Product");b.More={Visible:false};return b;}function h1(a,b){var e=a.map(function(i,j){var x=jQuery.sap.formatMessage(b("CreateOffer.Terms.FreestyleOffer.ForTerm"),i.Identifier);return new c.RewardApplicabilityForTerm(j,x,i);});e.push(new c.RewardApplicabilityWholeOffer(e.length,b("CreateOffer.Terms.FreestyleOffer.ForWholeOffer")));return e;}function i1(i,a){var b=new c.Reward(i,[],[]);b.Selection.DimensionType="01";b.DimensionTypeText=a("CreateOffer.Terms.FreestyleOffer.Product");b.More={Visible:false};return b;}function j1(a,b,e){function j(i){return i.Class===e;}var x=jQuery.extend(true,{},a.filter(j)[0]);x.SubConditions=b.filter(j);x.More={Visible:false};return x;}function k1(a,b,e){function j(i){return i.Class===e;}var x=jQuery.extend(true,{},a.filter(j)[0]);x.More={Visible:false};x.SubIncentives=b.filter(j);return x;}function l1(a){return a.Id;}function m1(a){return a instanceof c.RewardApplicabilityWholeOffer;}function n1(a){return a instanceof c.RewardApplicabilityInsteadOf;}function o1(b){return function(a){return a.Term===b;};}function p1(a){var b=parseFloat(a)||0;return(Math.round(100*a)/100);}function q1(a,b){return a.map(function(e){if(e.Value){e.Percentage=(p1(e.Value)/parseFloat(b)*100).toFixed(2);}return e;});}function r1(a,b){var e=b.filter(function(y1){return y1.Percentage===null;});var i=b.reduce(function(y1,z1){if(z1.Value){z1.Value=p1(z1.Value);}else{z1.Percentage=z1.Percentage!==null?p1(z1.Percentage):null;var x1=(a*(z1.Percentage/100));z1.Value=p1(x1);y1.regPrice+=!z1.Percentage?parseFloat(z1.RegularPrice):0;j+=z1.Percentage;}y1.value+=z1.Value;return y1;},{value:0,regPrice:0});e.forEach(function(x1){var y1=p1((x1.RegularPrice/i.regPrice)*(a-i.value));var x=(y1/parseFloat(a)*100)||0;x1.Value=y1;x1.Percentage=p1(x);});var j=b.reduce(function(y1,x1){y1.percent+=parseFloat(x1.Percentage);y1.value+=parseFloat(x1.Value);return y1;},{value:0,percent:0});if(e.length){var x=e[e.length-1].Percentage+(100-j.percent);var x1=e[e.length-1].Value+(a-j.value);e[e.length-1].Value=parseFloat(x1.toFixed(2));e[e.length-1].Percentage=parseFloat(x.toFixed(2));}return b;}function s1(a){return a.Selection.DiscountValue;}function t1(a){return a.PackageValue;}function u1(a,b,e){return a.reduce(function(i,j,x){if(j.isWholeOffer===false&&!!j.ForTerm){var x1=e(j);var y1=j.PercentageValue?parseFloat(j.PercentageValue):null;var z1=parseFloat(U.get(j,["Selection","Financials","RegularPrice"])||1);var A1=parseFloat(U.get(j,["ForTerm","Selection","Quantity"])||1);i.push({Index:x,Value:x1?parseFloat(x1):null,Percentage:y1>0?parseFloat(y1):null,RegularPrice:(z1>0?z1:1)*A1});}return i;},[]);}function v1(a,b,e){var i=a.getProperty("/Rewards");b.forEach(function(j){i[j.Index].Selection.DiscountValue=j.Value;i[j.Index].Selection.SubDiscountValue=j.Percentage;i[j.Index].PackageValue=i[j.Index].PackageValue?j.Value:null;i[j.Index].PercentageValue=i[j.Index].PercentageValue?j.Percentage:null;e.update(i[j.Index].ForTerm,"DiscountValue",j.Value);e.update(i[j.Index].ForTerm,"SubDiscountValue",j.Percentage);});r(a);}var w1={constructor:function(){this.data=new J({});this.content=new J({});this.productDetails=new P(this.data);this.productController=new f(this.data,this.productDetails);this.productGroupController=new g(this.data,this.productDetails);this.productHierarchyController=new h(this.data,this.productDetails);this.genericProductController=new G(this.data,this.productDetails,"11");this.displayProductController=new G(this.data,this.productDetails,"12");this.generalModel=null;},onInit:function(){this.resourceBundle=U.getResourceModel();var a=i1("1",this.getText.bind(this));a.isWholeOffer=true;this.data.setData(this.getDefaultTerms([],[a],[]));var b=n(this.data);a.Applicabilities=h1(b,this.getText.bind(this));var e={PossibleValues:[{Key:"1",Text:this.getText("CreateOffer.Terms.FreestyleOffer.All"),TermLevelText:this.getText("CreateOffer.Terms.FreestyleOffer.And")},{Key:"2",Text:this.getText("CreateOffer.Terms.FreestyleOffer.Any"),TermLevelText:this.getText("CreateOffer.Terms.FreestyleOffer.Or")}]};this.content.setData({TermOptions:[],RewardOptions:[],Operators:e});this.getView().setModel(this.data);this.getView().setModel(this.content,"Content");},afterTermsLoaded:function(){jQuery.sap.delayedCall(0,this,function(){var e=this.content.getProperty("/Editable");if(e===false){jQuery("input").css("paddingLeft","0px");}else{jQuery("input").css("paddingLeft","");}});},isTermSeparatorVisible:function(a){return!d1(n(this.data),a);},isRewardSeparatorVisible:function(a){return!d1(p(this.data),a);},isFinancialSeparatorVisible:function(a){return!d1(this.data.getData().Financials,a);},handleSort:function(e){var a=this.getView().byId("smartProductDetailsTable");a.sortColumn(e);},showForecast:function(e){var i=e.getSource().getBindingContext().getProperty("Id");var a={TermProductId:i};l.show(l.Level.Product,a,M.getServiceModel(),U.getResourceModel());},getDefaultTerms:function(a,b,e){var i=this.getText.bind(this);var j=g1("1",i);if(a.length===0){a=[j];}if(b.length===0){b=[];}if(e.length===0){e=[];}return{Terms:a,Rewards:b,Products:e};},setGeneralModel:function(a){this.getView().setModel(a,"GeneralModel");this.generalModel=a;this.productController.setMasterdataSystemModel(this.generalModel);this.productGroupController.setMasterdataSystemModel(this.generalModel);this.productHierarchyController.setMasterdataSystemModel(this.generalModel);this.genericProductController.setMasterdataSystemModel(this.generalModel);this.displayProductController.setMasterdataSystemModel(this.generalModel);},getEventBus:function(){return sap.ui.getCore().getEventBus();},getText:function(a){return this.resourceBundle.getProperty(a);},deleteConditions:function(e){var b=e.getSource().getBindingContext().getPath().split("/Conditions")[0];var a=e.getSource().getBindingContext().getPath().split("/");var j=a[a.length-1];b+="/Conditions";var x=this.data.getProperty(b);x=x.filter(function(x1,i){return i!==parseInt(j,10);});this.data.setProperty(b,x);r(this.data);},deleteIncentives:function(e){var b=e.getSource().getBindingContext().getPath().split("/Incentives")[0];var a=e.getSource().getBindingContext().getPath().split("/");var j=a[a.length-1];b+="/Incentives";var x=this.data.getProperty(b);x=x.filter(function(x1,i){return i!==parseInt(j,10);});this.data.setProperty(b,x);r(this.data);},handlePressOpenMenuTerm:function(e){var b=e.getSource();var a=e.getSource().getBindingContext();if(!this._menu){this._menu=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.TermOptionsMenu",this);this.getView().addDependent(this._menu);}var i=sap.ui.core.Popup.Dock;this._menu.setBindingContext(a);this._menu.open(this._bKeyboard,b,i.BeginTop,i.BeginBottom,b);},handlePressOpenMenuReward:function(e){var b=e.getSource();var a=e.getSource().getBindingContext();if(!this._rewardMenu){this._rewardMenu=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.RewardOptionsMenu",this);this.getView().addDependent(this._rewardMenu);}var i=sap.ui.core.Popup.Dock;this._rewardMenu.setBindingContext(a);this._rewardMenu.open(this._bKeyboard,b,i.BeginTop,i.BeginBottom,b);},updateTermsLabel:function(){function a(e){var j=U.get(this.content.getData(),["Operators","PossibleValues"])||[];return j.filter(function(x){return x.Key===e;}).map(function(x){return x.TermLevelText;})[0];}var b=n(this.data);var e=U.get(this.content.getData(),["Operators","Value"]);var i=a.call(this,e);y(b,i);r(this.data);},getPossibleConditions:function(){return this.content.getProperty("/PossibleConditions");},setFinancials:function(a){this.data.setProperty("/Financials",a);r(this.data);},setFinancialData:function(a){var b=jQuery.extend(true,[],this.data.getData().Financials);b.forEach(function(e,i){e.Data=a[i]?a[i].Financials:null;});this.data.setProperty("/Financials",b);},setupFinancials:function(){var i=U.getResourceModel();var a=p(this.data)||[];var b=n(this.data)||[];var e=[];var j=[];a.forEach(function(x){if(x.ForTerm){var x1=x.ForTerm.Identifier;j.push(parseInt(x1,10));}});b.forEach(function(x,x1){if(j.indexOf(x1+1)===-1){var y1={};y1.TermType=x.TermType;y1.Identifier=x1+1;y1.TermOrReward=i.getProperty("CreateOffer.Terms.FreestyleOffer.FinancialsTextTerm");e.push(y1);}});a.forEach(function(x,x1){if(x.Type==="01"||x.Type==="02"||x.ForTerm){var y1={};y1.TermType=(x.ForTerm||x).TermType;y1.Identifier=x1+1;y1.TermOrReward=i.getProperty("CreateOffer.Terms.FreestyleOffer.FinancialsTextReward");e.push(y1);}});this.data.setProperty("/Financials",e);},productDimensionChanged:function(e){var a=this.getText.bind(this);var b=m(e);b.Selection.ProductId=null;b.Selection.HierarchyNodeId=null;b.Selection.HierarchyId=null;this.productDetails.remove(b);var i=b.Selection.DimensionType;b.DimensionTypeText=e1(i,this.content.getProperty("/ProductDimensionsSet"));this.triggerDimensionValidation(e);this.productController.resetInput(e);this.productGroupController.resetInput(e);this.productHierarchyController.resetInput(e);this.genericProductController.resetInput(e);this.displayProductController.resetInput(e);},selectTermOption:function(e){var a=$.extend({},e.getParameter("item").getBindingContext("Content").getObject());var b=e.getSource().getBindingContext().getObject();function i(x){return x.hasOwnProperty("Class");}var j=function(){var x=a.Class;var x1=this.getPossibleConditions();a.Selection={};a.SubConditions=x1.filter(function(y1){return y1.Class===x;});a.More={Visible:false};b.Conditions.push(a);}.bind(this);if(i(a)){j(b,a);}else{t(b,{DimensionType:a.DimensionType,TermType:a.TermType,Type:a.Type});}r(this.data);},selectRewardOption:function(e){var a=e.getSource().getBindingContext().getObject();var b=$.extend({},e.getParameter("item").getBindingContext().getObject());var i=p(this.data)||[];function j(b){return b.hasOwnProperty("Class");}function x(a,b,z1,y1){b.Selection={};b.SubIncentives=z1.filter(function(B1){return B1.Class===y1;});b.More={Visible:false};a.Incentives.push(b);}var x1=this.getText.bind(this);if(j(b)){var y1=b.Class;var z1=this.content.getProperty("/PossibleIncentives")||[];x(a,b,z1,y1);}else{u(a,{DimensionType:b.DimensionType,TermType:b.TermType,Type:b.Type});a.DimensionTypeText=e1(a.Selection.DimensionType,this.content.getProperty("/ProductDimensionsSet"));this.setupFinancials();}if(a.Type==="02"){a.isWholeOffer=!a.ForTerm;var A1=n(this.data);N(i,A1,this.resourceBundle);}R(i);b1(i,null,null);r(this.data);},selectSubCondition:function(e){var a=o(e.getParameter("selectedItem")).SubConditionsProps;var b=a.isProductRelevant;var i=a.isQuantityRelevant;if(a.isProductRelevant==="O"){switch(a.CategoryCode){case"01":b="O01";break;case"09":b="O09";break;}}var j=e.getSource().getBindingContext().getPath();var x=j+"/ProductRelevant";var x1=j+"/QuantityRelevant";var y1=j+"/Selection/ProductId";var z1=j+"/Selection/ExtProductId";var A1=j+"/Selection/Quantity";if(b==="O01"||b==="O09"){var B1=j+"/Selection/OfferId";this.data.setProperty(B1,null);}this.data.setProperty(y1,null);this.data.setProperty(z1,null);this.data.setProperty(A1,"0");this.data.setProperty(x,b);this.data.setProperty(x1,i);r(this.data);},selectSubIncentive:function(e){var a=o(e.getParameter("selectedItem")).SubIncentivesProps;var b=a.isProductRelevant;var i=a.isQuantityRelevant;if(a.isProductRelevant==="O"){switch(a.CategoryCode){case"01":b="O01";break;case"09":b="O09";break;}}var j=e.getSource().getBindingContext().getPath();var x=j+"/ProductRelevant";var x1=j+"/QuantityRelevant";var y1=j+"/Selection/ProductId";var z1=j+"/Selection/ExtProductId";var A1=j+"/Selection/Quantity";if(b==="O01"||b==="O09"){var B1=j+"/Selection/OfferId";this.data.setProperty(B1,null);}this.data.setProperty(y1,null);this.data.setProperty(z1,null);this.data.setProperty(A1,0);this.data.setProperty(x,b);this.data.setProperty(x1,i);this.triggerDimensionValidation(e);},termLevelAddButtonPressed:function(e){var a=n(this.data);var b=p(this.data);var i=this.getText.bind(this);var j=B(a,i,this._oLastTermTemplate);this.updateTermsLabel();this.setupFinancials();if(this.generalModel.getProperty("/PackageOffer")){var x=this.rewardLevelAddButtonPressed(e);O(x,{Term:j});x.isWholeOffer=false;x.Type="03";var x1=this.content.getData().RewardOptions;var y1=this.generalModel.getProperty("/PackageOffer");v(x,"ForTerm",x1,y1);N(b,a,this.resourceBundle);}else{N(b,a,this.resourceBundle);}r(this.data);this.updatePackageAppropiation();this.updatePackageUserProjection();},termLevelRemoveButtonPressed:function(e){var a=m(e);var b=n(this.data);var i=p(this.data);var j=i.filter(function(y1){return y1.ForTerm===a;})[0];this.productDetails.remove(a);R(i,b);if(this.generalModel.getProperty("/PackageOffer")){var x=i.filter(function(y1){return!y1.isWholeOffer;});if(x.length===1){O(j,{Term:a});j.isWholeOffer=false;j.Type="03";}else{A(i,j);}w(i);}else{b1(i,a,null);i.forEach(function(y1){if(y1.ForTerm&&y1.ForTerm.Identifier===a.Identifier){y1.ForTerm=null;}});}z(b,a);var x1=w(b);this.productDetails.updateIdentifiers(x1);this.updateTermsLabel();this.setupFinancials();N(i,b,this.resourceBundle);if(b.length===1&&b[0]===a){O(j,{Term:b[0]});}else{s(j);}r(this.data);this.updatePackageAppropiation();},removeTermSelection:function(e){var a=m(e);var b=e.getSource().getBindingContext().sPath;U.removeMessagesByPatialPath(b);this.productDetails.remove(a);q(a);r(this.data);},updateUserProjection:function(e){var a=m(e);var b=U.get(a,["Selection","DimensionType"]);if(b!=="01"){return;}this.updateProductDetails(e,"UserProjection");},onLoadingProductGroupPage:function(e){var i=e.getParameter("isLoading");if(i){this.loadDataBusyDialog=new sap.m.BusyDialog();this.getView().addDependent(this.loadDataBusyDialog);this.loadDataBusyDialog.open();}else{this.loadDataBusyDialog.close();}},removeRewardSelection:function(e){var a=m(e);var b=p(this.data);if(a.ForTerm){this.productDetails.update(a.ForTerm,"DiscountType",null);this.productDetails.update(a.ForTerm,"DiscountValue",null);this.productDetails.update(a.ForTerm,"SubDiscountValue",null);this.productDetails.update(a.ForTerm,"DiscountTypeLabel",null);}else{this.productDetails.remove(a);}s(a);a.isWholeOffer=false;this.setupFinancials();R(b);b1(b,null,null);r(this.data);},rewardLevelAddButtonPressed:function(e){var b=p(this.data);var i=n(this.data);var j=this.getText.bind(this);var x=this.generalModel.getProperty("/PackageOffer");var x1=D(b,j,this._oRewardTemplate);N(b,i,this.resourceBundle);if(x){x1.Type=null;x1.Applicability=""+x1.Applicabilities.filter(function(a){return a instanceof c.RewardApplicabilityWholeOffer;}).map(function(a){return a.Id;})[0];x1.isWholeOffer=true;var y1=this.content.getData().RewardOptions;v(x1,"WholeOffer",y1,x);}this.triggerDimensionValidation(e);r(this.data);return x1;},rewardLevelRemoveButtonPressed:function(e){var a=m(e);var b=p(this.data);var i=n(this.data);var j=this.generalModel.getProperty("/PackageOffer");if(!a.isWholeOffer&&a.ForTerm){a.PackageValue=null;a.PercentageValue=null;this.productDetails.update(a.ForTerm,"DiscountType",null);this.productDetails.update(a.ForTerm,"DiscountValue",null);this.productDetails.update(a.ForTerm,"SubDiscountValue",null);this.productDetails.update(a.ForTerm,"DiscountTypeLabel",null);}else{this.productDetails.remove(a);}if(!j||a.isWholeOffer){A(b,a);var x=w(b);this.productDetails.updateIdentifiers(x);N(b,i,this.resourceBundle);}else{s(a,true);a.Type="03";}R(b,i);b1(b,null,a);this.setupFinancials();r(this.data);this.updatePackageAppropiation();},linkRewardOptionsInsteadOf:function(a,b){if(a.Type==="WholeOffer"&&b.InsteadOfLinkedReward){b.InsteadOfLinkedReward.RewardOptions=jQuery.extend(true,[],b.RewardOptions);}},rewardForSelected:function(e){var a=m(e);var b=o(e.getParameter("selectedItem"));var i=n(this.data);var j=p(this.data);var x=this.getText.bind(this);var x1=a.ForTerm;this.setupLinkForReward(a,b);this.setupFinancials();if(!e.getParameter("selectedItem")){a.Error="Error";return;}if(x1&&a.Error!=="Error"){this.productDetails.update(x1,"DiscountType",null);this.productDetails.update(x1,"DiscountValue",null);this.productDetails.update(x1,"SubDiscountValue",null);this.productDetails.update(x1,"DiscountTypeLabel",null);this.productDetails.update(x1,"DiscountDescription",null);}if(j.indexOf(a)>0){if(b.Type==="InsteadOf"){a.Operation="2";}else{a.Operation="1";}}N(j,i,this.resourceBundle);this.productDetails.update(a,"DiscountType",null);this.productDetails.update(a,"DiscountValue",null);this.productDetails.update(a,"SubDiscountValue",null);this.productDetails.update(a,"DiscountTypeLabel",null);this.productDetails.update(a,"DiscountDescription",null);if(b.Type==="ForTerm"||b.Type==="WholeOffer"||b.Type==="InsteadOf"){a.Type="";s(a,true);a.TermType="2";this.productDetails.remove(a);}if(b.Type==="WholeOffer"||b.Type==="InsteadOf"){a.Selection.DimensionType="01";a.DimensionTypeText=x("CreateOffer.Terms.FreestyleOffer.Product");}if(b.Type!=="WholeOffer"&&b.Type!=="InsteadOf"){a.isWholeOffer=false;}r(this.data);},setupLinkForReward:function(a,b){var e=p(this.data);R(e);O(a,b);Q(a,b);if(b){var i=this.content.getData().RewardOptions;var j=this.generalModel.getProperty("/PackageOffer");v(a,b.Type,i,j);this.linkRewardOptionsInsteadOf(b,a);}b1(e,null,null);},validate:function(){var a=n(this.data);var b=p(this.data);var e=a.concat(b);R(b,a);b1(b,null,null,a);var i=U.getMessageManager();var j=i.getMessageModel().getData();var x=j.filter(function(x1){return x1.target.indexOf("/Terms")>-1||x1.target.indexOf("/Rewards")>-1||x1.target.indexOf("/ProductDetails")>-1;}).length;if(x===0){r(this.data);}return e.filter(function(x1){return x1.Error==="Error";}).length+x;},setTermsData:(function(){function e(a,b){return b.map(function(i){return parseInt(a[i],10);}).reduce(function(i,a){return i||a;},false);}function j(a){var b=this.content.getProperty("/PossibleIncentives");var G1=this.content.getProperty("/PossibleConditions");var H1=b.concat(G1);var I1={};var J1="";for(var i=0;i<H1.length;i++){if(H1[i].Id===a.Type){var K1=H1[i].SubIncentivesProps;if(K1&&K1.isProductRelevant==="O"){J1=K1.isProductRelevant+K1.CategoryCode;}I1={IncentiveId:a.Id,Class:H1[i].Class,Description:H1[i].ClassDescription,Id:a.Type,Type:H1[i].Type,TermId:a.TermId};break;}}I1.Selection={};if(I1.Type==="0"){I1.QuantityRelevant=a.Quantity?"X":"";I1.Selection.Quantity=a.Quantity?a.Quantity+"":null;I1.Selection.ProductId=a.ProductId?a.ProductId:null;I1.Selection.ExtProductId=!a.ProductId&&a.ExtProductId?a.ExtProductId:null;I1.ProductRelevant=a.ProductId?"X":a.ExtProductId?"F":"";if(J1==="O01"||J1==="O09"){I1.ProductRelevant=J1;I1.Selection.OfferId=a.ProductId?a.ProductId:null;}I1.Selection.Type=a.Type;I1.Selection.Cost=a.Cost?parseFloat(a.Cost,10).toFixed(2)+"":null;I1.Selection.AdjustedCost=a.AdjustedCost?parseFloat(a.AdjustedCost,10).toFixed(2)+"":null;I1.Selection.Value=a.Value?parseFloat(a.Value,10).toFixed(2)+"":null;I1.Selection.AdjustedValue=a.AdjustedValue?parseFloat(a.AdjustedValue,10).toFixed(2)+"":null;I1.Selection.RedemptionRate=a.RedemptionRate?parseFloat(a.RedemptionRate,10).toFixed(2)+"":null;if(e(I1.Selection,k.INCENTIVE_MORE_PROPERTIES)){I1.More={Visible:true};}else{I1.More={Visible:false};}I1.SubConditions=H1.filter(function(L1){return L1.Class===a.Class;});}if(I1.Type==="1"){I1.QuantityRelevant=a.Quantity?"X":"";I1.Selection.Quantity=a.Quantity?a.Quantity+"":null;I1.Selection.ProductId=a.ProductId?a.ProductId:null;I1.Selection.ExtProductId=!a.ProductId&&a.ExtProductId?a.ExtProductId:null;I1.ProductRelevant=a.ProductId?"X":a.ExtProductId?"F":"";if(J1==="O01"||J1==="O09"){I1.ProductRelevant=J1;I1.Selection.OfferId=a.ProductId?a.ProductId:null;}I1.Selection.Type=a.Type;I1.Selection.Cost=a.Cost?parseFloat(a.Cost,10).toFixed(2)+"":null;I1.Selection.AdjustedCost=a.AdjustedCost?parseFloat(a.AdjustedCost,10).toFixed(2)+"":null;I1.Selection.Value=a.Value?parseFloat(a.Value,10).toFixed(2)+"":null;I1.Selection.AdjustedValue=a.AdjustedValue?parseFloat(a.AdjustedValue,10).toFixed(2)+"":null;I1.Selection.RedemptionRate=a.RedemptionRate?parseFloat(a.RedemptionRate,10).toFixed(2)+"":null;if(e(I1.Selection,k.INCENTIVE_MORE_PROPERTIES)){I1.More={Visible:true};}else{I1.More={Visible:false};}I1.SubIncentives=H1.filter(function(L1){return L1.Class===a.Class;});}return I1;}function x(i,a){var b=new c.Term(a+1,[],i.DimensionType);b.TermType=i.TermType;b.Type=i.DimensionType;b.OfferId=i.OfferId||"";if(!i.TermId){i.TermId="Term "+a;}b.TermId=i.TermId;b.Selection={};for(var G1 in i){if(i.hasOwnProperty(G1)&&!jQuery.isArray(i[G1])){if(i[G1]){b.Selection[G1]=i[G1];}}}delete b.Selection.DiscountType;delete b.Selection.DiscountTypeName;delete b.Selection.DiscountValue;delete b.Selection.SubDiscountValue;b.Selection.DimensionType=i.DimensionType||null;b.Selection.UnitOfMeasure=i.UnitOfMeasure||null;b.Selection.ExtHierarchyId=i.ExtHierarchyId||null;b.Selection.ExtHierarchyNodeId=i.ExtHierarchyNodeId||null;b.Selection.Quantity=i.Quantity||"0";b.Selection.MinAmount=i.MinAmount||"0";b.Selection.UserProjection=i.UserProjection||null;b.Selection.PromoCostPrice=i.PromoCostPrice||"0";b.Selection.PromoCostPriceCurrency=i.PromoCostPriceCurrency||i.Currency||null;b.DiscountTypeLabel=i.DiscountTypeName;b.DiscountType=i.DiscountType;b.DiscountValue=i.DiscountValue;b.UnitOfMeasures=(i.UoMs||[]).map(function(H1){return{Id:H1.Unit,Name:H1.Unit};});b.ProductTextValue=i.ExtProductId||i.ExtHierarchyNodeId||i.ExtHierarchyId;b.ProductDescriptionValue=i.Description;if(i.DiscountType==="04"){b.DiscountDescription="%";}else{b.DiscountDescription=i.Currency;}b.DimensionTypeText=e1(i.DimensionType,this.content.getProperty("/ProductDimensionsSet"));if(!U.isInitial(i.ProductId)){b.Selection.ProductId=i.ProductId;}else{delete b.Selection.ProductId;}if(!U.isInitial(i.HierarchyId)){b.Selection.HierarchyId=i.HierarchyId;}else{delete b.Selection.HierarchyId;}if(!U.isInitial(i.HierarchyNodeId)){b.Selection.HierarchyNodeId=i.HierarchyNodeId;}else{delete b.Selection.HierarchyNodeId;}if(i.TermProducts){b.TermProducts=jQuery.extend(true,[],i.TermProducts.concat());}if(e(b.Selection,k.TERM_MORE_PROPERTIES)){b.More={Visible:true};}else{b.More={Visible:false};}return b;}function x1(a,i,b){var G1=new c.Reward(b+1);var H1=i.ProductId||i.HierarchyNodeId||i.HierarchyId||i.DimensionType==="20";if(H1){G1.Type="02";}G1.TermType="2";G1.isWholeOffer=!!H1;G1.Selection={};for(var I1 in i){if(i.hasOwnProperty(I1)&&!jQuery.isArray(i[I1])){if(i[I1]){G1.Selection[I1]=i[I1];}}}G1.Selection.DimensionType=i.DimensionType||null;G1.Selection.DiscountType=i.DiscountType||null;G1.Selection.DiscountValue=i.DiscountValue||null;G1.Selection.DiscountAssignment=i.DiscountAssignment;G1.Selection.Variety=i.Variety;G1.Selection.UnitOfMeasure=i.UnitOfMeasure||null;G1.SubDiscountValue=null;G1.Selection.SubDiscountValue=parseFloat(i.SubDiscountValue)>0?i.SubDiscountValue:null;G1.Selection.Quantity=i.Quantity||null;G1.Selection.UserProjection=i.UserProjection||null;G1.Selection.PromoCostPrice=i.PromoCostPrice||null;G1.Selection.PromoCostPriceCurrency=i.PromoCostPriceCurrency||i.Currency||null;G1.Selection.Description=i.Description||null;G1.Selection.ExtProductId=i.ExtProductId||null;G1.Selection.ExtHierarchyId=i.ExtHierarchyId||null;G1.Selection.ExtHierarchyNodeId=i.ExtHierarchyNodeId||null;G1.DimensionTypeText=e1(i.DimensionType,a.content.getProperty("/ProductDimensionsSet"));G1.ProductTextValue=i.ExtProductId||i.ExtHierarchyNodeId||i.ExtHierarchyId;G1.ProductDescriptionValue=i.Description;if(i.DiscountType==="04"){G1.DiscountDescription="%";}else{G1.DiscountDescription=i.Currency;}G1.UnitOfMeasures=(i.UoMs||[]).map(function(J1){return{Id:J1.Unit,Name:J1.Unit};});G1.DiscountTypeLabel=i.DiscountTypeName;G1.DiscountType=i.DiscountType;if(!U.isInitial(i.ProductId)){G1.Selection.ProductId=i.ProductId;}else{delete G1.Selection.ProductId;}if(!U.isInitial(i.HierarchyId)){G1.Selection.HierarchyId=i.HierarchyId;}else{delete G1.Selection.HierarchyId;}if(!U.isInitial(i.HierarchyNodeId)){G1.Selection.HierarchyNodeId=i.HierarchyNodeId;}else{delete G1.Selection.HierarchyNodeId;}if(i.Operation){G1.Operation=i.Operation;}if(i.TermProducts){G1.TermProducts=jQuery.extend(true,[],i.TermProducts.concat());}if(e(G1.Selection,k.TERM_MORE_PROPERTIES)){G1.More={Visible:true};}else{G1.More={Visible:false};}return G1;}function y1(a,i,b,G1,H1){var I1=x1(a,i,b);var J1=a.content.getData().RewardOptions;var K1=a.generalModel.getProperty("/PackageOffer");I1.Type="01";I1.ForTerm=G1[b];I1.TermId=G1[b].TermId;I1.isWholeOffer=false;v(I1,"ForTerm",J1,K1);H1.push(b+"");return I1;}function z1(i){return i.DiscountType&&!!i.DiscountType.length;}function A1(a,b,G1,H1){var I1=a.content.getData().RewardOptions;var J1=a.generalModel.getProperty("/PackageOffer");if(b.Operation==="2"){for(var i=0;i<b.Applicabilities.length;i++){if(b.Applicabilities[i].Type==="InsteadOf"){v(b,"WholeOffer",I1,J1);b.LinkedReward=b.Applicabilities[i].Reward;b.LinkedReward.InsteadOfLinkedReward=b;return i+"";}}}else{for(var i=0;i<b.Applicabilities.length;i++){if(b.Applicabilities[i].Type==="WholeOffer"){v(b,"WholeOffer",I1,J1);b.LinkedReward=null;return i+"";}}}return null;}function B1(a,b,i,G1,H1,I1){N(i,G1,I1);H1.forEach(function(J1){J1.Applicability=b.shift();});i.forEach(function(J1,K1){if(J1.Applicability){return;}J1.Applicability=A1(a,J1,K1,i);});}function C1(a){return function(b){return b.TermId===a;};}function D1(a,b,i){b.RewardId=a[i]||"";return b;}var E1=(function(a){function b(i,G1,H1){G1.forEach(function(I1){if(I1.Id===i.TermId){I1.Terms=H1;I1.DiscountType=i.DiscountTypeName;I1.DiscountValue=i.DiscountValue;I1.RegularPrice=i.RegularPrice;I1.PurchasePrice=i.PurchasePrice;I1.UserProjection=i.UserProjection;I1.SubDiscountValue=i.SubDiscountValue;I1.LockUserProjection=i.LockUserProjection;I1.PromoCostPrice=i.PromoCostPrice;I1.PromoCostPriceCurrency=i.PromoCostPriceCurrency;I1.Description="";}});}return function(){var G1=[];if(a){for(var i=0;i<a.length;i++){if(a[i].TermProducts){G1.push.apply(G1,a[i].TermProducts);var H1=i+1;b(a[i],G1,"Term "+H1);}}}return G1;};}());function F1(a,b,i){var G1=b.filter(function(G1){return G1.TermId===i;})[0];if(!G1){G1=new c.Reward(b.length+1,null,null,"ForTerm");G1.Type=null;G1.TermId=i;G1.ForTerm=a.filter(C1(i))[0];G1.Applicability=a.indexOf(G1.ForTerm)+"";b.push(G1);}return G1;}return function(i){if(!i){return;}var G1=this.getText.bind(this);i.Terms=i.Terms||[];i.Incentives=i.Incentives||[];i.Terms.forEach(function(a){C.extendFinancials(a.Financials);});var H1=i.Terms.filter(function(a){return a.TermType==="1";});var I1=i.Terms.filter(function(a){return a.TermType==="2";});if(H1.length>1){var J1=H1[1].Operation;this.content.setProperty("/Operators/Value",J1);}var K1=H1.map(x.bind(this));var L1=[];var M1=[];H1.forEach(function(a,b){if(z1(a)){M1.push(y1(this,a,b,K1,L1));}}.bind(this));var N1=(i.Incentives||[]).map(j.bind(this));var O1=I1.map(function(i){return i.TermId;});var P1=M1.concat(I1.map(x1.bind(null,this)).map(D1.bind(null,O1)));var Q1=E1(i.Terms);this.data.setData(this.getDefaultTerms(K1,P1,Q1));var R1=i.Terms.map(function(a){return(a.Incentives||[]).map(function(b){b.TermId=a.TermId;return b;});}).reduce(function(a,b){return a.concat(b);},[]).map(j.bind(this));K1=n(this.data);P1=p(this.data);var S1=R1.filter(function(a){return a.Type==="0";});var T1=R1.filter(function(a){return a.Type==="1";});K1.forEach(function(a){a.Conditions=S1.filter(function(b){return b.TermId===a.TermId;});});P1.forEach(function(a){a.Incentives=T1.filter(function(b){return b.TermId===a.RewardId;});});T1.forEach(function(a){if(K1.some(C1(a.TermId))){var b=F1(K1,P1,a.TermId);b.Incentives.push(a);}});if(N1.length){var U1=new c.Reward(P1.length+1,null,null,"");U1.isWholeOffer=true;U1.Applicabilities=h1(K1,this.getText.bind(this));U1.Applicability=L(U1);U1.Incentives=N1;P1.push(U1);}if(P1.length===0){var V1=i1("1",G1);V1.Applicabilities=h1(K1,this.getText.bind(this));V1.Applicability=L(V1);if(V1.Applicability){V1.ApplicabilityName=V1.Applicabilities[V1.Applicability].Name;}var W1=this.generalModel.getProperty("/PackageOffer");if(!W1){V1.isWholeOffer=true;P1.push(V1);}}var X1=this.content.getData().RewardOptions;var W1=this.generalModel.getProperty("/PackageOffer");P1.forEach(function(a,b){if(a.isWholeOffer){v(a,"WholeOffer",X1,W1);}});if(W1){K1.forEach(function(a){var b=F1(K1,P1,a.Selection.TermId);b.isWholeOffer=false;b.Type="03";b.Applicabilities=h1(K1,this.getText.bind(this));b.Applicability=L(b);v(b,"ForTerm",X1,W1);},this);}B1(this,L1,P1,K1,M1,this.resourceBundle);w(K1);w(P1);r(this.data);};}()),setStaticData:function(a){if(a&&a.staticData){this.content.setProperty("/DiscountTypes",a.staticData.DiscountTypeSet);this.content.setProperty("/ProductDimensionsSet",a.staticData.ProductDimensionsSet);this.content.setProperty("/ProductDimensionsSetExcludingTransaction",a.staticData.ProductDimensionsSet.filter(function(z1){return z1.Key!=="20";}));this.content.setProperty("/DiscountAssignments",a.staticData.DiscountAssignmentSet);this.content.setProperty("/DiscountVarieties",a.staticData.DiscountVarietySet);this.content.setProperty("/CurrencyList",a.staticData.CurrencyListSet||[]);}if(a){this.content.setProperty("/Editable",a.editable);}if(a&&a.staticData){var b=a.staticData.IncentiveDefinitions.filter(function(z1){return z1.Type==="0";});b=c1(b);b=b.map(function(z1){return new c.ConditionType(z1.Id,z1.Class,z1.Type,z1.ClassDescription);});var e=a.staticData.GetOptions.map(function(z1,A1){return new c.RewardType(A1,z1.Value,"01",z1.Key);});var i=U.getI18NModel().getResourceBundle();var j=i.getText("CreateOffer.Terms.FreestyleOffer.Appropriation");e.push(new c.RewardType(e.length+1,j,"01","03"));var x=a.staticData.IncentiveDefinitions.filter(function(z1){return z1.Type==="1";});x=c1(x);x=x.map(function(z1){return new c.IncentiveType(z1.Id,z1.Class,z1.Type,z1.ClassDescription);});e=e.concat(x);var x1=a.staticData.IncentiveDefinitions.filter(function(z1){return z1.Type==="0";});x1=x1.map(function(z1){return new c.Condition(z1.Id,z1.Class,z1.ClassDescription,z1.Description,z1.Type,z1.ProductRelevant,z1.QuantityRelevant,z1.CategoryCode);});var y1=a.staticData.IncentiveDefinitions.filter(function(z1){return z1.Type==="1";});y1=y1.map(function(z1){return new c.Incentive(z1.Id,z1.Class,z1.ClassDescription,z1.Description,z1.Type,z1.ProductRelevant,z1.QuantityRelevant,z1.CategoryCode);});this.content.setProperty("/TermOptions",b);this.content.setProperty("/RewardOptions",e);this.content.setProperty("/PossibleConditions",x1);this.content.setProperty("/PossibleIncentives",y1);}},setTermsModel:function(a){var b=a.contentModel;this.getView().setModel(b,"TermsContentModel");},handleLoadItems:function(e){var b=e.getSource().getBinding("items");b.resume();b.checkUpdate(true);},setOfferData:function(a){this.setStaticData(a);this.setTermsData(a);this.setupFinancials();this.setFinancialData(a.Terms);var b=this.data.getData();var e=b.Terms;var i=b.Rewards;var j=e.concat(i).filter(function(x1){return x1.Selection.ProductId||x1.Selection.HierarchyId||x1.Selection.HierarchyNodeId;}).filter(function(x1){return!x1.ForTerm;});var x=this.getView().getModel("TermsContentModel").getProperty("/Purposes");this.productDetails.init(j,x);this.productDetails.calculateTotalProducts();this.updatePackage(s1);},getFinancials:function(){return this.data.getProperty("/Financials");},getTermsProductsFinancials:function(){var a=this.data.getProperty("/Terms");var b=this.getOfferData().Terms.map(function(e,i){e.TermProducts.forEach(function(j,x){j.Financials=U.get(a,[i,"TermProducts",x,"Financials"])||{Id:""};});return e;});return{Terms:b};},getOfferData:(function(){var a=(function(){function z1(B1,C1){if(C1.Selection.ProductId&&C1.ProductRelevant==="X"){B1.ProductId=C1.Selection.ProductId;}if(C1.Selection.ExtProductId&&C1.ProductRelevant==="F"){B1.ExtProductId=C1.Selection.ExtProductId;}if(C1.Selection.OfferId&&(C1.ProductRelevant==="O01"||C1.ProductRelevant==="O09")){B1.ProductId=C1.Selection.OfferId;}if(C1.Selection.Quantity){B1.Quantity=parseInt(C1.Selection.Quantity,10);}for(var D1 in C1.Selection){if(C1.Selection.hasOwnProperty(D1)&&D1!=="OfferId"){if(C1.Selection[D1]&&!B1.hasOwnProperty(D1)){B1[D1]=C1.Selection[D1]+"";}}}}function A1(B1){var C1={};z1(C1,B1);C1.Id=B1.IncentiveId||"";if(C1.Type&&B1.Class){C1.Class=B1.Class;}return C1;}return function(B1,C1){var D1=A1(C1);if(Object.keys(D1).length>1){B1.push(D1);}};}());function b(z1){if(z1){return z1+"";}return null;}function e(z1,A1){z1.Incentives=z1.Incentives||[];A1.Incentives.forEach(function(B1){a(z1.Incentives,B1);});}function i(z1,A1){if(z1==="05"||z1==="06"){return null;}if(!parseFloat(A1)){A1=0;}return A1+"";}function j(z1,A1){if(A1.Selection.DiscountType){z1.DiscountType=A1.Selection.DiscountType;z1.DiscountAssignment=A1.Selection.DiscountAssignment||"0";z1.SubDiscountType=A1.Selection.DiscountType;if(A1.Selection.Dimension!=="01"){z1.Variety=A1.Selection.Variety||"0";}}if(A1.Selection.DiscountValue){z1.DiscountValue=i(A1.Selection.DiscountType,A1.Selection.DiscountValue);}if(A1.Selection.SubDiscountValue){z1.SubDiscountValue=i(A1.Selection.DiscountType,A1.Selection.SubDiscountValue);}if(A1.Type==="03"){z1.DiscountType="02";delete z1.SubDiscountValue;}}var x=(function(){function z1(F1,G1){var H1={TermType:"1",DimensionType:F1.Selection.DimensionType||null,DiscountTypeName:F1.DiscountTypeLabel,UnitOfMeasure:F1.Selection.UnitOfMeasure||null,Quantity:b(F1.Selection.Quantity)||"1",MinAmount:b(F1.Selection.MinAmount)||"0",UserProjection:b(F1.Selection.UserProjection)||"0",Identifier:F1.Identifier,TermProducts:[],PromoCostPriceCurrency:F1.Selection.PromoCostPriceCurrency||F1.Currency,UoMs:(F1.UnitOfMeasures||[{Id:""}]).map(function(J1){return{Unit:J1.Id};})};for(var I1 in F1.Selection){if(F1.Selection.hasOwnProperty(I1)){if(!H1.hasOwnProperty(I1)&&F1.Selection[I1]){H1[I1]=F1.Selection[I1];}}}delete H1.ForceProductLoad;delete H1.Type;if(G1!==0){var op=this.content.getData().Operators;H1.Operation=op?op.Value||"1":"1";}if(F1.Conditions&&F1.Conditions.length){H1.Incentives=[];F1.Conditions.forEach(function(J1){a(H1.Incentives,J1);});}if(H1.DimensionType!=="20"){if(F1.Selection.ProductId){H1.ProductId=F1.Selection.ProductId;}if(F1.Selection.HierarchyNodeId){H1.HierarchyNodeId=F1.Selection.HierarchyNodeId;}if(F1.Selection.HierarchyId){H1.HierarchyId=F1.Selection.HierarchyId;}}if(F1.OfferId){H1.OfferId=F1.OfferId;}delete H1.TermId;if(F1.TermId&&F1.TermId.indexOf("Term")===-1){H1.TermId=F1.TermId;}if(F1.Selection.PromoCostPrice&&parseFloat(F1.Selection.PromoCostPrice)>0){H1.PromoCostPrice=b(F1.Selection.PromoCostPrice);H1.UsePromoCostPrice=true;}else{H1.UsePromoCostPrice=false;}var K1=this.productDetails.getForTerm(F1);H1.TermProducts=K1||[];return H1;}function A1(F1){var G1=F1.Selection.ProductId||(F1.Selection.HierarchyId&&F1.Selection.HierarchyNodeId);return F1.Selection.DimensionType==="20"?true:!!F1.Selection.DimensionType&&G1;}function B1(F1,G1){F1.forEach(function(H1){if(H1.ForTerm&&H1.ForTerm.Identifier==G1.Identifier){e(G1,H1);j(G1,H1);}});return G1;}function C1(F1){delete F1.Identifier;return F1;}function D1(F1){if(!F1.Type){return false;}return F1.Type!=="01"&&F1.Type!=="03";}function E1(F1,G1){var H1={TermType:"2",DimensionType:F1.Selection.DimensionType||null,UnitOfMeasure:F1.Selection.UnitOfMeasure||null,DiscountType:F1.Selection.DiscountType||"",DiscountTypeName:F1.DiscountTypeLabel,SubDiscountType:F1.Selection.DiscountType||"",DiscountValue:i(F1.Selection.DiscountType,F1.Selection.DiscountValue)||"0",SubDiscountValue:i(F1.Selection.DiscountType,F1.Selection.SubDiscountValue)||"0",Quantity:b(F1.Selection.Quantity)||"1",UserProjection:b(F1.Selection.UserProjection)||"0",PromoCostPrice:b(F1.Selection.PromoCostPrice)||"0",Financials:{Id:""},UoMs:(F1.UnitOfMeasures||[{Id:""}]).map(function(K1){return{Unit:K1.Id};})};for(var I1 in F1.Selection){if(F1.Selection.hasOwnProperty(I1)){if(!H1.hasOwnProperty(I1)&&F1.Selection[I1]){H1[I1]=F1.Selection[I1];}}}delete H1.ForceProductLoad;delete H1.Type;if(G1!==0){H1.Operation=F1.Operation||"1";}if(H1.DimensionType!=="20"){if(F1.Selection.ProductId){H1.ProductId=F1.Selection.ProductId;}if(F1.Selection.HierarchyNodeId){H1.HierarchyNodeId=F1.Selection.HierarchyNodeId;}if(F1.Selection.HierarchyId){H1.HierarchyId=F1.Selection.HierarchyId;}}if(H1.DimensionType!=="01"){H1.Variety=F1.Selection.Variety||"0";}if(F1.Incentives&&F1.Incentives.length){H1.Incentives=[];F1.Incentives.forEach(function(K1){a(H1.Incentives,K1);});}var J1=this.productDetails.getForTerm(F1);H1.TermProducts=J1||[];delete H1.TermId;return H1;}return function(F1,G1,H1){var I1=G1.filter(A1).map(z1,F1).map(B1.bind(null,H1)).map(C1);var J1=H1.filter(D1).map(E1,F1);return I1.concat(J1);};}());function x1(z1){var A1=[];z1.forEach(function(B1){var C1=B1.Applicability;var D1=B1.Applicabilities[C1];if(!D1||(D1.Type==="WholeOffer"&&!B1.Type)){B1.Incentives.forEach(function(E1){a(A1,E1);});}});return A1;}function y1(z1){var A1=jQuery.extend(true,[],n(z1.data));var B1=jQuery.extend(true,[],p(z1.data));return{Terms:x(z1,A1,B1),Incentives:x1(B1)};}return function(){return y1(this);};}()),setRouter:function(a){this.content.setProperty("/Router",a);this.productGroupController.setRouter(a);},processServerErrors:function(a){var b=U.getMessageManager();U.setErrorMessages(b,a,this.data);},applyConfigs:(function(){function a(i,j,x){var S1=i[j]||g1((j+1)+"",x);i[j]=S1;S1.SectionConfig={};return S1;}function b(i,j,x,S1){var T1=i[x]||i1((x+1)+"",S1);T1.Applicabilities=h1(j,S1);i[x]=T1;T1.SectionConfig={};return T1;}function e(i,j){return i[j]||{};}function x1(i){var j={};var x=i.Property;var S1=i.Value==="true"?false:true;var T1=i.Value;if(x==="readOnly"){j.Editable=S1;}if(x==="hidden"){j.Visible=S1;}if(x==="value"){j.DefaultValue=T1;}return j;}function y1(i){return i.map(function(j){return j.Control;}).filter(function(j,x,S1){return S1.indexOf(j)===x;});}function z1(i,j){return i.filter(function(x){return x.Control===j;});}function A1(j){var x={DefaultValue:null,Editable:true,Visible:true};for(var i=0;i<j.length;i++){var S1=e(j,i);x=jQuery.extend(x,x1(S1));}return x;}function B1(i,j){return i.filter(function(x){return j===x.Name;});}function C1(i){var x={};var S1=y1(i);for(var j=0;j<S1.length;j++){var T1=S1[j];var U1=z1(i,T1);x[T1]=A1(U1,T1);}return x;}function D1(i,j){var x={SectionItemRules:[]};if(!i){return[];}var S1=i.filter(function(S1){return S1.ItemType===j;})[0]||x;return S1.SectionItemRules;}function E1(i){var j=i.ProductConfig;var x=i.Selection;var S1=(j.ProductId||{}).DefaultValue;var T1=(j.HierarchyId||{}).DefaultValue;var U1=(j.HierarchyNodeId||{}).DefaultValue;var V1=(j.DimensionType||{}).DefaultValue;var W1=S1||U1||T1||V1;var X1=x.ProductId||x.HierarchyNodeId||x.HierarchyId;for(var Y1 in i.Selection){if(i.Selection.hasOwnProperty(Y1)&&i.ProductConfig.hasOwnProperty(Y1)){if((Y1==="ProductId"||Y1==="HierarchyNodeId"||Y1==="HierarchyId"||Y1==="DimensionType")){continue;}var Z1=(i.ProductConfig[Y1]||{}).DefaultValue;if(Z1&&Z1.trim){Z1=Z1.trim();}i.Selection[Y1]=i.Selection[Y1]||Z1;}}i.ForceProductLoad=false;if(!X1&&W1){i.Selection.ProductId=S1||null;i.Selection.HierarchyId=T1||null;i.Selection.HierarchyNodeId=U1||null;i.Selection.DimensionType=(j.DimensionType||{}).DefaultValue||null;i.Selection.ForceProductLoad=true;}}function F1(i){if(i.Type==="01"){var j=i.Selection;var x=null;if(j.ProductId||j.HierarchyId||j.HierarchyNodeId){x=j.DimensionType||(i.ProductConfig.DimensionType||{}).DefaultValue;}else{x=(i.ProductConfig.DimensionType||{}).DefaultValue;}i.Type=x||"01";i.Selection.DimensionType=i.Type;}else{i.Type=i.Type||(i.ProductConfig.DimensionType||{}).DefaultValue;i.Selection.DimensionType=i.Selection.DimensionType||(i.ProductConfig.DimensionType||{}).DefaultValue||"01";}}function G1(i){return function(x){return x.Id===i||x.Id+""===i;};}function H1(i){return!!(i.TermId||i.RewardId);}function I1(i,j){var x=(i.ProductConfig.RewardScope||{}).DefaultValue;var S1=i.Applicabilities;if(x&&!H1(i)){var T1=parseInt(x,10);var U1=j.filter(function(W1){return W1.Index===x||W1.Index===T1;})[0];O(i,{Term:U1});var V1=S1.filter(function(W1){return!!W1.Term;}).filter(function(W1){return W1.Term===i.ForTerm;})[0];if(V1){i.Applicability=V1.Id+"";i.ApplicabilityName=i.Applicabilities[V1.Id].Name;}}}function J1(i,j){var x=(i.ProductConfig.RewardScope||{}).DefaultValue;var S1=i.Applicabilities;if(x&&!H1(i)){var T1=parseInt(x,10);O(i,{Term:j.filter(function(W1){return W1.Index===x||W1.Index===T1;})[0]});var U1=S1.filter(function(W1){return!!W1.Term;}).filter(function(W1){return W1.Term===i.ForTerm;})[0];if(U1){i.Applicability=U1.Id+"";i.ApplicabilityName=U1.Name;}}else if(S1.filter(G1(i.Applicability)).length<=0){i.Applicability=i.Applicabilities[i.Applicabilities.length-1].Id;}else if(x==""){i.Applicability=(S1.length-1);}if(!H1(i)){M1(i);}else{var V1=S1.filter(G1(i.Applicability))[0];if(V1 instanceof c.RewardApplicabilityWholeOffer){i.isWholeOffer=true;i.Type="02";}}}function K1(i,x){if(i.SubConditions){for(var j=0;j<i.SubConditions.length;j++){if(i.SubConditions[j].Id===x){var S1=i.SubConditions[j].SubConditionsProps||{};var T1=S1.isProductRelevant;var U1=S1.isQuantityRelevant;var V1=S1.CategoryCode;i.ProductRelevant=T1;if(T1==="O"&&(V1==="01"||V1==="09")){i.ProductRelevant=T1+V1;}i.QuantityRelevant=U1;return;}}}}function L1(i,x){if(i.SubIncentives){for(var j=0;j<i.SubIncentives.length;j++){if(i.SubIncentives[j].Id===x){var S1=i.SubIncentives[j].SubIncentivesProps||{};var T1=S1.isProductRelevant;var U1=S1.isQuantityRelevant;var V1=S1.CategoryCode;i.ProductRelevant=T1;if(T1==="O"&&(V1==="01"||V1==="09")){i.ProductRelevant=T1+V1;}i.QuantityRelevant=U1;return;}}}}function M1(i){var j=i.ProductConfig;if(Object.keys(j).length){var x=j.RewardScope||{};if(x.DefaultValue){i.Type="01";}else{i.Type="02";if(i.Selection){i.Selection.DimensionType=i.Selection.DimensionType||"01";}}}}function N1(i,j,x,S1){var T1=i[j]||j1(S1.termOptions,S1.possibleConditions,x);i[j]=T1;T1.Config={};return T1;}function O1(i,j,x,S1){var T1=i[j]||k1(S1.rewardOptions,S1.possibleIncentives,x);i[j]=T1;T1.Config={};return T1;}function P1(j,x,S1,T1,U1,V1){var W1=(j.SectionItems||[]).filter(function(a2){return a2.ItemType==="Incentive";});for(var i=0,X1=0;i<W1.length;i++){var Y1=W1[i];var Z1=C1(Y1.SectionItemRules);if(Z1.hasOwnProperty("Class")){var $1=Z1.Class.DefaultValue;var _1=S1(x[U1],X1,$1,T1);_1.Config=Z1;if(!_1.Selection){_1.Selection={};}_1.Selection.Type=(Z1.Type||{}).DefaultValue||_1.Selection.Type;_1.Selection.Cost=(Z1.Cost||{}).DefaultValue||_1.Selection.Cost||_1.Selection.Cost;_1.Selection.AdjustedCost=(Z1.AdjustedCost||{}).DefaultValue||_1.Selection.AdjustedCost;_1.Selection.Value=(Z1.Value||{}).DefaultValue||_1.Selection.Value;_1.Selection.AdjustedValue=(Z1.AdjustedValue||{}).DefaultValue||_1.Selection.AdjustedValue;_1.Selection.RedemptionRate=(Z1.RedemptionRate||{}).DefaultValue||_1.Selection.RedemptionRate;K1(_1,_1.Selection.Type);L1(_1,_1.Selection.Type);X1+=1;}}}function Q1(i,j,x,S1){var T1=j.Rules||[];var U1=D1(j.SectionItems,"Buy");i.Index=j.Index;i.SectionConfig=C1(T1);i.ProductConfig=C1(U1);P1(j,i,N1,x,"Conditions","SelectedSubCondition");E1(i);F1(i);i.DimensionTypeText=e1(i.Selection.DimensionType,S1);}function R1(i,j,x,S1,T1,U1){var V1=j.Rules||[];var W1=D1(j.SectionItems,"Get");i.SectionConfig=C1(V1);i.ProductConfig=C1(W1);E1(i);J1(i,T1);P1(j,i,O1,x,"Incentives");i.DimensionTypeText=e1(i.Selection.DimensionType,S1);if(!i.ProductConfig.RewardScope){var X1=D1(j.SectionItems,"Incentive");var Y1=X1.filter(function(Z1){return Z1.Control==="RewardScope";});jQuery.extend(i.ProductConfig,C1(Y1));I1(i,T1);}if(i.Applicabilities&&i.Applicabilities[i.Applicability]){U1.setupLinkForReward(i,i.Applicabilities[i.Applicability]);}}return function(x){var S1=this.getText.bind(this);var T1=this.data.getData();var U1=T1.Terms;var V1=T1.Rewards;var W1={termOptions:this.content.getProperty("/TermOptions"),rewardOptions:this.content.getProperty("/RewardOptions"),possibleConditions:this.content.getProperty("/PossibleConditions"),possibleIncentives:this.content.getProperty("/PossibleIncentives")};var X1=this.content.getProperty("/ProductDimensionsSet");this._oLastTermTemplate=null;var Y1=B1(x,"Condition");for(var Z1=0;Z1<Y1.length;Z1++){var $1=Y1[Z1];if(Z1==(Y1.length-1)&&U1.length>Y1.length){for(var i=Z1;i<U1.length;i++){var _1=a(U1,i,S1);Q1(_1,$1,W1,X1);}}else{_1=a(U1,Z1,S1);Q1(_1,$1,W1,X1);}this._oLastTermTemplate=jQuery.extend(true,{},_1);}this._oRewardTemplate=null;var a2=B1(x,"Reward");for(var b2=0;b2<a2.length;b2++){var c2=a2[b2];if(b2==(a2.length-1)&&V1.length>a2.length){for(var j=b2;j<V1.length;j++){var d2=b(V1,U1,j,S1);R1(d2,c2,W1,X1,U1,this);}}else{d2=b(V1,U1,b2,S1);R1(d2,c2,W1,X1,U1,this);}this._oRewardTemplate=jQuery.extend(true,{},d2);}var e2=B1(x,"Header")[0]||{Rules:[]};var f2=e2.Rules||[];T1.Header={SectionConfig:C1(f2)};if(typeof(this.content.getProperty("/Operators/Value"))!=="undefined"){if(T1.Terms.length>1&&T1.Terms[1].Selection&&T1.Terms[1].Selection.Operation){this.content.setProperty("/Operators/Value",T1.Terms[1].Selection.Operation);}else{this.content.setProperty("/Operators/Value",(T1.Header.SectionConfig.AndOrSwitch||{DefaultValue:"1"}).DefaultValue);}}else{this.content.setProperty("/Operators/Value",(T1.Header.SectionConfig.AndOrSwitch||{DefaultValue:"1"}).DefaultValue);}if(!T1.Financials||T1.Financials.length<=0){this.setupFinancials();}this.updateTermsLabel();r(this.data,true);};}()),updateEnforceMultiple:function(e){var b=e==="I";if(!b){var a=this.data.getProperty("/Terms");var i=this.data.getProperty("/Rewards");a.forEach(function(j){j.Selection.SubDiscountValue=null;this.productDetails.update(j,"SubDiscountValue",null);},this);i.forEach(function(j){j.Selection.SubDiscountValue=null;this.productDetails.update(j,"SubDiscountValue",null);},this);r(this.data);}},validateCombo:function(a,b){var e=a.getValue();b=a.getBindingContext().getPath()+b;U.removeMessagesByPath(b);if(!e){return false;}var i=function(x1,y1){var C1=U.getI18NModel().getResourceBundle();var D1=C1.getText("CreateOffer.Terms.InvalidEntry.Title");var E1="";switch(x1){case"Terms":E1=C1.getText("CreateOffer.Terms.InvalidEntry.Description",y1);break;case"Rewards":E1=C1.getText("CreateOffer.Terms.Reward.InvalidEntry.Description",y1);break;}return{message:D1,description:E1};};var j=a.getProperty("selectedKey");if(!j){var x=b.split("/");var x1=x[1];var y1=x[2];y1=parseInt(y1,10)+1;var z1=U.getMessageManager();var A1=i(x1,y1);var B1=[{message:A1.message,description:A1.description,type:"Error",target:b,processor:a.getBindingContext().getModel()}];U.setErrorMessages(z1,B1);return false;}return true;},discountTypeChanged:function(e){var a=e.getSource();var b=m(e);b.Selection.DiscountValue=null;b.Selection.SubDiscountValue=null;this.updateDiscountDescription(b);var i=b;if(!b.isWholeOffer&&b.ForTerm){b=b.ForTerm;}b.DiscountTypeLabel=a.getValue();b.DiscountType=i.Selection.DiscountType;b.DiscountValue=i.Selection.DiscountValue;b.SubDiscountValue=i.Selection.SubDiscountValue;this.productDetails.update(b,"DiscountTypeLabel",b.DiscountTypeLabel);this.productDetails.update(b,"DiscountType",b.DiscountType);this.productDetails.update(b,"DiscountValue",null);this.productDetails.update(b,"SubDiscountValue",null);this.validateCombo(a,"/Selection/DiscountType");var j=this.productDetails.getIndicesForTerm(b);j.forEach(function(x){var x1="/ProductDetails/"+x;var y1=x1+"/DiscountValue";var z1=x1+"/SubDiscountValue";U.removeMessagesByPath(y1);U.removeMessagesByPath(z1);});},onSubConditionChange:function(e){var a=e.getSource();this.validateCombo(a,"/Selection/Type");},onUoMValueChanged:function(e){var a=e.getSource();var b=this.validateCombo(a,"/Selection/UnitOfMeasure");if(b){this.updateProductDetails(e,"PromotedUoM");}},onPromoCostPriceCurrencyChanged:function(e){var a=e.getSource();var b=this.validateCombo(a,"/Selection/PromoCostPriceCurrency");if(b){this.updateProductDetails(e,"PromoCostPriceCurrency");}},onSubIncentiveChange:function(e){var a=e.getSource();this.validateCombo(a,"/Selection/Type");},onProductDimensionChange:function(e){var a=m(e);var b=e.getSource();this.updateDiscountDescription(a);this.validateCombo(b,"/Selection/DimensionType");this.productDetails.remove(a);this.productDimensionChanged(e);r(this.data);},onDiscountAssignmentChange:function(e){var a=e.getSource();this.validateCombo(a,"/Selection/DiscountAssignment");},onDiscountVarietyChange:function(e){var a=e.getSource();this.validateCombo(a,"/Selection/Variety");},toggleVisibity:function(e){var a=e.getSource().getBindingContext().getObject();a.More=a.More||{};a.More.Visible=!a.More.Visible;r(this.data);},updateProductDetails:function(e,a){var b=m(e);if(!b.isWholeOffer&&b.ForTerm){b=b.ForTerm;}var i=e.getParameter("newValue");if(i){i=i.replace(",",".");}this.productDetails.update(b,a,i);return i;},updateDiscountDescription:function(a){var b=this;var e=a;if(a.Selection.DiscountType==="04"){e.DiscountDescription="%";}else{var i=a.Selection.ProductId||a.Selection.HierarchyNodeId||a.Selection.HiearchyId;var j=a.Selection.DimensionType;var x=!!i&&!!j;if(x){M.getProductById(i,j).then(function(x1){e.DiscountDescription=x1.ProductDetail.Currency;r(b.data);});}else{e.DiscountDescription=null;}}},genericHandler:function(e,a,i){var b=U.validationHandler(a,e,i,this.data.getData(),this.data);if(e.getParameter("dimensionTrigger")&&b){e.getSource().setValue("");var j=e.getSource().getBindingContext().sPath+i;U.removeMessagesByPath(j);}},handleSelectedSubIncentiveExtProductId:function(e){this.genericHandler(e,"emptyValidation","/Selection/ExtProductId");},handleSelectedSubIncentiveQuantity:function(e){this.genericHandler(e,"numericValidation","/Selection/Quantity");},handleSelectionQuantity:function(e){this.genericHandler(e,"numericValidation","/Selection/Quantity");},handleSelectionQuantityChange:function(e){var i=U.validationHandler("numericValidation",e,"/Selection/Quantity",this.data.getData(),this.data);if(!i){this.updatePackageAppropiation();this.updatePackageUserProjection();}},handleSelectionMinAmount:function(e){this.genericHandler(e,"minAmountValidation","/Selection/MinAmount");},handleSelectionUserProjection:function(e){this.genericHandler(e,"greaterOrEqualValidation","/Selection/UserProjection");},handleSelectionPromoCostPrice:function(e){this.genericHandler(e,"greaterOrEqualValidationWithMax","/Selection/PromoCostPrice");},handleSelectionDiscountValue:function(e){this.genericHandler(e,"minDiscountValidation","/Selection/DiscountValue");},handleSelectionSubDiscountValue:function(e){this.genericHandler(e,"minDiscountValidation","/Selection/SubDiscountValue");},handleSelectedSubIncentiveCost:function(e){this.genericHandler(e,"greaterOrEqualValidation","/Selection/Cost");},handleSelectedSubIncentiveAdjustedCost:function(e){this.genericHandler(e,"greaterOrEqualValidation","/Selection/AdjustedCost");},handleSelectedSubIncentiveValue:function(e){this.genericHandler(e,"greaterOrEqualValidation","/Selection/Value");},handleSelectedSubIncentiveAdjustedValue:function(e){this.genericHandler(e,"greaterOrEqualValidation","/Selection/AdjustedValue");},handleSelectedSubIncentiveRedemptionRate:function(e){this.genericHandler(e,"rangeValidation","/Selection/RedemptionRate");},triggerDimensionValidation:function(e){var a=function(){var y1=null;var x1=e.getSource().getParent().getParent();if(x1.getMetadata().getName().indexOf("FormContainer")>-1&&x1.getVisible()){y1=x1;}else{var z1=x1.getAggregation("items");var A1=null;for(var i=0,B1=z1.length;i<B1;i++){if(z1[i].getMetadata().getName().indexOf("sap.ui.layout.form.Form")>-1){A1=z1[i];}}if(A1){var C1=A1.getAggregation("formContainers");for(var j=0,D1=C1.length;j<D1;j++){if(C1[j].getMetadata().getName().indexOf("sap.ui.layout.form.FormContainer")>-1&&C1[j].getVisible()){y1=C1[j];}}}}return y1;};var b=function(){var y1=x1.getAggregation("formElements");for(var i=0,z1=y1.length;i<z1;i++){var A1=y1[i].getAggregation("fields");if(A1.length>0){for(var j=0,B1=A1.length;j<B1;j++){var C1=A1[j].getMetadata().getName().indexOf("Input")>-1?A1[j]:null;if(C1&&C1.getVisible()){var D1=C1.getValue();x(C1,D1);}}}}};var x=function(i,j){i.fireLiveChange({value:j,dimensionTrigger:true});};var x1=a();b();},openQuickView:function(e){function a(B1){var D1=jQuery.extend(true,{},B1);D1.DiscountDescription="";if(D1.DiscountType==="04"){D1.DiscountDescription="%";}else if(D1.DiscountType==="05"||D1.DiscountType==="06"){D1.DiscountValue=null;}return((D1.DiscountValue||D1.Selection.DiscountValue)||0).toString().concat(" ").concat(D1.DiscountDescription);}function b(D1,B1){return{Items:[{label:B1.DimensionTypeText,text:B1.ProductTextValue+" - "+B1.ProductDescriptionValue},{label:"{i18n>CreateOffer.Terms.Freestyle.QuantityAndUnitOfMeasure}",text:(B1.Selection.Quantity||"0")+" / "+B1.Selection.UnitOfMeasure},{label:"{i18n>CreateOffer.Terms.FreestyleOffer.DiscountType}",text:B1.DiscountTypeLabel||"-"},{label:"{i18n>CreateOffer.Terms.FreestyleOffer.DiscountValue}",text:a(B1)}]};}var i=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.terms.styles.QuickViewTerm",{afterClose:function(){this.destroy();}});var j=new J({});var x=this.data.getProperty(e.getSource().getParent().getBindingContext().getPath());var x1=this.data.getProperty("/TermFinancialFields").filter(function(D1){return D1.TermType+"-"+D1.Identifier===x.ParentId;})[0];var y1=x1.Items.map(function(D1){D1.label=D1.label.replace(":","");return D1;});var z1=x1.TermType+"-"+x1.Identifier;var A1=this.data.getProperty("/Terms").concat(this.data.getProperty("/Rewards"));var B1=A1.filter(function(D1){return D1.TermType+"-"+D1.Identifier===z1;})[0];var C1=b(this,B1);j.setData({Financials:y1,Term:C1});i.setModel(j);i.setModel(U.getI18NModel(),"i18n");i.setModel(this.getView().getModel("featuresAvailable"),"featuresAvailable");i.openBy(e.getSource());},onLocationSubGroupsChecked:function(e){var a=e.getParameter("object");var b=e.getParameter("name");var i=e.getParameter("selected");this.productDetails.subGroupChecked({data:a,name:b,selected:i});},hideProducts:function(e){var a=e.getParameter("selectedPaths")||[];var b={view:this.getView(),title:"{i18n>CreateOffer.HideProductTitle}",message:a.length>1?"{i18n>CreateOffer.OfferHideProductsDialogDescription}":"{i18n>CreateOffer.OfferHideProductDialogDescription}",state:"Warning",btnOk:"{i18n>ManageOffers.ProductDetails.Hide}",btnCancel:"{i18n>CreateOffer.CreateOfferDialog.Reject}",onOk:function(x1){x1();},onCancel:function(x1,y1){y1();}};var i=this.data.getProperty("/Terms");var j=this.data.getProperty("/Rewards");var x=this;U.createDialogUtil(b).then(function(){var x1=a.map(function(A1){var B1=x.data.getProperty(A1);var C1=parseInt(A1.match(/\d+$/)[0],10);return jQuery.extend(true,{Index:C1},B1);});var y1=function(A1){var B1=(A1.TermProducts||[]).reduce(function(C1,D1){var id=D1.ProductId||D1.HierarchyNodeId||D1.HierarchyId;C1[id]=D1;return C1;},{});x1.forEach(function(C1){var D1=C1.ProductId||C1.HierarchyNodeId||C1.HierarchyId;C1.Visibility="-";if(B1[D1]){B1[D1].Visibility="-";}});A1.TermProducts=Object.keys(B1).map(function(C1){return B1[C1];});};i.forEach(y1);j.forEach(y1);x.productDetails.hideProducts(x1);var z1=x.getView().byId("productDetailsTable");z1.clearSelection();});},addMoreProducts:function(e){var a=[];if(e.getId()==="select"){var i=e.getParameter("selected");var b=e.getSource().getBindingContext().getPath();var j=this.data.getProperty(b);var x=j.ProductId||j.HierarchyNodeId||j.HierarchyId;}else{a=e.getParameter("selections")||[];}var x1=this.data.getProperty("/Terms");var y1=(this.data.getProperty("/Rewards")||[]).filter(function(B1){return B1.isWholeOffer;});var z1=this;var A1=function(B1){var C1=B1.Selection;var id=C1.ProductId||C1.HierarchyNodeId||C1.HierarchyId;if(!id){return;}var E1=C1.DimensionType+"#"+U.base64ToHex(id);if(!a[E1]){if(j){a[E1]={Products:[]};a[E1].Products.push(j);}else{return;}}var F1=(z1.productDetails.getForTermData(B1)||[]).reduce(function(D1,G1){var H1=G1.ProductId||G1.HierarchyNodeId||G1.HierarchyId;D1[H1]=G1;return D1;},{});a[E1].Products.forEach(function(D1){var G1=D1.ProductId||D1.HierarchyNodeId||D1.HierarchyId;if(F1[G1]){F1[G1].Visibility="+";}else{D1.Visibility="+";F1[G1]=D1;}if(x&&x===G1&&!i){F1[G1].Visibility="";}});B1.TermProducts=Object.keys(F1).map(function(D1){return F1[D1];});if(!x){z1.productDetails.remove(jQuery.extend(true,{},B1));z1.productDetails.add(B1.TermProducts,B1);}};x1.forEach(A1);y1.forEach(A1);},openDetailsMassEditDialog:function(e){var a=this;var b=e.getParameter("selectedPaths")||[];var i=b.map(function(x){var x1=a.data.getProperty(x);var y1=parseInt(x.match(/\d+$/)[0],10);return jQuery.extend(true,{Index:y1},x1);});if(i.length>0){i.CurrencyList=this.content.getProperty("/CurrencyList");};var j=this.getView().getModel("TermsContentModel").getProperty("/EnforceMultipleValue");return new d(this.productDetails,i,this.productDetailsEditableFields(),j).openDialog();},productDetailsEditableFields:function(){return["DiscountValue","SubDiscountValue","DisplayUoM","LockUserProjection","UserProjection","DisplayUoMValue","PromotedUoM","PromoCostPrice","PromoCostPriceCurrency"];},validateProductDetailsUserProjection:function(e){var a=m(e);this.productDetails.validateItem(a,"UserProjection");},validateProductDetailsDisplayUoMValue:function(e){var a=m(e);this.productDetails.validateItem(a,"DisplayUoMValue");},validateProductDetailsPromoCostPrice:function(e){var a=m(e);this.productDetails.validateItem(a,"PromoCostPrice");},validateProductDetailsPromoCostPriceCurrency:function(e){var a=m(e);var b=this.productDetails.validateItem(a,"PromoCostPriceCurrency");var i=e.getSource();if(b!=""){i.setValueState(sap.ui.core.ValueState.Error);i.setValueStateText(b);}else{i.setValueState(sap.ui.core.ValueState.None);i.setValueStateText("");}},validateProductDetailsDisplayUoM:function(e){var a=m(e);var b=this.productDetails.validateItem(a,"DisplayUoM");var i=e.getSource();if(b!=""){i.setValueState(sap.ui.core.ValueState.Error);i.setValueStateText(b);}else{i.setValueState(sap.ui.core.ValueState.None);i.setValueStateText("");}},validateProductDetailsPromotedUoM:function(e){var a=m(e);var b=this.productDetails.validateItem(a,"PromotedUoM");var i=e.getSource();if(b!=""){i.setValueState(sap.ui.core.ValueState.Error);i.setValueStateText(b);}else{i.setValueState(sap.ui.core.ValueState.None);i.setValueStateText("");}},validatePackageAppropiation:function(a,b){var e=false;var i=U.getMessageManager();var j=[];var x=U.getI18NModel().getResourceBundle();U.removeMessagesByPath("/Rewards");var x1=b.reduce(function(y1,z1,A1){var B1=parseFloat(z1.PercentageValue);var C1=parseFloat(z1.PackageValue);z1.SubDiscountValueError="None";z1.DiscountValueError="None";if(B1>100||B1<0){e=true;j.push({message:x.getText("CreateOffer.Terms.FreestyleOffer.Invalid.AppropriationPercentage.Title"),description:x.getText("CreateOffer.Terms.FreestyleOffer.Invalid.AppropriationPercentage.Description"),type:"Error",target:"/Rewards/"+A1+"/PercentageValue"});}if(C1<0||C1>a){e=true;j.push({message:x.getText("CreateOffer.Terms.FreestyleOffer.Invalid.AppropriationValue.Title"),description:x.getText("CreateOffer.Terms.FreestyleOffer.Invalid.AppropriationValue.Description"),type:"Error",target:"/Rewards/"+A1+"/PackageValue"});}if(z1.PercentageValue&&z1.PackageValue){z1.SubDiscountValueError="Error";z1.DiscountValueError="Error";e=true;j.push({message:x.getText("CreateOffer.Terms.FreestyleOffer.Invalid.AppropriationPackage.Title"),description:x.getText("CreateOffer.Terms.FreestyleOffer.Invalid.AppropriationPackage.Description"),type:"Error",target:"/Rewards/ApportionmentPercentageAndValue"});}y1.percentage+=C1?parseFloat(z1.Selection.SubDiscountValue):(B1||0);y1.value+=B1?parseFloat(z1.Selection.DiscountValue):(C1||0);return y1;},{value:0,percentage:0});if(x1.percentage>100&&!e){e=true;b.forEach(function(y1){y1.SubDiscountValueError="Error";});j.push({message:x.getText("CreateOffer.Terms.FreestyleOffer.Invalid.AppropriationPercentageTotal.Title"),description:x.getText("CreateOffer.Terms.FreestyleOffer.Invalid.AppropriationPercentageTotal.Description"),type:"Error",target:"/Rewards/AppropriationPercentageTotal"});}if(x1.value>a&&!e){e=true;b.forEach(function(y1){y1.DiscountValueError="Error";});j.push({message:x.getText("CreateOffer.Terms.FreestyleOffer.Invalid.AppropriationValueTotal.Title"),description:x.getText("CreateOffer.Terms.FreestyleOffer.Invalid.AppropriationValueTotal.Description"),type:"Error",target:"/Rewards/AppropriationValueTotal"});}U.setErrorMessages(i,j,this.data);r(this.data);return e;},updatePackage:function(a){if(!this.generalModel.getProperty("/PackageOffer")){return;}var b=this.getView().getModel("TermsContentModel").getProperty("/PackageValue");if(!b){b="0";this.getView().getModel("TermsContentModel").setProperty("/PackageValue",b);}var e=parseFloat(b);var i=this.data.getProperty("/Rewards");if(!this.validatePackageAppropiation(e,i)){var e=parseFloat(this.getView().getModel("TermsContentModel").getProperty("/PackageValue"));var j=u1(i,e,a);var x=q1(j,e);var x1=r1(e,x);v1(this.data,x1,this.productDetails);}},updatePackageUserProjection:(function(){function a(i){i.Selection.UserProjection="0";}function b(i){return function(j){j.Selection.UserProjection=((j.Selection.Quantity||1)*i)+"";};}function e(i){var j=parseFloat(i);return!(i===null||i===undefined||j<=0);}return function(){if(!this.generalModel.getProperty("/PackageOffer")){return;}var i=this.getView().getModel("TermsContentModel").getProperty("/UserProjectionValue");var j=this.data.getProperty("/Terms");if(e(i)){j.forEach(b(parseFloat(i)));}else{j.forEach(a);this.getView().getModel("TermsContentModel").setProperty("/UserProjectionValue","0");}r(this.data);};}()),handleFilter:function(e){var a=this.getView().byId("smartProductDetailsTable");a.filterColumn(e);},updatePackageAppropiation:function(){this.updatePackage(t1);},validateProductDetailsDiscountValue:function(e){this.genericHandler(e,"minDiscountProductDetails","/DiscountValue");},validateProductDetailsSubDiscountValue:function(e){this.genericHandler(e,"minDiscountProductDetails","/SubDiscountValue");},termValuesUpdated:function(e){var a=m(e);jQuery.extend(a.Selection,e.getParameter("values"));}};["DiscountValue","SubDiscountValue"].forEach(function(a){w1["update"+a]=function(e){var b=this.updateProductDetails(e,a);var i=m(e);if(i.ForTerm){i.ForTerm[a]=b;}var j=U.getMessageManager();var x=j.getMessageModel().getData();var x1=x.filter(function(y1){return y1.target.indexOf("/ProductDetailsVisible")===-1||y1.target.indexOf(a)===-1;});j.removeAllMessages();j.addMessages(x1);};});["PromoCostPrice","PromoCostPriceCurrency","Quantity"].forEach(function(a){w1["update"+a]=function(e){this.updateProductDetails(e,a);};});return T.extend("retail.pmr.promotionaloffers.plugins.terms.styles.Freestyle",w1);});
