/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","retail/pmr/promotionaloffers/utils/Models","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/utils/TreeValueHelpDialog","retail/pmr/promotionaloffers/utils/OfferOperations","retail/pmr/promotionaloffers/utils/Formatter","sap/ui/model/json/JSONModel"],function(C,M,U,T,O,F,J){"use strict";var m=U.getErrorHandler().createMessagePopover();var h=function(d){var f=d[0].MasterdataSystem;return d.every(function(i){return i.MasterdataSystem===f;});};return C.extend("retail.pmr.promotionaloffers.view.ManageOffers",{onInit:function(){this.content=new J({DeleteEnabled:false,EditEnabled:false,Editable:false,OfferFunctionsEnabled:false,CollisionEnabled:false,ContentEnabled:false});this.featuresAvailable=new J();this.model=M.getServiceModel();this.getView().setModel(this.content,"Content");this.getView().setModel(this.model);this.getView().setModel(this.featuresAvailable,"featuresAvailable");this.offersSmartTable=this.getView().byId("offers");this.offers=this.getView().byId("offersTable");this.oBus=sap.ui.getCore().getEventBus();this.i18nModel=this.getOwnerComponent().getModel("i18n");this.oMessageManager=U.getMessageManager();m.setModel(this.oMessageManager.getMessageModel());this.oRouter=this.getRouter();this.oBus.subscribe("retail.pmr.promotionaloffers","onMasterDataSystemChange",this.onMasterDataSystemChange,this);this.getRouter().attachRouteMatched(function(e){var p=e.getParameter("name");if(p==="manage"){this.model.refresh(true);this.refreshOffersTable();}}.bind(this));U.addMasterdataSystemButton(this.oBus,this.i18nModel);this.setFeaturesAvailable();this.offerOperations=new O(this.getOwnerComponent().getState());},onExit:function(){this.oBus.unsubscribe("retail.pmr.promotionaloffers","onMasterDataSystemChange",this.onMasterDataSystemChange,this);},onBeforeRebindTable:function(e){this.oMessageManager.removeAllMessages();var b=e.getParameter("bindingParams");b.parameters.countMode=sap.ui.model.odata.CountMode.Inline;var q=b.parameters.select;var f=U.getFieldsFromSort(b.sorter);if(!U.getStatusField()){if(U.hasEntitySetProperty("UIState","Offers",e.getSource().getModel().getMetaModel())){U.setStatusField("UIState");}else{U.setStatusField("Status");}}b.parameters.select=U.attachFieldsToQuery(["OfferId","Editable","OfferSetId","PromotionType","MasterdataSystem","PurchasingGroup","PurchasingGroupName","LeadingCategoryName","LeadingCategory"].concat(U.getStatusForSearch()).concat(f),q);},onNavButtonPress:function(){var H=sap.ui.core.routing.History.getInstance();var p=H.getPreviousHash();if(p!==undefined){window.history.go(-1);this.refreshOffersTable();}},onMasterDataSystemChange:function(c,e,o){M.setMasterDataSystemPersonalization(o.MasterdataSystemId);},copyOffer:function(o){this.oRouter.navTo("copy",{path:U.base64ToHex(o.OfferId)});},setFeaturesAvailable:function(){var a=this.getModels();a.getFeaturesAvailable().then(function(d){if(!d&&!d.length){return;}var r=U.setupFeatures(d);this.featuresAvailable.setData(r);}.bind(this),U.handleErrors);},handleDeletePress:function(){this.oMessageManager.removeAllMessages();U.openDeleteConfirmDiaog().then(function(){this.batchDelete();}.bind(this));},batchDelete:function(){var s=this.offers.getSelectedContextPaths().map(function(p){return p.split("'")[1];});if(!s.length){return;}var b=this.i18nModel.getResourceBundle();U.getErrorHandler().showBusy(b.getText("CreateOffer.BusyIndicatorDeleteOffer.LoadingMessage"));M.deleteOffers(s).then(function(r){U.getErrorHandler().hideBusy();if(U.getErrorHandler().numOfErrors(this.oMessageManager)>0){U.getErrorHandler().showError(b.getText("ManageOffers.MassDelete.Error"));}else{U.getErrorHandler().showToast(b.getText("ManageOffers.MassDelete.Success"));}this.model.refresh(true);this.refreshOffersTable();}.bind(this),function(e){U.getErrorHandler().hideBusy();U.handleErrors(e);});},toggleToolbarButtons:function(e){var s=e.getSource().getSelectedContexts();var S=s.length;this.content.setProperty("/OfferFunctionsEnabled",!!S);this.content.setProperty("/EditEnabled",false);this.content.setProperty("/Editable",false);this.content.setProperty("/CollisionEnabled",false);this.content.setProperty("/ContentEnabled",false);if(S===1){this.content.setProperty("/Editable",true);this.content.setProperty("/CollisionEnabled",true);this.content.setProperty("/EditEnabled",true);this.content.setProperty("/ContentEnabled",true);}else if(S>1){this.content.setProperty("/EditEnabled",true);}this.content.setProperty("/DeleteEnabled",!!S);},createOfferPressed:function(){this.oMessageManager.removeAllMessages();this.getRouter().navTo("create");},copyOfferPressed:function(){this.oMessageManager.removeAllMessages();var o=this.offers.getSelectedItem().getBindingContext().getObject();U.navTocopyOffer(this.oRouter,o);},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this);},updateMultipleOffers:function(d){var k=Object.keys(d);var r={};for(var i=0;i<k.length;i++){if(d[k[i]].Selected){if(d[k[i]].map.Name&&d[k[i]].map.Id){r[d[k[i]].map.Name]=d[k[i]].map.Id==="PurchasingGroup"?"":d[k[i]].Value;r[d[k[i]].map.Id]=d[k[i]].Id;}else if(d[k[i]].hasOwnProperty("Id")){r[k[i]]=d[k[i]].Id;}}}if(Object.keys(r).length===0){return;}if(r.EndOfOffer){r.EndOfOffer=U.getFormatedDateForSave(r.EndOfOffer);}if(r.StartOfOffer){r.StartOfOffer=U.getFormatedDateForSave(r.StartOfOffer);}var s=this.getSelectedOffers();var S=this.offers.getSelectedItems();var o=this.model;U.getErrorHandler().showBusy(this.i18nModel.getResourceBundle().getText("ManageOffers.UpdateMultipleOffers"));M.updateOffers(r,s,S).then(function(){o.refresh(true);U.getErrorHandler().hideBusy();},function(e){U.handleErrors(e);U.getErrorHandler().hideBusy();});},createMultipleEditDialog:function(d){var t=this;var D=sap.ui.xmlfragment("retail.pmr.promotionaloffers.fragments.MassChangeDialog",{onAfterClose:function(){D.destroy();D=null;},onCancelPress:function(){D.close();},onOkPress:function(){t.updateMultipleOffers(D.getModel("Data").getData());D.close();D.destroy();D=null;},offerSetValueChanged:function(e){D.getModel("Data").setProperty("/OfferSetId/Value",e.getParameter("newValue"));},promotionTypeValueChanged:function(e){D.getModel("Data").setProperty("/PromotionType/Value",e.getParameter("newValue"));},purchasingGroupValueChanged:function(e){D.getModel("Data").setProperty("/PurchasingGroup/Value",e.getParameter("newValue"));},handleLeadingCategoryComplexSearch:function(){var l=D.getModel("Data").getData().LeadingCategoriesSet||[];T.openDialog({tableFragment:"retail.pmr.promotionaloffers.plugins.general.LeadingCategoryComplexSearch",title:"{i18n>CreateOffer.MerchCategorySearch.Title}",filterProps:["ExtId","Name","HierarchyDescription","ExtHierarchyId"],values:U.buildHierarchy(l,"LeadingCategory")}).then(function(s){D.getModel("Data").setProperty("/LeadingCategory/Value",s.ExtId);D.getModel("Data").setProperty("/LeadingCategory/Id",s.Id);});}});D.setModel(U.getI18NModel(),"i18n");var a=new J(d);D.setModel(a,"Data");D.setModel(M.getServiceModel());D.open();return D;},addDataMultipleEdit:function(d,a){var b=d.getModel("Data");var i=b.getData();jQuery.extend(a,i);b.setData(a);},processOffersMultipleEdit:function(d){var P=[{Key:"OfferSetId",MDDependent:false,Name:"OfferSetName",Id:"OfferSetId"},{Key:"PromotionType",MDDependent:true,Name:"PromotionTypeDescription",Id:"PromotionType"},{Key:"LeadingCategory",MDDependent:true,Name:"LeadingCategoryName",Id:"LeadingCategory"},{Key:"PurchasingGroup",MDDependent:true,Name:"PurchasingGroupName",Id:"PurchasingGroup"},{Key:"StartOfOffer",MDDependent:false,Name:null,Id:null},{Key:"EndOfOffer",MDDependent:false,Name:null,Id:null}];function g(k){return d.map(function(i){return i[k];});}function c(b){function e(j){return new Date(Date.UTC(j.getUTCFullYear(),j.getUTCMonth(),j.getUTCDate()));}function f(r,j){if(!r||!j){return null;}return e(r).getTime()===e(j).getTime()?e(j):null;}function i(r,j){return j===r?j:"";}return b.reduce(function(r,j){return j instanceof Date?f(r,j):i(r,j);},b[0]);}function a(r,i,v,n,s){if(v!==undefined){if(i.Key==="StartOfOffer"||i.Key==="EndOfOffer"){v=v?U.addTimezoneOffset(v):null;}r[i.Key]={Value:n,Id:!i.MDDependent||s?v:null,Selected:false,Enabled:!i.MDDependent||s,map:{Name:i.Name,Id:i.Id}};}return r;}return P.reduce(function(r,i){var v=c(g(i.Key));var n=c(g(i.Name));var s=h(d);return a(r,i,v,n,s);},{});},getModels:function(){return M;},addMDDependentSets:function(d,a){d.getModel("Data").setProperty("/LeadingCategory/Busy",true);var l=this.getModels().getLeadingCategoriesSet(a).then(function(L){this.addDataMultipleEdit(d,{LeadingCategoriesSet:L});}.bind(this),U.handleErrors);var p=this.getModels().getPromotionTypeSet(a).then(function(b){this.addDataMultipleEdit(d,{PromotionTypeSet:b});}.bind(this),U.handleErrors);var P=this.getModels().getPurchasingGroupSet(a).then(function(b){this.addDataMultipleEdit(d,{PurchasingGroupSet:b});}.bind(this),U.handleErrors);Promise.all([l,p,P]).then(function(){d.getModel("Data").setProperty("/LeadingCategory/Busy",false);});},editMultipleOffers:function(d){var r=this.i18nModel.getResourceBundle();function a(o){var j={Status:o.Status,UIState:o.UIState};return U.isEditableHeader(j)||U.isReadOnly(j);}function n(o){return o.Editable===false;}function i(o){return n(o)||a(o);}function b(j,k,l){return l.indexOf(j)===k;}function g(o){return o.StatusName;}function f(s){if(s.length===1){return s[0];}var j=s.slice(0,s.length-1);var l=s[s.length-1];return jQuery.sap.formatMessage(r.getText("ManageOffers.offerNotEditableOr"),j.join(", "),l);}if(Array.isArray(d)&&d.some(i)){var t="";if(d.every(a)){var s=f(d.map(g).filter(b));t=jQuery.sap.formatMessage(r.getText("ManageOffers.offerNotEditableStatus"),s);}else if(d.every(n)){t=r.getText("ManageOffers.offerNotEditable");}else{t=r.getText("ManageOffers.offerNotEditableGeneric");}U.getErrorHandler().showError(t);return;}var p=this.processOffersMultipleEdit(d);var c=this.createMultipleEditDialog(p);var e=h(d);if(e){this.addMDDependentSets(c,d[0].MasterdataSystem);}this.addDataMultipleEdit(c,{OfferSet:{}});},getSelectedOffers:function(){return this.offers.getSelectedItems().map(function(i){return i.getBindingContext().getObject();});},getSelectedOffersLength:function(){return this.getSelectedOffers().length;},editOfferPressed:function(){var a=function(){return this.getSelectedOffersLength()>1;}.bind(this);this.oMessageManager.removeAllMessages();var s=this.getSelectedOffers();if(a()){this.editMultipleOffers(s);}else{U.navToEditOffer(this.oRouter,s[0]);}},createFromVendorFunds:function(){this.getRouter().navTo("vendorFunds");},displayOffer:function(e){this.oMessageManager.removeAllMessages();var o=e.getSource().getBindingContext().getObject();this.oRouter.navTo("display",{path:U.base64ToHex(o.OfferId)});},handleOfferFunctionsDialogSearch:function(e){var v=e.getParameter("value");var f=new sap.ui.model.Filter("ActionName",sap.ui.model.FilterOperator.Contains,v);var b=e.getSource().getBinding("items");b.filter([f]);},handleOfferFunctionPress:function(e){this.oMessageManager.removeAllMessages();var a=e.getSource().data("area");var s=this.getSelectedOffers();if(!this.oSelectDialog){this.oSelectDialog=sap.ui.xmlfragment("retail.pmr.promotionaloffers.fragments.OfferFunctionsDialog",this);this.oSelectDialog.setModel(new J());this.oSelectDialog.setContentHeight("30%");}var t=e.getSource().getProperty("text");this.oSelectDialog.getModel().setData({Title:t,Items:[]});M.getOffersActions(s,a).then(function(d){var c=this.getCommonAreaActions(d.data);this.oSelectDialog.getModel().setData({Title:t,Items:c});var b=this.oSelectDialog.getBinding("items");b.filter([]);this.oSelectDialog.open();}.bind(this),U.handleErrors);},onCollisionDetection:function(){this.content.setProperty("/CollisionEnabled",false);var o=this.offers.getSelectedItem().getBindingContext().getObject();var v=this.getView();M.getOffer(o).then(function(d){this.oMessageManager.removeAllMessages();var p=d.data;p.Terms=p.Terms.results||[];this.offerOperations.detectCollision().then(function(a){this.offerOperations.populateCollisionDetection(a,p,v).then(function(){this.content.setProperty("/CollisionEnabled",true);}.bind(this));}.bind(this));}.bind(this));},onOfferContent:function(){var o=this.offers.getSelectedItem().getBindingContext().getObject();U.toOfferContent(o.OfferId,this.getOwnerComponent().getMetadata().getConfig());},getCommonAreaActions:function(a){var A,c,i;var p=a.length;var b=Infinity;while(p){if(a[--p].length<b){b=a[p].length;A=p;}}c=a.splice(A,1)[0];return c.filter(function(I){return a.every(function(d){for(i=0;i<d.length;i++){if(d[i].Action===I.Action){return true;}}return false;});});},offerFunctionsConfirmSelectDialog:function(E){var s=this.getSelectedOffers();var S=E.getParameter("selectedItem").getBindingContext().getObject();var a="";var b=this.i18nModel.getResourceBundle();var A=this.model.getServiceMetadata().dataServices.schema[0].entityContainer[0].functionImport;var H=A.filter(function(f){return(f.name==='MassOfferTransfer');});U.getErrorHandler().showBusy();if(H.length>0&&S.Action==='04'&&S.Area==='T'){var o=M.executeMassOfferTransfer(s);}else{var o=M.getExecuteOffersActions(s,S.Action,S.Area);}o.then(function(){U.getErrorHandler().hideBusy();if(U.getErrorHandler().numOfErrors(this.oMessageManager)>0){a=b.getText("ManageOffers.MassProcess.Error");U.getErrorHandler().showError(a);}else{a=b.getText("ManageOffers.MassProcess.Success");U.getErrorHandler().showToast(a);}this.model.refresh(true);}.bind(this),function(e){U.getErrorHandler().hideBusy();U.handleErrors(e);});},refreshOffersTable:function(){this.offers.removeSelections();this.content.setProperty("/DeleteEnabled",false);this.content.setProperty("/OfferFunctionsEnabled",false);this.content.setProperty("/EditEnabled",false);this.content.setProperty("/Editable",false);this.content.setProperty("/CollisionEnabled",false);},onMessagesIndicatorPress:function(e){m.openBy(e.getSource());}});});
