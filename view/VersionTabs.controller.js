/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/utils/OfferOperations","retail/pmr/promotionaloffers/plugins/versions/VersionsSelector","retail/pmr/promotionaloffers/utils/Models","retail/pmr/promotionaloffers/utils/controls/ValueHelpDialogTokenizer","retail/pmr/promotionaloffers/plugins/versions/VersionsHelper","retail/pmr/promotionaloffers/view/CommunicationServices","sap/ui/core/routing/History","retail/pmr/promotionaloffers/utils/ForecastDialog"],function(C,J,U,O,V,M,a,b,c,H,F){"use strict";function d(e,j){var x=[];var K=null;if(j.length>=2){for(var i=0,L=j.length;i<L;i++){x.push(U.getNodeType(j[i],"NodeId","NodeType"));}var N=e.NodeId||e.LocationId;var P;for(var k=0;k<j.length;k++){if(k==0){P=j[0].Name.concat(" (",j[0].ExtLocationId,")");}else{if(P.length>40){P=P.substring(0,37)+"...";break;}P=(P).concat(";",j[k].Name," (",j[k].ExtLocationId,")");}}if(P.length>40){P=P.substring(0,37)+"...";}K={"ParentId":N,"Description":P,"Children":x,"HierarchyId":e.HierarchyId};}else{var Q=j[0].NodeId||j[0].LocationId;K={"LocationNodeId":Q,"HierarchyId":e.HierarchyId};}return K;}var f=10000;var g=0;var m=U.getErrorHandler().createMessagePopover();function s(e,i){if(e&&!i){return false;}return true;}function h(e){e.isForSave=true;e.removeFinancial=true;var i=e.state.hasChanges();return i;}function l(e){if(s(h(e.controller),e.controller.isDisplayMode)){return Promise.resolve();}function i(k){k();}function j(k,x){x();}return U.createDialogUtil(jQuery.extend(e,{onOk:i,onCancel:j}));}function n(e){this.getOfferData=function(){if(!e){return{};}return e.preparePayloadForSave(true,true);};this.getOfferWithFinancials=function(){if(!e){return{};}return e.preparePayloadForSave(true,true);};}function o(e,j){if(e){for(var i=0;i<e.length;i++){var k=null;if(e[i]){k=e[i].LocationNodeId||e[i].LocationId||e[i].ExtLocationNodeId;}var x=j.LocationNodeId||j.LocationId||j.ExtLocationNodeId||j.NodeId;if(k===x){return i;}}}return-1;}function p(e){for(var i in e){if(e.hasOwnProperty(i)){return false;}}return true;}function q(e,i,j){var k=i;if(!j){k=i.substring(0,i.lastIndexOf("/"));}var x=null;var K=0;do{var L=e.getContextByIndex(K);if(L&&L.sPath===k){x=y(L);break;}K++;}while(L);return x;}function r(e,j,k){var x={};var K=false;var L=function(e,j){if(e&&j){for(var i=0;i<e.length;i++){var N=e[i].LocationNodeId||e[i].LocationId||e[i].ExtLocationNodeId;var P=j.LocationNodeId||j.NodeId||j.ExtLocationId;if(N===P){x=e[i];x.Readonly=k.isDisplayMode;if(k.locationSelected.LocationNodeId!==N&&k.locationSelected.ExtLocationId!==N&&!k.locationSelected.isTopLevel){x.Readonly=true;K=true;}break;}}}if(x&&!p(x)){x.isShowingParent=K;return x;}x=null;var Q=q(k.getSideBarTable(),j.path);if(Q&&!Q.isTopLevel){L(e,Q);}};L(e,j);return x;}function t(e,j,k){var x=null;if(e&&j){for(var i=0;i<e.length;i++){var K=e[i].LocationNodeId||e[i].LocationId||e[i].ExtLocationNodeId;var L=j.LocationNodeId||j.NodeId||j.ExtLocationId;if(K===L){x=e[i];break;}}}return x;}function u(e,i){return e.byId(i).getController();}function v(e,i){var j="";var k=0;do{var x=e.getContextByIndex(k);if(!x){continue;}var K=x.getObject();var L=K.LocationId||K.NodeId;if(L===i){j=K.ExtLocationId||K.ExtNodeId;break;}k++;}while(x);return j;}function w(e){function i(k){k();}function j(k,x){x();}return U.createDialogUtil(jQuery.extend(e,{onOk:i,onCancel:j}));}function y(e,i){var j={};if(e){var i=e.getObject();j.path=e.getPath();j.LocationNodeId=i.NodeId||i.LocationId;j.NodeId=i?i.NodeId:"";j.Name=i?i.Name:"";j.HierarchyId=i.HierarchyId;j.ParentId=i.ParentId;j.ExtLocationId=i.ExtLocationId||i.ExtNodeId;j.objectLocationTree=e.getModel().getData()[0];j.isTopLevel=i.ParentId===j.objectLocationTree.ParentId?true:false;j.hasVersion=i.hasVersion;j.isExcluded=i.excluded;j.isClosed=i.isClosed;}else if(i){j.LocationNodeId=i.NodeId||i.LocationId;j.NodeId=i?i.NodeId:"";j.Name=i?i.Name:"";j.HierarchyId=i.HierarchyId;j.ExtLocationId=i.ExtLocationId||i.ExtNodeId;}return j;}function z(e){e.refreshRows(true);e.getModel().refresh(true);}function A(e,i){var j=-1;var k=0;do{var x=e.getContextByIndex(k);if(x&&x.sPath===i){j=k;break;}k++;}while(x);if(!x&&j===-1){throw new Error("Context undefined");}return j;}function B(e,i){var j="";var k=0;do{var x=e.getContextByIndex(k);if(!x){continue;}var K=x.getObject();var L=K.LocationId||K.NodeId||K.ExtNodeId;if(L===i){j=x.getPath();break;}if(K.NodeId!==""||(K.userCreatedNode&&K.ExtNodeId!=="")){e.expand(k);z(e);}k++;}while(x);return j;}function D(e,j,k){var x=[];x=j.split("/");x.shift();if(x.length>1&&!k){x.pop();}var K="";for(var i=0;i<x.length;i++){K+="/"+x[i];var L=A(e,K);e.expand(L);z(e);}}function E(e){var i=[];var j=[];var k=0;do{var x=e.getContextByIndex(k);if(e.isExpanded(k)){if(x){i.push(x.getPath());j.push(k);}}k++;}while(x);return{paths:i,indexes:j};}function G(e){var i=U.getErrorHandler();if(i.numOfErrors()>0){i.showError(e);}}function I(e){var R=e;e.Margin="0";e.Sales="0";e.Profit="0";e.UnitProjection="0";e.UnitForecast="0";e.VendorFundImpact="0";if(jQuery.isArray(R.Terms)){R.Terms=R.Terms.map(function(T){if(jQuery.isArray(T.TermProducts)){var i=T;i.TermProducts=i.TermProducts.map(function(j){j.UserProjection=null;j.LockUserProjection=false;return j;});i.UserProjection=null;i.LockUserProjection=false;return i;}else{return T;}});}return R;}return C.extend("retail.pmr.promotionaloffers.view.VersionTabs",{constructor:function(){this.dataModel=new J();this.contentModel=new J();this.featureModels=new J();this.quickViewModel=new J();this.uiSettings=new J();},startLoading:function(e,j){e.load(function(){return M.getMetadataAnalyzer().then(function(){var k=e.getOfferData();var x=k.Versions;var K=null;for(var i=0,L=x.length;i<L;i++){if(U.base64ToHex(x[i].OfferId)===j){K=x[i];var N=this.pathName==="versionDisplay"?true:false;K.Readonly=N;break;}}this.setVersionData(k,e.getStaticData(),null,K,true);this.toggleCollisionBtn();}.bind(this));}.bind(this),function(i){jQuery.sap.log.error(i.stack);});},onInit:function(){this.snapshot={};this.getView().setModel(this.dataModel);this.getView().setModel(this.contentModel,"Content");this.getView().setModel(this.featureModels,"featuresAvailable");this.getView().setModel(this.uiSettings,"uiSettings");this.generalController=u(this,"generalVersionView");this.termsController=u(this,"termsVersionView");this.termsController.setGeneralDataModel({getDataModel:function(){return this.generalController.dataModel;}.bind(this)});this.oMessageManager=U.getMessageManager();m.setModel(this.oMessageManager.getMessageModel());this.i18nBundle=U.getResourceModel();this.uiSettings.setProperty("/VersionForBackButton",sap.ui.version>"1.38.7"?true:false);this.contentModel.setProperty("/ShowVesionList",true);this.contentModel.setProperty("/isPhone",sap.ui.Device.system.phone);this.contentModel.setProperty("/HideExcludedNodes",false);this.state=this.getOwnerComponent().getState();this.getRouter().attachRouteMatched(function(e){var k=this.pathName;this.pathName=e.getParameter("name");this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","onMasterDataSystemChange",this.promptMSDChange,this);if(this.pathName==="versionCreate"){this.getEventBus().subscribe("retail.pmr.promotionaloffers","onMasterDataSystemChange",this.promptMSDChange,this);}if(["versionCreate","versionDisplay","versionEdit"].indexOf(this.pathName)===-1){return;}this.isDisplayMode=this.pathName==="versionDisplay"?true:false;var x=H.getInstance();var K=x.aHistory[x.aHistory.length-1];if(K.indexOf("productGroup")!==-1){this.generalController.validateForm();this.termsController.validateForm();return;}if(x.getPreviousHash()&&this.state.historyBack!==undefined){return;}if(this.pathName!=="versionCreate"&&!k){this.startLoading(this.state,e.getParameter("arguments").id);}}.bind(this));var i=this.getView().byId("treePane");var j=new sap.ui.layout.SplitterLayoutData({size:"30%"});i.setLayoutData(j);this.aFinHeaderFields=["marginField","unitField","salesField","profitField","fundField","forecastField"].map(function(x){return this.getView().byId(x);},this);this.aForecastHeaderFields=["forecastField"].map(function(x){return this.getView().byId(x);},this);this.offerOperations=new O(this.state);this.getEventBus().subscribe("retail.pmr.promotionaloffers","toggleCollisionBtn",this.toggleCollisionBtn,this);this.getEventBus().subscribe("retail.pmr.promotionaloffers","onVersionLocationChange",this.updateLocationFromPicker,this);this.getEventBus().subscribe("retail.pmr.promotionaloffers","validateVersions",this.validateVersionsListener,this);},onExit:function(){this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","toggleCollisionBtn",this.toggleCollisionBtn,this);this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","onVersionLocationChange",this.updateLocationFromPicker,this);this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","validateVersions",this.validateVersionsListener,this);this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","changeLocationNameInSideTable",this.tableSoftRefresh,this);},resetLocationSelected:function(){this.locationSelected=null;},restoreLocationAfterForecast:function(e){if(!e.LocationHierarchy||(e.LocationHierarchy&&e.LocationHierarchy.length<1)||(e.LocationHierarchy&&e.LocationHierarchy.length>0&&!e.LocationHierarchy[0].Cardinality&&e.LocationHierarchy[0].Locations&&e.LocationHierarchy[0].Locations.length<1)){var i=this.selectedLocationHierarchy;if(this.storeLocationHierarchy&&this.storeLocationHierarchy.length>0&&this.storeLocationHierarchy[0].Cardinality){i=this.storeLocationHierarchy;}e.LocationHierarchy=i;}return e;},showForecast:function(e){var i=this.getView().getModel().getProperty("/OfferId")||this.getView().getModel().getProperty("/LeadingOffer");var k={OfferId:i};F.show(F.Level.Offer,k,M.getServiceModel(),U.getResourceModel());},tableSoftRefresh:function(e,i,j){if(j.versionName){this.dataModel.setProperty("/Name",j.versionName);}var k=this.selector.getCurrentHierarchy();this.saveShadowVersion();var x=this.table?E(this.getSideBarTable()):null;this.expandedPaths=x&&!this.isUserNodeCreated?x.paths:["/0"];this.isAlreadySelected=true;this.isUserNodeCreated=false;this.selector.setTreeTableData(k,this.offerData.Versions);jQuery.sap.delayedCall(0,this,function(){this.expandedPaths.forEach(function(K){if(K){D(this.getSideBarTable(),K,true);}}.bind(this));this.reselectVersion();});},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this);},onCancel:function(){this.openCancelDialog();},openCancelDialog:function(){var e={controller:this,view:this.getView(),title:"{i18n>CreateOffer.OfferCancelDialogTitle}",message:"{i18n>CreateOffer.OfferCancelDialogDescription}",btnOk:"{i18n>CreateOffer.CreateOfferDialog.Accept}",btnCancel:"{i18n>CreateOffer.CreateOfferDialog.Reject}"};var i=this;l(e).then(function(){i.goBackToMainOffer(false);i.oMessageManager.removeAllMessages();i.cleanModel();},U.identity);},onNavButtonPress:function(){this.goBackToMainOffer(true);},onToggleSideMenu:function(){if(this.contentModel.getProperty("/ToggleSplitPanePressed")===false){this.contentModel.setProperty("/SplitParentWidth",f);this.contentModel.setProperty("/ToggleSplitPanePressed",true);}else{this.contentModel.setProperty("/SplitParentWidth",g);this.contentModel.setProperty("/ToggleSplitPanePressed",false);}},onShowExcluded:function(){this.reselectVersion(true);},alertNoLocationSelected:function(){var e=this.i18nBundle.getResourceBundle().getText("Versions.NoSelectedLocationMessage");U.getErrorHandler().showError(e);},onAddMultiple:function(i){var j=this;var k=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.versions.VersionsTree",this);var x=new V(k,this.hierarchy,this.i18nBundle,this.offerData.Versions,this.offerData.ExcludedNodes,[]);k.attachToggleOpenState(function(e){var L={rowContext:e.getParameter("rowContext"),expanded:e.getParameter("expanded")};x.asyncExpand(L);});var K={title:this.i18nBundle.getResourceBundle().getText("Versions.Location.ValueHelpDialog"),supportMultiselect:true,stretch:sap.ui.Device.system.phone,ok:function(){var e=x.getSelected();var L=null;if(e&&e.length>0){L=x.getParentItem(e[0]);if(L){j.buildUserNode(L,e,true);}else{j.alertNoLocationSelected();}this.close();if(j._versionsDialog){j._versionsDialog.destroy();}}else{j.alertNoLocationSelected();}},cancel:function(){this.close();j._versionsDialog.destroy();j.generalController.setLocationDataFromSnapshot();},selectionChange:function(e){x.selectionChanged(e);}};this._versionsDialog=new a("versionsPickerID",K);this._versionsDialog.addStyleClass("sapUiSizeCompact");this._versionsDialog.setTable(k);k.getModel().setSizeLimit(U.getSizeLimit());k.setVisibleRowCount(x.data.length);x.setVHDialog(this._versionsDialog,{StartOfOffer:this.offerData.StartOfOffer,EndOfOffer:this.offerData.EndOfOffer});x.clearSelection();this._versionsDialog.open();},buildUserNode:function(e,i,j){this.onLoadingPage(true,true);var k=[];this.saveShadowVersion();k.push(d(e,i));var x=k[0].LocationNodeId;if(!j){this.removeLocalNodes(this.locationSelected.ExtLocationId);x=this.locationSelected.LocationNodeId||this.locationSelected.ExtLocationId||k[0].LocationNodeId;}var K=B(this.getSideBarTable(),j?k[0].ParentId||k[0].LocationNodeId:x);this.locationSelected=q(this.getSideBarTable(),K,true);this.addNewVersion=j;var L=r(this.offerData.Versions,this.locationSelected,this);if(L){L.StartOfOffer=new Date(L.StartOfOffer);L.EndOfOffer=new Date(L.EndOfOffer);}var N=this.getVersionData(L,k);if(j){if(i&&i.length>1){N.Name="";}this.offerData.Versions.push(I(N));this.addNewVersion=false;}else{var P=o(this.offerData.Versions,this.originalSelectedVersion);if(P!==-1){N.Readonly=false;this.offerData.Versions[P]=N;}}this.locationSelected=null;this.isNewVersion=true;this.isUserNodeCreated=true;this.setVersionData(this.offerData,this.staticData,null,N,true);},updateLocationFromPicker:function(e,i,j){if(j&&j.parent){this.buildUserNode(j.parent,j.selectedLocations,false);}},onAddSingle:function(){if((this.originalSelectedVersion&&!this.originalSelectedVersion.isShowingParent)||!this.locationSelected||this.locationSelected&&this.locationSelected.isTopLevel){return;}this.onLoadingPage(true,true);this.addNewVersion=true;var e=r(this.offerData.Versions,this.locationSelected,this);var i=I(this.getVersionData(e));this.offerData.Versions.push(i);this.addNewVersion=false;this.isNewVersion=true;this.setVersionData(this.offerData,this.staticData,null,i,true);},getSideBarTable:function(){return sap.ui.getCore().byId("SideBarTreeTable");},toggleOpenState:function(e){this.isExpandRow=true;},onRowSelectionChange:function(e){if(this.isAlreadySelected){this.isAlreadySelected=false;return;}var j=e.getParameter("rowIndex");if(j===-1){var k=e.getParameter("rowIndices");j=k[k.length-1];}var x=e.getSource().getContextByIndex(j).getPath();if(x===this.currentPath&&!this.refreshTableOnExcludeSwitch){return;}var K=this.getSideBarTable();var L=K.getSelectedIndex();if(L===-1&&this.currentPath){var N=A(this.getSideBarTable(),this.currentPath?this.currentPath:"/0");this.selectATreeRow(N);return;}this.saveShadowVersion();if(!this.verifyValidation()){if(this.currentIndex!==L){this.selectATreeRow(this.currentIndex);}return;}var P=K.getContextByIndex(L);if(P&&this.currentPath===P.getPath()&&!this.refreshTableOnExcludeSwitch){this.selectATreeRow(this.currentIndex);return;}if(K.getSelectedIndices().length>1){var i=A(this.getSideBarTable(),this.currentPath?this.currentPath:"/0");this.selectATreeRow(i);return;}this.locationSelected=y(P);if(P.getObject().OpeningDate){this.locationSelected.isClosed=U.isClosed(P.getObject(),this.dataModel.getData().StartOfOffer,this.dataModel.getData().EndOfOffer);}var Q=r(this.offerData.Versions,this.locationSelected,this);this.currentIndex=L;this.currentPath=P.getPath();var R=this.offerData.OfferId;if(this.pathName!=="versionCreate"){this.getRouter().navTo(this.pathName,{path:U.base64ToHex(this.offerData.OfferId),id:Q&&Q.OfferId?U.base64ToHex(Q.OfferId):U.base64ToHex(R)},true);}this.onLoadingPage(true,false);var S=this.refreshTableOnExcludeSwitch?true:false;if(this.refreshTableOnExcludeSwitch){this.refreshTableOnExcludeSwitch=false;}this.setVersionData(this.offerData,this.staticData,null,Q,S);},createSideBarTable:function(j,k,x){function K(R,e){for(var X in R){if(R.hasOwnProperty(X)&&jQuery.isNumeric(X)){var Y=R[X];K(Y,e);for(var i=0;i<e.length;i++){if((Y.LocationId===e[i].Id)){delete R[X];}}}}}function L(R,e){for(var X in R){if(R.hasOwnProperty(X)&&jQuery.isNumeric(X)){var Y=R[X];L(Y,e);for(var i=0;i<e.length;i++){if((Y.LocationId===e[i].Id)){R[X].excluded=true;}}}}}function N(R){var e={};var i=0;for(var X in R){if(R.hasOwnProperty(X)){if(jQuery.isNumeric(X)){e[i]=N(R[X]);i=i+1;}else{e[X]=R[X];}}}return e;}var P=function(e){if(U.isClosed(e,Q.offerData.StartOfOffer,Q.offerData.EndOfOffer)){e.isClosed=true;}for(var i in e){if(e.hasOwnProperty(i)&&jQuery.isNumeric(i)){if(U.isClosed(e[i],Q.offerData.StartOfOffer,Q.offerData.EndOfOffer)){e[i].isClosed=true;}e[i].excluded=false;P(e[i]);}}};var Q=this;var R=[];if(j&&j.hasOwnProperty("ParentId")){R.push(j);}P(R);L(R,x||[]);var S=jQuery.extend(true,[],R);K(S,x);S=N(S);this.contentModel.setProperty("/FullHierarchy",R);this.contentModel.setProperty("/IncludedHierarchy",S);if(this.contentModel.getProperty("/HideExcludedNodes")){S=R;}if(!this.table){this.table=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.versions.LocationsTreeSideBar",this);this.selector=new V(this.table,S,this.i18nBundle,k,x);}else{this.selector.setTreeTableData(S,this.offerData.Versions);}this.table.attachToggleOpenState(function(e){var i={rowContext:e.getParameter("rowContext"),expanded:e.getParameter("expanded")};Q.selector.asyncExpand(i);});var T=this.getView().byId("sideBarContent");T.addContent(this.table);var W=this.getSideBarTable();this.contentModel.setProperty("/VersionCount",this.i18nBundle.getResourceBundle().getText("ManageVersions.SideBar.Title",W.getModel().getData()[0].versionCount||"0"));W.setSelectionBehavior(sap.ui.table.SelectionBehavior.RowOnly);W.getModel().setSizeLimit(U.getSizeLimit());if(this.selector.data.length>W.getVisibleRowCount()){W.setVisibleRowCount(this.selector.data.length);W.refreshRows(true);W.getModel().refresh(true);}this.table.getBinding("rows");},openQuickView:function(e){var P=e.getSource().getParent().getAggregation("items")[0];P.openBy(e.getSource());},goBackToMainOffer:function(e){var i=H.getInstance().getPreviousHash()!==undefined;this.isForSave=true;var j=this.preparePayloadForSave(true,true);j.Readonly=this.isDisplayMode;j.LocationHierarchy=this.availableHierarchy;if(e){this.state.store(j);}this.getEventBus().publish("retail.pmr.promotionaloffers","onVersionDataChange");this.state.storeBack(true);if(i){window.history.go(-1);}else{var k="edit";if(this.isDisplayMode){k="display";}this.getRouter().navTo(k,{path:U.base64ToHex(j.OfferId)},true);}this.cleanModel();},getEventBus:function(){return sap.ui.getCore().getEventBus();},_getPayload:function(){var e=this.generalController.getOfferData();var i=this.termsController.getOfferData();var j=this.termsController.getFinancials();var k={};var x=this.termsController.getTermsProductsFinancials();jQuery.extend(k,e,i,{Financials:j},x);return k;},isParent:function(e){for(var i in e){if(e.hasOwnProperty(i)&&jQuery.isNumeric(i)){return true;}}return false;},updateChildrenDates:function(e,j,k,x){var K=j.Versions;if(x){var L=e.LocationNodeId;K=this.getChildren(x,L,j);}for(var i=0;i<K.length;i++){if(K[i].StartOfOffer.getTime()===k.StartOfOffer.getTime()){K[i].StartOfOffer=e.StartOfOffer;}if(K[i].EndOfOffer.getTime()===k.EndOfOffer.getTime()){K[i].EndOfOffer=e.EndOfOffer;}}},getChildren:function(e,j,k){var x=[];for(var i in e){if(e.hasOwnProperty(i)&&jQuery.isNumeric(i)){var K=y(null,e[i]);var L=t(k.Versions,K,this);if(L){x.push(L);}if(this.isParent(e[i])){this.getChildren(e[i],e[i].NodeId,k);}}}return x;},getCurrentSelectedHierarchy:function(e,j){var k;for(var i in e){if(e.hasOwnProperty(i)&&jQuery.isNumeric(i)){if(e[i].NodeId===j){k=e[i];break;}}}return k;},updateNodeDates:function(e,i,j){var k=o(e,i);if(k!==-1){e[k].StartOfOffer=j.StartOfOffer;e[k].EndOfOffer=j.EndOfOffer;}},versionHasChanges:function(e){var h=false;if(e&&!e.Readonly){var i=jQuery.extend(true,{},e);delete i.isShowingParent;var j=o(this.changedVersions,i);if(this.getVersionSnapshot(i)&&!jQuery.sap.equal(this.getVersionSnapshot(i),i)){if(j===-1){this.changedVersions.push(i);}}else{if(j!==-1){this.changedVersions.splice(j,1);}}}if((this.changedVersions&&this.changedVersions.length>0)||this.aVersionWasDeleted){h=true;}else{h=false;}return h;},getVersionSnapshot:function(e){var i=o(this.versionsSnapshot,e);if(i!==-1&&this.versionsSnapshot[i]){delete this.versionsSnapshot[i].isShowingParent;return this.versionsSnapshot[i];}else{return null;}},updateVersion:function(e,i){var j=this.offerData;if(i){j=i;}var k=jQuery.extend(true,{},j);if((this.locationSelected&&this.locationSelected.isTopLevel)||!this.locationSelected){this.updateMainOffer(e,j);this.updateChildrenDates(e,j,k);return;}if(this.isNoVersion){return;}var x=o(j.Versions,this.originalSelectedVersion);if(x!==-1){j.Versions[x]=jQuery.extend({},j.Versions[x],e);var K=e.Terms;j.Versions[x].Terms=K;}else{j.Versions.push(e);x=j.Versions.length-1;}var L=this.locationSelected.objectLocationTree;var N=this.locationSelected.LocationNodeId;var P=this.getCurrentSelectedHierarchy(L,N);if(P&&x!==-1){var Q=k.Versions[x];this.updateChildrenDates(e,j,Q,P);}},updateMainOffer:function(e,i){for(var k in e){i[k]=e[k];}if(this.pathName==="versionCreate"){i.ExtLocationNodeId=this.ExtLocationNodeId;}},cleanPayloadForSave:function(e,i,j){if(!i){delete e.Readonly;delete e.Financials;delete e.locationPath;if(this.locationSelected&&!this.locationSelected.isTopLevel){delete e.ExtLocationNodeId;delete e.Editable;e.UnitProjection=parseFloat(e.UnitProjection)+"";}e.Terms.forEach(function(k){delete k.OfferId;if(parseFloat(k.DiscountValue)===0){delete k.DiscountValue;}if(parseFloat(k.SubDiscountValue)===0){delete k.SubDiscountValue;}if(k.LockUserProjection===false){delete k.LockUserProjection;}if(this.removeFinancial){delete k.Financials;k.Financials={Id:""};}delete k.DiscountTypeName;if(this.removeFinancial){delete k.Financials;k.Financials={Id:""};}this.cleanProductsFinancials(k.TermProducts);}.bind(this));this.clearOfferForSave(j?j:this.offerData);}delete e.isShowingParent;delete e.ShowEdit;return e;},clearOfferForSave:function(e){delete e.Readonly;delete e.VersionItems;delete e.PurchasingGroupName;e.Financials=[{}];if(e.LocationHierarchy){e.LocationHierarchy.forEach(function(i){delete i.checked;delete i.expanding;delete i.N_ID;delete i.P_ID;});}if(e.Terms){e.Terms.forEach(function(i){if(i){delete i.OfferId;if(parseFloat(i.DiscountValue)===0){delete i.DiscountValue;}if(parseFloat(i.SubDiscountValue)===0){delete i.SubDiscountValue;}if(i.LockUserProjection===false){delete i.LockUserProjection;}if(this.removeFinancial){delete i.Financials;i.Financials={Id:""};}delete i.DiscountTypeName;this.cleanProductsFinancials(i.TermProducts);}}.bind(this));}this.addEmptyArrays(e,"Incentives");this.addEmptyArrays(e,"LocalNodes");this.addEmptyArrays(e,"Terms");this.addEmptyArrays(e,"VendorFunds");this.addEmptyArrays(e,"Versions");this.addOrRemovePropertiesAllVersions(true,true,e);},addEmptyArrays:function(e,i){if(!e[i]){e[i]=[];}},saveShadowVersion:function(){var e=this._getPayload();this.updateVersion(this.cleanPayloadForSave(e,true));},cleanModel:function(){this.locationSelected=null;this.offerData=null;if(this.table){this.table.destroy(true);this.table=null;}this.currentPath=null;this.expandedPaths=[];this.contentModel.setProperty("/HideExcludedNodes",false);this.afterSave=false;this.isAfterDeleteOrAdd=false;},preparePayloadForSave:function(e,j){var k=this.offerData;if(j){k=jQuery.extend(true,{},this.offerData);}var x=this._getPayload();if(this.isForSave||this.calcFinancials||this.pathName==="versionCreate"){this.updateVersion(this.cleanPayloadForSave(x,false,k),k);if(!e){if(k.Versions){k.Versions.forEach(function(L){delete L.isShowingParent;if(L.Description===""){delete L.Description;}});}var K=this;if(this.pathName==="versionCreate"&&k.Tactics&&k.Tactics.length>0){k.Tactics.forEach(function(N){if(N&&!N.TacticDesc&&!N.TacticTypeDesc){var P=K.staticData.Tactics;for(var i=0;i<P.length;i++){if(P[i].TacticId===N.TacticId&&P[i].TacticType===N.TacticType){N.TacticDesc=P[i].TacticDesc;N.TacticTypeDesc=P[i].TacticTypeDesc;break;}}}});}}else{for(var i=0;i<(k.Versions||[]).length;i++){var L=k.Versions[i];delete L.LocalNodes;}delete k.LocationHierarchy;}}this.isForSave=false;this.removeFinancial=false;this.calcFinancials=false;(k.Versions||[]).forEach(function(L){if(L.Tactics&&L.Tactics.length===0){delete L.Tactics;}});return k;},validateVersionsListener:function(e,i,j){this.versionsValid();},setUserLocationIdForUserNodes:function(){if(!this.locationSelected){return;}(this.offerData.LocalNodes||[]).some(function(i){if(this.locationSelected.ExtLocationId===i.Description){this.locationSelected.LocationNodeId=i.Id;return true;}}.bind(this));},onSave:function(){this.oMessageManager.removeAllMessages();if(!this.verifyValidation()){return;}if(!this.versionsValid()){return;}var e=this.getView().getModel("i18n").getResourceBundle();this.isForSave=true;this.removeFinancial=true;return this.state.save().then(function(R){U.getErrorHandler().showToast(e.getText("CreateOffer.ToastMessage.SaveCompleted"));this.offerData=jQuery.extend(true,{},this.state.getOfferData());this.setUserLocationIdForUserNodes();var i=this.locationSelected;if(!this.locationSelected){i=q(this.getSideBarTable(),"/0",true);}var j=r(this.offerData.Versions,i,this);var k="versionEdit";if(U.isReadOnly({Status:this.offerData.Status,UIState:this.offerData.UIState})){k="versionDisplay";this.isDisplayMode=true;(this.offerData.Versions||[]).forEach(function(x){x.Readonly=true;});this.offerData.Readonly=true;if(j){j.Readonly=true;}}this.afterSave=true;this.setVersionData(this.offerData,this.staticData,null,j,true);this.getRouter().navTo(k,{path:U.base64ToHex(this.offerData.OfferId),id:j&&j.OfferId?U.base64ToHex(j.OfferId):U.base64ToHex(this.offerData.OfferId)},true);U.getErrorHandler().showToast(this.i18nBundle.getResourceBundle().getText("CreateOffer.ToastMessage.SaveCompleted"));return j||this.offerData;}.bind(this),function(i){U.getErrorHandler().showError(e.getText("CreateOffer.ErrorMessage.Save"));});},versionsValid:function(){var e=this.state.getSavePayloadWithFinancials();var j=[];var k=e.Versions;if(k&&k.length>0){for(var i=0;i<k.length;i++){if(!U.isInOfferRange(k[i],e.StartOfOffer,e.EndOfOffer,this.offerData)){j.push({target:"/invalidVersion",type:"Error",processor:this.dataModel,message:this.i18nBundle.getResourceBundle().getText("Versions.Not.In.Range.Title.Error",k[i].Name),description:this.i18nBundle.getResourceBundle().getText("Versions.Not.In.Range.Message.Error",k[i].Name)});}}}U.removeMessagesByPath("/invalidVersion");U.setErrorMessages(U.getMessageManager(),j);return!j.length;},verifyValidation:function(){var e=[];var i=this._getPayload();if(i.Readonly){return true;}if(this.generalController.validateForm()){e.push(this.i18nBundle.getResourceBundle().getText("CreateVersion.General.Title"));}if(this.termsController.validateForm()){e.push(this.i18nBundle.getResourceBundle().getText("CreateOffer.Terms.Title"));}if(e.length){var j=this.i18nBundle.getResourceBundle().getText("CreateOffer.SaveOffer.Validate",e.join(", "));U.getErrorHandler().showError(j);return false;}return true;},onDeleteVersionPress:function(){if((this.locationSelected&&this.locationSelected.isTopLevel)||!this.locationSelected){return;}var e={"massageSingle":"ManageVersions.DeleteSingleVersionDialog.Message","messageMulti":"ManageVersions.DeleteVersionDialog.Message","title":"ManageVersions.DeleteVersionDialog.Title"};U.openDeleteConfirmDiaog(true,e).then(function(){this.onLoadingPage(true,false);var i=o(this.offerData.Versions,this.originalSelectedVersion);this.offerData.Versions.splice(i,1);this.removeLocalNodes(this.originalSelectedVersion.ExtLocationNodeId||this.locationSelected.ExtLocationId);var j=r(this.offerData.Versions,this.locationSelected,this);if(j){j.Readonly=true;}this.isAfterDeleteOrAdd=true;this.setVersionData(this.offerData,this.staticData,null,j,true);}.bind(this));},onRestoreVersionPress:function(){if((this.locationSelected&&this.locationSelected.isTopLevel)||!this.locationSelected){return;}var e={"massageSingle":"ManageVersions.RestoreVersionDialog.Message","messageMulti":"ManageVersions.RestoreVersionDialog.Message","title":"ManageVersions.RestoreVersionDialog.Title","confirmLabel":"ManageVersions.RestoreVersionDialog.Restore"};U.openDeleteConfirmDiaog(true,e).then(function(){this.onLoadingPage(true,false);this.restoreVersion=true;var i=o(this.offerData.Versions,this.originalSelectedVersion);var j=q(this.getSideBarTable(),this.locationSelected.path);var k=r(this.offerData.Versions,j,this);var x=this.getVersionData(k);(x.Terms||[]).forEach(function(Q){Q.UserProjection=null;});var K=this.locationSelected.objectLocationTree;var L=this.locationSelected;var N=U.findInTree(K,function(Q){return Q.ExtNodeId===L.ExtLocationId;});if(N.length>0){var P=null;if(N[0].VersionName){P=N[0].VersionName;}else if(L.Name){P=L.Name+" ("+L.ExtLocationId+")";}else{P=N[0].NodeName;}x.Name=P;}else{x.Name=L.Name+" ("+L.ExtLocationId+")";}this.offerData.Versions[i]=x;this.restoreVersion=false;this.setVersionData(this.offerData,this.staticData,null,x,true);}.bind(this));},onEditVersionPress:function(){if(!this.offerData.Editable){U.createDialogUtil({btnOk:"{i18n>Offer.OK}",message:"{i18n>ManageOffers.offerNotEditable}",state:"Error",view:this.getView(),onOk:function(i){i();}}).then(function(){});return;}this.onLoadingPage(true,false);var e=this._getPayload();delete e.Readonly;this.getRouter().navTo("versionEdit",{path:U.base64ToHex(this.offerData.OfferId),id:e.OfferId?U.base64ToHex(e.OfferId):U.base64ToHex(this.offerData.OfferId)},true);this.isDisplayMode=false;this.offerData.Versions.forEach(function(i){delete i.Readonly;});delete this.offerData.Readonly;this.setVersionData(this.offerData,this.staticData,null,e,false);this.createSnapshot();},addOrRemovePropertiesAllVersions:function(i,e,j){var k=this;var x=this.offerData;if(j){x=j;}if(x.Versions){x.Versions.forEach(function(K){if(e){delete K.Readonly;if(K.LocationId){K.LocationNodeId=K.LocationId;}delete K.isShowingParent;delete K.LocationId;delete K.ShowEdit;delete K.Financials;delete K.locationPath;K.UnitProjection=parseFloat(K.UnitProjection)+"";if(K.Terms){K.Terms.forEach(function(L){delete L.OfferId;if(parseFloat(L.DiscountValue)===0){delete L.DiscountValue;}if(parseFloat(L.SubDiscountValue)===0){delete L.SubDiscountValue;}if(L.LockUserProjection===false){delete L.LockUserProjection;}if(this.removeFinancial){delete L.Financials;L.Financials={Id:""};}delete L.DiscountTypeName;k.cleanProductsFinancials(L.TermProducts);}.bind(k));}if(K.Terms&&K.Terms.length===0){delete K.Terms;}}else{K.Readonly=i;}});}},cleanProductsFinancials:function(e){if(e){e.forEach(function(i){if(this.removeFinancial){delete i.Financials;i.Financials={Id:""};}if(!i.Financials){i.Financials={Id:""};}if(parseFloat(i.DiscountValue)===0){i.DiscountValue="0";}if(parseFloat(i.SubDiscountValue)===0){i.SubDiscountValue="0";}delete i.Id;}.bind(this));}},selectATreeRow:function(i,e){this.isAlreadySelected=true;this.refreshTableOnExcludeSwitch=false;if(e){this.isAlreadySelected=false;this.refreshTableOnExcludeSwitch=true;}this.getSideBarTable().setSelectedIndex(i);},getLocationTextForNodes:function(i){var e=this.getSideBarTable().getContextByIndex(i);if(!e){return;}var j=e.getObject();return j.ExtLocationId||j.ExtNodeId;},reselectVersion:function(i){var e=this.getSideBarTable();var j=A(e,this.locationSelected&&!i?this.locationSelected.path:"/0");this.selectATreeRow(j,i);},selectCurrentVersionDisplayed:function(e){var i=this.getSideBarTable();var j=B(i,e.LocationNodeId||e.LocationId||e.ExtLocationNodeId);i.collapseAll();D(i,j);var k=A(i,j);this.selectATreeRow(k);var x=i.getContextByIndex(k);return x;},removeParentIdsOnNewVersion:function(e,i){delete e.LocalNodes;delete e.LocationHierarchy;delete e.Versions;delete e.OfferId;if(e.Terms&&this.locationSelected&&!this.locationSelected.isTopLevel){(e.Incentives||[]).forEach(function(j){j.Id="";});e.Terms.forEach(function(j){if(j){delete j.TermId;if(j.Financials){delete j.Financials.Id;}delete j.OfferId;}});}else{e.Incentives=i.Incentives;e.Terms=i.Terms;}return e;},isOfferStatusApproved:function(){var i=false;var e=this.state.processor.getSnapshot();if(U.isReadOnly({Status:e.Status,UIState:e.UIState})&&(p(e)||!e.Status||(!p(e)&&this.offerData.Status===e.Status)||this.afterSave)){i=true;}return i;},getVersionData:function(e,i){var j={};var k=this.offerData.StartOfOffer;var x=this.offerData.EndOfOffer;if(e){k=e.StartOfOffer;x=e.EndOfOffer;}var K;if(e){K=e.ExtOfferId||"";jQuery.extend(true,j,e);if(e.isShowingParent&&this.addNewVersion){j=this.removeParentIdsOnNewVersion(j,e);}}else{K=this.offerData.ExtOfferId||"";jQuery.extend(true,j,this.offerData);if(this.locationSelected&&this.addNewVersion){this.locationSelected.isTopLevel=false;}j=this.removeParentIdsOnNewVersion(j,this.offerData);}var L=this.locationSelected?this.locationSelected.ExtLocationId:"";if(this.locationSelected&&this.locationSelected.Name){L=this.locationSelected.Name+" ("+L+")";}j.Name=this.addNewVersion?L:!e?this.offerData.Name:e.Name;j.EndOfOffer=x;j.StartOfOffer=k;j.ExtOfferId=this.addNewVersion?"":K;j.Readonly=!e&&!this.locationSelected?this.offerData.Readonly:this.addNewVersion||this.restoreVersion?false:!e?!this.locationSelected||(this.locationSelected&&this.locationSelected.isTopLevel)?this.isDisplayMode:true:e.Readonly;j.ShowEdit=((e&&!e.isShowingParent)||(this.locationSelected&&this.locationSelected.isTopLevel)||!this.locationSelected)&&j.Readonly&&!this.isOfferStatusApproved()?true:false;if(e&&!this.locationSelected){var N=this.selectCurrentVersionDisplayed(e);this.locationSelected=y(N);}if(i){if(i[0].LocationNodeId){j.HierarchyId=i[0].HierarchyId;j.LocationNodeId=i[0].LocationNodeId;}else{delete j.LocationNodeId;i[0].Id="";j.HierarchyId=i[0].HierarchyId;delete i[0].HierarchyId;j.ExtLocationNodeId=i[0].Description;this.addLocalNodes(i);}}else{var P=v(this.getSideBarTable(),this.offerData.LocationNodeId);if(this.locationSelected){var Q=this.locationSelected.HierarchyId?this.locationSelected.HierarchyId:this.offerData.HierarchyId;var R=this.locationSelected.LocationNodeId||this.locationSelected.ExtLocationId;var S=this.restoreVersion?R:!e?this.offerData.LocationNodeId:e.LocationNodeId;var T=v(this.getSideBarTable(),S)||this.locationSelected.ExtLocationId;var W=S?T:e.ExtLocationNodeId;var X=this.restoreVersion?T:!e?P:W;j.HierarchyId=!e?this.offerData.HierarchyId:Q;j.LocationNodeId=this.addNewVersion?this.locationSelected.LocationNodeId:S;j.ExtLocationNodeId=this.addNewVersion?this.locationSelected.ExtLocationId:X;}else{j.HierarchyId=!e?this.offerData.HierarchyId:e.HierarchyId;j.LocationNodeId=!e?this.offerData.LocationNodeId:e.LocationNodeId||e.LocationId;j.ExtLocationNodeId=!e?P:e.ExtLocationNodeId;}}var Y=false;if(this.offerData.LocalNodes){Y=this.offerData.LocalNodes.some(function(Z){return Z.Description===j.LocationNodeId&&Z.Id==="";});}if(Y){delete j.LocationNodeId;}return j;},addLocalNodes:function(e){if(!this.offerData.LocalNodes){this.offerData.LocalNodes=[];}var i=this.offerData.LocalNodes.indexOf(e[0]);if(i===-1){this.offerData.LocalNodes.push(e[0]);}},removeLocalNodes:function(e){var j=false;if(this.offerData.LocalNodes){for(var i=0;i<this.offerData.LocalNodes.length;i++){if(this.offerData.LocalNodes[i].Description===e){this.offerData.LocalNodes.splice(i,1);j=true;}}}this.removeLocalNodesFromVersionLevel(e);return j;},removeLocalNodesFromVersionLevel:function(e){if(this.offerData.Versions){var i=this.offerData.Versions;i.forEach(function(j){if(j.LocalNodes&&j.LocalNodes.Description===e){delete j.LocalNodes;}});}},setVersionData:function(e,i,j,k,x){this.originalSelectedVersion={};this.originalSelectedVersion=k;this.staticData=i;this.isNoVersion=!k?true:false;this.addEmptyArrays(e,"Versions");this.offerData={};jQuery.extend(true,this.offerData,e);if(!e.LocationHierarchy||(e.LocationHierarchy&&e.LocationHierarchy.length<1)||(e.LocationHierarchy&&e.LocationHierarchy.length>0&&!e.LocationHierarchy[0].Cardinality&&e.LocationHierarchy[0].Locations&&e.LocationHierarchy[0].Locations.length<1)){e.LocationHierarchy=this.availableHierarchy;}this.availableHierarchy=e.LocationHierarchy.slice();e.LocationHierarchy=U.buildLocationHierarchyFromVH(e.LocationHierarchy);var K=new b(e);if(!this.locationSelected&&!this.table){this.onLoadingPage(true,false,true);this.isDisplayMode=this.pathName==="versionDisplay"?true:false;if(this.pathName==="versionCreate"){var L=this.offerData.LocationHierarchy[0];this.ExtLocationNodeId=L.ExtHierarchyId;}}this.expandedPaths=[];if(x){this.hierarchy=K.getHierarchy()[0];var N=this.table?E(this.getSideBarTable()):null;this.expandedPaths=N&&!this.isUserNodeCreated?N.paths:["/0"];this.isAlreadySelected=true;this.isUserNodeCreated=false;this.createSideBarTable(this.hierarchy,e.Versions,e.ExcludedNodes||[]);jQuery.sap.delayedCall(0,this,function(){this.expandedPaths.forEach(function(P){if(P){D(this.getSideBarTable(),P,true);}}.bind(this));});}jQuery.sap.delayedCall(0,this,function(){this.setData(e,k,i,this.expandedPaths,x);});},onLoadingPage:function(i,e,j){if(i){U.getErrorHandler().showBusy();}else{jQuery.sap.delayedCall(300,this,U.getErrorHandler().hideBusy());}},setData:function(e,i,j,k,x){this.reselectVersion();var K={};K=this.getVersionData(i);if(x){var L=A(this.getSideBarTable(),this.locationSelected?this.locationSelected.path:"/0");this.currentIndex=L;this.currentPath=this.locationSelected?this.locationSelected.path:"/0";if(this.isNewVersion){var N=jQuery.extend(true,{},K);N.isNew=true;this.isNewVersion=false;this.isAfterDeleteOrAdd=true;}}var P=this.contentModel.getProperty("/ShowVesionList");var Q=this.contentModel.getProperty("/isPhone");this.contentModel.setData({Editable:!K.Readonly,NavButtonsEnabled:!K.Readonly,ShowEdit:K.ShowEdit,ShowVesionList:P,isPhone:Q,showVersionActions:!((this.locationSelected&&this.locationSelected.isTopLevel)||!this.locationSelected),LeadOfferName:e.Name,FullHierarchy:this.contentModel.getProperty("/FullHierarchy"),IncludedHierarchy:this.contentModel.getProperty("/IncludedHierarchy"),HideExcludedNodes:this.contentModel.getProperty("/HideExcludedNodes")});this.contentModel.setProperty("/SplitParentWidth",0);this.contentModel.setProperty("/ToggleSplitPanePressed",false);this.contentModel.setProperty("/CollisionEnabled",false);this.contentModel.setProperty("/VersionCount",this.i18nBundle.getResourceBundle().getText("ManageVersions.SideBar.Title",this.getSideBarTable().getModel().getData()[0].versionCount||"0"));this.dataModel.setData(K);var R=U.setupFeatures(j.FeaturesAvailable);this.featureModels.setData(R);e.selectedVersion=i;e.hierarchy=this.hierarchy;e.isTopLevel=!this.locationSelected||(this.locationSelected&&this.locationSelected.isTopLevel);this.generalController.setOfferData(K,j,e);this.termsController.setGeneralDataModel({getDataModel:function(){return this.generalController.dataModel;}.bind(this)});this.termsController.setRouter(this.getRouter());if(!K.Terms){K.Terms=[];}K.LocationSubgroups=e.LocationSubgroups;this.termsController.setOfferData(K,j);if(K.Financials){this.termsController.setFinancials(K.Financials);}this.staticData=j;if((!e.Editable||this.isOfferStatusApproved())&&this.pathName==="versionEdit"){var S="{i18n>ManageOffers.offerNotEditable}";if(this.isOfferStatusApproved()){S="{i18n>ManageOffers.offerNotEditableIsApproved}";}U.createDialogUtil({title:"{i18n>ManageOffers.OfferFunctionsErrorDialog.Title}",btnOk:"{i18n>Offer.OK}",message:S,state:"Error",view:this.getView(),onOk:function(T){T();}}).then(function(){this.getRouter().navTo("versionDisplay",{path:U.base64ToHex(this.offerData.OfferId),id:K.OfferId?U.base64ToHex(K.OfferId):U.base64ToHex(this.offerData.OfferId)},true);this.isDisplayMode=true;this.offerData.Versions.forEach(function(T){T.Readonly=true;});this.offerData.Readonly=true;K.Readonly=true;this.setVersionData(this.offerData,this.staticData,null,K,false);}.bind(this));}jQuery.sap.delayedCall(0,this,function(){if(this.afterSave){this.isAfterDeleteOrAdd=false;this.createSnapshot();this.afterSave=false;}else{var T=this.state.processor.getSnapshot();this.clearOfferForSave(T);this.state.processor.storeSnapshot(T);}this.state.storeTransientSnapshot();this.makeButtonsVisible();this.onLoadingPage(false,false);});this.makeButtonsVisible();},createSnapshot:function(e,i,j){var k=true;var x=jQuery.extend({},true,this.state.processor.getSnapshot());this.isForSave=true;var K=jQuery.extend({},true,this.state.processor.createSavePayload());this.removeFinancial=true;if(j){var L=K.Terms;var N=x.Terms;if(N&&L&&N.length!==L.length){k=false;}else{this.updateSnapshotTermProducts(K,x);}}if(!this.isAfterDeleteOrAdd&&k){this.clearOfferForSave(x);this.clearOfferForSave(K);this.state.processor.storeSnapshot(K);this.makeButtonsVisible();}this.removeFinancial=false;},getIndexOfTerm:function(e,j){var k=-1;if(j&&j.length>0){for(var i=0;i<j.length;i++){if(j.TermId&&j.TermId===e){k=i;}}}return k;},updateSnapshotTermProducts:function(e,i){var j=this;var k=function(_,x){for(var K in _){if(K!=="Terms"&&K!=="Versions"){_[K]=x[K];}else if(K==="Terms"){var L=_[K];var N=x[K];if(N&&L&&N.length!==L.length){continue;}(L||[]).forEach(function(P){var Q=j.getIndexOfTerm(P.TermId,N);if(Q!==-1){var R=N[Q];for(var S in P){if(S!=="TermProducts"){P[S]=R[S];}}}});}}};k(e,i);if(e&&e.Versions){(e.Versions||[]).forEach(function(x){if(i.Versions){var K=o(i.Versions,x);if(K!==-1){k(x,i.Versions[K]);}}});}},availableNodes:function(e,i){if(!i.versionCount||i.versionCount<1){e.nr++;}for(var j in i){if(jQuery.isNumeric(j)&&!i.userCreatedNode){this.availableNodes(e,i[j]);}}},makeButtonsVisible:function(){var e=this.contentModel.getProperty("/NavButtonsEnabled");var i=true;var j=false;var k=this;var x={nr:0};this.availableNodes(x,this.selector.hierarchy[0]);if(this.offerData&&this.offerData.LocalNodes){this.offerData.LocalNodes.forEach(function(K){if(K){if(k.locationSelected&&K.Description===k.locationSelected.ExtLocationId){i=false;}(K.Children||[]).forEach(function(L){if(k.locationSelected&&L.NodeId===k.locationSelected.LocationNodeId){i=false;j=true;}});}});}if((this.originalSelectedVersion&&!this.originalSelectedVersion.isShowingParent)||!this.locationSelected||(this.locationSelected&&this.locationSelected.isTopLevel)){i=false;}if(!s(h(this),this.isDisplayMode)){e=true;}if(this.locationSelected&&(this.locationSelected.isClosed||this.locationSelected.isExcluded)){i=false;j=true;}if(x.nr<2){i=false;}this.contentModel.setProperty("/VisibleAddSingle",i);this.contentModel.setProperty("/VisibleSave",e);this.contentModel.setProperty("/ShowAddActions",!this.isDisplayMode);this.contentModel.setProperty("/ShowDescription",this.isDisplayMode||(!this.isDisplayMode&&(i||j)));this.contentModel.setProperty("/ShowFooter",!this.isDisplayMode||U.errorMessagesExists());},removeEmptyTermsBeforeFinancialCalc:function(e){if(e.Terms&&e.Terms.length<1){delete e.Terms;}e.Versions.forEach(function(i){if(i.Terms&&i.Terms.length<1){delete i.Terms;}delete i.locationPath;});delete e.LocationHierarchy;delete e.Financials;},onForecastPress:function(){var i=this.getView().getModel("i18n").getResourceBundle();var j={loader:this.state,view:this.getView(),title:"{i18n>CreateOffer.ForecastTitle}",message:"{i18n>CreateOffer.OfferForecastDialogDescription}",state:"Warning",btnOk:"{i18n>CreateOffer.CreateOfferDialog.Accept}",btnCancel:"{i18n>CreateOffer.CreateOfferDialog.Reject}"};var k=function(e){this.onLoadingPage(false);this.offerOperations.setHeaderFieldsBusyState(false,this.aForecastHeaderFields);U.identity(e);}.bind(this);w(j).then(function(){var e=true;if(!this.verifyValidation("{i18n>CreateOffer.SaveOffer.Title}",e)){return;}this.isForSave=true;this.removeFinancial=true;this.oMessageManager.removeAllMessages();this.onLoadingPage(true,true);this.offerOperations.getForecast(this.aForecastHeaderFields).then(function(x){G(i.getText("CreateOffer.ErrorMessage.Forecast"));if(x){this.state.store(this.restoreLocationAfterForecast(x));this.state.storeBack(true);this.startLoading(this.state,true);if(!this.dataModel.getProperty("/ExtOfferId")||this.pathName!=="edit"){this.state.storeBack(true);}}this.onLoadingPage(false,true);}.bind(this));}.bind(this),k);},handleCalcFinancialsPress:function(){var e=jQuery.extend([],true,this.offerData.LocationHierarchy);this.calcFinancials=true;this.removeFinancial=true;var k=this.state.getSavePayloadWithFinancials();if(k===null){return;}this.removeEmptyTermsBeforeFinancialCalc(k);this.offerData=jQuery.extend(true,{},k);var x=null;var K=o(this.offerData.Versions,this._getPayload());var L=this;this.offerData.LocationHierarchy=e;this.oMessageManager.removeAllMessages();this.calcFinancials=true;this.removeFinancial=true;this.offerOperations.calculateFinancials(this.aFinHeaderFields).then(function(N){var P=null;var Q=null;var R=L.getView().getModel("i18n").getResourceBundle().getText("CreateOffer.ErrorMessage.Calculate");G(R);if(!N){return;}L.offerData.Margin=N.Margin;L.offerData.UnitProjection=N.UnitProjection;L.offerData.Sales=N.Sales;L.offerData.Profit=N.Profit;L.offerData.VendorFundImpact=N.VendorFundImpact;L.offerData.Currency=N.Currency;if((L.offerData.Versions||[]).length===(N.Versions||[]).length){L.offerData.Versions.forEach(function(T,K){var S=N.Versions[K];T.Margin=S.Margin;T.UnitProjection=S.UnitProjection;T.Sales=S.Sales;T.Profit=S.Profit;T.VendorFundImpact=S.VendorFundImpact;T.Currency=S.Currency;});}if(N.Versions&&k.Versions&&N.Versions&&N.Versions.length!==k.Versions.length){throw new Error("Number of versions in the payload is no equal with the number of versions in the response");}if(N.Versions&&N.Versions[K]){var S=N.Versions[K];P=N.Versions[K].Terms;if(!S||!P){return;}Q=P;x=k.Versions[K];for(var i=0;i<Q.length;i++){if(x.Terms[i]){x.Terms[i]=Q[i];}}x.Margin=S.Margin;x.UnitProjection=S.UnitProjection;x.Sales=S.Sales;x.Profit=S.Profit;x.VendorFundImpact=S.VendorFundImpact;x.Currency=S.Currency;}else{P=N.Terms;if(!P){return;}Q=P;for(var j=0;j<Q.length;j++){L.offerData.Terms[j]=Q[j];}x=null;}L.addAllAfterCalculate(N);L.offerData.LocationHierarchy=e;L.offerData.Editable=true;L.setVersionData(L.offerData,L.staticData,null,x,true);});},addAllAfterCalculate:function(e){this.offerData.Versions.forEach(function(i){this.updateTermForEveryVersion(i,e);}.bind(this));if(e.Terms&&e.Terms.length>0){this.offerData.Terms=e.Terms;}},updateTermForEveryVersion:function(e,i){var j=o(i.Versions,e);if(j!==-1){var k=i.Versions[j].Terms;if(k&&k.length>0){e.Terms=k;}}},onCollisionDetection:function(){var e=this.getView();var i=this.getView().getModel("i18n").getResourceBundle().getText("CreateOffer.ErrorMessage.Collision");this.calcFinancials=true;this.removeFinancial=true;this.contentModel.setProperty("/CollisionEnabled",false);U.getErrorHandler().showBusy();this.offerOperations.detectCollision().then(function(j){this.offerOperations.populateCollisionDetection(j,this.state.getSavePayload(),e).then(function(){U.getErrorHandler().hideBusy();G(i);this.contentModel.setProperty("/CollisionEnabled",true);}.bind(this));}.bind(this));},toggleCollisionBtn:function(){var e=this.generalController.getOfferData();var T=this.termsController.getOfferData();var i=["LocationNodeId","StartOfOffer","EndOfOffer"].every(function(P){return!!e[P];})&&T.Terms.some(function(j){return j.ProductId||j.HierarchyNodeId||j.DimensionType==="20";});this.contentModel.setProperty("/CollisionEnabled",i);},onMessagesIndicatorPress:function(e){m.openBy(e.getSource());},getOfferDataProvider:function(){return new n(this);},promptMSDChange:function(e,i,j){var k=this;var x=j.MasterdataSystemId;var K=this.dataModel.getProperty("/MasterdataSystem");return U.promptUserForMasterDataSystemChange(x,K).then(function(){var L=k.state.getSavePayloadWithFinancials();L.Versions=[];L.Terms=[];k.state.store(L,{MasterdataSystem:x,LocationNodeId:"",ExtLocationNodeId:"",LeadingCategory:"",LeadingCategoryName:"",PromotionType:"",PurchasingGroup:""});M.setMasterDataSystemPersonalization(x);var N="edit";if(k.pathName==="versionCreate"){window.history.back();return;}else if(k.pathName==="versionDisplay"){N="display";}k.getRouter().navTo(N,{path:U.base64ToHex(L.OfferId)},true);});},onOfferContentSave:function(){var e=this.getView();U.offerContentSaveDialog(e).then(function(){var i=this.getOwnerComponent().getMetadata().getConfig();this.onSave().then(function(j){if(j){var k=j.OfferId;U.toOfferContent(k,i);}});}.bind(this),jQuery.noop);}});});
