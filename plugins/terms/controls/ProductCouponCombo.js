/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/m/Input","sap/m/InputRenderer","retail/pmr/promotionaloffers/utils/Models","retail/pmr/promotionaloffers/utils/Utils","sap/ui/core/ListItem","sap/ui/model/json/JSONModel","sap/ui/comp/valuehelpdialog/ValueHelpDialog"],function(I,c,M,U,L,J,V){var P="01";var d="13";function g(a){if(!a){return"";}if(!a.ExtNodeId){return a.Name;}if(!a.Name){return a.ExtNodeId;}return a.ExtNodeId+" - "+a.Name;}function p(i,a){if(a){i.setValue(a.ExtNodeId);i.setDescription(a.Name);}else{i.setValue(null);i.setDescription(null);}}return I.extend("retail.pmr.promotionaloffers.plugins.terms.controls.ProductCouponCombo",{metadata:{properties:{masterdataSystem:{type:"string"},productCouponId:{type:"string"}}},renderer:c,_changeProxy:function(){},init:function(){this.attachSuggest(this._onSuggest);this.attachSuggestionItemSelected(this._onSuggestionItemSelected);this.setStartSuggestion(3);this.setShowSuggestion(true);this.setMaxSuggestionWidth("550px");this.setShowValueHelp(true);this.attachValueHelpRequest(this.initAdvancedSearch);this.attachChange(this.validateCoupon);this.setFilterFunction(function(v,i){function e(a,b){return a.indexOf(b)>-1;}var f=i.data;var l=v.toLowerCase();return e((f.Name+"").toLowerCase(),l)||e((f.ExtNodeId+"").toLowerCase(),l);});},destroy:function(){this.clearErrorMessage();I.prototype.destroy.apply(this,arguments);},clearErrorMessage:function(){var s=this.getBindingContext().getPath();U.removeMessagesByPath(s);this.setValueState("None");},createVHD:function(i,a){var t=this;this.couponAdvancedSearch=new V({title:a.getResourceBundle().getText("Terms.CouponAdvancedSearch.DialogTitle"),supportMultiselect:false,stretch:sap.ui.Device.system.phone,cancel:function(){this.close();},selectionChange:function(e){var s=e.getParameter("tableSelectionParams");var b=s.rowIndex;var f=s.rowContext.getModel().getData()[b];t.setProductCouponId(f.Id);p(t,f);this.close();t.clearErrorMessage();}});this.couponAdvancedSearch.addStyleClass("sapUiSizeCompact");},setTable:function(i){var t=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.terms.controls.ProductCouponCombo",this);t.setModel(i,"i18n");t.setBusy(true);this.couponModel=new J();t.setModel(this.couponModel);this.couponAdvancedSearch.setTable(t);},makeCall:function(a,b,f){var t=this;M.getCoupons(a.getMasterdataSystem(),b,P,d,f).then(function(e){var m=[];for(var i=0,l=e.Coupons.length;i<l;i++){var h={};h.Id=e.Coupons[i].Id;h.MasterdataSystem=e.Coupons[i].MasterdataSystem;h.ExtNodeId=e.Coupons[i].ExtNodeId;h.Name=e.Coupons[i].Name;h.StatusName=e.Coupons[i].ProductDetail.StatusName;m.push(h);}t.couponModel.setData(m);t.couponAdvancedSearch.getTable().setBusy(false);});},getFilterItems:function(i){var f=[];var a=[{label:i.getResourceBundle().getText("Terms.CouponAdvancedSearch.ExtNodeId"),key:"ExtNodeId"},{label:i.getResourceBundle().getText("Terms.CouponAdvancedSearch.Name"),key:"Name"}];for(var t=0;t<a.length;t++){var b=new sap.m.MultiInput(this.getFilterBarSettings([{label:a[t].label,key:a[t].key}],a[t].label));b.setFilterFunction(function(){return true;});b.searchKey=a[t].key;var e=new sap.ui.comp.filterbar.FilterItem({control:b,name:a[t].label,partOfCurrentVariant:true,label:a[t].label});f.push(e);}return f;},initAdvancedSearch:function(e){var t=this;var i=e.getSource();var a=U.getResourceModel();var b=U.getI18NModel();if(!this.couponAdvancedSearch){this.createVHD(i,b);this.setTable(a);var f=new sap.ui.comp.filterbar.FilterBar({advancedMode:true,filterBarExpanded:true,showGoOnFB:true,filterItems:t.getFilterItems(b),search:function(k){t.couponAdvancedSearch.getTable().setBusy(true);var l=U.calculateFilters(k);var m=U.flatenFilters(l);var n=U.setBasicSearchValue.call(t,"couponAdvancedSearch");t.makeCall(i,n,m);}});var h=new sap.m.SearchField({showSearchButton:sap.ui.Device.system.phone,placeholder:b.getResourceBundle().getText("General.Location.Picker.Placeholder")});if(f.setBasicSearch){f.setBasicSearch(h);}f.setSearchEnabled(true);t.couponAdvancedSearch.setFilterBar(f);}var j=i.getProperty("value");if(j.length>0){this.couponAdvancedSearch.setBasicSearchText(j);}this.makeCall(i,j);this.couponAdvancedSearch.getTable().clearSelection();this.couponAdvancedSearch.open();},getFilterBarSettings:function(r,t){var a=this;var n={valueHelpRequest:function(){var a=this;var s=[sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.BT,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.Contains,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.EQ,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.EndsWith,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.GE,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.GT,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.LE,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.LT,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.StartsWith];var v=new sap.ui.comp.valuehelpdialog.ValueHelpDialog({supportMultiselect:true,supportRanges:true,supportRangesOnly:true,title:t,ok:function(C){a.setTokens(C.getParameters().tokens);v.close();},cancel:function(C){v.close();},afterClose:function(){v.destroy();}});v.setIncludeRangeOperations(s);v.setRangeKeyFields(r);v.setTokens(a.getTokens());v.open();}};return n;},_onSuggest:U.throttle(function(e){var i=e.getSource();var s=e.getParameter("suggestValue");M.getProducts(i.getMasterdataSystem(),s,P,d).then(function(a){i.destroySuggestionItems();a.Products.map(function(b){var f=new L({key:b.Id,text:g(b),additionalText:b.TypeName});f.data=b;return f;}).forEach(function(b){i.addSuggestionItem(b);});});},250),_onSuggestionItemSelected:function(e){var i=e.getSource();var a=e.getParameter("selectedItem");var b=a.data;i.setProductCouponId(b.ProductId);p(i,b);this.clearErrorMessage();},validateCoupon:function(e){var s=e.getSource()._iPopupListSelectedIndex;if(s>-1){return;}var i=e.getSource();var v=i.getValue();if(!v){this.clearErrorMessage();return;}M.searchProduct(i.getMasterdataSystem(),v.toUpperCase(),P,d).then(function(a){if(a.Products.length){var b=a.Products[0];i.setProductCouponId(b.ProductId);p(i,b);}else{i.setProductCouponId(null);i.setValue(v);i.setDescription(null);var f=i.getBindingContext().getPath();var h=f.split("/");var j=h[2];j=parseInt(j,10)+1;var k=U.getI18NModel();var m=U.getMessageManager();var l=[{message:k.getResourceBundle().getText("CreateOffer.Terms.InvalidProductCoupon.Title"),description:k.getResourceBundle().getText("CreateOffer.Terms.InvalidProductCoupon.Description",j),type:"Error",target:f,processor:i.getBindingContext().getModel()}];U.setErrorMessages(m,l);i.setValueState("Error");}});},setProductCouponId:function(v){this.clearErrorMessage();var t=this;if(!v){t.setProperty("productCouponId",null);p(t,null);return;}M.getProductById(v,P).then(function(a){t.setProperty("productCouponId",a.ProductId);p(t,a);},function(e){t.setProperty("productCouponId",null);if(e){jQuery.sap.log.error(e);}});}});});
