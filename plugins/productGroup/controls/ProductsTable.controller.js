/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/utils/Models"],function(C,J,U,M){"use strict";return C.extend("retail.pmr.promotionaloffers.plugins.productGroup.controls.ProductsTable",{constructor:function(){this.contentModel=new J();this.dataModel=new J();this.timeModel=new J();},onInit:function(){this.getView().setModel(this.contentModel,"Content");this.getView().setModel(this.dataModel);var r=U.getResourceModel();this.getView().setModel(r,"i18n");this.contentModel.setProperty("/Editable",true);this.oMessageManager=U.getMessageManager();this.i18nModel=U.getResourceModel();this.componentId=U.getComponent().getId();this.productSearchField=this.getView().byId("productFilterId");this.busyIndicator=new sap.m.BusyDialog({text:"Importing products, please wait"});},getEventBus:function(){return sap.ui.getCore().getEventBus();},getProductGroupData:function(){var d=jQuery.extend({},this.dataModel.getData());return d;},resetSearchField:function(){this.productSearchField.setValue("");},setProductGroupData:function(d,i){this.dataModel.setData(d);this.contentModel.setProperty("/ReadOnly",!!d.Display);this.contentModel.setProperty("/EnableDelete",false);this.contentModel.setProperty("/IsIncluded",i);this.contentModel.setProperty("/EnableMultipleAdd",i);var p=this.getCorrectData(d);this.contentModel.setProperty("/ProductGroupItems",p);this.setCurentModelData(p);},getTable:function(){return this.getView().byId("productsTable");},getCurentModelData:function(){var p="/Excluded";if(this.contentModel.getProperty("/IsIncluded")){p="/Included";}var t=this.dataModel.getProperty(p);return t;},setCurentModelData:function(d){var p="/Excluded";if(this.contentModel.getProperty("/IsIncluded")){p="/Included";}this.dataModel.setProperty(p,d);},getCorrectData:function(d){var p=[];if(d){if(this.contentModel.getProperty("/IsIncluded")){p=d.Included?d.Included.results:[];}else{p=d.Excluded?d.Excluded.results:[];}}return p;},launchSearchProductsDialog:function(){var t=this;return new Promise(function(r,a){var p="retail.pmr.promotionaloffers.plugins.terms.controls.search.ProductSearchPage";var c=sap.ui.controller(p);var f=sap.ui.xmlfragment(p,c);f._sOwnerId=t.componentId;var i="Terms.Advanced.Product.Title";var m=t.getView().getModel().getProperty("/MasterdataSystem");c.onInit(f,m,null,i,r,a,true,t.getCurentModelData());});},launchProductImportDialog:function(){var t=this;return new Promise(function(r,a){function n(i){return!!i.trim();}function d(i,e,l){return l.indexOf(i)===e;}function m(e){return e.map(g);}var s={productIds:[]};var v=null;function b(v,s){if(!v){return;}var p=s.productIds;v.setTokens(m(p));v.setValue(null);}function c(s,e){switch(e.type){case"ADD_ITEMS":var i=s.productIds;var l=e.payload;var o=i.concat(l).filter(d);return{productIds:o};case"DELETE_ITEM":var p=s.productIds;var q=e.payload;return{productIds:p.filter(function(u){return q.indexOf(u)===-1;})};default:return s;}}function f(e){s=c(s,e);b(v,s);}function g(i){var e=new sap.m.Token({text:i,key:i});return e;}function h(e,l){for(var i=0;i<l.length;i++){if(e.indexOf(l[i])>-1){return true;}}return false;}var j={onInit:function(e){v=e.getSource();b(v,s);},handleOkPress:function(e){r(s.productIds);this.close(e);},handleCancelPress:function(e){a();this.close(e);},close:function(e){var k=e.getSource().getParent();k.close();k.destroy();},onChange:function(e){var i=e.getParameter("value");if(h(i,[";",","," ","\n"])){var l=i.replace(/;/g,";").replace(/\n/g,";").replace(/ /g,";").split(";");var p=l.filter(n);f({type:"ADD_ITEMS",payload:p});}},onTokenUpdate:function(e){var R=e.getParameter("removedTokens");var p=[];for(var i=0;i<R.length;i++){p.push(R[i].getText());}if(p.length>0){f({type:"DELETE_ITEM",payload:p});}}};var k=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.productGroup.controls.ProductImportDialog",j);k.setModel(t.i18nModel,"i18n");k.open();});},setTableState:function(b){this.getTable().setBusy(b);},removeTableSelections:function(){this.getTable().removeSelections(true);},triggerOnAction:function(){var i=this.contentModel.getProperty("/IsIncluded");this.getEventBus().publish("retail.pmr.promotionaloffers","onAction",{isIncluded:i});},handleAddPress:function(){var t=this;this.launchSearchProductsDialog().then(function(p){t.setCurentModelData(p);t.triggerOnAction();});},handleAddMultiplePress:function(){var t=this;var m=this.getView().getModel().getProperty("/MasterdataSystem");function d(i,n){return n.reduce(function(a,b){var c=i.filter(function(p){return p.ExtNodeId.toString().toUpperCase()===b;});if(!c.length){a.push(b);}return a;},[]);}function g(b,a){var c=Array.prototype.splice.call(arguments,0);c.splice(0,2);var r=[b.getText(a)].concat(c);return jQuery.sap.formatMessage.apply(null,r);}function v(i,a,n){var f="/ProductGroupPage/Messages";U.removeMessagesByPath(f);var b=d(a,n);var c=b.length===0;if(c){var e=g(i,"ProductGroupPage.ProductsTable.AddMultipleSuccess",a.length);sap.m.MessageBox.information(e);}else{var h=g(i,"ProductGroupPage.ProductsTable.AddMultipleFailed",b.length,n.length);sap.m.MessageBox.warning(h);var j=b.map(function(o){var q=g(i,"ProductGroupPage.ProductsTable.AddMultipleFailedWarnTitle",o);var r=g(i,"ProductGroupPage.ProductsTable.AddMultipleFailedWarnDesc",o);return{target:f,message:q,description:r,type:"Warning",};});var p=g(i,"ProductGroupPage.ProductsTable.AddMultiplePartialSuccessTitle",a.length);var k=a.map(function(o){return o.ExtNodeId;}).join(", ");var l=g(i,"ProductGroupPage.ProductsTable.AddMultiplePartialSuccessDesc",k);j.push({message:p,description:l,type:"Success",target:f});U.setErrorMessages(U.getMessageManager(),j,new J());}}this.launchProductImportDialog().then(function(a){t.busyIndicator.open();var b=t.contentModel.getProperty("/ProductGroupItems");var c=a.map(function(e){return e.toString().toUpperCase();});b=b.filter(function(p){return c.indexOf(p.ExtId)===-1;});return M.fetchProductsByExternalIds(m,c).then(function(p){t.busyIndicator.close();v(t.i18nModel.getResourceBundle(),p,c);t.setCurentModelData(p.concat(b));t.triggerOnAction();},function(f){try{var h=JSON.parse(f.responseText).error;var i=h.code;if(i==="/IWFND/CM_BEC/026"){sap.m.MessageBox.error(t.i18nModel.getResourceBundle().getText("ProductGroupPage.ProductsTable.AddMultipleFailedToManyItems"));}else{sap.m.MessageBox.error(t.i18nModel.getResourceBundle().getText("ProductGroupPage.ProductsTable.AddMultipleFailedGeneric"));}}catch(e){sap.m.MessageBox.error(f.statusText);}t.busyIndicator.close();});},U.identity);},onLiveChange:function(e){var s=e.getParameter("newValue");this.searchAfterAValue(s);},onSearch:function(e){var s=e.getParameter("query");this.searchAfterAValue(s);},searchAfterAValue:function(s){var m=jQuery.extend(true,[],this.getCurentModelData());var p=m.filter(function(i){return(i.Name.indexOf(s)>-1)||(i.ExtId.indexOf(s)>-1);});this.contentModel.setProperty("/ProductGroupItems",p);this.getTable().removeSelections(true);},onRowSelected:function(e){var t=this;this.selectedProducts=[];this.oSelectedItems=e.getSource().getSelectedItems();this.oSelectedItems.forEach(function(i){t.selectedProducts.push(i.getBindingContext("Content").getObject());});this.contentModel.setProperty("/EnableDelete",false);if(this.oSelectedItems&&this.oSelectedItems.length>0){this.contentModel.setProperty("/EnableDelete",true);}},getProductIndex:function(p,c){var a=-1;for(var i=0;i<p.length;i++){if(c.Id===p[i].Id){a=i;break;}}return a;},handleDeletePress:function(e){var s=this.selectedProducts;if(s.length===0){return;}var d={"massageSingle":"","messageMulti":"ProductGroupPage.DeleteProductsDialog.Message","title":"ProductGroupPage.DeleteProductsDialog.Title"};var t=this;U.openDeleteConfirmDiaog(false,d).then(function(){var a=t.getCurentModelData();s.forEach(function(b){var c=t.getProductIndex(a,b);if(c>-1){a.splice(c,1);}});var i=t.contentModel.getProperty("/IsIncluded");t.getEventBus().publish("retail.pmr.promotionaloffers","onAction",{isIncluded:i});});}});});
