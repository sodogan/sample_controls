/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/m/Table","sap/m/TableRenderer","retail/pmr/promotionaloffers/utils/Models","sap/m/Toolbar","sap/m/Button","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Utils","sap/ui/comp/smartvariants/PersonalizableInfo","sap/m/ToolbarSpacer","sap/ui/comp/smartvariants/SmartVariantManagement","sap/m/Column","sap/m/Label","sap/m/Text","sap/m/ColumnListItem","sap/m/BusyIndicator"],function(T,a,M,b,B,J,U,P,c,S,C,L,d,e,f){return T.extend("retail.pmr.promotionaloffers.utils.controls.TableWithCount",{renderer:a.render,metadata:{properties:{persistencyKey:{type:"string",group:"Misc",defaultValue:null},itemProperty:{type:"string",defaultValue:null},toolbarLoadingIndicator:{type:"boolean",defaultValue:false}},aggregations:{columns:{type:"sap.m.Column",multiple:true,singularName:"column"},template:{type:"sap.m.ColumnListItem",multiple:false,singularName:"item"}}},initialiseVariantManagement:function(){if(this.variantManagement&&!this.variantInitialized){this.variantInitialized=true;this.addToolbar();this.defaultCols=this.getColumns();this.defaultCells=this.getTemplate().getCells();this.bindItems(this.getItemProperty(),this.getTemplate());this.addColumnsFromMetadata();}},init:function(){T.prototype.init.apply(this,arguments);this.busyIndicator=new f({visible:this.getToolbarLoadingIndicator()});this.maxCount=0;var i=["SalesUom","DistributionChannel","SalesOrg","Id"];this.variantManagement=new S({});var m=M.getServiceModel().getMetaModel();var n=M.getNamespace(M.getServiceModel());this.oEntity=m.getODataEntityType(n+".ProductDetail");this.metaProperties=[];this.oEntity.property.forEach(function(p){if(p.name.indexOf("AT_")===-1&&i.indexOf(p.name)===-1){this.metaProperties.push({property:p.name,label:p["sap:label"],visible:p["sap:visible"]==="false"?false:true});}}.bind(this));},setToolbarLoadingIndicator:function(v){this.setProperty("toolbarLoadingIndicator",!!v);this.busyIndicator.setVisible(!!v);},getColsFromMeta:function(){var o=new e();this.defaultCells.forEach(function(i){o.addCell(i);});var g=this.defaultCols.map(function(i,j){i.setOrder(j);return i;});function n(j){for(var i=0,l=g.length;i<l;i++){if(g[i].data("cellData")===j.property){if(!g[i].getHeader()){g[i].setHeader(new d({text:j.label}));}g[i].setVisible(true);return false;}}return true;}var h=[];this.metaProperties.map(function(p,i){if(n(p)&&p.visible){h.push(new C({header:new L({text:p.label}),minScreenWidth:"Tablet",demandPopin:true,visible:false}).data("cellData",p.property));o.addCell(new d({text:"{Data>ProductDetail/"+p.property+"}"}));}});return{list:o,columns:g.concat(h)};},addColumnsFromMetadata:function(){this.removeAllColumns();var g=this.getColsFromMeta();g.columns.forEach(function(h){this.addColumn(h);}.bind(this));this.bindItems(this.getItemProperty(),g.list);},addToolbar:function(){var t=new b();t.addContent(this.variantManagement);t.addContent(new c());t.addContent(this.busyIndicator);t.addContent(new B({icon:"sap-icon://action-settings",press:this.openPersonalizationDialog.bind(this)}));this.setHeaderToolbar(t);},setPersistencyKey:function(v,i){this.setProperty("persistencyKey",v,i);var p=new P({type:"Control",keyName:"persistencyKey",dataSource:"TODO"});this._sOwnerId=U.getComponent().getId();p.setControl(this);this.variantManagement.addPersonalizableControl(p);this.variantManagement.initialise(this.initialiseVariantManagement,this);},openPersonalizationDialog:function(){var g=sap.ui.xmlfragment("retail.pmr.promotionaloffers.fragments.FinFields",this);var F=this.getColumns().map(function(h){return{path:h.data("cellData"),text:h.getHeader().getText(),visible:h.getVisible(),index:(h.getOrder())?(h.getOrder()):-1};});var p=new J({Fields:F});g.setModel(p);g.open();},closeFinFields:function(E){E.getSource().close();E.getSource().destroy();},okFinFields:function(E){var g=E.getParameter("payload").columns;this.closeFinFields(E);if(!g.tableItemsChanged){return;}this.variantManagement.currentVariantSetModified(true);this.rebuildTable(g.tableItems);},rebuildTable:function(g){this.aColumns=g||[];var h=this.getColumns();var t=[];this.removeAllColumns();for(var i=0,l=h.length;i<l;i++){for(var j=0,k=this.aColumns.length;j<k;j++){if(h[i].data("cellData")===this.aColumns[j].columnKey){h[i].setVisible(this.aColumns[j].visible);h[i].setOrder(this.aColumns[j].index);t.push(h[i]);break;}}}t.forEach(this.addColumn,this);},setMaxCount:function(g){this.maxCount=g;},resetGrowing:function(){this._oGrowingDelegate.reset();},getMaxItemsCount:function(){return this.maxCount;},fetchVariant:function(){return{columns:this.aColumns};},applyVariant:function(v){if(!v.columns){this.removeAllColumns();var x=this.getColsFromMeta();x.columns.forEach(function(g){this.addColumn(g);}.bind(this));this.bindItems(this.getItemProperty(),x.list);}else{this.rebuildTable(v.columns);}}});});
