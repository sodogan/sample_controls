/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Utils","sap/m/MessageBox"],function(J,U,M){function p(a,b){for(var i=0;i<b.length;i++){var e=b[i];if(e.Id===a.Id){return true;}}return false;}function c(e,i){var k=i.map(function(a){return p(e,a);});return k.reduce(function(a,b){return a&&b;},true);}function d(a,b){for(var k=0;k<b.length;k++){if(b[k].Id===a.Id){return true;}}return false;}function f(a){return a.reduce(function(b,e){var i=e.filter(function(k){var B=c(k,a)&&!d(k,b);return B;});return b.concat(i);},[]);}function g(a){if(jQuery.isNumeric(a)){return parseFloat(a);}var b=sap.ui.core.format.NumberFormat.getFloatInstance({style:'standard',groupingEnabled:false,minIntegerDigits:0,maxIntegerDigits:14,minFractionDigits:0,maxFractionDigits:5,emptyString:null});return b.parse(a);}function h(a){var b=sap.ui.core.format.NumberFormat.getFloatInstance({style:'standard',groupingEnabled:false,minIntegerDigits:0,maxIntegerDigits:14,minFractionDigits:0,maxFractionDigits:5,emptyString:null});return b.format(a);}function j(a,b){if(!a||a.length===0){return a;}a=jQuery.extend(true,[],a);Object.keys(a).forEach(function(e){b.forEach(function(i){if(!a[e][i]){a[e][i]=false;}});});return a;}function l(a){if(!a||a.length===0){return{};}return a.reduce(function(b,e){var i=Object.keys(b);i.forEach(function(k){if(b[k]!==e[k]){delete b[k];}});return b;});}function r(a){return Object.keys(a).reduce(function(b,k){var e=a[k];if(jQuery.isNumeric(e)){b[k]=h(e);}else{b[k]=e;}return b;},{});}function m(a,b,e){var i=b.map(function(b){return b.UnitOfMeasures;}).filter(U.identity);var k={};k.UnitOfMeasures=f(i);k.CurrencyList=b.CurrencyList||[];return k;}var N=["LockUserProjection"];function n(a,b){return N.concat(b).indexOf(a)!==-1;}function P(a,b,e,i){this.updateHandler=a;this.productDetails=b||[];this.editableFields=e;this.enforceMultiple=i;}function o(a,b,e,i,k){var B={};i.forEach(function(C){if(n(C,k)){B[C]=(b[C]&&b[C]!=="false")||b[C]==="true"?true:false;}else{B[C]=b[C];}});return a.map(function(C){var D={};i.forEach(function(E){if(!e[E+"Selected"]){return;}if(n(E,k)){D[E]=B[E];}else if(isNaN(g(B[E]))){D[E]=B[E];}else{D[E]=g(B[E])+"";}});D.Index=C.Index;return D;});}function s(a){return a.every(function(b,i,e){return b.DiscountType===e[0].DiscountType;});}function q(a,b,e){var i=e[0].DiscountType;var k=e[0].DiscountTypeLabel;var B=b[0][a]?g(b[0][a]):null;if(!i&&B!==null){return[{Type:"NoDiscountTypeError",Property:a}];}if(i==="05"||i==="06"){return[{Type:"FreeAndEDLPValidationError",Text:k,Property:a}];}if(i==="04"){if(B<0||B>100){return[{Type:"DiscountPercentOffValidationError",Property:a}];}}else{if(B<0){return[{Type:"RegularValueValidationError",Property:a}];}if(isNaN(B)){return[{Type:"IsNaNValidationError",Property:a}];}}return[];}function v(a,b){var e=!!a[0].DiscountValue;var i=s(b);if(e&&!i){return[{Type:"DiscountTypeError",Property:"DiscountValue"}];}return q("DiscountValue",a,b);}function t(a,b,e){var i=!!a[0].SubDiscountValue;var k=s(b);if(!i){return[];}if(!k){return[{Type:"DiscountTypeError",Property:"SubDiscountValue"}];}if(e!=="I"){return[{Type:"EnforceMultipleValidationError",Property:"SubDiscountValue"}].concat(q("SubDiscountValue",a,b));}return q("SubDiscountValue",a,b);}function u(a){return a.reduce(function(b,e){return jQuery.extend(true,b,e.Config);},{});}function w(a){return a[0];}function x(a,b){return a&&(!b.Editable||!b.Visible);}function y(a,b){var e=u(b);var i=w(a);return Object.keys(e).reduce(function(k,B){var C=e[B];var D=i[B];if(x(D,C)){k.push({Type:"ConfigError",Property:B});}return k;},[]);}function z(a,b){var e=a[0];var i=["UserProjection","DisplayUoMValue","PromoCostPrice"];return i.reduce(function(k,B){var C=e[B];if(!C){return k;}var D=parseFloat(C);if(D<0){k.push({Type:"RegularValueValidationError",Property:B});}if(isNaN(D)){k.push({Type:"IsNaNValidationError",Property:B});}return k;},[]);}P.prototype.validate=function(a){var b=this.productDetails;var e=this.enforceMultiple;return new Promise(function(i){if(a.length===0||b.length===0){return i([]);}var k=[];k=k.concat(v(a,b));k=k.concat(t(a,b,e));k=k.concat(y(a,b));k=k.concat(z(a,b));return i(k);});};function A(e,a){M.error(e.reduce(function(b,i){return b+a(i)+"\n";},""));}P.prototype.openDialog=function(){var a=this.editableFields;var b=this.productDetails;var i=this.updateHandler;var k=U.getI18NModel();var B=i.model.getProperty("/AllPurposes")||[];var C=[];var D=this;function E(e){var O=e.Type;var Q=e.Property||"";var R=e.Text||"";var S=k.getResourceBundle();var T=S.getText("ManageOffer.ProductDetail.Error."+O);var V=S.getText("ManageOffers.ProductDetails."+Q);var W=[V];if(R){W.push(R);}return jQuery.sap.formatMessage(T,W);}function F(O){return function(e){var Q=I.getModel();var R={};R[O+"Selected"]=true;var S=e.getSource();var T=o(b,Q.getData(),R,a,this.dynamicPurposes);D.validate(T).then(function(V){var W=V.map(E);if(W.length>0){S.setValueState("Error");S.setValueStateText(W.join(" \n"));}else{S.setValueState("None");S.setValueStateText(null);var X=g(Q.getProperty("/"+O));Q.setProperty("/"+O,h(X));}});};}var G={close:function(){I.close();I.destroy();},ok:function(){var e=I.getModel();var O=I.getModel("Data");var Q=o(b,e.getData(),O.getData(),a,this.dynamicPurposes);D.validate(Q).then(function(R){if(R.length>0){A(R,E);}else{i.massChange(Q);this.close();}}.bind(this));},cancel:function(){this.close();}};function H(I,e){var O="_PURPOSE_"+e.Id;C.push(O);var Q=new sap.ui.layout.Grid({width:"100%",defaultSpan:"L12 M12 S12",hSpacing:1,content:[new sap.m.ComboBox({selectedKey:"{/"+O+"}",width:"100%",items:[new sap.ui.core.Item({key:true,text:k.getResourceBundle().getText("CreateOffer.MassEdit.Yes")}),new sap.ui.core.Item({key:false,text:k.getResourceBundle().getText("CreateOffer.MassEdit.No")})],layoutData:new sap.ui.layout.GridData({span:"L10 M10 S10"}),id:"PURPOSE_ID_"+e.Id}),new sap.m.CheckBox({layoutData:new sap.ui.layout.GridData({span:"L2 M2 S2"}),selected:"{Data>/"+O+"Selected}"})]}).addStyleClass("gridInVerticalLayout");var R=new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:e.Name,labelFor:"PURPOSE_ID_"+e.Id}).addStyleClass("sapUiSmallMarginBegin"),Q]});I.addContent(R);}a.forEach(function(e){G["validate"+e]=F(e);});var I=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.terms.controls.freestyle.DetailsMassChangeDialog",G);I.open();B.forEach(function(e){H(I,e);});G.dynamicPurposes=C;a=a.concat(C);var K=r(l(j(b,C)));var L=m(i,b,K);I.setModel(k,"i18n");I.setModel(new J(K));I.setModel(new J(L),"Data");return I;};return P;},true);
