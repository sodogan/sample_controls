/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/utils/DateHandler","retail/pmr/promotionaloffers/utils/Formatter","retail/pmr/promotionaloffers/plugins/productGroup/ProductsCategoryHelper"],function(C,J,U,D,F,P){"use strict";return C.extend("retail.pmr.promotionaloffers.plugins.productGroup.preview.Preview",{constructor:function(){C.apply(this,arguments);this.dataProvider=null;this.contentModel=new J();this.dataModel=new J();this.onDemandProductsModel=new J();},onInit:function(){this.getView().setModel(this.contentModel,"Content");this.getView().setModel(this.dataModel);var r=U.getResourceModel();this.getView().setModel(r,"i18n");this.contentModel.setProperty("/Editable",true);this.oMessageManager=U.getMessageManager();this.i18nModel=U.getResourceModel();this.resetModel();this.state=this.getOwnerComponent().getState();this.masterDataSystem=this.state.offerData.MasterdataSystem;this.productCategoryHelper=new P(this.masterDataSystem,[],[]);},getTable:function(){return sap.ui.getCore().byId("listViewTable");},getTreeTable:function(){return sap.ui.getCore().byId("categoryViewTable");},getSmartTable:function(){return sap.ui.getCore().byId("previewHierarchySmartTable");},getPopUpTable:function(){return sap.ui.getCore().byId("onDemandProductsTable");},getProductGroupData:function(){var p={Search:this.contentModel.getProperty("/Search"),Skip:this.contentModel.getProperty("/Skip"),Top:this.contentModel.getProperty("/Top")};return p;},getEventBus:function(){return sap.ui.getCore().getEventBus();},setTableState:function(b){var t=this.getTable();var a=this.getTreeTable();var p=this.getPopUpTable();if(t){t.setBusy(b);}if(a){a.setBusy(b);}if(p){p.setBusy(b);}},setProductGroupData:function(d,I){if(this.IsListView){var p=[];var a=0;var b=0;this.IsRefresh=I;if(I){this.resetModel();var c=[];this.dataModel.setProperty("/ProductGroupItems",c);this.updateCount(a,b);}if(d&&d.Preview){a+=this.contentModel.getProperty("/DisplayCount")+20;p=d.Preview.results||d.Preview;b=d.Cardinality;}var v=d&&d.Cardinality?d.Cardinality:"0";this.dataModel.setProperty("/Cardinality",v);var e=this.dataModel.getProperty("/ProductGroupItems");if(e&&e.length>0){this.dataModel.getProperty("/ProductGroupItems").pop();}c=(this.dataModel.getProperty("/ProductGroupItems")||[]).concat(p);this.dataModel.setProperty("/ProductGroupItems",c);this.contentModel.setProperty("/ProductGroupItems",c);this.updateCount(a,b);if(d&&d.Preview){d.Preview.results=this.dataModel.getProperty("/ProductGroupItems").slice(0,21);}this.populateSearchFieldForListView();}else{this.dataModel.setProperty("/ProductGroupItems",[]);this.contentModel.setProperty("/DisplayCount",0);this.productCategoryHelper.setProductsCategory(d);var h=this.productCategoryHelper.getHierarchy(true);this.contentModel.setProperty("/HierarchyPreview",h);this.dataModel.setProperty("/HierarchyPreview",this.contentModel.getProperty("/HierarchyPreview"));this.refreshTreeTable();this.smartTable=this.getSmartTable();this.smartTable.setHeader(this.i18nModel.getResourceBundle().getText("ProductGroupPage.ProductsTable.TableTitle",d.Cardinality));this.populateSearchFieldForCategoryView();}this.previewData=d;},refreshTreeTable:function(){var t=this.getTreeTable();t.refreshRows(true);t.getModel().refresh(true);t.setSelectionBehavior(sap.ui.table.SelectionBehavior.RowOnly);},onSegmentButtonPress:function(e){var a=e.getParameters().id.split("-");var c=a[0];var f="retail.pmr.promotionaloffers.plugins.productGroup.preview.ListView";this.IsListView=true;this.dataModel.setProperty("/ProductGroupItems",this.listViewData);if(c==="categoryViewButton"){f="retail.pmr.promotionaloffers.plugins.productGroup.preview.CategoryView";this.IsListView=false;}this.changeFragment(f);this.segmentedButtonController=sap.ui.getCore().byId("segmentedButtonId");this.segmentedButtonController.setSelectedButton(e.getParameters().button);this.setProductGroupData(this.previewData);this.getEventBus().publish("retail.pmr.promotionaloffers","reselectTab",{indexSection:3});},populateSearchFieldForListView:function(i){if(i&&this.popUpSearchValue){var p=sap.ui.getCore().byId("popUpSearchField");p.setValue(this.popUpSearchValue);return;}if(this.searchValue){var s=sap.ui.getCore().byId("searchField");s.setValue(this.searchValue);}},populateSearchFieldForCategoryView:function(){if(this.categorySearchValue){var s=sap.ui.getCore().byId("searchFieldCategory");s.setValue(this.categorySearchValue);this.searchTreeTableAfterAValue(this.categorySearchValue);}},resetSearch:function(){var s=sap.ui.getCore().byId("searchField");if(s){s.setValue("");}this.searchValue=null;},resetModel:function(i){if(i){this.oldContentModel={};jQuery.extend(true,this.oldContentModel,this.contentModel);}this.contentModel.setProperty("/Search","");this.contentModel.setProperty("/Skip",0);this.contentModel.setProperty("/Top",21);this.updateCount(0,0,i);if(!i){this.IsListView=true;this.changeFragment("retail.pmr.promotionaloffers.plugins.productGroup.preview.ListView");}},onUpdateStarted:function(e){var r=e.getParameter("reason");var s=this.contentModel.getProperty("/DisplayCount");if(r==="Growing"){this.setTableState(true);var g=21;this.contentModel.setProperty("/Search","");this.contentModel.setProperty("/Skip",s);this.contentModel.setProperty("/Top",g);this.getEventBus().publish("retail.pmr.promotionaloffers","onAction",{isPreviewAction:true});}},updateCount:function(d,t,i){this.contentModel.setProperty("/DisplayCount",d);this.contentModel.setProperty("/TotalCount",t);setTimeout(function(){jQuery(i?"#onDemandProductsTable-triggerInfo":"#listViewTable-triggerInfo").text("["+d+"/"+t+"]");},100);},changeFragment:function(f){if(this.oFragment){this.oFragment.destroy(true);}var l=this.getView().byId("mainLayout");this.oFragment=sap.ui.xmlfragment(f,this);l.addContent(this.oFragment);},searchAfterAValue:function(s,i){this.resetModel(i);var a=0;var g=21;this.contentModel.setProperty("/Search",s);this.contentModel.setProperty("/Skip",a);this.contentModel.setProperty("/Top",g);this.dataModel.setProperty("/ProductGroupItems",[]);var o={isPreviewAction:true};if(i){this.onDemandProductsModel.setProperty("/ProductGroupItems",[]);o.launchPopUp=false;o.NodeId=this.categoryObj.Id;}else{this.dataModel.setProperty("/ProductGroupItems",[]);}this.getEventBus().publish("retail.pmr.promotionaloffers","onAction",o);this.populateSearchFieldForListView(i);},onLiveChange:function(e){this.setTableState(true);this.searchValue=e.getParameter("query");this.searchAfterAValue(this.searchValue);},searchTreeTableAfterAValue:function(s){var b=this.smartTable.getTable().getBinding("rows");var f=["Name"];var t=U.uiFilter(f);b.filter([t(s)]);this.refreshTreeTable();},onLiveChangeTreeTable:function(e){var s=e.getParameter("newValue")||"";this.categorySearchValue=s;this.searchTreeTableAfterAValue(this.categorySearchValue);},onCategorySelected:function(e){var s=e.getSource();this.categoryObj={Id:s.data("Id"),Cardinality:s.data("Cardinality"),Name:s.getText()};this.resetModel(true);this.setTableState(true);this.getEventBus().publish("retail.pmr.promotionaloffers","onAction",{isPreviewAction:true,launchPopUp:true,NodeId:this.categoryObj.Id});},setPopUpData:function(d){if(d.Skip==="0"){this.contentModel.setProperty("/DisplayCount",0);}var e=this.onDemandProductsModel.getProperty("/ProductGroupItems");if(e&&e.length>0){this.onDemandProductsModel.getProperty("/ProductGroupItems").pop();}var p=d.Preview?d.Preview.results||d.Preview:[];var a=this.onDemandProductsModel.getProperty("/ProductGroupItems").concat(p);this.onDemandProductsModel.setProperty("/ProductGroupItems",a);var b=this.contentModel.getProperty("/DisplayCount")+20;var c=this.categoryObj.Cardinality;this.updateCount(b,c,true);this.popUpTable=this.getPopUpTable();this.setTableState(false);},launchProductDialog:function(d){this.onDemandProductsModel.setData(d);this.onDemandProductsModel.setProperty("/ProductGroupItems",[]);this.onDemandProductsModel.setProperty("/Cardinality",this.categoryObj.Cardinality);this.onDemandProductsModel.setProperty("/DialogTitle",this.categoryObj.Name);this.setPopUpData(d);var t=this.getTreeTable();var a=this;var o=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.productGroup.preview.OnDemandProducts",{onClose:function(e){e.getSource().getParent().close();if(o){o.destroy(true);}t.clearSelection();if(a.oldContentModel){a.contentModel=a.oldContentModel;a.contentModel.setProperty("/DisplayCount",0);}},onPopUpSearch:function(e){a.onPopUpSearch(e);},onPopUpUpdateStarted:function(e){a.onPopUpUpdateStarted(e);},onListViewTableRebind:function(){var b=a.contentModel.getProperty("/DisplayCount");var c=a.contentModel.getProperty("/TotalCount");a.updateCount(b,c,true);}});o.setModel(U.getI18NModel(),"i18n");o.setModel(this.onDemandProductsModel);o.open();},onPopUpSearch:function(e){this.setTableState(true);this.popUpSearchValue=e.getParameter("query");this.searchAfterAValue(this.popUpSearchValue,true);},onPopUpUpdateStarted:function(e){var r=e.getParameter("reason");var s=this.contentModel.getProperty("/DisplayCount");if(r==="Growing"){this.setTableState(true);var g=21;this.contentModel.setProperty("/Search","");this.contentModel.setProperty("/Skip",s);this.contentModel.setProperty("/Top",g);this.getEventBus().publish("retail.pmr.promotionaloffers","onAction",{isPreviewAction:true,launchPopUp:false,NodeId:this.categoryObj.Id});}},onListViewTableRebind:function(){var d=this.contentModel.getProperty("/DisplayCount");var t=this.contentModel.getProperty("/TotalCount");this.updateCount(d,t);}});});
