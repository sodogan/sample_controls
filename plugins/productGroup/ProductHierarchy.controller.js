/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/utils/TreeValueHelpDialog","retail/pmr/promotionaloffers/utils/Models","retail/pmr/promotionaloffers/plugins/productGroup/ProductsCategoryHelper","retail/pmr/promotionaloffers/plugins/productGroup/DefineFilterHelper","retail/pmr/promotionaloffers/utils/Constants"],function(C,J,U,T,M,P,D,a){"use strict";function I(f){this.filters=f;}I.prototype.getFilters=function(){return jQuery.extend(true,[],this.filters);};I.prototype.deleteFilter=function(i){this.filters=this.filters.filter(function(b){return b.NodeId!==i;});};I.prototype.setFilters=jQuery.noop;var p=C.extend("retail.pmr.promotionaloffers.plugins.productGroup.ProductHierarchy",{constructor:function(){C.apply(this,arguments);this.dataProvider=null;this.oModel=new J();this.contentModel=new J();this.resetView();},resetView:function(){this.filterModified={};this.filtersWithData={};this.idOfNodeIfFilterIconClick=null;},getSmartTable:function(){return this.getView().byId("leadingCategorySmartTable");},getTable:function(){return this.getView().byId("productHierarchyTable");},setTableState:function(b){this.getTable().setBusy(b);},onInit:function(){this.eventBus=sap.ui.getCore().getEventBus();this.getView().setModel(this.oModel);this.i18nBundle=U.getResourceModel();this.getView().setModel(this.i18nBundle,"i18n");this.getView().setModel(this.contentModel,"Content");this.state=this.getOwnerComponent().getState();this.contentModel.setProperty("/ExcludedEnabled",false);this.contentModel.setProperty("/DeleteEnabled",false);this.contentModel.setProperty("/DefineFilter",false);this.contentModel.setProperty("/RemoveFilters",false);this.smartTable=this.getSmartTable();this.table=this.getTable();this.table.setMinAutoRowCount(1);this.table.setVisibleRowCount(1);var s=this;var r=function(){s.table.setShowOverlay(false);};this.table.addEventDelegate({onAfterRendering:r});this.smartTable.setHeader(this.i18nBundle.getResourceBundle().getText("productHierarchy.Title"));this.masterDataSystem=this.state.offerData.MasterdataSystem;this.productCategoryHelper=new P(this.masterDataSystem,[],[]);this.oAddLeadingCategoryButton=this.getView().byId("addLeadingCategoryButton");this.propertyLabels=null;this.getMetadataEntityInformation();this.includePGSearch=this.getView().byId("includeProductGroupSearchId");},getMetadataEntityInformation:function(){var t=this;var b=M.getMetadataAnalyzer();b.then(function(r){var c=r.getSchemaDefinition().entityType.filter(function(i){return i.name==="ProductFilter";});if(c&&c.length>0){t.propertyLabels=jQuery.extend([],c[0].property.map(function(d){return{Key:d["name"],Label:d["sap:label"]};}));t.intervals=jQuery.extend([],c[0].property.filter(function(i){return i["sap:filter-restriction"]==="interval";}).map(function(d){return{Key:d["name"]};}));}});},clearTableSelections:function(){this.breakNormalSelectionFlow=true;this.table.clearSelection();this.breakNormalSelectionFlow=false;},editSetIncludeRule:function(r){var t=r.filter(function(i){return i.Sign==="I";});var b=true;this.productCategoryHelper.setIncludes(t,b);},calculateFiltersModified:function(h){var t=this;var f=function(d,e){for(var i=0,l=e.length;i<l;i++){if(d===e[i].Id){return e[i];}else if(e[i].children&&e[i].children.length>0){var g=f(d,e[i].children);if(g){return g;}}}return null;};var r=function(s){var S=jQuery.extend([],typeof s==="string"?JSON.parse(s):s);var d=[];S.forEach(function(i){d.push({Property:i.Property,Option:i.Option,Sign:i.Sign,Low:i.Low,High:i.High,Text:i.Text});});return JSON.stringify(d);};var b=function(d,e){return d===e;};var c=function(){var d=t.filtersWithData;var e=jQuery.extend([],h);if(d&&Object.keys(d).length>0){for(var i in d){var g=f(d[i].ParentId,e);var j=null;var k=r(d[i].filters);if(g){g.Filters=r(g.Filters);j=b(g.Filters,k);}var n=d[i].filters.length>0;if(!j&&n){t.filterModified[i]=d[i];}if(j&&n&&!!t.filterModified[i]){delete t.filterModified[i];}}}};c();},setFiltersWithData:function(f,n){var t=this;this.filtersWithData={};f.forEach(function(b){if(!t.filtersWithData[b.NodeId]){n.forEach(function(c){if(b.NodeId===c.Id){var d=[];d.push(b);t.filtersWithData[b.NodeId]={ParentId:c.ParentId,filters:d};}});}else{t.filtersWithData[b.NodeId].filters.push(b);}});},setProductGroupData:function(d){if(!d.Display){this.oAddLeadingCategoryButton.setBusy(true);M.getLeadingCategoriesSet(this.masterDataSystem).then(function(l){this.contentModel.setProperty("/ProductsCategories",l);this.oAddLeadingCategoryButton.setBusy(false);}.bind(this));}this.contentModel.setProperty("/EnableDelete",false);this.contentModel.setProperty("/ReadOnly",!!d.Display);var r=d.Rules?d.Rules.results:[];this.editSetIncludeRule(r);var b=true;this.productCategoryHelper.setProductsCategory(d,b);var i=false;var c=true;var h=this.productCategoryHelper.getHierarchy(i,c);if(d.Filters&&d.Nodes){this.setFiltersWithData(d.Filters.results,d.Nodes.results);}this.filterHelper=new I(U.get(d,["Filters","results"])||[]);this.calculateFiltersModified(h);this.productCategoryHelper.markFilterModified(h,this.filterModified);this.oModel.setProperty("/ProductHierarchy",h);this.clearTableSelections();this.resetLinkAndSelection();var e=h.length===0?1:10;this.table.setVisibleRowCount(e);this.table.rerender();},getProductGroupData:function(){var b=this.productCategoryHelper.getPayload();return b;},getPGFilters:function(){if(!this.filterHelper){return[];}if(this.filterHelper){var b=this.filterHelper.getFilters();for(var f in this.filtersWithData){this.filtersWithData[f].filters.forEach(function(i){var c=b.some(function(e){return(e.NodeId===i.NodeId&&e.Property===i.Property);});if(!c){b.push(i);}});}return b;}},resetLinkAndSelection:function(){this.contentModel.setProperty("/ExcludedEnabled",false);this.contentModel.setProperty("/DeleteEnabled",false);this.contentModel.setProperty("/SelectedProducts",[]);this.contentModel.setProperty("/DefineFilter",false);this.contentModel.setProperty("/RemoveFilters",false);},selectionChanged:function(e){var t=this;if(this.breakNormalSelectionFlow){return;}var s=function(i){if(i&&i.length>=2){this.contentModel.setProperty("/DefineFilter",false);this.contentModel.setProperty("/RemoveFilters",false);this.contentModel.setProperty("/ExcludedEnabled",true);}else if(i.length>0){this.contentModel.setProperty("/ExcludedEnabled",true);this.contentModel.setProperty("/DefineFilter",i.length===1?true:false);var n=t.getNode(i[0].Id);var j=JSON.parse(n.Filters);this.contentModel.setProperty("/RemoveFilters",(i.length===1&&j&&j.length>0)?true:false);var k=false;for(var z=0,l=i.length;z<l;z++){if(!U.isInitial(i[z].VirtualParentId)){k=true;break;}}if(!k){this.contentModel.setProperty("/DeleteEnabled",true);}else{this.contentModel.setProperty("/DeleteEnabled",false);}}else{this.contentModel.setProperty("/ExcludedEnabled",false);this.contentModel.setProperty("/DeleteEnabled",false);this.contentModel.setProperty("/DefineFilter",false);this.contentModel.setProperty("/RemoveFilters",false);}};var b=[];if(e.getParameter("selectAll")){var c=e.getParameter("rowIndices");var d=[];c.forEach(function(i){d.push(e.getSource().getContextByIndex(i).sPath);});d.forEach(function(i){var j=e.getParameter("rowContext").oModel.getProperty(i);b.push({Id:j.Id,Dimension:j.Dimension,VirtualParentId:j.virtualParentId});});this.contentModel.setProperty("/SelectedProducts",b);s.call(this,b);}else if(e.getParameter("rowIndex")===-1){this.resetLinkAndSelection();}else if(e.getParameter("rowContext")&&e.getParameter("rowIndices").length===1){var f=e.getParameter("rowContext").sPath;var g=e.getParameter("rowContext").oModel.getProperty(f);var h=this.contentModel.getProperty("/SelectedProducts")||[];var m=function(g){var j=false;for(var i=0,l=h.length;i<l;i++){if(h[i].Id===g.Id){h.splice(i,1);j=true;break;}}if(!j){h.push({Id:g.Id,Dimension:g.Dimension,VirtualParentId:g.virtualParentId});}};m(g);this.contentModel.setProperty("/SelectedProducts",h);s.call(this,h);}},handleExcludeProduct:function(e){var b=this.contentModel.getProperty("/SelectedProducts")||[];var h=this.table.getModel().getData().ProductHierarchy;var c=[];for(var i=0,l=h.length;i<l;i++){c.push({Id:h[i].Id});}this.productCategoryHelper.setIncludes(c);this.eventBus.publish("retail.pmr.promotionaloffers","excludedProducts",{excludedProducts:b});this.resetLinkAndSelection();this.clearTableSelections();this.eventBus.publish("retail.pmr.promotionaloffers","onAction",{isHierarchy:true});},removeAllFiltersFromHierarchy:function(h){var t=this;var r=function(b){for(var i=0,l=b.length;i<l;i++){delete t.filterModified[b[i].Id];delete t.filtersWithData[b[i].Id];if(t.filterHelper){t.filterHelper.deleteFilter(b[i].Id);}if(b[i].children&&b[i].children.length>0){r(b[i].children);}}};r(h);},removeAllFiltersNotModifiedFromHierarchy:function(h){var t=this;var r=function(b){for(var i=0,l=b.length;i<l;i++){if(!b[i].filterModified){delete t.filterModified[b[i].Id];delete t.filtersWithData[b[i].Id];t.filterHelper.deleteFilter(b[i].Id);}if(b[i].children&&b[i].children.length>0){r(b[i].children);}}};delete h[0].filterModified;r(h);},handleDeleteProduct:function(e){var s=e.getSource().getBindingContext().getPath();var b=this.oModel.getProperty(s);var h=this.oModel.getProperty("/ProductHierarchy")||[];if(!b.isIncluded){var d={type:sap.m.DialogType.Message,title:this.i18nBundle.getResourceBundle().getText("Product.Group.Delete.Hierarchy.Title"),message:this.i18nBundle.getResourceBundle().getText("Product.Group.Delete.Hierarchy.Message"),btnOk:this.i18nBundle.getResourceBundle().getText("Product.Groups.Dialog.Search.For.Filters.Ok"),btnCancel:this.i18nBundle.getResourceBundle().getText("Product.Groups.Dialog.Search.For.Filters.Cancel"),onCancel:function(){},onOk:function(){},view:this.getView(),state:sap.ui.core.ValueState.Warning};U.createDialogUtil(d);this.clearTableSelections();this.resetLinkAndSelection();}else{for(var z=h.length-1,c=0;z>=c;z--){if(b.Id===h[z].Id){h.splice(z,1);this.removeAllFiltersFromHierarchy([b]);break;}}this.productCategoryHelper.removeIncludeNode(b.Id);this.clearTableSelections();this.resetLinkAndSelection();this.eventBus.publish("retail.pmr.promotionaloffers","onAction",{isHierarchy:true});}},handleAddProductHierarchy:function(E){var t=this;T.openDialog({tableFragment:"retail.pmr.promotionaloffers.plugins.general.LeadingCategoryComplexSearch",title:"{i18n>productHierarchy.Title}",filterProps:["ExtId","Name","HierarchyDescription","ExtHierarchyId"],values:U.buildHierarchy(this.contentModel.getProperty("/ProductsCategories"),"LeadingCategory"),multiselect:true,styleClass:"sapUiSizeCompact",selectionChange:jQuery.noop,ok:function(e){var b=e.getSource().getTable();var s=b.getSelectedIndices().map(function(i){return b.getContextByIndex(i).getObject();});t.productCategoryHelper.setIncludes(s);t.eventBus.publish("retail.pmr.promotionaloffers","onAction",{isHierarchy:true});e.getSource().close();}});},setSearch:function(s){var b=this.smartTable.getTable().getBinding("rows");var s=s||"";var f=["Name","ExtId","TypeName","MerchandiseCategory","Size","Color","Brand","BaseUom"];var t=U.uiFilter(f);b.filter([t(s)]);},onLiveChange:function(e){this.setSearch(e.getParameter("newValue"));},getDataInclude:function(){var h=this.oModel.getProperty("/ProductHierarchy");return this.productCategoryHelper.slimData(h,true);},resetIncludes:function(){this.oModel.setProperty("/ProductHierarchy",[]);this.productCategoryHelper=new P(this.masterDataSystem,[],[]);this.setSearch("");this.includePGSearch.setValue("");this.resetView();},filterPress:function(e){var s=e.getSource().getBindingContext().getPath();var b=this.oModel.getProperty(s);this.idOfNodeIfFilterIconClick=b;var f=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.productGroup.fragments.FilterPopover",this);this.getView().addDependent(f);f.bindElement(s);f.setModel(this.i18nBundle,"i18n");f.setModel(this.contentModel,"Content");var d=new J();var c=JSON.parse(b.Filters);this.propertyLabels.forEach(function(l){c.forEach(function(i){if(i.Property===l.Key){i.Label=l.Label;}});});d.setProperty("/FilterItems",c);d.setProperty("/SelectedTitle",this.i18nBundle.getResourceBundle().getText("Product.Groups.Filter.For")+" "+b.Name);f.setModel(d,"Data");f.addCustomData(new sap.ui.core.CustomData({key:"to_popover_Id",value:b.Id}));f.addCustomData(new sap.ui.core.CustomData({key:"to_popover_Name",value:b.Name}));var B=e.getSource();jQuery.sap.delayedCall(0,this,function(){f.openBy(B);});},getNode:function(b){var h=this.table.getModel().getData().ProductHierarchy;var n=null;var f=function(c,b){for(var i=0,l=c.length;i<l;i++){if(c[i].Id===b){n=c[i];break;}else if(c[i].children&&c[i].children.length>0){f(c[i].children,b);}}};f(h,b);return n;},getFromCustomData:function(c){var t={};var b=c.getCustomData();b.forEach(function(d){if(d.getKey()==="to_popover_Id"){t.to_popover_Id=d.getValue();}else if(d.getKey()==="to_popover_Name"){t.to_popover_Name=d.getValue();}else if(d.getKey()==="from_popover"){t.from_popover=d.getValue();}});return t;},handleDefineFilter:function(e){var d="";var o=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.productGroup.fragments.DefineFilter",this);if(e.getSource().getMetadata().getName()==="sap.m.Button"){var b=e.getSource().getParent().getParent();var c=this.getFromCustomData(b);o.addCustomData(new sap.ui.core.CustomData({key:"from_popover",value:c.to_popover_Id}));d=this.i18nBundle.getResourceBundle().getText("Product.Groups.Dialog.Title.Edit",c.to_popover_Name);}else{d=this.i18nBundle.getResourceBundle().getText("Product.Groups.Dialog.Title",this.getNode(this.contentModel.getProperty("/SelectedProducts")[0].Id).Name);}o.setTitle(d);o.setModel(this.i18nBundle,"i18n");var f=M.getServiceModel();o.setModel(f);o.open();},checkFilterModified:function(o,n,b){if(!U.isInitial(o.ParentId)){var c=true;if(o.filters.length!==n.filters.length){c=false;}else{for(var i in o.filters){for(var j in n.filters){if(o.filters[i].Property===n.filters[j].Property){c=JSON.stringify(o.filters[i])===JSON.stringify(n.filters[j])?true:false;}}}}if(!c){this.filterModified[b]=n;}}},onDefineFilterOkPress:function(e){var b=e.getSource().getParent();b.close();var f=this.filterHelper.getFiltersObject();var n=jQuery.extend({},f.sfbFilters);this.filtersWithData=jQuery.extend(this.filtersWithData,n,true);this.eventBus.publish("retail.pmr.promotionaloffers","onAction",{isHierarchy:true});b.destroy();},onDefineFilterCancelPress:function(e){this.idOfNodeIfFilterIconClick=null;var b=e.getSource().getParent();b.close();b.destroy();},getFilter:function(b){var f="[]";var n=null;var h=this.oModel.getProperty("/ProductHierarchy")||[];var c=function(d,b){for(var i=0,l=d.length;i<l;i++){if(d[i].Id===b){f=d[i].Filters;n=d[i];break;}else if(d[i].children&&d[i].children.length>0){c(d[i].children,b);}}};if(h&&h.length>0){c(h,b);}return{filters:f,node:n};},onInitialise:function(e){var f=e.getSource();var d=f.getParent();var b=a.DialogModeEnum.WithRadio;var r=null;var c=e.getSource().getParent().getCustomData();if(c&&c.length>0&&c[0].getKey()==="from_popover"){r=this.getFilter(c[0].getValue());}else{r=this.getFilter(this.contentModel.getProperty("/SelectedProducts")[0].Id);}var g=JSON.parse(r.filters);if(g&&g.length>0){this.filterHelper=new D(f,d,b,g,r.node,this.intervals);}else{this.filterHelper=new D(f,d,b,[],null,this.intervals);}},removeFilterDialog:function(s){var d=new J();var t=this;var b=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.productGroup.fragments.MultipleFilterDialog",{onCancelPress:function(){b.close();b.destroy();},onOkPress:function(e){if(d.getData().AllUnmodifiedSubnodes){t.removeAllFiltersNotModifiedFromHierarchy([t.getNode(s)]);t.eventBus.publish("retail.pmr.promotionaloffers","onAction",{isHierarchy:true});}if(d.getData().Subnodes){t.removeAllFiltersFromHierarchy([t.getNode(s)]);t.eventBus.publish("retail.pmr.promotionaloffers","onAction",{isHierarchy:true});}if(d.getData().OnlyThisNode){delete t.filterModified[s];delete t.filtersWithData[s];t.filterHelper.deleteFilter(s);t.eventBus.publish("retail.pmr.promotionaloffers","onAction",{isHierarchy:true});}this.onCancelPress();}});b.setModel(U.getI18NModel(),"i18n");b.setModel(d,"Data");b.open();},handleFilterRemove:function(e){var b=e.getSource().getParent().getParent();var d=this.getFromCustomData(b);var s=d.to_popover_Id;this.removeFilterDialog(s);},handleRemoveFilter:function(){var s=this.contentModel.getProperty("/SelectedProducts")[0];var b=s.Id;this.removeFilterDialog(b);},assignFiltersChanged:function(e){var h=null;if(this.contentModel.getProperty("/SelectedProducts")&&this.contentModel.getProperty("/SelectedProducts").length>0){h=this.contentModel.getProperty("/SelectedProducts")[0].Id;}else{h=this.getFromCustomData(e.getSource().getParent()).from_popover;}var b=this.getNode(h);var m={};if(this.filterHelper&&this.filterHelper.uiBuilderHelper){var c=this.filterHelper.uiBuilderHelper.controlls;c.forEach(function(i){if(i.getAggregation("content")&&i.getAggregation("content").length>0){var d=i.getAggregation("content")[0].getAggregation("content")[1];var k=d.searchKey;var v=d.getValue();m[k]={value:v};}});}var s=jQuery.extend({},e.getSource().getFilterData());for(var i in m){if(m[i].value){var t=this.filterHelper.generateFiltersManually(m[i].value,i);s[i]={items:[],ranges:[t]};}}if(this.filterHelper&&Object.keys(s).length===0&&h){var r=this.filterHelper.calculateRadioSelection();if(r===a.APPLY_CHANGES_RADIO.All_subnodes){this.removeAllFiltersFromHierarchy([b]);}else if(r===a.APPLY_CHANGES_RADIO.Only_this_node){delete this.filtersWithData[h];delete this.filterModified[h];if(this.filterHelper){this.filterHelper.deleteFilter(h);}}else if(r===a.APPLY_CHANGES_RADIO.All_unmodified_subnodes){this.removeAllFiltersNotModifiedFromHierarchy([b]);}}if(this.filterHelper){this.filterHelper.setFilters(s,b,this.filterModified);}}});return p;});
