/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Models","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/utils/TreeValueHelpDialog","retail/pmr/promotionaloffers/utils/DateHandler","sap/ui/model/Filter","sap/ui/core/ListItem","sap/ui/comp/filterbar/FilterGroupItem","retail/pmr/promotionaloffers/plugins/general/dynamicfilter/DynamicFilterController","retail/pmr/promotionaloffers/plugins/general/LocationSelector","retail/pmr/promotionaloffers/utils/controls/ValueHelpDialogTokenizer","retail/pmr/promotionaloffers/utils/Formatter","sap/ui/comp/odata/MetadataAnalyser","sap/ui/comp/providers/ValueHelpProvider","sap/ui/comp/providers/ValueListProvider"],function(C,J,M,U,T,D,F,L,c,d,f,V,g,h,k,l){"use strict";var p=function(i,a,b){return U.promptUser({i18n:i,title:"{i18n>CreateOffer.General.ReferenceEvent}",type:"Message",state:"Warning",text:"{i18n>CreateOffer.General.ReferenceEvent.DialogText}",ok:"{i18n>CreateOffer.General.ConfirmYes}",cancel:"{i18n>CreateOffer.General.Reject}",okValue:function(){return a();},cancelValue:function(){return b();}});};var m=function(i,a,b){return U.promptUser({i18n:i,title:"{i18n>CreateOffer.General.Confirm}",type:"Message",state:"Warning",text:"{i18n>CreateOffer.General.ManualExclusionSwitch.DialogText}",ok:"{i18n>CreateOffer.General.ConfirmYes}",cancel:"{i18n>CreateOffer.General.Reject}",okValue:function(){return a();},cancelValue:function(){return Promise.resolve();}});};var n=function(a,i){return U.promptUser({i18n:i,title:"{i18n>CreateOffer.General.PackageOffer}",type:"Message",state:"Warning",text:"{i18n>CreateOffer.General.PackageOffer.Warning}",ok:"{i18n>CreateOffer.General.MasterDataSystem.Ok}",cancel:"{i18n>CreateOffer.General.MasterDataSystem.Cancel}",okValue:function(){return a;},cancelValue:function(){return!a;}});};var o=function(a,b,i){return U.promptUser({i18n:i,title:"{i18n>CreateOffer.General.MasterDataSystemDialog.Title}",type:"Message",state:"Warning",text:"{i18n>CreateOffer.General.MasterDataSystemDialog.Message}",ok:"{i18n>CreateOffer.General.MasterDataSystem.Ok}",cancel:"{i18n>CreateOffer.General.MasterDataSystem.Cancel}",okValue:function(){return a;},cancelValue:function(){return b;}});};function r(a){var b=["PurchasingGroupName"];b.forEach(function(e){delete a[e];});}function s(a,b,e){return(a||[]).filter(v(b,e));}function u(a,b){var e=a.map(U.prop("ExtLocationNodeId"));return(b||[]).filter(function(i){var j=i.Description||i.Id;return e.indexOf(j)>-1;});}function v(a,e){return function(b){return U.isNotOnExcluded(b,a,e);};}function w(a,e){return function(b){return!U.isNotOnExcluded(b,a,e);};}function y(a,b,e){if(a&&a.some(w(b,e))){return U.openDeleteConfirmDiaog(true,{"massageSingle":"General.Versions.On.ExcludedNodes","messageMulti":"ManageVersions.DeleteVersionDialog.Message","title":"ManageVersions.DeleteVersionDialog.Title"});}else{return Promise.resolve();}}function z(a,e){return function(b){return!U.isInOfferRange(b,a,e);};}function A(a){return{StartOfOffer:a.StartOfOffer,EndOfOffer:a.EndOfOffer};}function B(a,b){var e=a.getCombinedStartDate();var i=a.getCombinedEndDate();var j=b.map(A).map(D.updateRangeIfSame(a)).some(z(e,i));if(j){return U.openDeleteConfirmDiaog(true,{"massageSingle":"General.Versions.Not.In.Offer.Range","messageMulti":"ManageVersions.DeleteVersionDialog.Message","title":"ManageVersions.DeleteVersionDialog.Title"});}else{return Promise.resolve();}}return C.extend("retail.pmr.promotionaloffers.plugins.general.General",{extHookOnsetOfferData:null,extHookOnvalidateForm:null,extHookOngetOfferData:null,constructor:function(){this.eventBus=null;this.contentModel=new J({"TacticTypes":[],"Statuses":[]});this.offerSetModel=new J({"OfferSets":[]});this.contentModel.setSizeLimit(U.getSizeLimit());this.CONSTANTS={};Object.defineProperty(this.CONSTANTS,"TARGET_GROUP_EMPTY_ROW",{value:{"RedeemEnabled":false},writable:false});this.dataModel=new J({"Tactics":[],"TargetGroups":[]});this.timeModel=new J();this.featuresAvailable=new J();this.dateHandler=new D();},onInit:function(){this.eventBus=sap.ui.getCore().getEventBus();this.getView().setModel(this.contentModel,"Content");this.getView().setModel(this.dataModel);this.getView().setModel(this.timeModel,"Time");this.i18nModel=U.getResourceModel();this.oMarketingArea=this.getView().byId("generalMarketingArea");this.getView().setModel(this.featuresAvailable,"featuresAvailable");this.bLocSuggestSelect=false;this.oCachedHierarchies={};this.lastSeachLocationData=[];this.oLocationSelector=null;function i(b,e){return function(j){return U.isInOfferRange(j,b,e);};}function a(b,e){var j=e.getProperty("/Versions");var q=e.getProperty("/LocalNodes");var t=b.getCombinedStartDate();var x=b.getCombinedEndDate();var E=j.filter(i(t,x));e.setProperty("/Versions",E);var G=u(E,q);e.setProperty("/LocalNodes",G);var H={versions:E,localNodes:G};sap.ui.getCore().getEventBus().publish("retail.pmr.promotionaloffers","deleteInvalidVersions",H);}this.dateHandler.attachEvent("dateChanged",function(e){var b=e.getSource();B(e.getSource(),this.dataModel.getProperty("/Versions")||[]).then(function(){this.dataModel.setProperty("/StartOfOffer",b.getStartDate());this.dataModel.setProperty("/EndOfOffer",b.getEndDate());this.timeModel.setProperty("/StartTime",b.getStartTime());this.timeModel.setProperty("/EndTime",b.getEndTime());this.setWeekForStartOfOffer(b.getStartDate());this.setWeekForEndOfOffer(b.getEndDate());this.timeModel.refresh(true);this.dateHandler.updateTactics(this.dataModel,this.timeModel);this.dateHandler.updateVersions(this.dataModel);a(this.dateHandler,this.dataModel);this.validateTactics();this.validateDates();}.bind(this),function(){this.dataModel.setProperty("/StartOfOffer",b.getPrevStartDate());this.dataModel.setProperty("/EndOfOffer",b.getPrevEndDate());this.timeModel.setProperty("/StartTime",b.getPrevStartTime());this.timeModel.setProperty("/EndTime",b.getPrevEndTime());}.bind(this));}.bind(this));this.manageOfferSetsDialog=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.general.ManageOfferSetsDialog",this.getView().getController());this.getView().addDependent(this.manageOfferSetsDialog);this._targetGroupDialog=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.general.TargetGroupSearch",this.getView().getController());this._tacticsDialog=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.general.TacticSearch",this.getView().getController());this._tacticsDialog.setModel(this.contentModel);this.oMessageManager=U.getMessageManager();},onExit:function(){},processServerErrors:function(a){U.setErrorMessages(this.oMessageManager,a,this.dataModel);},setSystem:function(a,K){this.dataModel.setProperty("/MasterdataSystem",a);this.setMasterDataSystemDependentCombos(a);this.eventBus.publish("retail.pmr.promotionaloffers","resetViews",{MasterdataSystem:a});if(!K){this.eventBus.publish("retail.pmr.promotionaloffers","resetTermsTab");}this.eventBus.publish("retail.pmr.promotionaloffers","setMasterDataSystem",{SelectedMasterDataSystem:a});this.contentModel.setProperty("/LocationText","");this.dataModel.setProperty("/LocationNodeId","");this.dataModel.setProperty("/LocationFilters",[]);this.dataModel.setProperty("/ExcludedNodes",[]);this.dataModel.setProperty("/LeadingCategory","");this.dataModel.setProperty("/PromotionType","");this.dataModel.setProperty("/PurchasingGroup","");this.dataModel.setProperty("/LeadingCategoryName","");this.contentModel.setProperty("/LocationStores","");return Promise.resolve(a);},resetSystem:function(a){this.contentModel.setProperty("/LastMasterdataSystem",a);this.dataModel.setProperty("/MasterdataSystem",a);},masterdataSystemChange:function(a){var t=this;var b=function b(){return["/LocationNodeId","/PromotionType","/LeadingCategory","/PurchasingGroup"].map(function(i){return!!t.dataModel.getProperty(i);}).reduce(function(i,j){return j||i;},false);};var e=function e(){return o(a,t.contentModel.getProperty("/LastMasterdataSystem"),t.getView().getModel("i18n"));};if(b()){return e().then(t.setSystem.bind(t),t.resetSystem.bind(t));}else{setTimeout(function(){t.setSystem(a);});return Promise.resolve(a);}},timePickerVisible:function(a){return!a?"L6 M6 S6":"L12 M12 S12";},onAllDaySelect:function(e){var a=e.getParameter("selected");if(a){this.dateHandler.onAllDaySelect();}this.timeModel.setProperty("/Selected",a);this.timeModel.refresh(true);},setLeadingCategory:function(a){var e=this.contentModel.getProperty("/Editable");if(!e){return;}this.contentModel.setProperty("/LeadingCategoryBusy",true);return M.getLeadingCategoriesSet(a).then(function(b){this.contentModel.setProperty("/LeadingCategoriesSet",b);this.contentModel.setProperty("/LeadingCategoryBusy",false);}.bind(this));},setMasterDataSystemDependentCombos:function(a){this.contentModel.setProperty("/PromotionTypeEnabled",false);this.contentModel.setProperty("/PurchasingGroupEnabled",false);this.contentModel.setProperty("/LeadingCategoriesSet",[]);return M.getPromotionTypeSetAndPurchasingGroupSet(a).then(function(b){var e=b[0];var i=b[1];this.contentModel.setProperty("/PromotionTypeSet",e);this.contentModel.setProperty("/PromotionTypeEnabled",true);this.contentModel.setProperty("/PurchasingGroupSet",i);this.contentModel.setProperty("/PurchasingGroupEnabled",true);this.contentModel.setProperty("/TotalAudience",this.getTotalAudience(this.dataModel.getProperty("/TargetGroups")));}.bind(this));},purchasingGroupChanged:function(e){var a=this.dataModel.getProperty("/PurchasingGroup");var b=this.getView().byId("generalPurchasingGroup").getValue();if(b===""||b===null){U.removeMessagesByPath("/PurchasingGroup");return;}var i={message:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralPurchasingGroup.Invalid.Title"),description:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralPurchasingGroup.Invalid.Description")};this.validateByPath("/PurchasingGroup",this.dataModel,i,function(){return a;});},promotionTypeChanged:function(e){var a=this.dataModel.getProperty("/PromotionType");var b=this.getView().byId("generalPromotionType").getValue();if(b===""||b===null){U.removeMessagesByPath("/PromotionType");return;}var i={message:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralPromotionType.Invalid.Title"),description:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralPromotionType.Invalid.Description")};this.validateByPath("/PromotionType",this.dataModel,i,function(){return a;});},validateByPath:function(a,b,e,N){U.removeMessagesByPath(a);if(N()){return 0;}var E={target:a,type:"Error",processor:b,message:e.message,description:e.description};U.setErrorMessages(this.oMessageManager,[E]);return 1;},validateName:function(){var a=this.dataModel.getProperty("/Name");var b=a?a.trim():"";var e={};if(b.length>40){e={message:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralOfferName.TitleTooLong"),description:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralOfferName.DescriptionTooLong")};}else{e={message:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralOfferName.Title"),description:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralOfferName.Description")};}return this.validateByPath("/Name",this.dataModel,e,function(){return(b.length>0&&b.length<=40);});},validateMarketingArea:function(){var a=this.dataModel.getProperty("/MarketingArea");var b={message:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralMarketingArea.Invalid.Title"),description:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralMarketingArea.Invalid.Description")};var e=this.oMarketingArea.getValue();return this.validateByPath("/MarketingArea",this.dataModel,b,function(){return!(e&&!a);});},validateLocation:function(){var a=this.contentModel.getProperty("/LocationText");var b={};if(!a){b={message:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralLocation.Title"),description:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralLocation.Description")};}else{b={message:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralLocation.Invalid.Title"),description:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralLocation.Invalid.Description")};}return this.validateByPath("/LocationText",this.contentModel,b,function(){return a&&a.length>0&&this.dataModel.getProperty("/LocationNodeId");}.bind(this));},validateDates:function(){var a=function(){var e=this.timeModel.getProperty("/StartOfOfferValue");var i={message:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralStartDate.Invalid.Title"),description:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralStartDate.Description")};if(!e){i.message=this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralStartDate.Title");}return this.validateByPath("/StartOfOfferValue",this.timeModel,i,function(){return this.validOfferDate("StartOfOffer");}.bind(this));};var b=function(){var e=this.timeModel.getProperty("/EndOfOfferValue");var i={message:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralEndDate.Invalid.Title"),description:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralEndDate.Description")};if(!e){i.message=this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralEndDate.Title");}return this.validateByPath("/EndOfOfferValue",this.timeModel,i,function(){return this.validOfferDate("EndOfOffer");}.bind(this));};return a.call(this)+b.call(this);},validateLeadingCategory:function(){var a=this.dataModel.getProperty("/LeadingCategoryName");var b={message:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralLeadingCategory.Invalid.Title"),description:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralLeadingCategory.Invalid.Description")};return this.validateByPath("/LeadingCategoryName",this.dataModel,b,function(){return(!a||this.dataModel.getProperty("/LeadingCategory"));}.bind(this));},validateOfferSet:function(){var a=this.contentModel.getProperty("/OfferSetValue");var b={message:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralOfferSet.Invalid.Title"),description:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralOfferSet.Invalid.Description")};return this.validateByPath("/OfferSetValue",this.contentModel,b,function(){return(!a||!!a&&this.dataModel.getProperty("/OfferSetId"));}.bind(this));},validateReferenceEvent:function(){var a=this.contentModel.getProperty("/ReferenceEventText");var b={message:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralReferenceEvent.Invalid.Title"),description:this.i18nModel.getResourceBundle().getText("ErrorMessage.GeneralReferenceEvent.Invalid.Description")};return this.validateByPath("/ReferenceEventText",this.contentModel,b,function(){return(!a||this.contentModel.getProperty("/ReferenceEvent"));}.bind(this));},validateForm:function(){var a=this.validateName()+this.validateLocation()+this.validateLeadingCategory()+this.validateDates()+this.validateOfferSet()+this.validateReferenceEvent()+this.validateTargetGroups()+this.validateTactics()+this.validateMarketingArea();if(this.extHookOnvalidateForm){return a+this.extHookOnvalidateForm();}this.eventBus.publish("retail.pmr.promotionaloffers","toggleCollisionBtn",{});return a;},formatRefEventValue:function(i,a){if(!i){return;}var t=parseInt(i,10).toString();if(a){t=a+" ("+t+")";}return t;},offerSetChanged:function(e){var t=this;var a=this.getModelDataFromAnnotation(e);var b=a.Text||a;this.dataModel.setProperty("/OfferSetName",null);this.dataModel.setProperty("/OfferSetId",null);t.contentModel.setProperty("/OfferSetValue",b);if(!b){this.validateOfferSet();return;}var i={"$filter":"Text eq'"+b+"'"};M.getOfferSet(i).then(function(j){if(j.data.length){var q=j.data[0];t.dataModel.setProperty("/OfferSetName",q.Text);t.dataModel.setProperty("/OfferSetId",q.Id);}t.validateOfferSet();});},referenceSuggestionSelected:function(e){var i=this.getModelDataFromAnnotation(e).Id;e.getSource().setValue(i);this.referenceEventChanged(e);},updateReferenceEventFields:function(a){var t=this;function b(x){var E=U.getFormatedDateForRead(x.StartDate);var G=U.getFormatedDateForRead(x.EndDate);var H=t.getDate(E);var I=t.getDate(G);var K=t.getTime(E);var N=t.getTime(G);t.timeModel.setData({Selected:U.isAllDay(H,I),StartTime:K,EndTime:N,PreviousStartOfOffer:H,PreviousEndOfOffer:I,PreviousStartTime:K,PreviousEndTime:N,ValidStartOfOffer:true,ValidEndOfOffer:true});t.dateHandler.setStartDate(H);t.dateHandler.setEndDate(I);t.dateHandler.setStartTime(K);t.dateHandler.setEndTime(N);t.dateHandler.setPrevStartDate(H);t.dateHandler.setPrevEndDate(I);t.dateHandler.setPrevStartTime(K);t.dateHandler.setPrevEndTime(N);t.setWeekForStartOfOffer(H);t.setWeekForEndOfOffer(I);t.dataModel.setProperty("/StartOfOffer",H);t.dataModel.setProperty("/EndOfOffer",I);return Promise.resolve(x);}function e(x,E){if(x.MasterdataSystem!=E){var K=false;}else{K=true;}return t.setSystem(x.MasterdataSystem,K).then(function(){return x;});}function i(x){var E=t.contentModel.getProperty("/TacticTypes").filter(function(H){return x.Tactic===H.TacticId&&x.TacticType===H.TacticType;})[0];t.dataModel.setProperty("/Tactics",[]);var G=t.addNewTactic(E.Id,E.Name);G.TacticType=x.TacticType;G.TacticId=x.Tactic;return Promise.resolve(x);}function j(x){var E="HierarchyId eq '"+x.HierarchyId+"'";return t.setLocationHierarchy(E).then(function(){return Promise.resolve(x);});}this.contentModel.setProperty("/ReferenceEvent",a.Id);var q=this.formatRefEventValue(a.Id,a.Name);this.contentModel.setProperty("/ReferenceEventText",q);return Promise.resolve(a).then(b).then(e(a,this.dataModel.getProperty("/MasterdataSystem"))).then(i).then(j).then(function(x){this.dataModel.setProperty("/RefEventId",x.Id);this.dataModel.setProperty("/RefEventName",x.Name);this.dataModel.setProperty("/Versions",[]);this.dataModel.setProperty("/LocalNodes",[]);var E={versions:this.dataModel.getProperty("/Versions"),localNodes:this.dataModel.getProperty("/LocalNodes")};this.eventBus.publish("retail.pmr.promotionaloffers","deleteInvalidVersions",E);this.validateForm();}.bind(this));},marketingAreaChanged:function(e){var a=this.dataModel.getProperty("/MarketingArea");this.contentModel.setProperty("/MarketingAreaFilter",{MarketingArea:a});var t=(this.dataModel.getProperty("/TargetGroups")||[]).filter(function(i){return i.MarketingArea===a;});var b=this.getTotalAudience(t);this.contentModel.setProperty("/TotalAudience",b);this.dataModel.setProperty("/TargetGroups",t);this.validateMarketingArea();},referenceEventChanged:function(e){if(!e){return;}function a(t,i){this.contentModel.setProperty("/ReferenceEvent",this.dataModel.getProperty("/RefEventId"));var j=this.dataModel.getProperty("/RefEventName");var q=this.dataModel.getProperty("/RefEventId");j=this.formatRefEventValue(q,j);this.contentModel.setProperty("/ReferenceEventText",j);this.validateReferenceEvent();}var b=e.getSource().getValue();M.getReferenceEvent(b).then(function(i){var j=i[0];if(j){p(this.getView().getModel("i18n"),this.updateReferenceEventFields.bind(this,j),a.bind(this,j));}else{this.contentModel.setProperty("/ReferenceEvent",j);this.dataModel.setProperty("/RefEventId",j);this.dataModel.setProperty("/RefEventName",j);this.validateReferenceEvent();}}.bind(this));},setWeekForStartOfOffer:function(S){if(!S){this.timeModel.setProperty("/StartWeek","");return;}U.getWeek(S).then(function(W){this.timeModel.setProperty("/StartWeek",W.trim());}.bind(this),function(){this.timeModel.setProperty("/StartWeek","");}.bind(this));},setWeekForEndOfOffer:function(e){if(!e){this.timeModel.setProperty("/EndWeek","");return;}U.getWeek(e).then(function(W){this.timeModel.setProperty("/EndWeek",W.trim());}.bind(this),function(){this.timeModel.setProperty("/EndWeek","");}.bind(this));},validOfferDate:function(t){var b=true;var S=this.dataModel.getProperty("/StartOfOffer");var e=this.dataModel.getProperty("/EndOfOffer");switch(t){case"StartOfOffer":if(!S){b=false;}else if(e&&S.getTime()>e.getTime()){b=false;}break;case"EndOfOffer":if(!e){b=false;}else if(S&&S.getTime()>e.getTime()){b=false;}break;}return b;},getModelDataFromAnnotation:function(e){var S={};if(e.getParameter("tokens")){S=e.getParameter("tokens")[0].data("row");}else if(e.getParameter("value")===e.getParameter("value")+""){return e.getParameter("value");}else{var a=e.getParameter("selectedRow");var b=a.getBindingContext("Annotation").getPath();S=a.getBindingContext("Annotation").getModel().getProperty(b);}return S;},updateLocationHierarchyOnDateChange:function(a){var b=this.dataModel.getData();var t=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.general.LocationTree",this);var e=new f(t);if(a.data.length){this.cacheLocations(a.data[0].HierarchyId,a.data);}var i={ID:b.LocationNodeId,ExcludeNodes:[]};var j=this.getHierarchiesWithCache(a.data);e.setData(i,j,{StartOfOffer:b.StartOfOffer.getTime(),EndOfOffer:b.EndOfOffer.getTime()});var q=e.getSelection();var x=q.selection;var E=q.exclusions;this.contentModel.setProperty("/Hierarchy",x);var G=this.contentModel.getProperty("/ExtNodeId");this.eventBus.publish("retail.pmr.promotionaloffers","setLocationSelection",{includeNode:x,excludedNodes:E,hierarchy:x});},removeBadVersionsOnExcluded:function(a,e){var b=a.getProperty("/Versions");var i=a.getProperty("/LocalNodes");var j=s(b,i,e);a.setProperty("/Versions",j);var q=u(j,i);a.setProperty("/LocalNodes",q);var t={versions:j,localNodes:i};sap.ui.getCore().getEventBus().publish("retail.pmr.promotionaloffers","deleteInvalidVersions",t);},onOfferStartDateChange:function(e){var a=e.getParameter("valid");var b=e.getSource().getDateValue();if(!a){this.timeModel.setProperty("/StartOfOfferValue",U.getFormatDatePiker(b));}this.dateHandler.startDateChanged(b,a);},onOfferEndDateChange:function(e){var a=e.getParameter("valid");var b=e.getSource().getDateValue();if(!a){this.timeModel.setProperty("/EndOfOfferValue",U.getFormatDatePiker(b));}this.dateHandler.endDateChanged(b,a);},onOfferStartTimeChange:function(e){var a=e.getParameter("valid");var b=e.getSource().getDateValue();if(!a){this.timeModel.setProperty("/StartOfOfferValue",U.getFormatDatePiker(b));}this.dateHandler.startTimeChanged(b,a);},onOfferEndTimeChange:function(e){var a=e.getParameter("valid");var b=e.getSource().getDateValue();if(!a){this.timeModel.setProperty("/EndOfOfferValue",U.getFormatDatePiker(b));}this.dateHandler.endTimeChanged(b,a);},promptUserForLocationChange:function(a,b,i){return U.promptUser({i18n:i,title:"{i18n>CreateOffer.General.LocationChangeDialog.Title}",type:"Message",state:"Warning",text:"{i18n>CreateOffer.General.LocationChangeDialog.Message}",ok:"{i18n>CreateOffer.General.LocationChangeDialog.OkBtn}",cancel:"{i18n>CreateOffer.General.LocationChangeDialog.CancelBtn}",okValue:function(){return a;},cancelValue:function(){return b;}});},setDataProvider:function(a){this.loader=a;},handlePromptUserForLocationChange:function(a){var b=this.dataModel.getData();var e={NodeId:"",HierarchyId:b.HierarchyId,ExtNodeId:this.contentModel.getProperty("/ExtNodeId"),excludes:b.ExcludedNodes||[]};if(b.LocationHierarchy&&b.LocationHierarchy.length>0){e.NodeId=b.LocationHierarchy[0].NodeId;}else{e.NodeId=b.LocationNodeId;}var i=(this.getOwnerComponent().getState().getSavePayload().Terms||[]).some(function(j){return j.ProductId||j.HierarchyNodeId||j.HierarchyId;})||!!(b.Versions||[]).length;if(i&&e.NodeId&&a.NodeId!==e.NodeId){return this.promptUserForLocationChange(a,e,this.getView().getModel("i18n")).then(function(a){this.setLocationValue(a);this.validateLocation();return a;}.bind(this),function(a){var j=jQuery.sap.formatMessage(a.ExtNodeId," ",a.HierarchyDescription).trim();this.contentModel.setProperty("/LocationText",j);return null;}.bind(this));}else{this.setLocationValue(a);this.validateLocation();return Promise.resolve(a);}},setLocationValue:function(a){var e=a.excludes;var b="";if(a.ExtNodeId){b=jQuery.sap.formatMessage(a.ExtNodeId," ",a.HierarchyDescription).trim();var i=this.contentModel.getProperty("/ExtNodeId");var j=this.dataModel.getProperty("/LocationSubgroups")||[];if(i!==a.ExtNodeId&&j.length){j.forEach(function(t){t.Filters=[];});}}var H=this.dataModel.getProperty("/HierarchyId");if(H!==a.HierarchyId){(j||[]).forEach(function(t){t.Id="";});}this.dataModel.setProperty("/LocationNodeId",a.NodeId);this.dataModel.setProperty("/LocationFilters",[]);this.dataModel.setProperty("/ExcludedNodes",[]);this.dataModel.setProperty("/HierarchyId",a.HierarchyId);this.dataModel.setProperty("/ExtHierarchyId",a.ExtHierarchyId);this.dataModel.setProperty("/ExtLocationNodeId",a.ExtNodeId);this.contentModel.setProperty("/LocationText",b);var q=(e||[]).map(function(t){return{Id:t.NodeId||t.LocationId,Type:t.LocationId?"01":"04"};});this.dataModel.setProperty("/ExcludedNodes",q);this.contentModel.setProperty("/ExtNodeId",a.ExtNodeId);if(a.hierarchy){this.setLocationDescription(a.hierarchy);}else{this.updateLocationLabel(a.Cardinality,a.Cardinality);}this.contentModel.setProperty("/LocationText",b);return a;},setLocationDescription:function(a){var b=new d(a);var t=b.getStores().length;var e=b.getSelectedStoresCount();if(t>0){this.updateLocationLabel(t,e);}else{this.contentModel.setProperty("/LocationStores","");}},updateLocationLabel:function(t,a){var b;if(t>0){if(t===a){b=this.i18nModel.getResourceBundle().getText("General.Location.DescriptionSimple",a);}else{b=this.i18nModel.getResourceBundle().getText("General.Location.DescriptionComplex",[a,t]);}}else{b="";}this.contentModel.setProperty("/TotalStores",t);this.contentModel.setProperty("/LocationStores",b);},selectLocation:function(a){if(!a){this.resetLocation();this.validateLocation();return;}this.handlePromptUserForLocationChange(a);},getTacticsMap:function(t,a){return t.filter(function(i){return i.Id;}).map(function(b){if(!b.EndTimeOfTacticValue){b.EndOfTactic=a.EndOfOffer;}if(!b.StartTimeOfTacticValue){b.StartOfTactic=a.StartOfOffer;}return{"OfferId":b.OfferId||"","TacticType":b.TacticType,"TacticId":b.TacticId,"StartOfTactic":b.StartOfTactic,"EndOfTactic":b.EndOfTactic,"TacticTypeDesc":b.TacticTypeDesc,"TacticDesc":b.TacticDesc};});},getOfferData:function(){this.resetCouponData();var a=jQuery.extend({},this.dataModel.getData());r(a);a.TargetGroups=(a.TargetGroups||[]).filter(function(i){return i.Id&&i.RedeemPercent;}).map(function(i){if(i.hasOwnProperty("Guid")){return{"Id":i.Id,"RedeemPercent":i.RedeemPercent+"","Name":i.Name+"","Description":i.Description+"","Members":i.Members+0,"MarketingArea":i.MarketingArea+"","MarketingAreaDesc":i.MarketingAreaDesc+"","Guid":i.Guid};}else{return{"Id":i.Id,"RedeemPercent":i.RedeemPercent+"","Name":i.Name+"","Description":i.Description+"","Members":i.Members+0,"MarketingArea":i.MarketingArea+"","MarketingAreaDesc":i.MarketingAreaDesc+""};}});a.Tactics=this.getTacticsMap(a.Tactics||[],this.dataModel.getData());if(this.extHookOngetOfferData){a=jQuery.extend(a,this.extHookOngetOfferData());}delete a.Terms;delete a.Versions;return a;},getDate:function(a,t){if(!a||!t){return a;}var b=new Date(a.getTime());b.setHours(t.getHours());b.setMinutes(t.getMinutes());b.setSeconds(t.getSeconds());return b;},getTime:function(a){var R=new Date(0);R.setHours(a.getHours());R.setMinutes(a.getMinutes());R.setSeconds(a.getSeconds());return R;},getTotalAudience:function(t){var a=0;if(t.length>0){t.forEach(function(b){a=a+b.ProjectedMembers;});}return a;},setOfferData:function(a,b,e){this.featuresAvailable.setData(e);this.contentModel.setProperty("/TacticTypes",b.Tactics);this.contentModel.setProperty("/ReferenceEvent",a.RefEventId);this.contentModel.setProperty("/ReferenceEventText",this.formatRefEventValue(a.RefEventId,a.RefEventName));this.contentModel.setProperty("/LocationStores","");this.contentModel.setProperty("/Hierarchy","");a.StartOfOffer=new Date(a.StartOfOffer);a.EndOfOffer=new Date(a.EndOfOffer);var S=this.getTime(a.StartOfOffer);var E=this.getTime(a.EndOfOffer);this.timeModel.setData({Selected:U.isAllDay(a.StartOfOffer,a.EndOfOffer),StartTime:S,EndTime:E,PreviousStartOfOffer:a.StartOfOffer,PreviousEndTime:E,ValidStartOfOffer:a.StartOfOffer?true:false,ValidEndOfOffer:a.EndOfOffer?true:false});this.dateHandler.setStartDate(a.StartOfOffer);this.dateHandler.setEndDate(a.EndOfOffer);this.dateHandler.setStartTime(S);this.dateHandler.setEndTime(E);this.dateHandler.setPrevStartDate(a.StartOfOffer);this.dateHandler.setPrevEndDate(a.EndOfOffer);this.dateHandler.setPrevStartTime(S);this.dateHandler.setPrevEndTime(E);this.setWeekForStartOfOffer(a.StartOfOffer);this.setWeekForEndOfOffer(a.EndOfOffer);if(a.Tactics.length){a.Tactics.forEach(function(H){H.Id=H.TacticType+"/"+H.TacticId;H.Name=H.TacticTypeDesc+"/"+H.TacticDesc;H.OfferId=H.OfferId||"";H.StartOfTactic=H.StartOfTactic?H.StartOfTactic:a.StartOfOffer;H.EndOfTactic=H.EndOfTactic?H.EndOfTactic:a.EndOfOffer;H.StartTimeOfTactic=this.getTime(H.StartOfTactic);H.EndTimeOfTactic=this.getTime(H.EndOfTactic);H.EndTimeOfTacticValue=this.timeLabelValueFormatter(H.EndTimeOfTactic);H.StartTimeOfTacticValue=this.timeLabelValueFormatter(H.StartOfTactic);}.bind(this));}else{a.Tactics.push({"Id":null,"Name":null,"StartOfTactic":a.StartOfOffer,"EndOfTactic":a.EndOfOffer,"StartTimeOfTactic":S,"EndTimeOfTactic":E,"EndTimeOfTacticValue":this.timeLabelValueFormatter(E),"StartTimeOfTacticValue":this.timeLabelValueFormatter(S)});}if(a.TargetGroups&&a.TargetGroups.length){a.TargetGroups=a.TargetGroups.map(function(H){H.ProjectedMembers=Math.round(parseFloat(H.RedeemPercent)/100*H.Members);return H;});var i=this.getTotalAudience(a.TargetGroups);this.contentModel.setProperty("/TotalAudience",i);}var j=a.Status;var q=b.Statuses.filter(function(H){return H.Key===j;});if(!q||(q&&q.length<1)){b.Statuses.unshift({Key:a.Status,Value:a.StatusName});}this.contentModel.setProperty("/Statuses",b.Statuses);this.contentModel.setProperty("/OfferSetValue",a.OfferSetName);this.contentModel.setProperty("/Editable",!a.Readonly);this.getView().byId("generalStatus").setSelectedKey(a.Status);if(U.isEditableHeader({Status:a.Status,UIState:a.UIState})){this.contentModel.setProperty("/Editable",false);}this.dataModel.setData(a);this.contentModel.setProperty("/LocationText",a.ExtLocationNodeId);if(a.LocationHierarchy.length){var t=U.storeCount(a.LocationHierarchy);var x=a.ExcludedNodes?a.ExcludedNodes.length:0;var G=t-x;this.updateLocationLabel(t,G);}this.contentModel.setProperty("/ExtNodeId",a.ExtLocationNodeId);if(this.getView().getModel("UIVisiblity").getProperty("/Version")>2&&!this.oMarketingArea.getBinding("items")){this.contentModel.setProperty("/MarketingAreaFilter",{MarketingArea:this.dataModel.getProperty("/MarketingArea")});var I=new sap.ui.core.Item({key:"{MKT_AREA_ID}",text:{parts:[{path:"MKT_AREA_DESC"},{path:"MKT_AREA_ID"}],formatter:retail.pmr.promotionaloffers.utils.Formatter.marketingArea}});this.oMarketingArea.setModel(M.getServiceModel());this.oMarketingArea.setModel(this.dataModel,"Data");this.oMarketingArea.bindItems("/SH_H_DMF_MKT_AREA_H",I);}this.setMasterDataSystemDependentCombos(a.MasterdataSystem);if(this.extHookOnsetOfferData){this.extHookOnsetOfferData(a,b);}},resetOfferData:function(){this.contentModel.setData({});this.dataModel.setData({});this.timeModel.setData({});},resetMarketingArea:function(){var a="";this.dataModel.setProperty("/MarketingArea",a);this.contentModel.setProperty("/MarketingAreaFilter",{MarketingArea:a});var t=(this.dataModel.getProperty("/TargetGroups")||[]).filter(function(b){return b.MarketingArea===a;});this.dataModel.setProperty("/TargetGroups",t);},openLeadingCategoryDialog:function(){T.openDialog({tableFragment:"retail.pmr.promotionaloffers.plugins.general.LeadingCategoryComplexSearch",title:"{i18n>CreateOffer.General.LeadingCategory}",filterProps:["ExtId","Name","HierarchyDescription","ExtHierarchyId"],values:U.buildHierarchy(this.contentModel.getData().LeadingCategoriesSet,"LeadingCategory")}).then(function(a){if(!a){this.dataModel.setProperty("/LeadingCategory",null);this.dataModel.setProperty("/LeadingCategoryName","");return;}this.dataModel.setProperty("/LeadingCategory",a.Id);this.dataModel.setProperty("/LeadingCategoryName",jQuery.sap.formatMessage(a.ExtId," ",a.Name));this.validateLeadingCategory();}.bind(this));},handleLeagingCategoryComplexSearch:function(){var a=this.contentModel.getProperty("/LeadingCategoriesSet")||[];if(!a.length){var b=this.dataModel.getProperty("/MasterdataSystem");this.setLeadingCategory(b).then(function(){this.openLeadingCategoryDialog();}.bind(this));return;}this.openLeadingCategoryDialog();},typeSearchLocationPicker:function(e,a){var t=e.getSource();var b=e.getParameter("suggestValue");var i=a.dataModel.getProperty("/MasterdataSystem");var j=e.getSource().searchKey;var x=null;if(j==="DistributionChannel"){x="DistChannel";}else{x="SalesOrg";}if(x){M.getSearchHelpLocationPicker(i,x,b).then(function(E){t.destroySuggestionItems();var G=E.data.length>10?10:E.data.length;for(var q=0;q<G;q++){var H=new L({text:E.data[q].Key,key:E.data[q].Key,additionalText:E.data[q].Value});t.addSuggestionItem(H);}});}},getFilterBarSettings:function(a,t){var b={valueHelpRequest:function(){var e=this;var i=[sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.Contains,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.BT,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.EQ,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.EndsWith,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.GE,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.GT,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.LE,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.LT,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.StartsWith];var j=new sap.ui.comp.valuehelpdialog.ValueHelpDialog({supportMultiselect:true,supportRanges:true,supportRangesOnly:true,title:t,ok:function(q){e.setTokens(q.getParameters().tokens);j.close();},cancel:function(){j.close();},afterClose:function(){j.destroy();}});j.setIncludeRangeOperations(i);j.setRangeKeyFields(a);j.setTokens(e.getTokens());j.open();}};return b;},getFiltersFromTokens:function(a,b,i){for(var t=0,e=a[i].getTokens().length;t<e;t++){var j={};if(a[i].getTokens()[t].getAggregation("customData").length>0){var q=a[i].getTokens()[t].getAggregation("customData")[0].getProperty("value");j.key=q.keyField;j.exclude=q.exclude;j.operator=q.operation;j.value1=q.value1;j.value2=q.value2;}else{j.key=a[i].searchKey;j.operator="EQ";j.exclude=false;j.value1=a[i].getTokens()[t].getKey();j.value2="";}b.push(j);}},setSelectedHierarchy:function(i,e,a){var t=this;function _(j,x,e,q,a){var E={NodeId:j,HierarchyId:x,ExtNodeId:q,excludes:e,hierarchy:a};t.handlePromptUserForLocationChange(E);}function b(){t.contentModel.setProperty("/LocationText","");}if(i){var j=i.NodeId?i.NodeId:i.LocationId;var q=i.ExtNodeId?i.ExtNodeId:i.ExtLocationId;_(j,i.HierarchyId,e,q,a);}else{_(null,null,null,null);b();}this.validateLocation();},onLocationSuggest:function(e){var a=e.getParameter("suggestValue");var i=e.getSource();var b=this.dataModel.getProperty("/MasterdataSystem");i.destroySuggestionItems();this.bLocSuggestSelect=false;M.getLocationSuggestions(b,a).then(function(j){i.setFilterFunction(function(){return true;});j.data.map(function(q){var t=new L({key:q.ExtNodeId,text:q.ExtNodeId||"",additionalText:q.ExtHierarchyId||""});t.data=q;return t;}).forEach(i.addSuggestionItem,i);});},resetLocation:function(){this.dataModel.setProperty("/LocationNodeId",null);this.dataModel.setProperty("/HierarchyId",null);this.dataModel.setProperty("/ExcludedNodes",[]);this.dataModel.setProperty("/LocationFilters",[]);this.contentModel.setProperty("/ExtNodeId",null);this.contentModel.setProperty("/LocationStores","");},onLocationChange:function(e){if(this.bLocSuggestSelect){this.bLocSuggestSelect=false;return;}var a=e.getSource().getValue();if(!a){this.selectLocation(null);this.updateLocationLabel(0);return;}var b="ExtNodeId eq '"+a.toUpperCase()+"'";this.setLocationHierarchy(b);},setLocationHierarchy:function(a,e){var b=this.dataModel.getProperty("/MasterdataSystem");return M.getLocationFiltered(b,a,null,true).then(function(i){if(i.data.length){var j=e?i.data.filter(function(q){return q.ExtNodeId===e;}):i.data;if(location){}this.handlePromptUserForLocationChange(j[0]).then(function(q){if(q){this.updateLocationHierarchyOnDateChange(i);}}.bind(this));this.resetFilters();}else{this.resetLocation();this.validateLocation();}}.bind(this));},handleLocationComplexSearch:function(){var a=this.dataModel.getProperty("/LocationFilters")||[];var t=this;var b=a.filter(function(e){return e.Sign==="I"||e.Field!=="ExtLocationId";});if(!b.length){t.openLocationComplexSearch.call(t);}else{m(t.getView().getModel("i18n"),function(){t.openLocationComplexSearch.call(t);}.bind(this),U.identity);}},openLocationComplexSearch:function(){function i(){return true;}var a=this;var b=this.i18nModel.getResourceBundle();var j=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.general.LocationTree",a);a.getView().addDependent(j);var q=new f(j);this.oLocationSelector=q;j.expandToLevel(0);j.attachToggleOpenState(function(e){var P={rowContext:e.getParameter("rowContext"),expanded:e.getParameter("expanded")};q.asyncExpand(P);});var x={title:this.i18nModel.getResourceBundle().getText("CreateOffer.General.Location"),supportMultiselect:true,stretch:sap.ui.Device.system.phone,ok:function(){a.dataModel.setProperty("/LocationFilters",[]);var e=q.getSelection();var P=e.selection;var Q=e.exclusions;var R=this;var S=a.dataModel.getData().Versions;var W=a.dataModel.getProperty("/LocalNodes");y(S,W,Q).then(function(){a.setSelectedHierarchy(P,Q,P);a.removeBadVersionsOnExcluded(a.dataModel,Q);var X=false;var Y=a.dataModel.getData();if(Y.LocationHierarchy&&Y.LocationHierarchy.length>0){if(P&&P.HierarchyId===Y.LocationHierarchy[0].HierarchyId){X=true;}}a.contentModel.setProperty("/Hierarchy",P);a.eventBus.publish("retail.pmr.promotionaloffers","setLocationSelection",{includeNode:P,excludedNodes:Q,hierarchy:P,isOnlyExclude:X});R.close();a._locationPickerDialog.destroy();}.bind(this),U.identity);},cancel:function(){this.close();a._locationPickerDialog.destroy();},selectionChange:function(e){var P=e.getParameter("tableSelectionParams").rowContext.getObject();if(P.needsExpand){a.getHierarchy(P);}q.selectionChanged(e,true);}};a._locationPickerDialog=new V("locationPickerID",x);a._locationPickerDialog.setTable(j);var E=[];var G=[{label:b.getText("General.Location.NodeId"),key:"ExtNodeId"},{label:b.getText("General.Location.NodeName"),key:"Location"},{label:b.getText("General.Location.DistributionChannel"),key:"DistributionChannel"},{label:b.getText("General.Location.SalesOrg"),key:"SalesOrg"}];for(var t=0;t<G.length;t++){var H=new sap.m.MultiInput(a.getFilterBarSettings([{label:G[t].label,key:G[t].key}],G[t].label));H.setFilterFunction(i);if(G[t].key==="SalesOrg"||G[t].key==="DistributionChannel"){H.attachEvent("suggest",a,this.typeSearchLocationPicker);}H.searchKey=G[t].key;var I=new sap.ui.comp.filterbar.FilterItem({control:H,name:G[t].label,partOfCurrentVariant:true,label:G[t].label});E.push(I);}var K=new sap.ui.comp.filterbar.FilterBar({advancedMode:true,filterBarExpanded:true,showGoOnFB:true,filterItems:E,persistencyKey:"filterBarKey",beforeVariantSave:function(){},afterVariantLoad:function(){},search:function(e){a._locationPickerDialog.getTable().setBusy(true);var P=U.calculateFilters(e);var Q=U.flatenFilters(P);var R=a.dataModel.getProperty("/MasterdataSystem");var S=U.setBasicSearchValue.call(a,"_locationPickerDialog");var W=e.getParameter("expand");var X=!!W&&!a.oCachedHierarchies[W];M.getLocationFiltered(R,Q,S,X).then(function(Y){a.lastSeachLocationData=jQuery.extend(true,[],Y.data);if(X){a.cacheLocations(W,Y.data);}var Z=a.getHierarchiesWithCache(Y.data);var $=a.dataModel.getData();var _=$.ExcludedNodes;var a1=$.LocationNodeId;if(q.selector){var b1=q.getSelection();a1=b1.selection?b1.selection.NodeId:a1;_=(!b1.selection)?_:b1.exclusions;}var c1={ID:a1,ExcludeNodes:_};q.passVHDialog(a._locationPickerDialog,b.getText("General.LocationHierarchy.NoData"));q.setData(c1,Z,{StartOfOffer:$.StartOfOffer.getTime(),EndOfOffer:$.EndOfOffer.getTime()});j.setBusy(false);a.eventBus.publish("retail.pmr.promotionaloffers","setLocationData",{locationSet:Z});});}});var N=new sap.m.SearchField({showSearchButton:sap.ui.Device.system.phone,placeholder:b.getText("General.Location.Picker.Placeholder")});if(K.setBasicSearch){K.setBasicSearch(N);}K.setSearchEnabled(true);a._locationPickerDialog.setFilterBar(K);a._locationPickerDialog.addStyleClass("sapUiSizeCompact");a._locationPickerDialog.open();if(a.getView().byId("generalLocation").getValue().length>0&&a.dataModel.getData().LocationNodeId){var O=a.contentModel.getProperty("/ExtNodeId")||"";a._locationPickerDialog.setBasicSearchText(O);K.fireSearch({expand:a.dataModel.getProperty("/HierarchyId")});}},findChildrenForLeadingCategory:function(a,b){if(a){if(b[a.Id]){a.children=b[a.Id];for(var i=0,e=a.children.length;i<e;++i){this.findChildrenForLeadingCategory(a.children[i],b);}}}},findChildrenForLocation:function(a,b){if(a){if(b[a.NodeId]){a.children=b[a.NodeId];for(var i=0,e=a.children.length;i<e;++i){this.findChildrenForLocation(a.children[i],b);}}}},cacheLocations:function(a,b){if(!this.oCachedHierarchies[a]){this.oCachedHierarchies[a]={};}b.forEach(function(e){this.oCachedHierarchies[a][e.NodeId]=e;}.bind(this));},getHierarchiesWithCache:function(a){return jQuery.extend(true,[],a).map(function(b){if(this.oCachedHierarchies[b.HierarchyId]){b.Locations=jQuery.extend(true,[],this.oCachedHierarchies[b.HierarchyId][b.NodeId].Locations);}else if(parseInt(b.Cardinality,10)>0){b.Locations.results=[{}];b.needsExpand=true;}return b;}.bind(this));},getHierarchy:function(a,e){var b="HierarchyId eq '"+a.HierarchyId+"'";var j=this.dataModel.getProperty("/MasterdataSystem");var t=this._locationPickerDialog.getTable();var q=this.i18nModel.getResourceBundle();var x=this.dataModel.getData();t.setShowOverlay(true);M.getLocationFiltered(j,b,"",true).then(function(E){if(E.data&&E.data.length){this.cacheLocations(a.HierarchyId,E.data);}var G=this.getHierarchiesWithCache(this.lastSeachLocationData);this.oLocationSelector.passVHDialog(this._locationPickerDialog,q.getText("General.LocationHierarchy.NoData"));var H=this.oLocationSelector.getSelection();var I=H.selection?H.selection.NodeId:"";var K={ID:I,ExcludeNodes:H.exclusions};this.oLocationSelector.setData(K,G,{StartOfOffer:x.StartOfOffer.getTime(),EndOfOffer:x.EndOfOffer.getTime()});t.setShowOverlay(false);var N=this.oLocationSelector.treeModel.getData();for(var i=0,O=N.length;i<O;i++){if(a.HierarchyId===N[i].HierarchyId){break;}}if(e){N[i].expanding=true;this.oLocationSelector.renderExpand(t,this.oLocationSelector.treeModel,a);}t.setFirstVisibleRow(i);}.bind(this));},locationToggle:function(e){var a=e.getParameter("rowContext").getObject();if(this.oCachedHierarchies[a.HierarchyId]){return;}this.getHierarchy(a,e.getParameter("expanded"));},locationSuggestionItemSelected:function(e){var i=e.getParameter("selectedItem");if(!i){return;}var a=i.data;this.bLocSuggestSelect=true;var b="HierarchyId eq '"+a.HierarchyId+"'";this.setLocationHierarchy(b,a.ExtNodeId);},onLeadingCategorySuggestionSelect:function(e){var S=e.getParameters("selectedItem").selectedItem;var i=S.getProperty("key");var t=S.getProperty("text");this.dataModel.setProperty("/LeadingCategory",i);this.dataModel.setProperty("/LeadingCategoryName",t);this.validateLeadingCategory();},onLeadingCategorySuggest:function(e){var a=this.contentModel.getProperty("/LeadingCategoriesSet")||[];if(a.length||this.contentModel.getProperty("/LeadingCategoryBusy")){return;}var b=this.dataModel.getProperty("/MasterdataSystem");this.setLeadingCategory(b).then(function(){this.validateLeadingCategory();}.bind(this));},leadingCategoryValueChanged:function(e){var a=e.getSource().getValue();this.dataModel.setProperty("/LeadingCategory","");if(!a){this.validateLeadingCategory();return;}function b(){var q=this.contentModel.getProperty("/LeadingCategoriesSet")||[];for(var i=0;i<q.length;i++){var t=q[i];if(t.ExtId===a.toUpperCase()){this.dataModel.setProperty("/LeadingCategory",t.Id);this.dataModel.setProperty("/LeadingCategoryName",jQuery.sap.formatMessage(t.ExtId," ",t.Name));}}this.validateLeadingCategory();}if(!(this.contentModel.getProperty("/LeadingCategoriesSet")||[]).length){var j=this.dataModel.getProperty("/MasterdataSystem");this.setLeadingCategory(j).then(function(){b.call(this);}.bind(this));return;}b.call(this);},_handleReferenceEventDialogSearch:function(e){var a=e.getParameter("value");var b=new F("Name",sap.ui.model.FilterOperator.Contains,a);e.getSource().getBinding("items").filter([b]);},onTargetGroupChange:function(e){if(e.skipChange&&e.valueInput){e.getSource().setValue(e.valueInput);return;}var t=e.getSource().getValue();var P=e.getSource().getParent().getBindingContext().getPath();var R=null;if(!t){R=jQuery.extend(true,{},this.CONSTANTS.TARGET_GROUP_EMPTY_ROW);this.dataModel.setProperty(P,R);this.validateTargetGroups();return;}var a=function(){return jQuery.extend(true,{},this.CONSTANTS.TARGET_GROUP_EMPTY_ROW,{"Name":t,"RedeemEnabled":false});}.bind(this);M.getTargetGroups("equals",t).then(function(b){if(b.TargetGroups.length){R=b.TargetGroups[0];if(R.RedeemPercent===0){R.RedeemPercent="100";}jQuery.extend(R,{"ProjectedMembers":Math.round(parseFloat(R.RedeemPercent)/100*R.Members),"RedeemEnabled":true});this.dataModel.setProperty(P,R);}else{this.dataModel.setProperty(P,a());}this.validateTargetGroups();}.bind(this),function(){this.dataModel.setProperty(P,a());this.validateTargetGroups();}.bind(this));},onRedeemPercentChange:function(e){var R=parseFloat(e.getSource().getValue());var P=e.getSource().getParent().getBindingContext().getPath();var i=null;if(R>=1&&R<=100){var a=this.dataModel.getProperty(P+"/Members");i=Math.round(R/100*a);}this.dataModel.setProperty(P+"/ProjectedMembers",i);this.validateTargetGroups();},onTargetGroupSuggestionSelect:function(e){var a=this.getModelDataFromAnnotation(e);var P=Math.round(parseFloat(a.RedeemPercent)/100*parseFloat(a.Members));var b=e.getSource().getParent().getBindingContext().getPath();a=jQuery.extend(true,{},a,{"ProjectedMembers":P,"RedeemEnabled":true});var i=this.getView().getModel("UIVisiblity").getProperty("/Version")>2;if(i&&!this.dataModel.getProperty("/MarketingArea")){this.dataModel.setProperty("/MarketingArea",a.MarketingArea);this.contentModel.setProperty("/MarketingAreaFilter",{MarketingArea:a.MarketingArea});}this.dataModel.setProperty(b,a,null,true);e.valueInput=a.Name;e.skipChange=true;this.validateTargetGroups();return e;},handleAddTargetGroupPress:function(){var t=this.dataModel.getData().TargetGroups;var N=jQuery.extend(true,{},this.CONSTANTS.TARGET_GROUP_EMPTY_ROW);N.Id=null;N.Name=null;t.push(N);this.dataModel.updateBindings();},handleDeleteTargetGroup:function(e){var P=e.getParameter("listItem").getBindingContext().getPath();var t=P.split("/");var R=t[t.length-1];var a=this.dataModel.getData().TargetGroups;a.splice(R,1);this.dataModel.updateBindings();this.validateTargetGroups();},validateTargetGroups:function(){var t=this.dataModel.getProperty("/TargetGroups");var i=this.i18nModel.getResourceBundle();var I=i.getText("CreateOffer.General.TargetGroup.Invalid");var a=i.getText("CreateOffer.General.TargetGroup.InvalidRedeemPercent");var b=i.getText("CreateOffer.General.TargetGroup.Duplicate");U.removeMessagesByPath("/TargetGroups");var e=[];var j=function(K,N,O){e.push(new sap.ui.core.message.Message({message:N,description:O,type:"Error",target:K,processor:this.dataModel}));}.bind(this);var q=function(K){return!K.Name;};var x=function(K,N){if(parseFloat(K.RedeemPercent)<1||parseFloat(K.RedeemPercent)>100){var O="/TargetGroups/"+N+"/RedeemPercent";var P=i.getText("CreateOffer.General.TargetGroup.InvalidRedeemPercentRow",N+1);j(O,a,P);}};var E=function(K,N){if(!K.Id){var O="/TargetGroups/"+N+"/Name";var P=i.getText("CreateOffer.General.TargetGroup.InvalidRow",N+1);j(O,I,P);}};var G=function(t){var K={};t.forEach(function(O,P){if(!O.Id){return;}if(typeof K[O.Id]==="undefined"){K[O.Id]=[];}O.index=P;K[O.Id].push(O);});for(var N in K){if(K[N].length>1){K[N].forEach(function(O){j("/TargetGroups/"+O.index+"/Name",b,"");});}}};this.validateTable(t,{validations:[G],iterationValidations:[E,x],skipRowFn:q});this.oMessageManager.addMessages(e);if(e.length===0){var H=this.getTotalAudience(t);this.contentModel.setProperty("/TotalAudience",H);}return e.length;},setTacticTypeInfo:function(P,a,b){var e=b.getProperty(P);e=jQuery.extend(e,a);b.setProperty(P,e,null,true);},onTacticSuggestionSelect:function(e){var S=this.getModelDataFromAnnotation(e);var i=S.TacticAndType;var t=S.TacticAndTypeDesc;var R=e.getSource().getParent().getBindingContextPath();this.dataModel.setProperty(R+"/Id",i,null,true);this.dataModel.setProperty(R+"/Name",t,null,true);this.setTacticTypeInfo(R,S,this.dataModel);this.validateTactics();},handleAddTacticsPress:function(){this.addNewTactic();this.validateTactics();},addNewTactic:function(i,a){var t=this.dataModel.getData().Tactics;var S=this.dataModel.getProperty("/StartOfOffer");var e=this.dataModel.getProperty("/EndOfOffer");var b=this.timeModel.getData();var j={"Id":i||null,"Name":a||null,"StartOfTactic":S,"EndOfTactic":e,"StartTimeOfTactic":b.StartTime,"EndTimeOfTactic":b.EndTime,"EndTimeOfTacticValue":this.timeLabelValueFormatter(b.EndTime),"StartTimeOfTacticValue":this.timeLabelValueFormatter(b.StartTime)};t.push(j);this.dataModel.refresh();return j;},handleDeleteTactic:function(e){var t=this.dataModel.getData().Tactics;if(t.length===1){var S=this.dataModel.getProperty("/StartOfOffer");var E=this.dataModel.getProperty("/EndOfOffer");var a=this.timeModel.getData();t[0]={"Id":null,"StartOfTactic":S,"EndOfTactic":E,"StartTimeOfTactic":a.StartTime,"EndTimeOfTactic":a.EndTime,"EndTimeOfTacticValue":this.timeLabelValueFormatter(a.EndTime),"StartTimeOfTacticValue":this.timeLabelValueFormatter(a.StartTime)};}else{var P=e.getParameter("listItem").getBindingContext().getPath();var b=P.split("/");var R=b[b.length-1];t.splice(R,1);}this.dataModel.updateBindings();this.validateTactics();},onTacticTypeChange:function(e){var a=e.getSource().getValue();var P=e.getSource().getParent().getBindingContext().getPath();this.dataModel.setProperty(P+"/Id",null);if(!a){this.validateTactics();return;}var b=function(x){var R=this.dataModel.getProperty(P);jQuery.extend(R,x);this.dataModel.setProperty(P,R);}.bind(this);var t=null,j=null;var q=this.contentModel.getData().TacticTypes;for(var i=0;i<q.length;i++){var x=q[i];if(x.Id===a.toUpperCase()){t=x;break;}if(x.Name===a){j=x;}}if(t){b(t);}else if(j){b(j);}this.validateTactics();},onTacticTimeChange:function(e){var a=function(P,t,j){var q=this.dataModel.getProperty(P);var x;if(!q){if(j==="start"){q=this.dataModel.getProperty("/StartOfOffer");}else if(j==="end"){q=this.dataModel.getProperty("/EndOfOffer");}x=this.getDate(q,t);}else{x=this.getDate(q,t);}this.dataModel.setProperty(P,x);}.bind(this);var R=e.getSource().getParent().getBindingContextPath();var S=this.dataModel.getProperty(R+"/StartTimeOfTactic");var E=this.dataModel.getProperty(R+"/EndTimeOfTactic");a(R+"/StartOfTactic",S,"start");a(R+"/EndOfTactic",E,"end");var b=this.dataModel.getProperty(R+"/StartOfTactic");var i=this.dataModel.getProperty(R+"/EndOfTactic");this.dataModel.setProperty(R+"/StartOfTactic",new Date(NaN));this.dataModel.setProperty(R+"/StartOfTactic",b);this.dataModel.setProperty(R+"/EndOfTactic",new Date(NaN));this.dataModel.setProperty(R+"/EndOfTactic",i);this.validateTactics();},buildTacticsErrors:function(a,b){function e(i){return i.Id;}function j(i,t){var I={day:i.getDate(),month:i.getMonth(),year:i.getFullYear()};var K={day:t.getDate(),month:t.getMonth(),year:t.getFullYear()};return jQuery.sap.equal(I,K);}function q(i,t){return i.getTime()<t.getTime();}function x(i,t){return"/Tactics/"+i+t;}function E(t,i){return i.Tactics.some(function(I){return!!I.Id&&t!==I&&I.Id===t.Id;});}function G(I,i){var K=[];function N(t,$,_){K.push({message:a.getText(t),description:a.getText($,i+1),type:"Error",target:x(i,_),processor:b});}function O($){var t=new Date(0);t.setHours($.getHours(),$.getMinutes(),$.getSeconds(),$.getMilliseconds());return t;}if(!e(I,b.getData())){N("CreateOffer.General.Tactics.Errors.InvalidTacticType","CreateOffer.General.Tactics.Errors.InvalidTacticTypeRow","/Name");}var P=(I.StartOfTactic);var Q=(I.EndOfTactic);var R=O(I.StartTimeOfTactic);var S=O(I.EndTimeOfTactic);var W=(b.getData().StartOfOffer);var X=(b.getData().EndOfOffer);var Y=O(b.getData().StartOfOffer);var Z=O(b.getData().EndOfOffer);if(j(P,W)){if(q(R,Y)){N("CreateOffer.General.Tactics.Errors.TimeFrom","CreateOffer.General.Tactics.Errors.StartTimeLowerThanStartOfOffer","/StartTimeOfTactic");}if(j(W,X)){if(q(Z,R)){N("CreateOffer.General.Tactics.Errors.TimeFrom","CreateOffer.General.Tactics.Errors.StartTimeBiggerThanEndOfOffer","/StartTimeOfTactic");}}}else{if(q(P,W)){N("CreateOffer.General.Tactics.Errors.DateFrom","CreateOffer.General.Tactics.Errors.StartDateLowerThanStartDateOfOffer","/StartOfTactic");}if(q(X,P)){N("CreateOffer.General.Tactics.Errors.DateFrom","CreateOffer.General.Tactics.Errors.StartDateBiggerThanEndDateOfOffer","/StartOfTactic");}}if(j(Q,X)){if(q(Z,S)){N("CreateOffer.General.Tactics.Errors.TimeTo","CreateOffer.General.Tactics.Errors.EndTimeBiggerThanEndOfOffer","/EndTimeOfTactic");}if(j(W,X)){if(q(S,Y)){N("CreateOffer.General.Tactics.Errors.TimeTo","CreateOffer.General.Tactics.Errors.EndTimeLowerThanStartOfOffer","/EndTimeOfTactic");}}}else{if(q(Q,W)){N("CreateOffer.General.Tactics.Errors.DateTo","CreateOffer.General.Tactics.Errors.EndDateLowerThanStartDateOfOffer","/EndOfTactic");}if(q(X,Q)){N("CreateOffer.General.Tactics.Errors.DateTo","CreateOffer.General.Tactics.Errors.EndDateBiggerThanEndDateOfOffer","/EndOfTactic");}}if(!j(P,Q)){if(q(Q,P)){N("CreateOffer.General.Tactics.Errors.CDateFrom","CreateOffer.General.Tactics.Errors.StartDateBiggerThanEndDate","/StartOfTactic");N("CreateOffer.General.Tactics.Errors.CDateTo","CreateOffer.General.Tactics.Errors.EndDateLowerThanStartDate","/EndOfTactic");}}if(j(P,Q)){if(q(S,R)){N("CreateOffer.General.Tactics.Errors.CTimeFrom","CreateOffer.General.Tactics.Errors.StartTimeBiggerThanEndTime","/StartTimeOfTactic");N("CreateOffer.General.Tactics.Errors.CTimeTo","CreateOffer.General.Tactics.Errors.EndTimeLowerThanStartTime","/EndTimeOfTactic");}}if(E(I,b.getData())){N("CreateOffer.General.Tactics.Errors.DuplicatedTacticTypes","","/Name");}return K;}var H=b.getData().Tactics;return H.reduce(function(t,I,i){return t.concat(G(I,i));},[]);},validateTactics:function(){var i=this.i18nModel.getResourceBundle();var a=this.buildTacticsErrors(i,this.dataModel);U.removeMessagesByPath("/Tactics");U.setErrorMessages(this.oMessageManager,a,this.dataModel);return a.length;},validateTable:function(I,a){for(var i=0;i<I.length;i++){if(a.skipRowFn(I[i])){continue;}for(var j=0;j<a.iterationValidations.length;j++){a.iterationValidations[j](I[i],i);}}a.validations.forEach(function(b){b(I);});},validateManageOfferSet:function(a){var b=function(a){var O=this.offerSetModel.getData().OfferSets;for(var i=0,j=O.length;i<j;i++){if(O[i].Text===a){return true;}}return false;}.bind(this);var e={text:this.i18nModel.getResourceBundle().getText("ErrorMessage.General.OfferSetEmptyName"),state:"Error",error:true};if(!a.length){return e;}else if(b(a)){e.text=this.i18nModel.getResourceBundle().getText("ErrorMessage.General.OfferSetAlreadyExists");return e;}else{return{text:"",state:"None",error:false};}},onManageOfferPress:function(){var t=this;M.getOfferSet().then(function(a){var b=a.data||[];t.offerSetModel.setData({"OfferSets":b,"Count":b.length,"iLastModified":null});t.manageOfferSetsDialog.setModel(t.offerSetModel,"OfferSet");t.manageOfferSetsDialog.open();});},onSaveOfferSets:function(e){var O=this.offerSetModel.getData().OfferSets;var j={"remove":[],"update":[],"add":[]};var S=false;var q={Id:this.dataModel.getProperty("/OfferSetId"),Text:this.dataModel.getProperty("/OfferSetName")};for(var i=0,t=O.length;i<t;i++){if(O[i].status){var x={Id:O[i].Id,Text:O[i].Text};if(q.Id&&x.Id===q.Id){q.Text=x.Text;}if(x.Id===q.Id&&O[i].status==="remove"){q.Text=null;q.Id=null;}j[O[i].status].push(x);S=true;}}this.manageOfferSetsDialog.close();if(!S){return;}U.getErrorHandler().showBusy();var E=this;M.manageOfferSet(j).then(function(j){var G=U.get(j,["returnedData","__batchResponses"])||[];var H=G.map(function(a){return a.__changeResponses||[];}).reduce(function(a,b){return a.concat(b);},[]).filter(function(a){return!!a.data;}).map(function(a){return a.data;});var I=H[0]||q;E.dataModel.setProperty("/OfferSetName",I.Text);E.dataModel.setProperty("/OfferSetId",I.Id);E.contentModel.setProperty("/OfferSetValue",I.Text);U.getErrorHandler().hideBusy();},function(){U.getErrorHandler().hideBusy();});},onOfferSetsSearch:function(e){var a=[];var q=e.getSource().getValue();if(q&&q.length>0){var b=new F("Text",sap.ui.model.FilterOperator.Contains,q);a.push(b);}var i=sap.ui.getCore().byId("OfferSetManageListId");var j=i.getBinding("items");j.filter(a,"Application");this.offerSetModel.setProperty("/Count",j.getLength());this.offerSetModel.refresh(true);},onCancelOfferSets:function(e){this.manageOfferSetsDialog.close();},validateOfferSetText:function(e){var O=this.offerSetModel.getData().OfferSets;var P=e.getSource().getBindingContext("OfferSet").getPath();var a=P.split("/")[2];var b=this.validateManageOfferSet(e.getSource().getValue().trim());O[a].ValueState=b.error;O[a].ValueStateText=b.text;},handleEditOfferSetPress:function(e){var O=this.offerSetModel.getData().OfferSets;var P=e.getSource().getBindingContext("OfferSet").getPath();var a=P.split("/")[2];if(this.offerSetModel.getData().iLastModified!==null){O[this.offerSetModel.getData().iLastModified].isEditValue=false;O[this.offerSetModel.getData().iLastModified].ValueState=false;}this.offerSetModel.getData().iLastModified=a;O[a].isEditValue=!O[a].isEditValue;O[a].TextInput=O[a].Text;this.offerSetModel.updateBindings(true);},handleDeleteOfferSetPress:function(e){var O=this.offerSetModel.getData().OfferSets;var P=e.getSource().getBindingContext("OfferSet").getPath();var a=P.split("/")[2];var b=this.i18nModel.getResourceBundle().getText("CreateOffer.General.ManageOfferSets.DeleteText",O[a].Text);var i={"massageSingle":b,"title":"CreateOffer.General.ManageOfferSets.Delete"};U.openDeleteConfirmDiaog(true,i).then(function(){this.offerSetModel.getData().Count--;O[a].status="remove";O[a].isDeleted=true;this.offerSetModel.updateBindings(true);}.bind(this));},handleOkOfferSetPress:function(e){var O=this.offerSetModel.getData().OfferSets;var P=e.getSource().getBindingContext("OfferSet").getPath();var a=P.split("/")[2];if(O[a].ValueState){return;}O[a].isEditValue=!O[a].isEditValue;if(O[a].Text!==O[a].TextInput){O[a].status="update";}O[a].Text=O[a].TextInput;this.offerSetModel.updateBindings(true);},handleCancelOfferSetPress:function(e){var O=this.offerSetModel.getData().OfferSets;var P=e.getSource().getBindingContext("OfferSet").getPath();var a=P.split("/")[2];O[a].isEditValue=!O[a].isEditValue;O[a].ValueState=false;this.offerSetModel.updateBindings(true);},handleAddOfferSetPress:function(e){var t=this;var a=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.general.NewOfferSetDialog",{validateNewOfferSetText:function(e){var b=t.validateManageOfferSet(e.getSource().getValue());var i=e.getSource();i.setValueStateText(b.text);i.setValueState(b.state);},onOkPress:function(){var i=sap.ui.getCore().byId("newOfferSet");var b=i.getValue().trim();var j=t.validateManageOfferSet(b);i.setValueStateText(j.text);i.setValueState(j.state);if(j.error){return;}t.offerSetModel.getData().OfferSets.push({Id:"",Text:b,status:"add"});t.offerSetModel.getData().Count++;t.offerSetModel.updateBindings(true);a.close();},onCancelPress:function(){a.close();},onAfterClose:function(){a.destroy();}});a.setModel(this.i18nModel,"i18n");a.open();},offerSetDeleteButtonFormatter:function(a){return!a;},offerSetChangedFormatter:function(a,b){if(!a&&!b){return"";}var e=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"MMM dd HH:mm a"});return a+" - "+e.format(b);},getIndexFromPath:function(P){var t=P.split("/");return t[t.length-1];},liveSearchLocation:U.liveChangeFilterHandler(["ExtNodeId","HierarchyDescription"],"LocationTreeTable"),timeLabelVisibilityFormatter:function(e){return!e;},timeLabelValueFormatter:function(t){return this.dateHandler.getFormatTimePiker(t);},togglePackageOffer:function(e){var t=this;var a=function a(){return(t.getOwnerComponent().getState().getSavePayload().Terms.length>0)||(t.getOwnerComponent().getState().getSavePayload().Incentives.length>0);};if(a()){n(e.getParameter("selected"),t.getView().getModel("i18n")).then(function(b){t.eventBus.publish("retail.pmr.promotionaloffers","resetTermsTab");},function(b){t.dataModel.setProperty("/PackageOffer",b);});}else{t.eventBus.publish("retail.pmr.promotionaloffers","resetTermsTab");}},resetFilters:function(){this.dataModel.setProperty("/ExcludedNodes",[]);this.dataModel.setProperty("/LocationFilters",[]);var a=this.contentModel.getProperty("/TotalStores");this.updateLocationLabel(a,a);},advancedLocationSettings:function(){var a=sap.ui.core.UIComponent.getRouterFor(this);var b=this.getOwnerComponent().getState();var e=b.processor.createSavePayloadWithFinancials();var i=this.contentModel.getProperty("/Hierarchy");if(i){e.LocationHierarchy=U.buildLocationHierarchyFromVH(i);}var j=e.OfferId;var q=e.LocationNodeId;b.setTransientSnapshot(e);b.store(e,{});if(!j){a.navTo("locationGroupsCreate",{locationId:U.base64ToHex(q)});}else{a.navTo("locationGroups",{path:U.base64ToHex(j),locationId:U.base64ToHex(q)});}},isPackageOffer:function(){return this.dataModel.getProperty("/PackageOffer")||false;},notNull:function(x){return!!x;},isCouponOfferSelect:function(){var b=this.dataModel.getProperty("/IsCouponOffer")||false;if(b){var a=this.getTotalAudience(this.dataModel.getProperty("/TargetGroups"));this.contentModel.setProperty("/TotalAudience",a);}},resetCouponData:function(){if(this.dataModel.getProperty("/IsCouponOffer")===false){this.dataModel.setProperty("/EnforceEligibility",false);this.dataModel.setProperty("/UniqueIdRequired",false);this.dataModel.setProperty("/WebCode","");this.dataModel.setProperty("/MaxRedemp",0);this.dataModel.setProperty("/PersonalMaxRedemp",0);this.dataModel.setProperty("/UniqueIdLimit",0);this.contentModel.setProperty("/TotalAudience",0);}var a=["EligibilityDays","EligibilityOffset","MaxRedemp","PersonalMaxRedemp","UniqueIdLimit"];var t=this;a.forEach(function(b){var e=t.getView().byId(b).getValueState();if(e==="Error"){t.getView().byId(b).setValueState("None");t.getView().byId(b).setValue(0);}});}});});
