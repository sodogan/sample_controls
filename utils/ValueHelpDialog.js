/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/model/resource/ResourceModel","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Models","sap/ui/comp/filterbar/FilterGroupItem","sap/m/MultiInput","sap/ui/comp/valuehelpdialog/ValueHelpDialog","sap/ui/comp/filterbar/FilterBar"],function(R,J,M,F,a,H,b){"use strict";var O={bt:function(){return"BT";},cp:function(){return"CP";},endswith:function(){return"CP";},startswith:function(){return"CP";},eq:function(){return"EQ";},nb:function(){return"NB";},ne:function(){return"NE";},np:function(){return"NP";}};var S={include:function(){return"I";},exclude:function(){return"E";}};var V={filterValues:[],createPayload:function(s,t,f){var h=!jQuery.sap.equal(s.filters,f);var d=[];var p={"Action":s.action,"Skip":s.skip,"Top":h?s.topForSearch:s.top,"TermObjects":[],"Filters":d};for(var i=0;i<t.length;i++){p.TermObjects.push(t[i]);}for(var j=0;j<f.length;j++){p.Filters.push(f[j]);}return p;},create:function(s,e,p){return new Promise(function(r,c){setTimeout(function(){s.create(e,p,{async:true,success:function(d){r({data:d});},error:c});},100);});},read:function(s,e){return new Promise(function(r,c){setTimeout(function(){s.read(e,{async:true,success:function(d){r({data:d});},error:c});},100);});},bindItems:function(c,t){var r=c.data;var o=new J();if(r.TermObjects){o.setData(r.TermObjects.results);}else{o.setData([]);}t.setShowNoData(true);t.setModel(o);t.bindRows("/");},getOption:function(t,c){function r(){return t.exclude===false?"I":"E";}function i(){return{"Id":c+1,"Attribute":t.keyField,"Sign":r(),"Option":O.eq(),"Low":t.value1};}function d(){return{"Id":c+1,"Attribute":t.keyField,"Sign":r(),"Option":O.cp(),"Low":"*"+t.value1+"*"};}function e(){return{"Id":c+1,"Attribute":t.keyField,"Sign":r(),"Option":O.bt(),"Low":t.value1,"High":t.value2};}function f(){return{"Id":c+1,"Attribute":t.keyField,"Sign":r(),"Option":O.endswith(),"Low":"*"+t.value1};}function g(){return{"Id":c+1,"Attribute":t.keyField,"Sign":r(),"Option":O.startswith(),"Low":t.value1+"*"};}var o={"EQ":i,"Contains":d,"BT":e,"EndsWith":f,"StartsWith":g};return o[t.operation]();},getSign:function(v){if(v&&v.indexOf("!(")>-1){return S.exclude();}return S.include();},defaultFilters:function(s,f){for(var i=0;i<s.filters.length;i++){s.filters[i].Id=i+1;f.push(s.filters[i]);}},basicSearchFilter:function(f){var c=this.basicSearchField.getValue();var d=null;if(c&&c!==""){d={"Id":f.length+1,"Attribute":"EXT_HR_ID","Sign":S.include(),"Option":O.cp(),"Low":"*"+c+"*"};f.push(d);}},getAttributeName:function(c){return"ATTR#"+this.oSettings.attributeType+"#"+c;},advancedSearchFilter:function(c,f){var s=c[0].getParameter("selectionSet");for(var i=0;i<s.length;i++){var d=s[i];var t=d.getTokens();for(var j=0;j<t.length;j++){var e=t[j].getAggregation("customData")[0].getProperty("value");var g=this.getOption(e,f.length);f.push(g);}if(d.getValue()){var h={exclude:false,operation:"EQ",keyField:d.searchKey,value1:d.getValue(),value2:""};f.push(this.getOption(h,f.length));}}},getColumnModel:function(c){var C=new J();C.setData({cols:c});return C;},initCtrl:function(s,c){c=c||jQuery.noop;if(!(c instanceof Function)){throw new Error("Value Help Dialog column customizer must be a function");}var d=this;this.oBus=sap.ui.getCore().getEventBus();this.oSettings=s;var v=new H({basicSearchText:s.searchValue,title:s.title,supportMultiselect:s.supportMultiselect,supportRanges:s.supportRanges,supportRangesOnly:s.supportRangesOnly,stretch:s.stretch,cancel:function(C){d.oBus.publish("retail.pmr.promotionaloffers","cancelProductGroup",null);v.close();},afterClose:function(){v.destroy();}});if(sap.ui.version>="1.44.0"){v.setEscapeHandler(function(){d.oBus.publish("retail.pmr.promotionaloffers","cancelProductGroup",null);v.close();});}var e=v.getTable();var f=this.getColumnModel(s.tableColumns);e.setModel(f,s.oColModelBindName);e.getColumns().forEach(c);e.getColumns().forEach(function(n,p){if(p===4){n.setHAlign("End");n.getLabel().setTextAlign("End");}});if(e.bindItems){var T=v.getTable();T.bindAggregation("items",s.bindPath,function(I,C){var n=T.getModel("columns").getData().cols;return new sap.m.ColumnListItem({cells:n.map(function(p){var r=p.template;return new sap.m.Label({text:"{"+r+"}"});})});});}e.attachRowSelectionChange(function(C){var n=C.getParameters().rowContext.sPath.split("/")[1];var p=C.getParameters().rowContext.getModel().getData()[n];d.selectedItem=p;d.oBus.publish("retail.pmr.promotionaloffers","selectedProductGroup",{"selectedProductGroupItem":d.selectedItem});v.close();});var g=[];function h(r,n){var p={valueHelpRequest:function(){var d=this;var u=[sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.Contains,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.EQ,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.BT,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.StartsWith,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.EndsWith];var w=new H({supportMultiselect:true,supportRanges:true,supportRangesOnly:true,title:n,ok:function(C){d.setTokens(C.getParameters().tokens);w.close();},cancel:function(C){w.close();},afterClose:function(){w.destroy();}});w.setIncludeRangeOperations(u);w.setRangeKeyFields(r);w.setTokens(d.getTokens());w.open();}};return p;}var t=0;var i=null;for(t=0;t<s.definedFilters.length;t++){i=new a(h([{label:s.definedFilters[t].label,key:s.definedFilters[t].key}],s.definedFilters[t].label));i.searchKey=s.definedFilters[t].key;var j=new F({groupTitle:"Group Details",groupName:"g1",name:s.definedFilters[t].key,label:s.definedFilters[t].label,control:i,visibleInFilterBar:true});g.push(j);}var k=[];for(t=0;t<s.productGroupAttributes.length;t++){i=new a(h([{label:s.productGroupAttributes[t].label,key:s.productGroupAttributes[t].key}],s.productGroupAttributes[t].label));i.searchKey="ATTR_"+s.productGroupAttributes[t].type+"_"+s.productGroupAttributes[t].id;var l={multiInput:i,label:s.productGroupAttributes[t].label,id:s.productGroupAttributes[t].id,object:s.productGroupAttributes[t].object};k.push(l);}for(var q=0;q<k.length;q++){var m=new F({groupTitle:"Attributes",groupName:"g2",name:"attr_name_"+k[q].id+"_"+k[q].object,label:k[q].label,control:k[q].multiInput,visibleInFilterBar:true});g.push(m);}var o=new b({advancedMode:true,filterBarExpanded:s.filterBarExpand,showGoOnFB:s.showGoOnFB,filterGroupItems:g,search:function(n){var p=[];var r=[];d.defaultFilters(s,p);d.basicSearchFilter(p);d.advancedSearchFilter(arguments,p);var u=s.complexSearchUrl;var w=d.createPayload(s,r,p);e.setBusy(true);d.create(s.service,u,w).then(function(x){d.bindItems(x,e);e.setBusy(false);});}});this.basicSearchField=new sap.m.SearchField({showSearchButton:sap.ui.Device.system.phone,placeholder:s.FilterPlaceholder,value:s.inputFilter});if(o.setBasicSearch){o.setBasicSearch(this.basicSearchField);}o.setSearchEnabled(true);v.setFilterBar(o);return v;}};return V;},true);
