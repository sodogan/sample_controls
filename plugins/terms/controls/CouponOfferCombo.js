/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/m/Input","sap/m/InputRenderer","retail/pmr/promotionaloffers/utils/Models","retail/pmr/promotionaloffers/utils/Utils","sap/ui/core/ListItem","sap/ui/model/json/JSONModel","sap/ui/comp/valuehelpdialog/ValueHelpDialog"],function(I,c,M,U,L,J,V){var C="O01";var N="O09";this.sLastSelection="";function g(o){if(!o){return"";}if(!o.ExtOfferId){return o.Name;}if(!o.Name){return o.ExtOfferId;}return o.ExtOfferId+" - "+o.Name;}function p(i,o){if(o){i.setValue(o.ExtOfferId);i.setDescription(o.Name);}else{i.setValue(null);i.setDescription(null);}}return I.extend("retail.pmr.promotionaloffers.plugins.terms.controls.CouponOfferCombo",{metadata:{properties:{productRelevant:{type:"string"},couponOfferId:{type:"string"}}},renderer:c,_changeProxy:function(){},init:function(){this.attachSuggest(this._onSuggest);this.attachSuggestionItemSelected(this._onSuggestionItemSelected);this.setStartSuggestion(1);this.setShowSuggestion(true);this.setMaxSuggestionWidth("550px");this.setShowValueHelp(true);this.attachValueHelpRequest(this.initAdvancedSearch);this.attachChange(this.validateCouponOffer);this.setFilterFunction(function(v,i){function d(a,b){return a.indexOf(b)>-1;}var e=i.data;var l=v.toLowerCase();return d((e.Name+"").toLowerCase(),l)||d((e.ExtOfferId+"").toLowerCase(),l);});},destroy:function(){this.clearErrorMessage();I.prototype.destroy.apply(this,arguments);},clearErrorMessage:function(){var P=this.getBindingContext().getPath();U.removeMessagesByPath(P);this.setValueState("None");},createVHD:function(i,a,s){var t=this;var T="";if(s===C){T=a.getResourceBundle().getText("Terms.CouponOfferAdvancedSearch.DialogTitle");}else{T=a.getResourceBundle().getText("Terms.OfferAdvancedSearch.DialogTitle");}this.couponOfferAdvancedSearch=new V({title:T,supportMultiselect:false,stretch:sap.ui.Device.system.phone,cancel:function(){this.close();},selectionChange:function(e){var b=e.getParameter("tableSelectionParams");var d=b.rowIndex;var f=b.rowContext.getModel().getData()[d];t.setCouponOfferId(f.OfferId);p(t,f);this.close();t.clearErrorMessage();}});},setTable:function(i,s){var t=sap.ui.xmlfragment("retail.pmr.promotionaloffers.plugins.terms.controls.CouponOfferCombo",this);var e="";if(s===C){e=i.getResourceBundle().getText("Terms.CouponOfferAdvancedSearch.ExtOfferId");}else{e=i.getResourceBundle().getText("Terms.OfferAdvancedSearch.ExtOfferId");}t.getColumns()[0].getLabel().setText(e);t.setModel(i,"i18n");t.setBusy(true);this.couponOfferModel=new J();t.setModel(this.couponOfferModel);this.couponOfferAdvancedSearch.setTable(t);},makeCall:function(a,b,s,f){var t=this;M.getCouponOffers(b,s,f).then(function(o){var m=[];for(var i=0,l=o.length;i<l;i++){var d={};d.OfferId=o[i].OfferId;d.ExtOfferId=o[i].ExtOfferId;d.Name=o[i].Name;d.Status=o[i].Status;d.StatusName=o[i].StatusName;m.push(d);}t.couponOfferModel.setData(m);t.couponOfferAdvancedSearch.getTable().setBusy(false);});},calculateFilters:function(o){var f=[];var s=o.getParameters().selectionSet||[];for(var i=0,a=s.length;i<a;i++){if(s[i].getValue().length>0){var n={};n.key=s[i].searchKey;n.exclude=false;var b=s[i].getValue()||"";n.value1=b;n.value2="";if(n.key==="Name"){n.operator="Contains";f.push(U.getOption(n));continue;}n.operator="EQ";var d=[];d.push(n);if(s[i].getTokens().length>0){d=U.getFiltersFromTokens(s,i);}}else{d=U.getFiltersFromTokens(s,i);}if(d.length>0){var r=U.getArryByIncludeOrExclude(d);f.push(r);}}return f;},getFilterItems:function(i,s){var f=[];var l="";if(s===C){l=i.getResourceBundle().getText("Terms.CouponOfferAdvancedSearch.ExtOfferId");}else{l=i.getResourceBundle().getText("Terms.OfferAdvancedSearch.ExtOfferId");}var d=[{label:l,key:"ExtOfferId"},{label:i.getResourceBundle().getText("Terms.CouponOfferAdvancedSearch.Name"),key:"Name"}];for(var t=0;t<d.length;t++){var a=new sap.m.MultiInput(this.getFilterBarSettings([{label:d[t].label,key:d[t].key}],d[t].label));a.setFilterFunction(function(){return true;});a.searchKey=d[t].key;var b=new sap.ui.comp.filterbar.FilterItem({control:a,name:d[t].label,partOfCurrentVariant:true,label:d[t].label});f.push(b);}return f;},initAdvancedSearch:function(e){var t=this;var i=e.getSource();var a=U.getResourceModel();var b=U.getI18NModel();var s=this.getProductRelevant();if(!this.couponOfferAdvancedSearch||(this.sLastSelection&&this.sLastSelection!==s)){this.sLastSelection=s;this.createVHD(i,b,s);this.setTable(a,s);var f=new sap.ui.comp.filterbar.FilterBar({advancedMode:true,filterBarExpanded:true,showGoOnFB:true,filterItems:t.getFilterItems(b,s),search:function(j){t.couponOfferAdvancedSearch.getTable().setBusy(true);var k=t.calculateFilters(j);var l=U.flatenFilters(k);var m=U.setBasicSearchValue.call(t,"couponOfferAdvancedSearch");t.makeCall(i,m,s,l);}});var d=new sap.m.SearchField({showSearchButton:sap.ui.Device.system.phone,placeholder:b.getResourceBundle().getText("General.Location.Picker.Placeholder")});if(f.setBasicSearch){f.setBasicSearch(d);}f.setSearchEnabled(true);t.couponOfferAdvancedSearch.setFilterBar(f);}var h=i.getProperty("value");if(h.length>0){this.couponOfferAdvancedSearch.setBasicSearchText(h);}this.makeCall(i,h,s,null);this.couponOfferAdvancedSearch.open();},getFilterBarSettings:function(r,t){var a=this;var n={valueHelpRequest:function(){var a=this;var s=[sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.BT,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.Contains,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.EQ,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.EndsWith,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.GE,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.GT,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.LE,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.LT,sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.StartsWith];var v=new sap.ui.comp.valuehelpdialog.ValueHelpDialog({supportMultiselect:true,supportRanges:true,supportRangesOnly:true,title:t,ok:function(o){a.setTokens(o.getParameters().tokens);v.close();},cancel:function(o){v.close();},afterClose:function(){v.destroy();}});v.setIncludeRangeOperations(s);v.setRangeKeyFields(r);v.setTokens(a.getTokens());v.open();}};return n;},validateInputValue:function(i){var v=i.getValue();if(!v){this.clearErrorMessage();this.setProperty("couponOfferId",null);p(this,null);return;}var s=this.getProductRelevant();M.getCouponOffers(v,s).then(function(o){if(o.length===1){var a=o[0];i.setCouponOfferId(a.OfferId);p(i,a);}else{i.setCouponOfferId(null);i.setValue(v);i.setDescription(null);var P=i.getBindingContext().getPath();var b=P.split("/");var d=b[2];d=parseInt(d,10)+1;var e=U.getI18NModel();var m=U.getMessageManager();var D="";if(s===C){D=e.getResourceBundle().getText("Terms.CouponOfferAdvancedSearch.ExtOfferId");}else{D=e.getResourceBundle().getText("Terms.OfferAdvancedSearch.ExtOfferId");}var f=[{message:e.getResourceBundle().getText("CreateOffer.Terms.InvalidCouponOffer.Title")+" - "+D,description:"",type:"Error",target:P,processor:i.getBindingContext().getModel()}];U.setErrorMessages(m,f);i.setValueState("Error");}});},_onSuggest:function(e){var i=e.getSource();i.destroySuggestionItems();this.validateInputValue(i);},_onSuggestionItemSelected:function(e){var i=e.getSource();var a=e.getParameter("selectedItem");var b=a.data;i.setCouponOfferId(b.OfferId);p(i,b);this.clearErrorMessage();},validateCouponOffer:function(e){var s=e.getSource()._iPopupListSelectedIndex;if(s>-1){return;}var i=e.getSource();this.validateInputValue(i);},setCouponOfferId:function(v){this.clearErrorMessage();var t=this;if(!v){t.setProperty("couponOfferId",null);p(t,null);return;}M.getCouponOfferById(v).then(function(o){t.setProperty("couponOfferId",o.OfferId);p(t,o);},function(e){t.setProperty("couponOfferId",null);if(e){jQuery.sap.log.error(e);}});}});});
