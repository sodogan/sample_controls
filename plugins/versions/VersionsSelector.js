/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/plugins/general/LocationSelector"],function(J,U,L){function a(b,c,d){if(b===c.LocationId||b===c.NodeId||b===c.ExtNodeId){c.hasVersion=true;c.VersionName=d;}else{for(var i in c){if(c.hasOwnProperty(i)&&jQuery.isNumeric(i)){a(b,c[i],d);}}}}function v(b){var c=0;b.showTooltip=true;if(b.NodeId||b.LocationId||b.ExtNodeId){c=0;d(b,c);if(c>0){b.versionCount=c;}}for(var i in b){if(b.hasOwnProperty(i)&&jQuery.isNumeric(i)){v(b[i]);}}function d(b){if(b.hasVersion){c++;}for(var i in b){if(b.hasOwnProperty(i)&&jQuery.isNumeric(i)){d(b[i]);b.showTooltip=false;}}}}function V(t,l,i,b,e,s){this.table=t;var h=jQuery.extend({},l);this.versionsCount=0;this.setTreeTableData(h,b);this.table.setModel(i,"i18n");this.selected=[];this.isCombine=true;if(s&&s.length>0){this.selected=s;this.isCombine=false;}this.expanding=false;}V.prototype=Object.create(L.prototype);V.prototype.setTreeTableData=function(h,b){this.hierarchy=h;if(b){for(var i=0,l=b.length;i<l;i++){var c=b[i].LocationId||b[i].LocationNodeId||b[i].NodeId||b[i].ExtLocationNodeId;a(c,h,b[i].Name);}}v(h);this.data=[];this.flattenTree(this.data,h);this.treeModel=new J(h);this.table.setModel(this.treeModel);};V.prototype.getCurrentHierarchy=function(){return this.hierarchy;};V.prototype.setVHDialog=function(b,o){this.vhDialog=b;this.vhDialog.setHandleRemoveAllSelectedBtn(this.handleRemoveAllSelected.bind(this));this.addToken();this.offerInterval=o;};V.prototype.handleRemoveAllSelected=function(e){if(e.constructor===Array){var l=this.selected[0].LocationId||this.selected[0].NodeId;this.selected=[];var b=this.treeModel.getData();var r=this.flattenItems(b);this.expandParent(this.treeModel,l);for(var i=0;i<r.length;i++){if(r[i].checked){r[i].checked=false;}}this.table.clearSelection();return;}var t=e.getParameters().token;if(this.selected&&this.selected.length>0){for(var i=0;i<this.selected.length;i++){var l=this.selected[i].LocationId||this.selected[i].NodeId;var c=t.getKey();if(l===c){this.expandParent(this.treeModel,l);var u=this.getObject(this.treeModel,l);this.selectionLogic(u);this.removeTokenId=l;this.isDeleteToken=true;break;}}this.renderSelections(this.table,this.treeModel);this.isDeleteToken=false;this.removeTokenId=null;}};V.prototype.expandParent=function(m,l){var b=m.getData();var r=this.flattenItems(b);var o=null;var g=function(h){if(h&&h.LocationIds&&h.LocationIds.split(";").indexOf(l)!==-1){o=h;}if(!o){for(var k in h){if(h.hasOwnProperty(k)&&jQuery.isNumeric(k)){g(h[k]);}}}};g(this.hierarchy);for(var i=0;i<r.length;i++){var c=r[i];var d=c.LocationId||c.NodeId;if(o){var p=o.NodeId;if(p===d){c.expanded=true;this.table.expand(i);this.table.expand(i);}}}};V.prototype.getObject=function(m,l){var b=m.getData();var r=this.flattenItems(b);for(var i=0;i<r.length;i++){var c=r[i];var d=c.LocationId||c.NodeId;if(l===d){return c;}}};V.prototype.selectionLogic=function(o){var t=this;var b=true;var c=true;var d=false;var e=false;var n=function(){if(o.hasVersion){return false;}return true;};var f=function(){if(o.excluded){return false;}return true;};var g=function(i){if(i.hasOwnProperty("NodeId")&&i.NodeId){return true;}return false;};var s=function(x,y){if(x.checked){if(g(x)!==y){b=false;}}if(b){for(var i in x){if(x.hasOwnProperty(i)&&jQuery.isNumeric(i)){s(x[i],y);}}}};var h=function(x,y){for(var i=0,z=y.length;i<z;i++){if(x!==y[i].ParentId){c=false;break;}}};var r=function(i){t.selected=t.selected.filter(function(x){var y=x.NodeId||x.LocationId;return!(i.NodeId===y||i.LocationId===y);});};var j=function(){if(!n()){return;}if(!f()){return;}var i=u();if((o.userCreatedNode&&!o.isChild&&!o.isParent)||(i&&i.userCreatedNode&&t.isCombine)){return;}if(t.isDeleteToken){return;}d=g(o);var x=t.vhDialog.getTable().getModel().getData();s(x[0],d);if(b){h(o.ParentId,t.selected);if(c){var y=t.hierarchy;var z=t.flattenItems(y);var A=z.filter(function(B){return!B.checked&&!B.versionCount&&!B.userCreatedNode;});if(A.length>1){o.checked=true;if(!o.isParent){t.selected.push(o);}}}}m();t.addToken();};var k=function(){var i=o.NodeId||o.LocationId;if(t.isDeleteToken&&i!==t.removeTokenId){return;}o.checked=false;o.hasVersion=false;r(o);m();t.addToken();};var l=function(x){for(var i in x){if(x.hasOwnProperty(i)&&jQuery.isNumeric(i)){t.select(x[i],x[i].excluded?false:x.checked);l(x[i]);if(x.checked){t.selected.push(x[i]);}else{r(x[i]);}}}};var m=function(){if(o.isParent){l(o);}if(o.isChild){var i=u();if(i){if(q(i)>1){t.select(i,true);}else{t.select(i,false);}}}};var p=function(i){var x=[];for(var y in i){if(i.hasOwnProperty(y)&&jQuery.isNumeric(y)){x.push(i[y]);}}return x;};var q=function(x){var y=0;var z=p(x);for(var i=0;i<z.length;i++){if(z[i].checked||z[i].excluded){y++;}}return y;};var u=function(){var i=null;var x=function(y){if(y&&y.LocationIds&&y.LocationIds.split(";").indexOf(o.LocationId||o.NodeId)!==-1){i=y;}if(!i){for(var z in y){if(y.hasOwnProperty(z)&&jQuery.isNumeric(z)){x(y[z]);}}}};x(t.hierarchy);return i;};var w={"true":j,"false":k};w[!o.checked]();};V.prototype.select=function(i,s){i.checked=s;};V.prototype.addToken=function(){var t=[];if(this.vhDialog){this.vhDialog.removeAllSelectedTokens();if(this.selected&&this.selected.length>0){for(var i=0;i<this.selected.length;i++){var b=this.selected[i];var c=b.LocationId||b.NodeId;var d=b.ExtNodeId||b.ExtLocationId;var e=d;if(b.Name){e=b.Name+" ("+d+")";}var n=new sap.m.Token({key:c,text:e});t.push(n);this.vhDialog.setTokens(t);}this.removeDuplicates();}}};V.prototype.removeDuplicates=function(){if(this.selected&&this.selected.length>1){var d=[];var n=this.selected.length-1;for(var i=0;i<n;i++){for(var j=0;j<i+1;j++){var t=this.selected[j].LocationId||this.selected[j].NodeId;d.push(t);this.vhDialog.removeToken(t);}}}};V.prototype.clearSelection=function(){var t=this;var b=t.vhDialog.getTable();var c=function(b){var i=0;do{var d=b.getContextByIndex(i);if(!d){continue;}var o=d.getObject();o.checked=false;o.extended=false;if(o.NodeId!==""||(o.userCreatedNode&&o.ExtNodeId!=="")){b.expand(i);b.expand(i);}i++;}while(d);b.collapseAll();};c(b);};V.prototype.getSelected=function(){return this.selected;};V.prototype.getParentItem=function(b){var t=this;var p=null;var g=function(c){if(c.NodeId===b.ParentId){p=c;}else{for(var i in c){if(c.hasOwnProperty(i)&&jQuery.isNumeric(i)){g(c[i]);}}}};var h=t.vhDialog.getTable().getModel().getData();g(h);return p;};V.prototype.flattenTree=function(b,t){if(t.length>0){for(var i=0,l=t.length;i<l;i++){b.push(U.removeMetadata(t[i]));this.pushChildrens(t[i],b);}}else{this.pushChildrens(t,b);}};V.prototype.pushChildrens=function(b,c){for(var i in b){if(b.hasOwnProperty(i)&&jQuery.isNumeric(i)){c.push(U.removeMetadata(b[i]));this.flattenTree(c,b[i]);}}};return V;},true);
