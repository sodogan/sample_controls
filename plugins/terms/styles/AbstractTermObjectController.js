/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["retail/pmr/promotionaloffers/utils/Models","retail/pmr/promotionaloffers/utils/Utils","sap/ui/core/ListItem"],function(M,U,L){var E={ProductDetail:{}};function p(e,a){return!e?null:e.getSource().getBindingContext(a).getPath();}function f(a){if(!a){return"";}if(!a.ExtNodeId){return a.Name;}if(!a.Name){return a.ExtNodeId;}return a.ExtNodeId+" - "+a.Name;}function c(a,b){return a.indexOf(b)>-1;}function d(v,i){var a=i.data;var l=v.toLowerCase().trim();return c((a.Name.trim()+"").toLowerCase(),l)||c((a.ExtNodeId.trim()+"").toLowerCase(),l);}function A(m,a){this.model=m;this.productDetails=a;this.masterdataSystemModel=null;this.openValueHelpDialog=this.openValueHelpDialog.bind(this);this.openValueHelpSearch=this.openValueHelpSearch.bind(this);this.openSuggest=this.openSuggest.bind(this);this.onSuggestionSelected=this.onSuggestionSelected.bind(this);this.onChange=this.onChange.bind(this);this.handleProductDetails=this.handleProductDetails.bind(this);}A.prototype.getDimension=function(){throw new Error("Not implemented");};A.prototype.openValueHelpDialog=function(e){throw new Error("Not implemented");};A.prototype.populateModel=function(m,a,b){throw new Error("Not implemented");};A.prototype.handleProductDetails=function(a,b,t){throw new Error("Not implemented");};A.prototype.openValueHelpSearch=function(e){var a=p(e);var m=this.model;var b=this.masterdataSystemModel.getProperty("/MasterdataSystem");var t=this;m.setProperty(a+"/ProductBusy",true);this.openValueHelpDialog(e,b).then(function(s){t.populateModel(m,a,s);t.populateUnitOfMeasure(m,a,s);t.handleProductDetails(t.productDetails,s,t.model.getProperty(a));m.setProperty(a+"/ProductErrorState","None");U.removeMessagesByPath(a);m.setProperty(a+"/ProductBusy",false);},function(o){m.setProperty(a+"/ProductBusy",false);});};A.prototype.openSuggest=U.throttle(function(e){var i=e.getSource();i.setFilterFunction(d);var s=e.getParameter("suggestValue");var m=this.masterdataSystemModel.getProperty("/MasterdataSystem");M.getProducts(m,s.trim(),this.getDimension()).then(function(a){i.destroySuggestionItems();a.Products.map(function(b){var g=new L({key:b.Id,text:f(b),additionalText:b.DimensionName});g.data=b;return g;}).forEach(function(b){i.addSuggestionItem(b);});});},250);A.prototype.populateUnitOfMeasure=function(m,a,b){var u=U.get(b,["UnitOfMeasures","results"])||[];var P=m.getProperty(a+"/Selection/UnitOfMeasure");if(P!=undefined){for(var i=0;i<u.length;i++){if(u[i].Id==P){var e=true;}}}if(!e){var g=u.filter(function(h){return h.Default;})[0]||u[0];m.setProperty(a+"/Selection/UnitOfMeasure",(g||{}).Id);}m.setProperty(a+"/UnitOfMeasures",u.map(function(h){return{Id:h.Id,Name:h.Id};}));};A.prototype.onSuggestionSelected=function(e){var a=p(e);var i=e.getParameter("selectedItem");var t=this;if(!i){return Promise.resolve();}this.suggestionSelected=true;t.model.setProperty(a+"/ProductBusy",true);return M.getProductById(i.getKey(),this.getDimension()).then(function(b){t.populateModel(t.model,a,b);t.populateUnitOfMeasure(t.model,a,b);t.handleProductDetails(t.productDetails,b,t.model.getProperty(a));U.removeMessagesByPath(a);t.model.setProperty(a+"/ProductErrorState","None");t.model.setProperty(a+"/ProductBusy",false);delete t.suggestionSelected;},function(e){t.model.setProperty(a+"/ProductBusy",false);});};A.prototype.onChange=function(e){var m=this.masterdataSystemModel.getProperty("/MasterdataSystem");var a=p(e);var i=e.getSource();var v=i.getValue();if(this.suggestionSelected){return;}if(!v){this.resetInput(e);return;}this.model.setProperty(a+"/ProductBusy",true);M.searchProduct(m,v.toUpperCase().trim(),this.getDimension()).then(function(b){this.model.setProperty(a+"/ProductBusy",false);if(b.Products.length){var g=b.Products[0];U.removeMessagesByPath(a);this.populateModel(this.model,a,g);this.populateUnitOfMeasure(this.model,a,g);this.handleProductDetails(this.productDetails,g,this.model.getProperty(a));this.model.setProperty(a+"/ProductErrorState","None");}else{this.populateModel(this.model,a,E);this.populateUnitOfMeasure(this.model,a,E);this.handleProductDetails(this.productDetails,null,this.model.getProperty(a));i.setValue(v);var h=a.split("/");var j=parseInt(h[2],10)+1;var k=U.getI18NModel();var l=U.getMessageManager();var n=[{message:k.getResourceBundle().getText("CreateOffer.Terms.InvalidEntry.Title"),description:k.getResourceBundle().getText("CreateOffer.Terms.InvalidEntry.Description",j),type:"Error",target:a,processor:this.model}];if(this.model.getProperty(a+"/ProductErrorState")!=="Error"){U.setErrorMessages(l,n);}this.model.setProperty(a+"/ProductErrorState","Error");}}.bind(this),function(e){this.model.setProperty(a+"/ProductBusy",false);}.bind(this));};A.prototype.setMasterdataSystemModel=function(m){this.masterdataSystemModel=m;};A.prototype.resetInput=function(e){var a=p(e);U.removeMessagesByPath(a);this.populateModel(this.model,a,E);this.populateUnitOfMeasure(this.model,a,E);this.handleProductDetails(this.productDetails,null,this.model.getProperty(a));this.model.setProperty(a+"/ProductErrorState","None");this.model.setProperty(a+"/ProductBusy",false);};return A;},true);
