/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["jquery.sap.global","sap/m/Dialog","sap/m/Text","sap/m/Button","sap/ui/model/resource/ResourceModel","sap/ui/model/json/JSONModel","sap/ui/comp/valuehelpdialog/ValueHelpDialog","retail/pmr/promotionaloffers/utils/StatusHandler","sap/ui/comp/filterbar/FilterItem","sap/m/MultiInput","retail/pmr/promotionaloffers/utils/ErrorHandler"],function(Q,D,T,B,R,J,V,S,F,M,E){"use strict";function d(i){var a=Array.prototype.slice.call(arguments,1);E.showError(i.getResourceBundle().getText("CriticalErrors.ContactSysAdmin"));throw new Error(a.join("\n"));}function h(p){return function(v){var f=p.map(function(c){return new sap.ui.model.Filter(c,sap.ui.model.FilterOperator.Contains,v);});return new sap.ui.model.Filter({filters:f,and:false});};}function w(a,c,p){c(a,p);for(var i in a){if(a.hasOwnProperty(i)&&Q.isNumeric(i)){w(a[i],c,a);}}}function k(a,p){var r=[];w(a,function(i){if(p(i)){r.push(i);}},a);return r;}function m(x){return x;}function n(a){return function(x){return x[a];};}function s(a){if(!a){return null;}return a[0];}function t(a){return a!=null;}var I=new RegExp("^[0]{5,}$");function u(v){return v===null||v===undefined||v==="AAAAAAAAAAAAAAAAAAAAAA=="||v===""||I.test(v);}function y(v){var a="AAAAAAAAAAAAAAAAAAAAAA==";if(I.test(v)){return a;}if(v===a){return a;}if(v===""){return a;}if(v===null){return a;}return v;}function A(a,b,c,P,e,f){this.Id=a;this.ParentId=P;this.Title=b;this.SubTitle=c;this.Info1=e;this.Info2=f;this.ExtHierarchyId=f;}A.prototype.push=function(i){Array.prototype.push.call(this,i);};function C(i){return i.reduce(function(r,c){r[c.Id]=new A(c.Id,c.ExtNodeId,c.Name,c.ParentId,c.HierarchyDescription,c.ExtHierarchyId);return r;},{});}A.buildTree=function(l){var a=C(l);return Object.keys(a).reduce(function(r,i){var b=a[i];var p=a[b.ParentId]||r;p.push(b);return r;},[]);};var _=sap.ui.core.format.NumberFormat.getFloatInstance({maxFractionDigits:2,groupingEnabled:true});var U={getErrorHandler:function(){return E;},setComponent:function(c){this.component=c;},getComponent:function(){return this.component;},setupFeatures:function(f){var i,l,a,v;var r={};for(i=0,l=f.length;i<l;i++){a=f[i].Key;v=f[i].Value;r[a]=v;}return r;},buildTree:function(){return A.buildTree.apply(A,arguments);},getFormatDatePiker:(function(){var o=new sap.m.DatePicker();return function(a){if(!a){return"";}return o._formatValue(a);};}()),validateEmptyInputForm:function(i){if(i.getValue().trim().length===0){i.setValueState(sap.ui.core.ValueState.Error);return true;}i.setValueState(sap.ui.core.ValueState.None);return false;},setResourceModel:function(r){this._i18nResourceModel=r;},getResourceModel:function(){return this._i18nResourceModel;},setReuseI18NModel:function(c){var r=this.getI18NModel();c.getView().setModel(r,"i18n");return r;},getI18NModel:function(){return this.getResourceModel();},getFormatedDateForSave:function(o){if(!o){return null;}if(!(o instanceof Date)){return o;}var a=o.getFullYear();var b=this.pad(o.getMonth()+1);var c=this.pad(o.getDate());var e=this.pad(o.getHours());var f=this.pad(o.getMinutes());var g=this.pad(o.getSeconds());return[a,"-",b,"-",c,"T",e,":",f,":",g].join("");},getFormatedStringDate:function(o){if(!o){return null;}if(!(o instanceof Date)){return o;}var a=o.getFullYear();var b=this.pad(o.getMonth()+1);var c=this.pad(o.getDate());var e=this.pad(o.getHours());var f=this.pad(o.getMinutes());var g=this.pad(o.getSeconds());return[a,b,c,e,f,g].join("");},getFormatedDateForRead:function(o){if(!o||!(o instanceof Date)){return o;}return new Date(o.getTime()+o.getTimezoneOffset()*60000);},pad:function(a,l){var b=String(a);var c=parseInt(l,10)||2;while(b.length<c){b="0"+b;}return b;},decodeFromBase64:function(e){return atob(e);},base64ToHex:function base64ToHex(a){for(var i=0,b=this.decodeFromBase64(a.replace(/[ \r\n]+$/,"")),c=[];i<b.length;++i){var e=b.charCodeAt(i).toString(16);if(e.length===1){e="0"+e;}c[c.length]=e;}return c.join("").toUpperCase();},base64ToGuid:function(i){var H=this.base64ToHex(i);return H.slice(0,8)+"-"+H.slice(8,12)+"-"+H.slice(12,16)+"-"+H.slice(16,20)+"-"+H.slice(20);},dateMediumObj:sap.ui.core.format.DateFormat.getDateInstance({style:"medium"}),dateShortObj:sap.ui.core.format.DateFormat.getDateInstance({style:"short"}),dateMedium:function(v){return(v&&v.getTime)?this.dateMediumObj.format(v,false):"";},getDateRange:function(f,a,b){if(typeof f==="string"){f=new Date(f.match(/\d+/)[0]*1);}if(typeof a==="string"){a=new Date(a.match(/\d+/)[0]*1);}if(f&&a&&f.getTime&&a.getTime){return this.dateShortObj.format(f,false)+" - "+this.dateShortObj.format(a,!!b);}return"";},uiFilter:h,liveChangeFilterHandler:function(p,a){var f=h(p);return function(e){var v=this.getView().byId(a)||sap.ui.getCore().byId(a);var b=v.getBinding("rows");var c=e.getSource().getValue();if(c.length>=3){b.filter([f(c)]);}else{b.filter(null);}};},getSizeLimit:function(){return 5000;},toOfferContent:function(i,c){var g=U.base64ToGuid(i);var o={semanticObject:c.offerSemanticObject,action:c.contentAction};var a=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService&&sap.ushell.Container.getService("CrossApplicationNavigation");if(a){var b=a.hrefForExternal({target:o});a.toExternal({target:{shellHash:b+"&/Offer/"+g}});}},promptUserForMasterDataSystemChange:function(a,o){var i=this.getI18NModel();return U.promptUser({i18n:i,title:"{i18n>CreateOffer.General.MasterDataSystemDialog.Title}",type:"Message",state:"Warning",text:"{i18n>CreateOffer.General.MasterDataSystemDialog.Message}",ok:"{i18n>CreateOffer.General.MasterDataSystem.Ok}",cancel:"{i18n>CreateOffer.General.MasterDataSystem.Cancel}",okValue:function(){return a;},cancelValue:function(){return o;}});},promptUser:function(a){a.okValue=a.okValue||Q.noop;a.cancelValue=a.cancelValue||Q.noop;return new Promise(function(r,b){var c=new D({title:a.title,state:a.state,type:a.type,content:new T({text:a.text}),beginButton:new B({text:a.ok,press:function(){c.close();r(a.okValue());}}),endButton:new B({text:a.cancel,press:function(){c.close();b(a.cancelValue());}}),afterClose:function(){c.destroy();}});if(a.i18n){c.setModel(a.i18n,"i18n");}c.open();});},removeDuplicatedObjByProp:function(a,p){for(var i=0;i<a.length;i++){for(var j=i+1;j<a.length;j++){if(a[i][p]===a[j][p]){a.splice(j,1);j--;}}}return a;},handleErrors:function(e){E.handleError(e);},setErrorMessages:function(o,a,b){E.setErrorMessages(o,a,b);},setStatusField:function(v){this.sStatusField=v;this.oStatusHandler=new S(v);},getStatusField:function(v){return this.sStatusField;},getStatusForSearch:function(v){return this.oStatusHandler.getFieldForSearch(v);},status:function(i,a){if(!U.oStatusHandler){U.oStatusHandler=new S();}return U.oStatusHandler.getObjectStatusState({UIState:i,Status:a});},isReadOnly:function(v){return this.oStatusHandler.getReadOnly(v);},isEditableHeader:function(v){return this.oStatusHandler.getEditableHeader(v);},isStatusApprovedSaved:function(c,v){return c&&this.isReadOnly(v);},getStatusForStore:function(a){return this.oStatusHandler.getObjectForStore(a);},hasEntitySetProperty:function(N,a,o){var e=o.getODataEntitySet(a).entityType;var b=o.getODataEntityType(e);return b.property.filter(function(p){return p.name===N;}).length===1;},initOpenMasterDataSystemDialog:function(e){var o=sap.ui.xmlfragment("retail.pmr.promotionaloffers.fragments.MasterDataSystemDialog",{handleSearch:function(){},onCancelPress:function(){o.destroy();},onMasterDataSystemSelect:function(b){var c=b.getParameter("selectedItem").getBindingContext().getObject();e.publish("retail.pmr.promotionaloffers","onMasterDataSystemChange",{MasterdataSystemId:c.Id});o.destroy();}});var i=this.getI18NModel();o.setModel(i,"i18n");o.setContentHeight("40%");var a=retail.pmr.promotionaloffers.utils.Models;a.getMasterDataSystems().then(function(b){if(b.length===0){d(i,"Missing Masterdata System","Check that user can get a list of masterdata systems from backend.","Call '/MasterdataSystems' and check it has values");}a.getMasterDataSystem().then(function(c){b=b.map(function(g){g.Selected=false;if(g.Id===c){g.Selected=true;}return g;});var f=new J(b);o.setModel(f);o.open();});});},compose:(function(){function a(b){return Array.prototype.splice.call(b,0);}function c(f,g){return function(x){return f(g(x));};}return function compose(){return a(arguments).reduce(c,m);};}()),getFieldsFromSort:function(a){var f=[];if(!a.length){return f;}for(var i=0,l=a.length;i<l;i++){if(a[i].sPath){f.push(a[i].sPath);}}return f;},attachFieldsToQuery:function attachFieldsToQuery(f,q){var a=q.split(",");return f.reduce(function(q,c){if(q.indexOf(c)<0){q.push(c);}return q;},a).join(",");},flatenFilters:function(f){var a="";if(f.length>0){for(var z=0,b=f.length;z<b;z++){if(z===0){a+=f[0];}else{a+=" and "+f[z];}}}return a;},getFilterString:function(f,a){var q="";var b="";for(var z=0,c=f.length;z<c;z++){var h="";b=a||" or ";if(z===0){h=this.getOption(f[z]);if(c>1){q+="("+h;if(!(z+1<c)){q+=")";}}else{q+=h;}}else{if(z+1<c){q+=b+""+this.getOption(f[z]);}else{q+=b+""+this.getOption(f[z])+")";}}}return q;},getArryByIncludeOrExclude:function(f){var i=[];var e=[];for(var q=0,a=f.length;q<a;q++){if(f[q].exclude){e.push(f[q]);continue;}i.push(f[q]);}var b=this.getFilterString(i," or ");var c=this.getFilterString(e," and ");var g="";if(b.length>0&&c.length>0){g="("+b+" and "+c+")";}else if(b.length>0){g=b;}else if(c.length>0){g=c;}return g;},getOption:function(a){function r(){return a.exclude===false?"I":"E";}function i(){var q=a.exclude?"("+a.key+" ne '"+a.value1+"')":"("+a.key+" eq '"+a.value1+"')";return q;}function b(){var q="(substringof('"+a.value1+"',"+a.key+"))";return q;}function c(){var q="(("+a.key+" ge '"+a.value1+"' and "+a.key+" le '"+a.value2+"'))";return q;}function e(){var q="(endswith("+a.key+",'"+a.value1+"'))";return q;}function f(){var q="(startswith("+a.key+",'"+a.value1+"'))";return q;}function g(){var q="("+a.key+" ge '"+a.value1+"')";return q;}function j(){var q="("+a.key+" gt '"+a.value1+"')";return q;}function l(){var q="("+a.key+" le '"+a.value1+"')";return q;}function o(){var q="("+a.key+" lt '"+a.value1+"')";return q;}var p={"EQ":i,"Contains":b,"BT":c,"EndsWith":e,"StartsWith":f,"GE":g,"GT":j,"LE":l,"LT":o};return p[a.operator]();},identity:m,get:function get(o,p){if(!o){return o;}var r=o[p[0]];if(p.length<=1){return r;}var a=p.slice(1);return get(r,a);},getMessageManager:function(){return E.getMessageManager();},removeMessagesByPath:function(p){E.removeMessagesByPath(p);},removeMessagesByPatialPath:function(p){E.removeMessagesByPartialPath(p);},errorMessagesExists:function(){return E.numOfMessages(this.getMessageManager())>0;},getFirstMessage:function(){return E.getFirstMessage(this.getMessageManager());},errorExistByPatialPath:function(p){var e=E.errorExistByPartialPath(p);return e;},getItemIndexInArray:function(a,b){var c=-1;if(b&&b.length>0){for(var i=0;i<b.length;i++){if(b[i].Id===a){c=i;break;}}}return c;},createNewFilterFromHierarchyTokens:function(i){var f=null;var a=this.getFiltersFromTokens([i],0);if(!a||(a&&a.length<1)){return f;}var b=a.map(function(c){var g=new sap.ui.model.Filter({path:c.key,operator:c.exclude?"NE":c.operator,value1:""+c.value1,value2:""+c.value2});return g;});f=new sap.ui.model.Filter({filters:b,and:false});return f;},combineFilters:function(f,a){return new sap.ui.model.Filter({filters:f,and:a});},createTokenForHierarchy:function(a){var b=new sap.m.Token({text:a.Name||a.ExtId,key:a.Id});b.addCustomData(new sap.ui.core.CustomData({key:"HierarchyObject",value:a}));return b;},buildHierarchy:function(a,b){var r=[],c={},i=0,l=0;for(i=0,l=(a||[]).length;i<l;++i){var e=null;if(b==="LeadingCategory"){e=this.getItemByType("LeadingCategory",a[i]);}if(b==="Location"){e=this.getItemByType("Location",a[i]);}if(!b){e=a[i];var p=e.virtualParentId;if(this.isInitial(p)){p=null;}var f=!p?r:(c[p]||(c[p]=[]));f.push(e);}else{if(e){var p=e.ParentId;if(this.isInitial(p)){p=null;}var f=!p?r:(c[p]||(c[p]=[]));f.push(e);}}}if(b==="LeadingCategory"){for(i=0,l=(a||[]).length;i<l;++i){this.findChildrenForLeadingCategory(r[i],c);}}if(b==="Location"){for(i=0,l=a.length;i<l;++i){this.findChildrenForLocation(r[i],c);}}if(!b){for(i=0,l=a.length;i<l;++i){this.findChildrenForLeadingCategory(r[i],c);}}return r;},getItemByType:function(a,b){var i={};if(a==="LeadingCategory"){i={"ExtHierarchyId":b.ExtHierarchyId,"ExtId":b.ExtId,"HierarchyDescription":b.HierarchyDescription,"HierarchyId":b.HierarchyId,"Id":b.Id,"MasterdataSystem":b.MasterdataSystem,"Name":b.Name,"ParentId":b.ParentId};return i;}if(a==="Location"){var l=b.Locations.results.filter(function(i){delete i.__metadata;return true;});b.Locations.results=l;i={"ExtHierarchyId":b.ExtHierarchyId,"ExtNodeId":b.ExtNodeId,"HierarchyDescription":b.HierarchyDescription,"HierarchyId":b.HierarchyId,"LogSysId":b.LogSysId,"NodeId":b.NodeId,"MasterdataSystem":b.MasterdataSystem,"NodeType":b.NodeType,"ParentId":b.ParentId,"HierarchyCombination":b.HierarchyCombination,"Location":b.Locations.results};return i;}},findChildrenForLeadingCategory:function(p,c){if(p){if(c[p.Id]){p.children=c[p.Id];for(var i=0,l=p.children.length;i<l;++i){this.findChildrenForLeadingCategory(p.children[i],c);}}}},findChildrenForLocation:function(p,c){if(p){if(c[p.NodeId]){p.children=c[p.NodeId];for(var i=0,l=p.children.length;i<l;++i){this.findChildrenForLocation(p.children[i],c);}}}},addMasterdataSystemButton:function(e){var o=new sap.m.Button({text:this.getResourceModel().getProperty("CreateOffer.MasterDataSystem"),press:Q.proxy(function(){this.initOpenMasterDataSystemDialog(e);},this)});sap.ushell.services.AppConfiguration.addApplicationSettingsButtons([o]);},messageChangeEvent:function(e){var a=e.getParameter("newMessages");var o=e.getParameter("oldMessages");if(!a.length){return;}var b=sap.ui.getCore().getMessageManager();for(var i=0,l=a.length;i<l;i++){a[i].persistent=true;}if(a.length){var c=this.removeDuplicatedObjByProp(b.getMessageModel().oData,"message");b.removeAllMessages();b.addMessages(c);}},openDeleteConfirmDiaog:function(b,a){return new Promise(function(r,c){var o=this.getResourceModel().getResourceBundle();var e="";if(b){e=o.getText(a?a.massageSingle:"ManageOffers.DeleteSingleOfferDialog.Message");}else{e=o.getText(a?a.messageMulti:"ManageOffers.DeleteOfferDialog.Message");}var f="ManageOffers.DeleteOfferDialog.Ok";if(a&&a.confirmLabel&&a.confirmLabel!==""){f=a.confirmLabel;}var g=new D({title:o.getText(a?a.title:"ManageOffers.DeleteOfferDialog.Title"),type:"Message",state:"Warning",content:new T({text:e}),beginButton:new B({text:o.getText(f),press:function(){g.close();r();}}),endButton:new B({text:o.getText("ManageOffers.DeleteOfferDialog.Cancel"),press:function(){g.close();c();}}),afterClose:function(){g.destroy();}});g.open();}.bind(this));},navToEditOffer:function(r,o,a){var b=o.Editable===false;var c=U.isReadOnly({State:o.State,UIState:o.UIState});if(b||c){var e=this.getResourceModel().getResourceBundle().getText("ManageOffers.offerNotEditable");if(c){e=Q.sap.formatMessage(this.getResourceModel().getResourceBundle().getText("ManageOffers.offerNotEditableStatus"),o.StatusName);}U.getErrorHandler().showError(e);}else{r.navTo("edit",{path:this.base64ToHex(o.OfferId)},!!a);}},navTocopyOffer:function(r,o){r.navTo("copy",{path:this.base64ToHex(o.OfferId)});},isInitial:u,returnParentID:y,throttle:function throttle(f,a,b){a=a||250;var l=null,c=null;return function(){var e=b||this,g=+new Date(),i=arguments;if(l&&g<l+a){clearTimeout(c);c=setTimeout(function(){l=g;f.apply(e,i);},a);}else{l=g;f.apply(e,i);}};},getFiltersFromTokens:function(a,i){var b=[];for(var c=0,e=a[i].getTokens().length;c<e;c++){var f={};if(a[i].getTokens()[c].getAggregation("customData").length>0){var g=a[i].getTokens()[c].getAggregation("customData")[0].getProperty("value");f.key=g.keyField;f.exclude=g.exclude;f.operator=g.operation;f.value1=g.value1;f.value2=g.value2;}else{f.key=a[i].searchKey;f.operator="EQ";f.exclude=false;f.value1=a[i].getTokens()[c].getKey();f.value2="";}b.push(f);}return b;},calculateFilters:function(o){var f=[];var a=o.getParameters().selectionSet||[];for(var i=0,b=a.length;i<b;i++){if(a[i].getValue().length>0){var c={};c.key=a[i].searchKey;c.exclude=false;var e=a[i].getValue()||"";c.value1=e.toUpperCase();c.value2="";if(c.key==="ExtNodeId"){c.operator="Contains";f.push(this.getOption(c));continue;}c.operator="EQ";var g=[];g.push(c);if(a[i].getTokens().length>0){g=this.getFiltersFromTokens(a,i);}}else{g=this.getFiltersFromTokens(a,i);}if(g.length>0){var r=this.getArryByIncludeOrExclude(g);f.push(r);}}return f;},setBasicSearchValue:function(a){var b=this[a].getFilterBar().getBasicSearch();var c=Q("#"+b+" input");var e=c.length>0?c.val():"";return e;},getWeek:function(o){var c=this.subTimezoneOffset(o);var a=retail.pmr.promotionaloffers.utils.Models;return a.getWeeks().then(function(W){for(var i=0;i<W.length;i++){if(c>=W[i].Start.getTime()&&c<=W[i].End.getTime()){return W[i].Description;}}return Promise.reject();});},addTimezoneOffset:function(o){if(!(o instanceof Date)){return o;}return new Date(o.getTime()+o.getTimezoneOffset()*60000);},subTimezoneOffset:function(o){if(!(o instanceof Date)){return o;}return new Date(o.getTime()-o.getTimezoneOffset()*60000);},createDialogUtil:function(o){return new Promise(function(r,a){var b=new sap.m.Dialog({title:o.title,type:o.type||"Message",state:o.state||"None",content:new sap.m.Text({text:o.message}),beginButton:new sap.m.Button({text:o.btnOk,press:function(){b.close();o.onOk(r,a);}}),endButton:o.btnCancel&&new sap.m.Button({text:o.btnCancel,press:function(){b.close();o.onCancel(r,a);}}),afterClose:function(){b.destroy();}});o.view.addDependent(b);b.open();});},offerContentSaveDialog:function(v){return this.createDialogUtil({title:"{i18n>Offer.OfferContent}",btnOk:"{i18n>Offer.OK}",btnCancel:"{i18n>CreateOffer.General.CancelBtn}",message:"{i18n>Offer.OfferContentSave}",state:"Warning",view:v,onOk:function(r){r();},onCancel:function(r,a){a();}});},manageVersionsSaveDialog:function(v){return this.createDialogUtil({title:"{i18n>ManageVersions.Title}",btnOk:"{i18n>Offer.OK}",btnCancel:"{i18n>CreateOffer.General.CancelBtn}",message:"{i18n>Offer.OfferContentSave}",state:"Warning",view:v,onOk:function(r){r();},onCancel:function(r,a){a();}});},guid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c==="x"?r:(r&0x3|0x8);return v.toString(16);});},filterData:function(l){var a=[];for(var i=0,b=l.length;i<b;i++){var c=l[i].Locations.results||l[i].Locations;for(var j=0,L=c.length;j<L;j++){l[i][j]=this.clear(c[j]);}a.push(this.deleteMetadataLocations(l[i]));}return a;},clear:function(a){Object.getOwnPropertyNames(a).forEach(function(b){if(Q.type(a[b])==="object"){delete a[b];}});var f=["NodeId","HierarchyId","LocationId","ExtNodeId","City","Region","RegionName","Country","CountryName"];f.forEach(function(b){a[b]=a[b]||"";});a.ParentId=a.ParentNodeId||a.ParentId;a.checked=a.checked?a.checked:false;if(Q.isNumeric(a.BlockingEndDate)){a.BlockingEndDate=a.BlockingEndDate;}else{a.BlockingEndDate=a.BlockingEndDate?a.BlockingEndDate.getTime():null;}if(Q.isNumeric(a.BlockingStartDate)){a.BlockingStartDate=a.BlockingStartDate;}else{a.BlockingStartDate=a.BlockingStartDate?a.BlockingStartDate.getTime():null;}if(Q.isNumeric(a.ClosingDate)){a.ClosingDate=a.ClosingDate;}else{a.ClosingDate=a.ClosingDate?a.ClosingDate.getTime():null;}if(Q.isNumeric(a.OpeningDate)){a.OpeningDate=a.OpeningDate;}else{a.OpeningDate=a.OpeningDate?a.OpeningDate.getTime():null;}return a;},removeMetadata:function(o){var a={};var f=["NodeId","HierarchyId","LocationId","ExtNodeId","Name","ExtLocationId","DistributionChannelDescription","DistributionChannel","SalesOrgDescription","SalesOrg","PurchaseOrgDescription","PurchaseOrg","City","Region","RegionName","Country","CountryName"];f.forEach(function(b){a[b]=o[b]||"";});a.ParentId=o.ParentNodeId||o.ParentId;a.checked=o.checked?o.checked:false;a.HierarchyDescription=o.HierarchyDescription;a.HierarchyId=o.HierarchyId;a.expanding=a.expanding?a.expanding:false;if(Q.isNumeric(o.BlockingEndDate)){a.BlockingEndDate=o.BlockingEndDate;}else{a.BlockingEndDate=o.BlockingEndDate?o.BlockingEndDate.getTime():null;}if(Q.isNumeric(o.BlockingStartDate)){a.BlockingStartDate=o.BlockingStartDate;}else{a.BlockingStartDate=o.BlockingStartDate?o.BlockingStartDate.getTime():null;}if(Q.isNumeric(o.ClosingDate)){a.ClosingDate=o.ClosingDate;}else{a.ClosingDate=o.ClosingDate?o.ClosingDate.getTime():null;}if(Q.isNumeric(o.OpeningDate)){a.OpeningDate=o.OpeningDate;}else{a.OpeningDate=o.OpeningDate?o.OpeningDate.getTime():null;}return a;},deleteMetadataLocations:function(o){delete o.Locations;delete o.__metadata;var c=Q.extend({},o);var p=this.returnParentID(c.ParentId);c.checked=o.checked?o.checked:false;c.expanding=o.expanding?o.expanding:false;c.ParentId=p;return c;},buildHierarchyVH:function(a){var r=[],c={};for(var i=0,l=a.length;i<l;++i){var p=a[i].ParentId;if(this.isInitial(p)){p=null;}var b=!p?r:(c[p]||(c[p]=[]));b.push(a[i]);}for(var j=0,L=a.length;j<L;++j){this.findChildren(r[j],c);}return r;},buildLocationHierarchyFromVH:function(o){var l=[];var b=function(o){var i={"Locations":[]};for(var a in o){if(o.hasOwnProperty(a)&&Q.isNumeric(a)){var c=o[a];if(c.userCreatedNode===true){continue;}if(c.NodeId===""){i.Locations.push(c);}else{b(c);}}else{i[a]=o[a];}}l.push(i);};b(o);return l;},findChildren:function(p,c){if(p){if(c[p.NodeId]){var a=this.calculateLength(p);var b=c[p.NodeId].length;for(var j=0;j<b;j++){p[a+j]=c[p.NodeId][j];}for(var i in p){if(p.hasOwnProperty(i)&&Q.isNumeric(i)){this.findChildren(p[i],c);}}}}},calculateLength:function(a){var c=0;for(var i in a){if(a.hasOwnProperty(i)&&Q.isNumeric(i)){c++;}}return c;},getNodeType:function(i,a,b){var c=i.NodeId?"04":"01";var e=i.NodeId||i.LocationId;var f={};f[a]=e;f[b]=c;return f;},flattenTree:function(a,b){if(b.length>0){for(var i=0,l=b.length;i<l;i++){a.push(this.removeMetadata(b[i]));this.pushChildrens(b[i],a);}}else{this.pushChildrens(b,a);}},pushChildrens:function(a,i){for(var j in a){if(a.hasOwnProperty(j)&&Q.isNumeric(j)){i.push(this.removeMetadata(a[j]));this.flattenTree(i,a[j]);}}},isAllDay:function(a,e){var b=new Date(a);var c=new Date(e);b.setHours(0,0,0,0);c.setHours(23,59,59,0);return b.getTime()===a.getTime()&&c.getTime()===e.getTime();},addValidationMessages:function(a,p,b){var v=false;if(a.message){var o=this.getMessageManager();var c=[{message:a.message,description:a.description,type:"Error",target:p,processor:b}];this.removeMessagesByPath(p);this.setErrorMessages(o,c);v=true;}else{this.removeMessagesByPath(p);v=false;}return v;},isGreaterOrEqual:function(a,v){var b=parseFloat(v);if(this.isNumeric(v)){if(b>=a){return true;}else if(isNaN(b)){return true;}return false;}return false;},isPositive:function(v){var a=parseFloat(v.replace(',','.'));if(this.isNumeric(v)){if(a>0){return true;}else if(isNaN(a)){return true;}return false;}return false;},isNumeric:function(v){var a=parseFloat(v);if(typeof a==="number"&&isFinite(a)){return true;}else if(typeof v==="string"&&v===""){return true;}return false;},isFilled:function(v){if(v!==""&&v.trim()!==""){return true;}return false;},isInRange:function(a,b,v){var c=parseFloat(v);if(this.isNumeric(v)){if(c>=a&&c<=b){return true;}else if(isNaN(c)){return true;}return false;}return false;},validationHandler:function(p,e,a,b,c){var f=0;var g=100;var i=this.getI18NModel().getResourceBundle();var j={};var P=e.getSource().getBindingContext()?e.getSource().getBindingContext().sPath+a:a;var l=this;var o=c;var q=e.getSource().getBindingContext()?e.getSource().getBindingContext().sPath.split("/")[2]:-1;var v=false;var r=function(){var W=b.Rewards[q];if(W&&W.Selection.DiscountType==="04"){G(f,g,e,a);}else{H(e,f,a);}};var x=function(){var W=b.ProductDetails[q];if(W&&W.DiscountType==="04"){G(f,g,e,a);}else{H(e,f,a);}};var z=function(){var W=b.Terms[q];if(W&&W.Selection.DimensionType==="20"){L(e,a);}else{H(e,f,a);}};var G=function(){if(!l.isNumeric(e.getParameters().value)){j={message:i.getText("Validation.Terms.Is.Numeric.Title"),description:i.getText("Validation.Terms.Is.Numeric")};}else if(!l.isInRange(f,g,e.getParameters().value)){j={message:Q.sap.formatMessage(i.getText("Validation.Terms.Not.In.Range.Title"),""+f,""+g),description:Q.sap.formatMessage(i.getText("Validation.Terms.Not.In.Range"),""+f,""+g)};}v=l.addValidationMessages(j,P,o);};var H=function(){if(!l.isNumeric(e.getParameters().value)){j={message:i.getText("Validation.Terms.Is.Numeric.Title"),description:i.getText("Validation.Terms.Is.Numeric")};}else if(!l.isGreaterOrEqual(f,e.getParameters().value)){j={message:Q.sap.formatMessage(i.getText("Validation.Terms.Greater.Or.Equal.Title"),""+f),description:Q.sap.formatMessage(i.getText("Validation.Terms.Greater.Or.Equal"),""+f)};}v=l.addValidationMessages(j,P,o);};var K=function(){if(!l.isNumeric(e.getParameters().value)){j={message:i.getText("Validation.Terms.Is.Numeric.Title"),description:i.getText("Validation.Terms.Is.Numeric")};}else if(!l.isInRange(f,10000000,e.getParameters().value)){j={message:Q.sap.formatMessage(i.getText("Validation.Terms.Not.In.Range.Title"),""+f,"9999999"),description:Q.sap.formatMessage(i.getText("Validation.Terms.Not.In.Range"),""+f,"9999999")};}v=l.addValidationMessages(j,P,o);};var L=function(){if(!l.isNumeric(e.getParameters().value)){j={message:i.getText("Validation.Terms.Is.Numeric.Title"),description:i.getText("Validation.Terms.Is.Numeric")};}else if(!l.isPositive(e.getParameters().value)){j={message:i.getText("Validation.Terms.Is.Numeric.And.Positive.Title"),description:Q.sap.formatMessage(i.getText("Validation.Terms.Is.Numeric.And.Positive"),""+f)};}v=l.addValidationMessages(j,P,o);};var N=function(){if(!l.isFilled(e.getParameters().value)){j={message:i.getText("Validation.Terms.Not.Epmty.Title"),description:i.getText("Validation.Terms.Not.Epmty")};}v=l.addValidationMessages(j,P,o);};var O={"emptyValidation":N,"numericValidation":L,"greaterOrEqualValidation":H,"rangeValidation":G,"minAmountValidation":z,"minDiscountValidation":r,"minDiscountProductDetails":x,"greaterOrEqualValidationWithMax":K};O[p]();return v;},isClosed:function(i,v,a){var o=i.OpeningDate?i.OpeningDate:null;var c=i.ClosingDate?i.ClosingDate:null;var b=i.BlockingEndDate?i.BlockingEndDate:null;var e=i.BlockingStartDate?i.BlockingStartDate:null;var f=v?v:null;var g=a?a:null;if(o&&g<o){return true;}else if(c&&c<f){return true;}else if(!!(b&&e)&&(e<f&&g<b)){return true;}return false;},isInOfferRange:function(v,a,b,c){var e=v.StartOfOffer;var f=v.EndOfOffer;if(c&&e.getTime()===c.StartOfOffer.getTime()&&f.getTime()===c.EndOfOffer.getTime()){return true;}if(e.getTime()<a.getTime()){return false;}else if(b.getTime()<f.getTime()){return false;}return true;},isNotOnExcluded:function(v,l,e){var a=v.LocationId||v.LocationNodeId||v.ExtLocationNodeId;for(var i=0;i<e.length;i++){var b=e[i].NodeId||e[i].LocationId;if(a===b||this.isExcludedStoreFromUserNode(a,b,l)){return false;}}return true;},isExcludedStoreFromUserNode:function(a,e,l){if(!l){return false;}var b=function(L,c){for(var i=0;i<c.length;i++){if(c[i].NodeId===L){c.splice(i,1);if(c.length===0){return true;}}}return false;};for(var i=0;i<l.length;i++){var c=l[i].Children||[];if((l[i].Description===a||l[i].Id===a)&&b(e,c)){return true;}}return false;},getTextLikeToken:function(l,a,b,o){function i(){return"="+l;}function c(){return"!(="+l+")";}function e(){return l+"-"+a;}function r(){return l;}var f=b.toUpperCase()==="I"?{"EQ":i,"BT":e,"EndsWith":r,"StartsWith":r,"CP":r,"LE":r,"LT":r,"GE":r,"GT":r}:{"EQ":c};return f[o]();},cleanFinancialsForVersion:function(v,r){if(v&&v.Terms){v.Terms.forEach(function(a){if(!r){a.Financials={Id:""};this.cleanProductsFinancials(a.TermProducts);}if(a.Incentives&&a.Incentives.length===0){delete a.Incentives;}}.bind(this));}delete v.Financials;delete v.Readonly;delete v.ShowEdit;},cleanProductsFinancials:function(p){if(p){p.forEach(function(a){delete a.Financials;a.Financials={Id:""};});}},not:function(p){return function(x){return!p(x);};},allEqual:function(a){var b=a[0];for(var i=1;i<a.length;i++){if(b!==a[i]){return false;}}return true;},concatAll:function(a){return Array.prototype.concat.apply([],a).filter(function(x){return x!==undefined&&x!==null;});},takeWhile:function(p,x){var r=[];for(var i=0;i<x.length;i++){if(!p(x[i])){break;}r.push(x[i]);}return r;},find:function(p,x,a){for(var i=0;i<x.length;i++){if(p(x[i])){return x[i];}}return a;},unique:function(x){return x.filter(function(a,i,b){return b.indexOf(a)===i;});},criticalError:d,prop:n,walk:w,findInTree:k,notNull:t,indexBy:function(f,a){var b={};for(var i=0;i<a.length;i++){var c=a[i];var e=f(c);var g=b[e];if(g){g.push(c);}else{g=[c];b[e]=g;}}return b;},first:s,storeCount:function(l){var c=l.map(function(x){return x.Locations;});var f=c.reduce(function(a,b){return a.concat(b);},[]);var e=f.filter(function(x){return x.LocationType==="1040";});return e.length;},decimalFormatter:function(v){return _.format(v||"");},getSubstringEndText:function(a,b){return b.substring(b.lastIndexOf(a)+a.length,b.length);},setSchemaVersion:function(a){this._schemaVersion=a;},getSchemaVersion:function(){return this._schemaVersion;},};return U;},true);
