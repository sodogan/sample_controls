/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/plugins/general/SelectionLogic"],function(J,U,S){function L(t){this.table=t;this.treeModel=new J();if(t){t.setModel(this.treeModel);}}function c(v){v.removeAllSelectedTokens();v.removeAllExcludedTokens();}function a(i){var d=i.N_ID+"";var n=i.Name||i.ExtNodeId||i.ExtLocationId||"";return new sap.m.Token({key:d,text:n}).data("range",{"operation":sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.EQ,"keyField":"NodeId","value1":n,"value2":""});}function b(i){var t=a(i);var d=t.data("range");d.exclude=true;t.data("range",d);return t;}L.prototype={passVHDialog:function(v,n){this.vhDialog=v;var t=v.getTable();t.collapseAll();var d=new sap.m.Label({text:n,textAlign:sap.ui.core.TextAlign.Center});d.addStyleClass("sapUiTableCtrlEmptyMsg");t.setNoData(d);this.vhDialog.setHandleRemoveAllSelectedBtn(this.handleRemoveAllSelected.bind(this));this.vhDialog.setHandleRemoveExcludeBtn(this.handleRemoveExclude.bind(this));this.vhDialog.setHandleRemoveAllExcludeBtn(this.handleRemoveAllExclude.bind(this));},setData:function(i,s,o){this.offerInterval=o;this.buildTreeLogic(i,s,o);var d=this.selector.getSelection();if(this.table&&this.vhDialog){this.updateTokens(d);this.renderSelections(this.table,this.treeModel);}},selectionChanged:function(e,d){var s=e.getParameter("tableSelectionParams");if(s.selectAll||s.rowIndices.length>1||!s.rowContext){this.renderSelections(this.table,this.treeModel);return;}this.selectionLogic(s.rowContext.getObject());this.renderSelections(this.table,this.treeModel);},expand:function(p){var o={};if(p.isObject){o=p.rowContext;}else{o=p.rowContext.getObject();}var e=p.expanded;this.toggleExpandItem(o,e);if(p.isObject){this.renderExpand(this.table,this.treeModel,o);}this.renderSelections(this.table,this.treeModel);},buildTreeLogic:function(i,l,o){this.initTree(l,i,o);},selectionLogic:function selectionLogicImpl(o){var d=!o.checked;this.selector.runSelection(o,d,this.offerInterval.StartOfOffer,this.offerInterval.EndOfOffer);var s=this.selector.getSelection();this.updateTokens(s);},updateTokens:function(s){c(this.vhDialog);if(s.selection){var i=a(s.selection);var e=s.exclusions.map(b);var d=[i].concat(e);this.vhDialog.setTokens(d);}},getTable:function(){return this.table;},asyncExpand:function(p){setTimeout(function(){this.expand(p);}.bind(this));},getSelection:function(){return this.selector.getSelection();},handleRemoveExclude:function(e){var t=e.getParameter("token");var k=t.getKey();var n=this.selector.getById(k);this.selectionLogic(n);this.renderSelections(this.table,this.treeModel);},handleRemoveAllSelected:function(e){var t=[];if(e instanceof Array){t=e;}else{t.push(e.getParameter("token"));}this.removeTokens(t);this.renderSelections(this.table,this.treeModel);},handleRemoveAllExclude:function(t){this.removeTokens(t);this.renderSelections(this.table,this.treeModel);},removeTokens:function(t){var k=t.map(function(d){return d.getKey();});k.forEach(function(d){var n=this.selector.getById(d);this.selectionLogic(n);},this);}};L.prototype.select=function(i,s){if(!U.isClosed(i,this.offerInterval.StartOfOffer,this.offerInterval.EndOfOffer)){i.checked=s;}};L.prototype.setExpand=function(i,e){i.expanded=e;};L.prototype.isExpanded=function(i){return!!i.expanded;};L.prototype.traverse=function(d,f){for(var i in d){if(d.hasOwnProperty(i)&&jQuery.isNumeric(i)){f(d[i]);if(this.isExpanded(d[i])){this.traverse(d[i],f);}}}};L.prototype.flattenItems=function(i){var r=[];this.traverse(i,function(d){r.push(d);});return r;};L.prototype.selectAt=function(t,i){if(t){t.addSelectionInterval(i,i);}};L.prototype.renderSelections=function(t,m){var d=m.getData();if(t){t.clearSelection();t.refreshRows(true);t.getModel().refresh(true);}var r=this.flattenItems(d);for(var i=0;i<r.length;i++){if(r[i].checked){this.selectAt(t,i);}}};L.prototype.renderExpand=function(t,m,o){var d=m.getData();var r=this.flattenItems(d);for(var i=0;i<r.length;i++){var e=r[i];var l=e.LocationId||e.NodeId||e.ExtNodeId;var f=o.LocationId||o.NodeId||o.ExtNodeId;if(r[i].expanding&&l===f){r[i].expanded=true;t.expand(i);t.expand(i);break;}}};L.prototype.unexpandAll=function(d){for(var i in d){if(d.hasOwnProperty(i)&&jQuery.isNumeric(i)){d[i].expanded=false;this.unexpandAll(d[i]);}}};L.prototype.toggleExpandItem=function(o,e){this.setExpand(o,e);if(!e){this.unexpandAll(o);}};L.prototype.initTree=function(l,i,o){var d=U.filterData(l,o);var t=U.buildHierarchyVH(d);var e=i.ID?[i.ID]:[];var f=(i.ExcludeNodes||[]).map(function(n){return n.NodeId||n.LocationId||n.Id;});this.treeModel.setData(t);this.selector=new S(t,e,f,o);};return L;},true);
