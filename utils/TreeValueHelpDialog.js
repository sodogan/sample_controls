/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["jquery.sap.global","sap/ui/model/json/JSONModel","sap/ui/comp/filterbar/FilterBar","sap/m/SearchField","retail/pmr/promotionaloffers/utils/HierarchyOperations","retail/pmr/promotionaloffers/utils/controls/ValueHelpDialogTokenizer","retail/pmr/promotionaloffers/utils/Utils"],function(q,J,F,S,H,V,U){"use strict";function _(n,m){var t=sap.ui.xmlfragment(n,{});t.setModel(m);return t;}function a(t,b,w,h){if(t&&t.length>0){var v=h.getRowSelectedIdsFromTokens(t);var r=v[0];var p=v[1];if(b){h.selectTreeTablesRows(b,r,p,w);}}}var T={setOptions:function(o){this.oOptions=o;},setHierarchyOperations:function(){this.oHierarchyOperations=new H();},setTable:function(){this.oTable=_(this.oOptions.tableFragment,this.oModel);this.oTable.attachToggleOpenState(function(e){a(this.oTokens,this.oTable,true,this.oHierarchyOperations);});},setTokens:function(){this.oTokens=this.oOptions.tokens||[];},setModel:function(){this.oModel=new J({});},setBasicSearchField:function(){this.basicSearchField=new S({showSearchButton:sap.ui.Device.system.phone});this.basicSearchField.attachSearch(q.proxy(this.manageSearch,this));},setFilterBar:function(){this.oFilterBar=new F({advancedMode:true,filterBarExpanded:true,showGoOnFB:true});this.oFilterBar.setBasicSearch(this.basicSearchField);this.oFilterBar.setSearchEnabled(true);this.oFilterBar.attachSearch(q.proxy(this.manageSearch,this));},rowSelectionChange:function(e){if(!this.oOptions.tokens){this.oOptions.selectionChange(e);return;}this.oValueHelpName.removeAllSelectedTokens();var i=this.oOptions.selectionChange(e);this.oTokens=i.map(function(h){return U.createTokenForHierarchy(h);});this.oValueHelpName.setTokens(this.oTokens);},createValueHelpName:function(r){this.oValueHelpName=new V({supportMultiselect:this.oOptions.multiselect||false,supportRanges:this.oOptions.ranges||false,supportRangesOnly:this.oOptions.rangeOnly||false,stretch:sap.ui.Device.system.phone,title:this.oOptions.title,ok:this.oOptions.ok||function(){this.close();},cancel:function(){this.close();r();},afterClose:function(){this.destroy();},tokenRemove:this.oOptions.tokenRemove||q.noop});if(sap.ui.version>="1.44.0"){this.oValueHelpName.setEscapeHandler(function(){this.oValueHelpName.close();r();}.bind(this));}this.oValueHelpName.addStyleClass(this.oOptions.styleClass||"sapUiSizeCompact");this.oValueHelpName.setHandleRemoveAllSelectedBtn(this.handleRemoveAllSelected.bind(this));this.oValueHelpName.attachSelectionChange(q.proxy(this.rowSelectionChange,this));this.oValueHelpName.setTable(this.oTable);this.oValueHelpName.setFilterBar(this.oFilterBar);this.oValueHelpName.setModel(U.getI18NModel(),"i18n");},handleRemoveAllSelected:function(e){this.oTable.clearSelection();if(e.getParameter&&e.getParameter("token")){var t=e.getParameter("token");if(this.oTokens&&this.oTokens.length>0){for(var i=0;i<this.oTokens.length;i++){if(this.oTokens[i].getKey()===t.getKey()){this.oTokens.splice(i,1);break;}}a(this.oTokens,this.oTable,true,this.oHierarchyOperations);}}else{this.oTokens=[];if(this.oOptions.tokenRemove){this.oOptions.tokenRemove(null);}}},manageSearch:function(e){var t=U.uiFilter(this.oOptions.filterProps);var b=this.oTable.getBinding("rows");var c="";c=this.basicSearchField.getValue();this.oTable.getModel().setSizeLimit(Number.MAX_VALUE);if(c.length>0){var d=t(c);b.filter(d);this.oTable.expandToLevel(100);}else{b.filter(null);this.oTable.expandToLevel(0);}q.sap.delayedCall(0,this,function(){a(this.oTokens,this.oTable,true,this.oHierarchyOperations);});},checkExistingTokens:function(){if(this.oTokens.length>0){this.oValueHelpName.setTokens(this.oTokens);}},checkMultiSelect:function(){if(this.oOptions.multiselect){var c=this.oValueHelpName.getContent();if(c.length&&c[0].getItems()&&c[0].getItems()[2]){if(!this.oOptions.tokens){c[0].getItems()[2].setVisible(false);}}}},openDialog:function(o){this.setOptions(o);this.setBasicSearchField();this.setModel();this.setTable();this.setTokens();this.setFilterBar();this.setHierarchyOperations();return new Promise(function(r,b){this.createValueHelpName(b);this.oOptions.selectionChange=this.oOptions.selectionChange||function(e){var c=e.getParameter("tableSelectionParams").rowContext.getObject();r(c);this.oValueHelpName.close();}.bind(this);this.checkExistingTokens();this.checkMultiSelect();this.oModel.setProperty("/Busy",true);Promise.resolve(o.values).then(function(d){this.oModel.setProperty("/",d);}.bind(this)).then(function(){q.sap.delayedCall(0,this,function(){a(this.oTokens,this.oTable,false,this.oHierarchyOperations);this.oModel.setProperty("/Busy",false);});}.bind(this),function(e){this.oModel.setProperty("/Busy",false);q.sap.log.error(e);});this.oValueHelpName.open();}.bind(this));}};return T;});
