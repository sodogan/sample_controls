/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/Control","sap/m/SearchField","sap/m/Label","sap/m/Title","sap/m/ComboBox","sap/m/OverflowToolbar","sap/m/Button","sap/m/Link","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Utils","sap/ui/comp/smartvariants/PersonalizableInfo","sap/m/ToolbarSpacer","sap/ui/comp/smartvariants/SmartVariantManagement","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/table/SortOrder","sap/ui/table/ColumnMenu"],function(C,S,L,T,a,b,B,c,J,U,P,d,f,F,g,h,j){"use strict";var s=sap.ui.getCore().getConfiguration().getLanguage();var o=new sap.ui.core.Locale(s);var n=sap.ui.core.format.NumberFormat.getFloatInstance({groupingEnabled:false,maxFractionDigits:2,emptyString:null},o);function k(e){var i=e.Selection;return i.ProductId||i.HierarchyNodeId||i.HierarchyId;}function m(v,e){var i=parseFloat(v);var l=parseFloat(e);if(isNaN(i)&&isNaN(l)){return-1;}if(isNaN(i)||i<l){return-1;}if(isNaN(l)||i>l){return 1;}return 0;}function q(v){return parseFloat(n.format(v))===this.oValue1;}function r(e,p,v){var i,l;var w=e.getColumns();var x=w.filter(function(D){return D.getSortProperty()===p;})[0];var y=e.getSortedColumns();for(i=0,l=w.length;i<l;i++){if(jQuery.inArray(w[i],y)<0){w[i].setProperty("sorted",false,true);w[i].setProperty("sortOrder",h.Ascending,true);w[i]._updateIcons();delete w[i]._oSorter;}}x.setProperty("sorted",true,true);x.setProperty("sortOrder",v,true);x._oSorter=new g(x.getSortProperty(),x.getSortOrder()===h.Descending);var z=x.getFilterType();if(z&&z.sName==="Float"){x._oSorter.fnCompare=m;}var A=[];for(i=0,l=y.length;i<l;i++){y[i]._updateIcons();A.push(y[i]._oSorter);}e.getBinding("rows").sort(A);}function t(p,v,V){var w=p.getColumns();var x=w.filter(function(G){return G.getSortProperty()===v;})[0];x.setProperty("filtered",!!V,true);x.setProperty("filterValue",V,true);var M=x.getMenu();if(M&&j&&M instanceof j){M._setFilterValue(V);}var y=[];var z=p.getColumns();for(var i=0,l=z.length;i<l;i++){var A=z[i],D;M=A.getMenu();try{D=A._getFilter();if(M&&j&&M instanceof j){M._setFilterState("None");}}catch(e){if(M&&j&&M instanceof j){M._setFilterState("Error");}continue;}if(D){var E=A.getFilterType();if(E&&E.sName==="Float"&&D.sOperator==="EQ"){D.fnTest=q.bind(D);}y.push(D);}}p.getBinding("rows").filter(y,sap.ui.model.FilterType.Application);x._updateIcons();return y;}var u=C.extend("retail.pmr.promotionaloffers.plugins.terms.controls.freestyle.SmartProductDetails",{renderer:function(R,e){R.write("<div");R.writeControlData(e);R.writeClasses();R.write(">");R.renderControl(e.getAggregation("table"));R.write("</div>");},metadata:{properties:{itemProperty:{type:"string",defaultValue:null},width:{type:"sap.ui.core.CSSSize"},filterItems:{type:"string",defaultValue:null},persistencyKey:{type:"string",group:"Misc",defaultValue:null},termFinancialItems:{type:"any",defaultValue:[]},purposeColumns:{type:"any",defaultValue:[]},editable:{type:"boolean",defaultValue:true},financialsAvailable:{type:"boolean",defaultValue:true}},events:{massEditClicked:{selections:"array",selectedPaths:"array"},showMoreProductsOk:{selections:"object"},hideProductsConfirm:{selections:"array",selectedPaths:"array"},purposeChecked:{}},aggregations:{table:{type:"sap.ui.table.Table",multiple:false}}},setWidth:function(w){this.setProperty("width",w);this.getTable().setWidth(w);},getTermFilters:function(e){var i=this.getModel().getData();var l=(i.Rewards||[]).filter(function(w){return w.isWholeOffer;});var p=(i.Terms||[]).concat(l);var v=p.filter(k).map(function(w){var x=w.Selection;var y=k(w);return{"Attribute":"TERM","Sign":"I","Option":"EQ","Low":x.DimensionType+"#"+U.base64ToHex(y)};});return e.concat(v);},launchSearchProductsDialog:function(){var e=this;return new Promise(function(i,l){var p="retail.pmr.promotionaloffers.plugins.terms.controls.search.ProductSearchPage";var v=sap.ui.controller(p);var w=sap.ui.xmlfragment(p,v);w._sOwnerId=e.componentId;var x="ManageOffers.ProductDetails.ShowMoreProducts";var y=e.getModel("GeneralModel").getProperty("/MasterdataSystem");v.getExtraFilters=e.getTermFilters.bind(e);v.onInit(w,y,null,x,i,l,true,[]);});},addToolbar:function(i){var l=this;var p=new b();p.addContent(new T({text:{parts:[{path:"i18n>CreateOffer.ProductDetails.TableTitle"},{path:"i18n>CreateOffer.ProductDetails.TableTitleWithSubset"},{path:"/ProductDetailsVisible/length"},{path:"/ProductDetailsTotal"}],formatter:function(e,x,y,z){if(y===z){return jQuery.sap.formatMessage(e,y);}return jQuery.sap.formatMessage(x,y,z);}}}));p.addContent(this.variantManagement);var v=new S({placeholder:"{i18n>ManageOffers.ProductDetails.ProductSearch}",liveChange:this.filterProductDetails.bind(this),width:"15rem"});var w=new L({text:"{i18n>ManageOffers.ProductDetails.ProductView}"});this.comboFilter=new a({selectedKey:"All Terms",selectionChange:function(e){l.filterTable(v.getValue());},items:{path:this.getFilterItems(),template:new sap.ui.core.Item({key:"{Key}",text:"{Value}"})}});this.comboFilter.addAriaLabelledBy(w);this.massEditLink=new c({text:"{i18n>ManageOffers.ProductDetails.MassEdit}",press:function(){var e=l.oTable.getSelectedIndices();var x=e.map(function(y){return l.oTable.getContextByIndex(y).sPath;});l.fireEvent("massEditClicked",{selections:e,selectedPaths:x});},enabled:false});this.showMoreProducts=new c({text:"{i18n>ManageOffers.ProductDetails.ShowMoreProducts}",press:function(){this.launchSearchProductsDialog().then(function(e){var x=e.reduce(function(y,z){var A=z.Term.split("' '").map(function(D){return D.trim();});A.forEach(function(D){if(!y[D]){y[D]={Products:[]};}y[D].Products.push(z);});return y;},{});l.fireEvent("showMoreProductsOk",{selections:x});});}.bind(this),enabled:true,visible:"{= ${/ProductDetailsVisible/length} !== ${/ProductDetailsTotal} && ${UIVisiblity>/Version} > 2 && ${Content>/Editable} }"}).addStyleClass("sapUiSmallMarginBegin sapUiSmallMarginEnd");this.hideProducts=new c({text:"{i18n>ManageOffers.ProductDetails.Hide}",press:function(){var e=l.oTable.getSelectedIndices();var x=e.map(function(y){return l.oTable.getContextByIndex(y).sPath;});l.fireEvent("hideProductsConfirm",{selections:e,selectedPaths:x});},enabled:false,visible:"{=${UIVisiblity>/Version} > 2 && ${Content>/Editable} && ${featuresAvailable>/ProductSubset} === 'X'}"});p.addContent(w);p.addContent(this.comboFilter);p.addContent(new d());p.addContent(v);p.addContent(this.massEditLink);p.addContent(this.showMoreProducts);p.addContent(this.hideProducts);p.addContent(new B({icon:"sap-icon://action-settings",press:this.openPersonalizationDialog.bind(this)}));i.setToolbar(p);},setEditable:function(v){this.setProperty("editable",v);this.massEditLink.setVisible(v);if(v!==undefined&&v!==null){this.oTable.setSelectionMode(v?"MultiToggle":"None");}else{this.oTable.setSelectionMode("MultiToggle");}},filterTable:function(e){var i=this.oTable.getBinding("rows");var l=this.comboFilter.getSelectedKey();if(l!=="All Terms"&&l){this.aFilters=[new F("Terms","EQ",this.comboFilter.getSelectedKey())];}else{this.aFilters=[];}this.aFilters=this.aFilters.concat([new F([new F("ExtProductId","Contains",e),new F("Name","Contains",e)])]);i.filter(this.aFilters.concat(this.aFilterColumns),sap.ui.model.FilterType.Application);},filterProductDetails:function(e){var i=e.getParameter("newValue");this.filterTable(i);},_storeColumnsConfig:function(){this.aColumns=this.oTable.getColumns().reduce(function(e,i){var l=i.getSortProperty()||i.data("property");e[l]={columnKey:l,visible:i.getVisible(),index:i.getIndex()};if(i.getSorted()){e[l].sortOrder=i.getSortOrder();}if(i.getFilterValue()){e[l].filterValue=i.getFilterValue();}return e;},{});},setTable:function(i){if(!i){return;}this.setAggregation("table",i);this.oTable=i;i.setSelectionMode("MultiToggle");var l=this;i.attachRowSelectionChange(function(e){var p=e.getSource().getSelectedIndices().length>0;l.massEditLink.setEnabled(p);l.hideProducts.setEnabled(p);});this.addToolbar(i);this.aFreezeCols=i.getFixedColumnCount();i.attachColumnFreeze(function(e){var p=e.getParameter("column");this.aFreezeCols=p.getIndex()+1;this.variantManagement.currentVariantSetModified(true);}.bind(this));this._storeColumnsConfig();this.aFilters=[];this.aSortItems=[{keyField:"ExtProductId",operation:"Ascending"}];this.bMultiSort=false;this.oTable.attachColumnMove(function(e){this.variantManagement.currentVariantSetModified(true);}.bind(this));},setPersistencyKey:function(v,i){this.setProperty("persistencyKey",v,i);var p=new P({type:"Control",keyName:"persistencyKey",dataSource:"TODO"});this._sOwnerId=U.getComponent().getId();p.setControl(this);this.variantManagement.addPersonalizableControl(p);this.variantManagement.initialise(this.initialiseVariantManagement,this);},initialiseVariantManagement:function(){if(this.variantManagement&&!this.variantInitialized){this.variantInitialized=true;this.oTable.bindRows(this.getItemProperty());}},init:function(){this.variantManagement=new f({});this.variantManagement.setShowShare(true);this.aSortItems=[];this.aFilterColumns=[];}});u.prototype.fetchVariant=function(){this._storeColumnsConfig();return{columns:jQuery.extend(true,{},this.aColumns),freezeIndex:this.aFreezeCols,sortItems:this.aSortItems,multiSort:this.bMultiSort};};u.prototype.filterColumn=function(e){var i=e.getParameter("column");var v=e.getParameter("value");var l=i.getSortProperty();this.aColumns[l].filterValue=v;this.variantManagement.currentVariantSetModified(true);e.bPreventDefault=true;this.aFilterColumns=t(this.oTable,l,e.getParameter("value"))||[];};u.prototype.sortColumn=function(e){var i=e.getParameter("column");var l=e.getParameter("sortOrder");var p=i.getSortProperty();Object.keys(this.aColumns).forEach(function(v){delete this.aColumns[v].sortOrder;}.bind(this));this.aColumns[p].sortOrder=l;this.variantManagement.currentVariantSetModified(true);e.bPreventDefault=true;this.aSortItems=[{keyField:p,operation:e.getParameter("sortOrder")}];this.bMultiSort=false;r(this.oTable,p,e.getParameter("sortOrder"));};u.prototype.reset=function(e){this.aColumns=e||{};var l=this.oTable.getColumns();var p=[];this.oTable.removeAllColumns();var v;var w=[];this.aFilterColumns=[];var x=this.aSortItems.reduce(function(D,E){D[E.keyField]=E.operation;w.push(new g(E.keyField,E.operation==="Descending"));return D;},{});for(var i=0,y=l.length;i<y;i++){var z=l[i];var A=z.getSortProperty()||z.data("property");if(this.aColumns.hasOwnProperty(A)){z.setVisible(this.aColumns[A].visible);this.oTable.insertColumn(z,this.aColumns[A].index);z.setSorted(false);if(x.hasOwnProperty(A)){z.setSorted(true);z.setSortOrder(x[A]);}v=this.aColumns[A].filterValue;z.setFiltered(!!v);z.setFilterValue(v||"");if(!!v){this.aFilterColumns.push(z._getFilter());}}else if(z.getSortProperty().indexOf("_PURPOSE_")===-1){z.setVisible(false);p.push(z);}}p.forEach(function(D){var E=this.oTable.getColumns().length;this.oTable.insertColumn(D,E);}.bind(this));this.addPurposesDynamically(false);this.oTable.bindRows({path:this.getItemProperty(),filters:this.aFilters.concat(this.aFilterColumns),sorter:w});this.variantManagement.currentVariantSetModified(false);};u.prototype.endsWith=function(i,v){return i.indexOf(v,i.length-v.length)!==-1;};u.prototype.applyVariant=function(v){var e={};this.aSortItems=v.sortItems||[];this.bMultiSort=!!v.multiSort;if(jQuery.isArray(v.columns)){v.columns.forEach(function(i){e[i.columnKey]=i;});}else{e=v.columns;}this.reset(e);this.getTable().setFixedColumnCount(v.freezeIndex);};u.prototype.openPersonalizationDialog=function(){var e=this.getFinancialsAvailable();var i=sap.ui.xmlfragment("retail.pmr.promotionaloffers.fragments.ProductDetailsPers",this);var l=this.getModel("UIVisiblity").getProperty("/Version");var p=this;var v=this.oTable.getColumns().filter(function(x){var y=x.data("financialColumn")==="true";if(y){return e;}if((l<=3&&x.getFilterProperty()==='PromoCostPriceCurrency')||(l<=4&&x.getFilterProperty()==='Visibility')){return false;}return true;}).map(function(x){return{path:x.getSortProperty()||x.data("property"),text:x.getLabel().getText(),visible:x.getVisible(),index:x.getIndex()};});var w=new J({Fields:v,SortItems:jQuery.extend(true,{},this.aSortItems)});i.setModel(U.getI18NModel(),"i18n");i.setModel(w);i.open();};u.prototype.closeFinFields=function(e){e.getSource().close();e.getSource().destroy();};u.prototype.okFinFields=function(e){var l=e.getParameter("payload").columns;var p=e.getSource();var v=p.getPanels()[1];var w=v._getConditions();this.closeFinFields(e);var x=w.map(function(i){return{keyField:i.keyField,operation:i.operation};});this.bMultiSort=!jQuery.sap.equal(this.aSortItems,x);if(!l.tableItemsChanged&&!this.bMultiSort){return;}var y=(l.tableItems||[]).reduce(function(z,A,i){if(this.aColumns[A.columnKey]){A.filterValue=this.aColumns[A.columnKey].filterValue;A.sortOrder=this.aColumns[A.columnKey].sortOrder;}A.index=A.index||i;z[A.columnKey]=A;return z;}.bind(this),{});this.aSortItems=x;this.reset(y);this.variantManagement.currentVariantSetModified(true);};u.prototype.removeAllPurposeColumns=function(){var e=this.getTable();e.getColumns().filter(function(i){return i.getSortProperty().indexOf("_PURPOSE_")!==-1;}).forEach(function(i){var p=i.getSortProperty();e.removeColumn(i);if(this.aColumns.hasOwnProperty(p)){delete this.aColumns[p];}}.bind(this));};u.prototype.addPurposesDynamically=function(v){var p=this.getPurposeColumns();var i=this.getTable();var l=this;var w=function(x){var y=new sap.ui.table.Column({label:new sap.m.Label({text:x.Name}),hAlign:"Center",visible:v,filterType:"sap.ui.model.type.Boolean",filterProperty:"_PURPOSE_"+x.Id,sortProperty:"_PURPOSE_"+x.Id,template:new sap.m.CheckBox({enabled:"{Content>/Editable}",selected:"{_PURPOSE_"+x.Id+"}",name:"_PURPOSE_"+x.Id,select:function(e){var A=e.getSource();l.fireEvent("purposeChecked",{object:A.getBindingContext().getObject(),name:A.getName(),selected:A.getSelected()});}})});i.addColumn(y);var z="_PURPOSE_"+x.Id;l.aColumns[z]={columnKey:z,visible:v,index:y.getIndex()};};p.forEach(function(e){var x="_PURPOSE_"+e.Id;if(!l.aColumns.hasOwnProperty(x)){w(e);}});};u.prototype.setPurposeColumns=function(v,i){if(!v||!v.length){return;}this.removeAllPurposeColumns();if(v[0].Id){this.setProperty("purposeColumns",v,i);this.addPurposesDynamically(true);}};return u;});
