/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/utils/Models","retail/pmr/promotionaloffers/plugins/general/dynamicfilter/DynamicFilterController","retail/pmr/promotionaloffers/plugins/general/LocationSelector","sap/ui/core/routing/History","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(C,J,U,M,D,L,H,F,a){"use strict";function t(i){return new Date(parseInt(i.substring(i.indexOf("(")+1,i.indexOf(")"))),10);}function b(e){return e.map(function(i){var f=jQuery.extend(true,{},i);if(f.Low.indexOf("Date")>-1){f.Low=t(f.Low);}if(f.High.indexOf("Date")>-1){f.High=t(f.High);}return f;});}function c(e,i){var f="";if(e.Reason==="C"){f=i.getText("General.LocationGroups.Overview.ReasonClosed");}return f;}function d(e){return{Field:e.sPath,Sign:e.bAnd,Option:e.sOperator,Low:e.oValue1,High:e.oValue2};}function h(e,f,i){var g=(e||[]).map(function(O){return{Id:O.PURPOSE_ID,Name:O.PURPOSE_DESC};});var I=(f.LocationSubgroups||[]).map(function(O){return O.Purpose;});var K=g.filter(function(O){return I.indexOf(O.Id)!==-1;});var N=[{Id:"all",Name:i.getText("General.LocationGroups.Allstores")}];return{ProcessingPurposes:N.concat(K),Purposes:g};}function j(i){return[{"Id":"none","Name":i.getText("General.LocationGroups.None"),"Scope":"0"},{"Id":"offer","Name":i.getText("General.LocationGroups.OfferSpecific"),"Scope":"1"}];}function k(e,f,i,I){var K=e.Purposes;var N=i.LocationSubgroups||[];var O=K.map(function(P){var Q=j(I);var g=f.filter(function(V){return V.Purpose===P.Id;}).map(function(V){return{Id:V.Id,Name:V.Name,Scope:"2"};});var R=g.map(function(V){return V.Id;});var S=N.filter(function(V){return R.indexOf(V.Id)!==-1;});var T=N.some(function(V){return V.Purpose===P.Id;});if(S.length){P.SelectedKey=S[0].Id;}else if(T){P.SelectedKey="offer";}else{P.SelectedKey="none";}P.Items=Q.concat(g);return P;});return O;}function l(e,f){var g=[];if(e&&e.length>0){g=new F({filters:(f||[]).map(function(i){return new F(i,sap.ui.model.FilterOperator.Contains,e);}),and:false});}return g;}function m(e){return{GroupId:2,Field:"ExtLocationId",Option:"EQ",Sign:"I",Low:e.ExtLocationId};}function n(e,f){return e.reduce(function(g,I){var K=I.Id||I.ExtLocationId;for(var i=0,N=f.length;i<N;i++){if(f[i].ExtLocationId===K){g.push(f[i]);break;}}return g;},[]);}function o(e){this.getOfferData=function(){return e.getData();};}function p(f){return(f||[]).map(function(e){Object.keys(e).forEach(function(g){if(e[g]===null){e[g]="";}});return e;});}function s(e,f){Object.keys(f).forEach(function(g){e.setProperty("/"+g,f[g]);});}function q(e){var f=parseInt(e,10);if(f&&f.toString().length===14){var g=e.substring(0,4);var i=e.substring(4,6);var I=e.substring(6,8);var K=e.substring(8,10);var N=e.substring(10,12);var O=e.substring(12,14);var P=new Date();P.setYear(g);P.setMonth(parseInt(i,10)-1);P.setDate(I);P.setHours(K);P.setMinutes(N);P.setSeconds(O);if(Date.parse(P)){return{date:P,valid:true};}}return{date:e,valid:false};}function r(e){var O=e.Option;var V=e.Low;var f=e.High;var g=e.Sign==="E";var T;if(V){switch(O){case a.Contains:T="*"+V+"*";break;case a.EQ:var i=V;var I=q(i);if(I.valid){i=U.dateMedium(I.date);}if(e.hasOwnProperty("Text")&&e.Text.length){i=e.Text+" ("+e.Low+")";}T="="+i;break;case a.GT:T=">"+V;break;case a.GE:T=">="+V;break;case a.LT:T="<"+V;break;case a.LE:T="<="+V;break;case a.StartsWith:T=V+"*";break;case a.EndsWith:T="*"+V;break;case a.BT:if(f){T=V+"..."+f;}break;default:T=V;break;}}if(g&&T){T="!("+T+")";}return T;}var u=function(f,e){var g=e.property.reduce(function(I,K){if(K.name){I[K.name]=K["sap:label"];}return I;},{});var i=f.reduce(function(I,K){if(g[K.Field]){K.Field=g[K.Field];}if(!I[K.Field]){I[K.Field]={Include:[],Exclude:[]};}var N=r(K);if(K.Sign==="I"){I[K.Field].Include.push(N);}else{I[K.Field].Exclude.push(N);}return I;},{});return Object.keys(i).map(function(I){return{Attribute:I,Include:(i[I].Include||[]).join(", "),Exclude:(i[I].Exclude||[]).join(", ")};});};var v=(function(){function e(f){if(f.Option==="CP"){f.Option="Contains";if(f.Low.indexOf("*")===0&&f.Low.lastIndexOf("*")===f.Low.length-1){f.Low=f.Low.substring(1,f.Low.length);f.Low=f.Low.substring(0,f.Low.length-1);}else if(f.Low.indexOf("*")===0){f.Option="EndsWith";f.Low=f.Low.substring(1,f.Low.length);}else if(f.Low.indexOf("*")===f.Low.length-1){f.Option="StartsWith";f.Low=f.Low.substring(0,f.Low.length-1);}}if(f.Option==="EQ"&&f.Text&&f.Text!==""){f.tokenText=f.Text+" ("+f.Low+")";f.value=f.Low;}else{f.tokenText="";}return f;}function g(f){var I=e(f);return{exclude:I.Sign==="E",keyField:I.Field,operation:I.Option,tokenText:I.tokenText,value1:I.Low,value2:I.High};}function i(f){var V=e(f);if(V.Option==="EQ"&&f.Sign!=="E"){return{type:"item",object:{key:V.Low,text:V.tokenText}};}else{return{type:"range",object:{exclude:V.Sign==="E",keyField:V.Field,operation:V.Option,tokenText:V.tokenText,value1:V.Low,value2:V.High}};}}return function(f){var I=[];f.forEach(function(K){var P=K.Field;var N=I[P]||{items:[],ranges:[]};I[P]=N;var O=q(K.Low);if(O.valid){K.Low=q(K.Low).date;K.High=q(K.High).date;N.ranges.push(g(K));return;}var Q=i(K);if(Q.type==="range"){N.ranges.push(Q.object);}else{N.items.push(Q.object);}});return I;};}());function w(){var e=M.getServiceModel().getMetaModel();var f=M.getNamespace(M.getServiceModel());return e.getODataEntityType(f+".Location");}function x(e){var f=e.byId("locationPurposeStoresSmartTable");var g=f.getTable();var I=g.getColumns();function K(R){for(var i=0,S=I.length;i<S;i++){if(I[i].data("p13nData").columnKey===R.property){return false;}}return true;}var N=[];var O=[];var P=w();P.property.forEach(function(i){N.push({property:i.name,label:i["sap:label"],visible:i["sap:visible"]==="false"?false:true});});var Q=new sap.m.ColumnListItem();e.byId("columnsTemplate").getCells().forEach(function(i){Q.addCell(i);});f._aColumnKeys=[];N.forEach(function(i){if(K(i)&&i.visible){O.push(new sap.m.Column({header:new sap.m.Label({text:i.label,tooltip:i.label}),minScreenWidth:"Tablet",demandPopin:true,visible:false}).data("p13nData",{"columnKey":i.property,"leadingProperty":i.property,"sortProperty":i.property,"filterProperty":i.property}));Q.addCell(new sap.m.Text({text:"{TreeModel>"+i.property+"}"}));}});O.forEach(function(i){g.addColumn(i);});f._oPersController=null;f._createPersonalizationController();g.bindItems("TreeModel>/Stores",Q);}function y(e){return e.map(function(i){var f=jQuery.extend(true,{},i);for(var g in f){if(g.indexOf("Date")!==-1){if(f[g]!==null&&jQuery.isNumeric(f[g])){var I=U.getFormatedDateForRead(new Date(f[g]));f[g]=U.dateMedium(I);}}}return f;});}function z(e,f){return e.filter(function(g){for(var i=0;i<f.length;i++){var I=f[i];if(I.Id===g.LocationId){return false;}}return true;});}function A(e){return{exclude:true,keyField:"ExtLocationId",operation:"EQ",tokenText:"",value1:e.ExtLocationId,value2:""};}function B(e){return{ExtLocationId:{items:[],ranges:e.map(A)}};}function E(e){return{getLocationSubgroupWithLocations:function(){var g=e.getProperty("/GroupByPurpose");return Object.keys(g).filter(function(f){return f!=="all";}).map(function(f){var i=jQuery.extend(true,{},g[f]);return i;}).reduce(function(i,f){i[f.Purpose]=f;return i;},{});},getLocationSubgroup:function(){var g=e.getProperty("/GroupByPurpose");return Object.keys(g).filter(function(f){return f!=="all";}).map(function(f){var i=jQuery.extend(true,{},g[f]);i.Locations=[{}];i.Filters=p(i.Filters);i.Filters=(i.Filters||[]).filter(function(I){return I.GroupId!==2;});return i;});},getLocationFilters:function(){var g=e.getProperty("/GroupByPurpose");var i=p(g.all.Filters);i=i.filter(function(f){return f.GroupId!==2;});return i;},getLocationFiltersCombined:function(){var f=e.getProperty("/FilterPurposes");var g=this.getLocationSubgroup();var i=this.getLocationFilters().concat(f.all||[]);g=g.map(function(I){I.Filters=I.Filters.concat(f[I.Purpose]||[]);return I;});return{locationFilters:i,LocationSubgroup:g};},separateFiltersByGroupId:function(){var g=e.getProperty("/GroupByPurpose");var f=jQuery.extend(true,{},g);var I={};var K={};Object.keys(f).forEach(function(Q){f[Q].Filters=[];(g[Q].Filters||[]).forEach(function(R){if(R.GroupId!==2){f[Q].Filters.push(R);}else{if(!I[Q]){I[Q]=[];}if(f[Q].Scope!=="2"){if(!K[Q]){K[Q]=[];}K[Q].push(R);}I[Q].push(R);}});f[Q].Filters=p(f[Q].Filters);I[Q]=p(I[Q]);});e.setProperty("/GroupByPurpose",f);e.setProperty("/FilterPurposes",I);var N=e.getProperty("/AllStores");var O=[];var P={};for(var i in K){(K[i]||[]).forEach(function(Q){if(!P[Q.Low]){var R=N.filter(function(S){return S.ExtLocationId===Q.Low;});P[Q.Low]=R[0];}P[Q.Low][i+"Selected"]=true;});}for(var i in P){O.push(P[i]);}e.setProperty("/IncludedStores",O);}};}function G(e){return{getLocationFiltersCombined:function(){var f=E(e).getLocationFilters().map(function(g){delete g.GroupId;return g;});return{locationFilters:f,LocationSubgroup:null};},separateFiltersByGroupId:function(){}};}return C.extend("retail.pmr.promotionaloffers.view.LocationGroups",{constructor:function(){this.dataModel=new J();this.featuresAvailable=new J();this.contentModel=new J({Busy:true,Stores:[],AllStores:[],ExcludedNodes:[],LocationFilters:[],SelectedPurpose:"all",ProcessingPurposes:[],IncludedStores:[],GroupByPurpose:{"all":{Locations:[],Filters:[],Scope:"1"}},Separator:"|",FilterPurposes:{},StoresLength:0});this.i18nBundle=U.getResourceModel();},cancelRebind:function(e){e.getParameter("bindingParams").preventTableBind=true;},filterBarInitialized:function(e){this.filterBar=e.getSource();},setupFilterBar:function(f){var e=jQuery.extend(true,[],f);e.map(U.prop("Field")).forEach(function(i){this.filterBar.addFieldToAdvancedArea(i);}.bind(this));e=v(e);this.filterBar.setFilterData(e,true);},handleRouteMatched:function(e){var f=e.getParameter("name");var g=this.state;var i=g.getOfferData();if(f!=="locationGroups"&&f!=="locationGroupsCreate"){return;}if(f==="locationGroupsCreate"&&(!i||Object.keys(i).length===0)){this.router.navTo("manage");return;}this.loadData();},onInit:function(){this.router=sap.ui.core.UIComponent.getRouterFor(this);this.getView().setModel(this.contentModel,"TreeModel");this.getView().setModel(this.dataModel,"DataModel");this.getView().setModel(M.getServiceModel());this.getView().setModel(this.i18nBundle,"i18n");this.getView().setModel(this.featuresAvailable,"featuresAvailable");this.state=this.getOwnerComponent().getState();this.router.attachRouteMatched(function(e){this.handleRouteMatched(e);},this);var f=this.getView().byId("locationStoresTable");f.onAfterRendering=function(){};this.oMessageManager=U.getMessageManager();},setData:function(e,f){var g=f[0];var I=f[1]||[];var K=f[2]||[];var N=e.ExcludedNodes||[];var O={ID:this.dataModel.getData().LocationNodeId,ExcludeNodes:N};var P=[];var Q=this.contentModel;var R=e.StartOfOffer;var S=e.EndOfOffer;var T=h(I,e,this.i18nBundle.getResourceBundle());var V=k(T,K,e,this.i18nBundle.getResourceBundle());this.contentModel.setProperty("/ProcessingPurposes",T.ProcessingPurposes);this.contentModel.setProperty("/Purposes",T.Purposes);this.contentModel.setProperty("/PurposesGlobal",V);g.data.forEach(function(d1){if(d1.Locations.results.length){d1.Locations.results.forEach(function(e1){var f1=N.filter(function(i){return i.Id===e1.LocationId;});if(f1.length){var g1=P.filter(function(i){return i.LocationId===f1[0].Id;});if(!g1.length){P.push(e1);}}if(e1.CustomAttributes.results.length){e1.CustomAttributes.results.forEach(function(i){e1[i.Property]=i.Description+" ("+i.Value+")";});}});}});var W=new L(null);W.setData(O,g.data,{StartOfOffer:R.getTime(),EndOfOffer:S.getTime()});var X=W.getSelection();var Y=X.selection;var Z=new D(Y);var $=Z.getStores();if($.length!==0&&$.length>100){Q.setSizeLimit($.length);}var _=y(z($||[],N));var a1=Q.getProperty("/GroupByPurpose");Object.keys(a1).forEach(function(i){a1[i].Locations=y(n((a1[i].Locations||[]),$));});a1.all.Locations=_;s(Q,{AllStores:y($),Stores:_,Busy:false,Separator:"|",StoresLength:_.length,GroupByPurpose:a1,FilterPurposes:{}});if(!(e.LocationFilters&&e.LocationFilters.length)){this.filterBar.setFilterData(B(P));var b1=this.getTransformFilters();a1.all.Filters=b1.map(d);}Q.setProperty("/ExcludedNodes",e.ExcludedNodes);this.getLocationsFunctionality.separateFiltersByGroupId();var c1=this.contentModel.getProperty("/GroupByPurpose");this.setupFilterBar(c1.all.Filters||[]);this.clearIncludedPurposes();this.applyIncludedPurposes();},initPurposeFunctionality:function(e){if(e==="X"){this.getLocationsFunctionality=E(this.contentModel);}else{this.getLocationsFunctionality=G(this.contentModel);}},loadData:function(){var e=this;if(e.filterBar){e.filterBar.clear();e.showOverlay(false);}var g=e.contentModel.getProperty("/GroupByPurpose");s(this.contentModel,{Busy:true,Separator:"|",Stores:[],AllStores:[],ExcludedNodes:[],LocationFilters:[],ProcessingPurposes:[],IncludedStores:[],GroupByPurpose:g,FilterPurposes:{},StoresLength:0});this.state.load(function(){var f=e.state.getOfferData();var i=f.MasterdataSystem;if(!e.bTableColumnsCreated){x(e.getView());e.bTableColumnsCreated=true;var I=e.getView().byId("locationPurposeStoresSmartTable");I._oPersController.attachAfterP13nModelDataChange(function(O){var S=[];if(O.getParameter("changeData").hasOwnProperty("sort")){O.getParameter("changeData").sort.sortItems.forEach(function(P){S.push(new sap.ui.model.Sorter(P.columnKey,!(P.operation==="Ascending")));});}I.getTable().getBinding("items").sort(S);e.showOverlay(false);}.bind(e));}e.setOfferData(f);var K=[];var N=e.featuresAvailable.getProperty("/LocationSubgroups");if(N==="X"){K.push({func:M.getPurposes,params:{}});K.push({func:M.getLocationSubgroups,params:{HierarchyId:f.HierarchyId}});}e.initPurposeFunctionality(N);Promise.all([M.getLocationFiltered(i,"",f.ExtLocationNodeId,true,true)].concat(K.map(function(O){return O.func.call(M,O.params);}))).then(function(O){e.setData.call(e,f,O);e.setTitle();e.showOverlay(false);});});},setOfferData:function(e){this.dataModel.setData(e);var f=this.state.getStaticData();var g=U.setupFeatures(f.FeaturesAvailable);this.featuresAvailable.setData(g);this.contentModel.setProperty("/SelectedPurpose","all");var i=this.state.getLocationSubgroups();var I=[{Locations:[],Filters:e.LocationFilters,Purpose:"all"}].concat(e.LocationSubgroups||[]);var K=I.reduce(function(N,O){N[O.Purpose]={Purpose:O.Purpose,Id:O.Id,Filters:O.Filters,Locations:O.Locations,Scope:O.Scope||"1"};N[O.Purpose].Locations=(i[O.Purpose]||{}).Locations||O.Locations;return N;},{});this.contentModel.setProperty("/GroupByPurpose",K);this.contentModel.setProperty("/Editable",!e.Readonly&&!U.isReadOnly({Status:e.Status,UIState:e.UIState}));},setTitle:function(){var e=this.dataModel.getData();var f=U.storeCount(e.LocationHierarchy);var g=this.contentModel.getProperty("/GroupByPurpose");var i=g.all.Locations.length||0;this.setStoreCount(f,i);},resetSearchFilter:function(){this.getView().byId("searchStore").setValue("");this.getView().byId("locationStoresTable").getBinding("items").filter([]);},setStoreCount:function(e,f){var g=this.dataModel.getData();s(this.contentModel,{Purpose:this.i18nBundle.getResourceBundle().getText("CreateOffer.General.Location"),LocationHierarchyNode:g.ExtLocationNodeId||g.ExtHierarchyId,CurrentNumberOfStores:f,TotalNumberOfStores:e});},getOfferDataProvider:function(){return new o(this.dataModel);},onNavButtonPress:function(e){this.oMessageManager.removeAllMessages();var f=this.dataModel.getData();f.ExcludedNodes=this.contentModel.getProperty("/ExcludedNodes");var g=this.getLocationsFunctionality.getLocationFiltersCombined();f.LocationFilters=g.locationFilters;if(g.LocationSubgroup){f.LocationSubgroups=g.LocationSubgroup;var i=this.getLocationsFunctionality.getLocationSubgroupWithLocations();this.state.storeLocationSubgroups(i);}this.state.store(f);var I=sap.ui.core.routing.History.getInstance();var P=I.getPreviousHash();this.state.storeBack(true);if(P!==undefined){window.history.go(-1);}else{var K="edit";var N=U.base64ToHex(this.dataModel.getProperty("/OfferId"));if(U.isReadOnly({Status:f.Status,UIState:f.UIState})){K="display";}this.router.navTo(K,{path:N},true);}},onDynamicLocationFilterChange:function(e){this.showOverlay(false);var f=e.getParameter("mParameters")&&e.getParameter("mParameters").filterChangeReason;if(f){this.showOverlay(true);}},onDataReceivedFromSearch:function(e){var g=this.contentModel;var i=g.getData();var I=U.get(e,["returnedData","__batchResponses",0,"__changeResponses",0,"statusCode"]);if(I!=="200"){i.Stores=[];i.GroupByPurpose.all.Locations=[];i.StoresLength=i.Stores.length;this.setStoreCount(i.AllStores.length,0);g.setProperty("/Busy",false);this.resetSearchFilter();g.refresh(true);var K=JSON.parse(U.get(e,["returnedData","__batchResponses",0,"response","body"])||{});if(K.error&&K.error.message){U.getErrorHandler().showError(I+":"+K.error.message.value);}return;}i.ExcludedNodes=U.get(e,["returnedData","__batchResponses",0,"__changeResponses",1,"data","ExcludedNodes","results"])||[];i.FilterPurposes={};var N=b(U.get(e,["returnedData","__batchResponses",0,"__changeResponses",1,"data","LocationFilters","results"])||[]);N.map(function(f){if(f.GroupId===2){if(!i.FilterPurposes.all){i.FilterPurposes.all=[];}i.FilterPurposes.all.push(f);}return f;}).filter(function(f){return f.GroupId!==2;});if(i.SelectedPurpose==="all"){i.GroupByPurpose[i.SelectedPurpose].Filters=N||[];}i.GroupByPurpose.all.Locations=y(z(i.AllStores,i.ExcludedNodes));var O=(U.get(e,["returnedData","__batchResponses",0,"__changeResponses",1,"data","LocationSubgroups","results"])||[]);O.map(function(P){var Q=i.GroupByPurpose[P.Purpose];Q.Filters=b(U.get(P,["Filters","results"])||[]).map(function(f){if(f.GroupId===2){if(!i.FilterPurposes[P.Purpose]){i.FilterPurposes[P.Purpose]=[];}i.FilterPurposes[P.Purpose].push(f);}return f;}).filter(function(f){return f.GroupId!==2;});var R=U.get(P,["Locations","results"])||[];Q.Locations=n(R,i.AllStores);});i.Stores=i.GroupByPurpose[i.SelectedPurpose].Locations;if(i.GroupByPurpose[i.SelectedPurpose].Scope==="2"){i.TableFilters=u(jQuery.extend(true,[],i.GroupByPurpose[i.SelectedPurpose].Filters),w());}i.StoresLength=i.Stores.length;this.setStoreCount(i.AllStores.length,i.GroupByPurpose.all.Locations.length);g.setProperty("/Busy",false);this.resetSearchFilter();this.clearIncludedPurposes();this.applyIncludedPurposes();g.refresh(true);},searchDynamicLocation:function(e){this.showOverlay(false);var f=this.getTransformFilters();var g=this.contentModel.getProperty("/SelectedPurpose");var i=this.contentModel.getProperty("/GroupByPurpose");i[g].Filters=f.map(d);var I=this.dataModel.getData();var K=I.MasterdataSystem;var N=I.LocationNodeId;var O=I.HierarchyId;var P={start:U.getFormatedDateForSave(I.StartOfOffer),end:U.getFormatedDateForSave(I.EndOfOffer)};this.contentModel.setProperty("/Busy",true);var Q=this.getLocationsFunctionality.getLocationFiltersCombined();var R=this;M.determineLocations(K,N,O,Q.locationFilters,Q.LocationSubgroup,P).then(R.onDataReceivedFromSearch.bind(R));},showOverlay:function(f){this.getView().byId("locationPurposeStoresSmartTable")._showOverlay(f);},getTransformFilters:function(){function e(K){var i=[];var P="";i=f(K,P,i);return i;}function f(P,Q,S){for(var i=0;i<P.length;i++){if(P[i].bAnd===true){Q="E";}if(P[i].bAnd===false){Q="I";}if(P[i].aFilters&&P[i].aFilters.length){f(P[i].aFilters,Q,S);}else{P[i].bAnd=Q;S.push(P[i]);}}return S;}var g={"EQ":"EQ","Contains":"CP","BT":"BT","EndsWith":"CP","StartsWith":"CP","GT":"GT","GE":"GE","LT":"LT","LE":"LE","NE":"NE","OpeningDate":"OD"};var I=this.filterBar.getFilters();var K=e(I);var N=K.map(function(i){var P=i.oValue1;if(P&&P instanceof Date){P=U.getFormatedStringDate(P);}var Q=i.oValue2;if(Q&&Q instanceof Date){Q=U.getFormatedStringDate(Q);}var S=null;if(i.bAnd==="E"){S="EQ";}else{S=g[i.sOperator];}return{bAnd:i.bAnd,oValue1:P,oValue2:Q||"",sOperator:S,sPath:i.sPath};}).filter(function(i){return i.sOperator!=="CP";});var O=this.filterBar.getFilterData();var R=[];Object.getOwnPropertyNames(O).forEach(function(i){var P=O[i];(P.ranges||[]).forEach(function(Q){if(["StartsWith"].indexOf(Q.operation)!==-1){R.push({bAnd:Q.exclude?"E":"I",oValue1:Q.value1+"*",oValue2:Q.value2||"",sOperator:"CP",sPath:i});}else if(["EndsWith"].indexOf(Q.operation)!==-1){R.push({bAnd:Q.exclude?"E":"I",oValue1:"*"+Q.value1,oValue2:Q.value2||"",sOperator:"CP",sPath:i});}else if(["Contains"].indexOf(Q.operation)!==-1){R.push({bAnd:Q.exclude?"E":"I",oValue1:"*"+Q.value1+"*",oValue2:Q.value2||"",sOperator:"CP",sPath:i});}});});return N.concat(R);},onStoreSearch:function(e){var Q=e.getSource().getValue();var f=["ExtLocationId","Name"];var g=l(Q,f);var i=this.getView().byId("locationStoresTable").getBinding("items");i.filter(g,"Application");this.contentModel.setProperty("/StoresLength",i.getLength());},handleAddLocationSearch:function(e){var V=e.getParameter("value");var f=["ExtLocationId","Name"];var g=l(V,f);var i=e.getSource().getBinding("items");i.filter(g);},onManualStoreSearch:function(e){var Q=e.getSource().getValue();var f=["ExtLocationId","Name"];var g=l(Q,f);var i=sap.ui.getCore().byId("manualStoresSelectionTable").getBinding("items");i.filter(g,"Application");},onOverviewSearch:function(e){var Q=e.getSource().getValue();var f=["ExtLocationId","Name"];var g=l(Q,f);var i=sap.ui.getCore().byId("overviewTable").getBinding("items");i.filter(g,"Application");this.contentModel.setProperty("/Overview/StoresLength",i.getLength());},applyIncludedPurposes:function(){var i=this.contentModel.getProperty("/IncludedStores");var f=this.contentModel.getProperty("/FilterPurposes");var e=this.contentModel.getProperty("/ProcessingPurposes");e.filter(function(g){return g.Id!=="all";}).forEach(function(g){(f[g.Id]||[]).forEach(function(I){i.forEach(function(K){if(K.ExtLocationId===I.Low){K[g.Id+"Selected"]=true;}});});});this.contentModel.setProperty("/IncludedStores",i);},clearIncludedPurposes:function(){var e=this.contentModel.getProperty("/ProcessingPurposes");var i=this.contentModel.getProperty("/IncludedStores");e.filter(function(f){return f.Id!=="all";}).forEach(function(f){i.forEach(function(g){g[f.Id+"Selected"]=false;});});this.contentModel.setProperty("/IncludedStores",i);},handleAddPurpose:function(e){var f=this.contentModel.getProperty("/PurposesGlobal");var g=[{Id:"all",Name:this.i18nBundle.getResourceBundle().getText("General.LocationGroups.Allstores")}];var i=this.contentModel.getProperty("/GroupByPurpose");f.forEach(function(K){var N=K.Items.filter(function(O){return O.Id===K.SelectedKey;})[0];if(N.Scope!=="0"){i[K.Id]={Purpose:K.Id,Id:N.Scope==="2"?N.Id:"",Filters:N.Scope==="2"?[]:(i[K.Id]||{}).Filters,Locations:[{}],Scope:N.Scope};g.push(K);}else{delete i[K.Id];}});var I=f.filter(function(K){return K.SelectedKey!==K.SelectedKeyTemp&&K.SelectedKey!=="none";});if(I.length){this.contentModel.setProperty("/SelectedPurpose",I[0].Id);}else if(!i[this.contentModel.getProperty("/SelectedPurpose")]){this.contentModel.setProperty("/SelectedPurpose","all");}this.handleLocationSubgroupChange();this.contentModel.setProperty("/ProcessingPurposes",g);this.contentModel.setProperty("/GroupByPurpose",i);this.searchDynamicLocation();this.oSelectDialog.close();},onAddPressed:function(e){if(!this.oSelectDialog){this.oSelectDialog=sap.ui.xmlfragment("retail.pmr.promotionaloffers.fragments.ProcessingPurposeDialog",this);this.getView().addDependent(this.oSelectDialog);this.oSelectDialog.setModel(this.contentModel,"Content");}var g=this.contentModel.getProperty("/PurposesGlobal");g.forEach(function(f){f.SelectedKeyTemp=f.SelectedKey;});this.contentModel.refresh(true);this.oSelectDialog.open();},onRemovePressed:function(e){if(!this.oDeletePurposesDialog){this.oDeletePurposesDialog=sap.ui.xmlfragment("retail.pmr.promotionaloffers.fragments.DeletePurposesDialog",this);this.getView().addDependent(this.oDeletePurposesDialog);this.oDeletePurposesDialog.setModel(this.contentModel,"Content");}var P=this.contentModel.getProperty("/ProcessingPurposes");var f=P.filter(function(g){return g.Id!=="all";});this.contentModel.setProperty("/ProcessingPurposesRemove",f);this.oDeletePurposesDialog.open();},handleRemovePurpose:function(e){var f=e.getParameter("selectedItems");var g=this.contentModel.getProperty("/ProcessingPurposes");var i=this.contentModel.getProperty("/GroupByPurpose");var I=this.contentModel.getProperty("/FilterPurposes");var K=[];this.clearIncludedPurposes();f.forEach(function(O){delete i[O.getDescription()];delete I[O.getDescription()];K.push(O.getDescription());});var N=this.contentModel.getProperty("/PurposesGlobal");N=N.forEach(function(O){if(K.indexOf(O.Id)!==-1){O.SelectedKey="none";}});g=g.filter(function(O){return K.indexOf(O.Id)===-1;});this.contentModel.setProperty("/ProcessingPurposes",g);this.contentModel.setProperty("/SelectedPurpose","all");this.applyIncludedPurposes();this.handleLocationSubgroupChange();},setColumnsOnManualStoresSelection:function(){var e=sap.ui.getCore().byId("manualStoresSelectionTable");var f=sap.ui.getCore().byId("columnsManualTemplate");var g=this.contentModel.getProperty("/ProcessingPurposes");var i=this.contentModel.getProperty("/GroupByPurpose");e.addColumn(new sap.m.Column({header:new sap.m.Label({text:this.i18nBundle.getResourceBundle().getText("General.LocationGroups.ManualStoreSelection.Location")})}));e.addColumn(new sap.m.Column({header:new sap.m.Label({text:this.i18nBundle.getResourceBundle().getText("General.LocationGroups.ManualStoreSelection.Name")})}));g.forEach(function(K){e.addColumn(new sap.m.Column({hAlign:"Center",header:new sap.m.Label({text:K.Name})}));});f.addCell(new sap.m.Text({text:"{Content>ExtLocationId}"}));f.addCell(new sap.m.Text({text:"{Content>Name}"}));var I=this.contentModel.getProperty("/Editable");g.forEach(function(K){if(K.Id==="all"){f.addCell(new sap.ui.core.Icon({src:"sap-icon://accept"}));}else{f.addCell(new sap.m.CheckBox({selected:"{Content>"+K.Id+"Selected}",enabled:I&&i[K.Id].Scope!=="2"}));}});},getStoresForOverview:function(){var e={AllStores:[],OnlyIncludedStores:[]};var i=this.i18nBundle.getResourceBundle();var I=this.contentModel.getProperty("/IncludedStores");var g=this.contentModel.getProperty("/GroupByPurpose");var f=jQuery.extend(true,[],this.contentModel.getProperty("/AllStores"));var K=this.contentModel.getProperty("/ProcessingPurposes");var N=this.contentModel.getProperty("/ExcludedNodes")||[];var O=this.contentModel.getProperty("/FilterPurposes");var P=jQuery.extend(true,[],g.all.Locations);var S={};P.forEach(function(Q){S[Q.ExtLocationId]=Q;});Object.keys(g).forEach(function(Q){g[Q].Locations.forEach(function(R){if(S[R.ExtLocationId]){S[R.ExtLocationId][Q+"Icon"]="sap-icon://accept";S[R.ExtLocationId][Q+"Tooltip"]="";}});});I.forEach(function(Q){K.forEach(function(R){if(Q[R.Id+"Selected"]&&S[Q.ExtLocationId]){S[Q.ExtLocationId][R.Id+"Icon"]="sap-icon://kpi-managing-my-area";S[Q.ExtLocationId][R.Id+"Tooltip"]=i.getText("General.LocationGroups.Overview.ManuallyAdded");}});});e.OnlyIncludedStores=Object.keys(S).map(function(Q){return S[Q];});f.forEach(function(Q){if(!S[Q.ExtLocationId]){S[Q.ExtLocationId]=Q;}});Object.keys(g).filter(function(Q){return g[Q].Scope==="2";}).forEach(function(Q){(O[Q]||[]).forEach(function(R){if(S[R.Low]){S[R.Low][Q+"Icon"]="sap-icon://kpi-managing-my-area";S[R.Low][Q+"Tooltip"]=i.getText("General.LocationGroups.Overview.ManuallyAdded");}});});if(N.length){N.forEach(function(Q){var R=f.filter(function(T){return T.LocationId===Q.Id;});if(R.length){S[R[0].ExtLocationId]["ExcludedReason"]=c(Q,i);}});}e.AllStores=Object.keys(S).map(function(Q){return S[Q];});return e;},setOverviewModel:function(){var g=this.contentModel.getProperty("/GroupByPurpose");var P=this.contentModel.getProperty("/ProcessingPurposes");var e=this.getStoresForOverview();var f={Groups:[],AllStores:e.AllStores,Stores:e.OnlyIncludedStores,OnlyIncludedStores:e.OnlyIncludedStores,StoresLength:e.OnlyIncludedStores.length};P.forEach(function(i){f.Groups.push({NrLocs:(g[i.Id].Locations||[]).length,Name:i.Name});});this.contentModel.setProperty("/Overview",f);},setOverviewColumns:function(){var e=sap.ui.getCore().byId("overviewTable");var f=sap.ui.getCore().byId("columnsOverviewTemplate");var g=this.contentModel.getProperty("/ProcessingPurposes");var i=this.i18nBundle.getResourceBundle();e.addColumn(new sap.m.Column({header:new sap.m.Label({text:this.i18nBundle.getResourceBundle().getText("General.LocationGroups.ManualStoreSelection.Location")})}));e.addColumn(new sap.m.Column({header:new sap.m.Label({text:this.i18nBundle.getResourceBundle().getText("General.LocationGroups.ManualStoreSelection.Name")})}));g.forEach(function(I){var K=I.Id==="all"?i.getText("CreateVersion.General.LocationHierarchy"):I.Name;e.addColumn(new sap.m.Column({header:new sap.m.Label({text:K}),minScreenWidth:"Tablet",demandPopin:true,hAlign:"Center"}));});f.addCell(new sap.m.Text({text:"{Content>ExtLocationId}"}));f.addCell(new sap.m.Text({text:"{Content>Name}"}));g.forEach(function(I){var K=new sap.m.VBox();var N=new sap.ui.core.Icon({src:"{Content>"+I.Id+"Icon}",visible:"{= ${Content>"+I.Id+"Icon} === '' ? false : true}",tooltip:"{Content>"+I.Id+"Tooltip}"});K.addItem(N);if(I.Id==="all"){var O=new sap.m.Text({text:"{Content>ExcludedReason}",visible:"{= ${Content>ExcludedReason} ? true : false}"});K.addItem(O);}f.addCell(K);});},applyOverviewData:function(f){sap.ui.getCore().byId("searchOverview").setValue("");sap.ui.getCore().byId("overviewTable").getBinding("items").filter([]);var e=this.contentModel.getData();e.Overview.Stores=e.Overview[f];e.Overview.StoresLength=e.Overview.Stores.length;this.contentModel.refresh(true);},showOnlyIncludedStores:function(e){this.applyOverviewData("OnlyIncludedStores");},showAllStores:function(e){this.applyOverviewData("AllStores");},onOverviewPressed:function(e){this.oOverviewDialog=sap.ui.xmlfragment("retail.pmr.promotionaloffers.fragments.OverviewPurposesDialog",this);this.getView().addDependent(this.oOverviewDialog);this.setOverviewModel();this.setOverviewColumns();this.oOverviewDialog.setModel(this.contentModel,"Content");this.oOverviewDialog.open();},onOverviewClosePressed:function(){this.oOverviewDialog.close();},onOverviewAfterClose:function(){this.oOverviewDialog.destroy();},onManualStoreSelectionPressed:function(e){this.oManualStoreSelDialog=sap.ui.xmlfragment("retail.pmr.promotionaloffers.fragments.ManualStoreSelectionDialog",this);this.setColumnsOnManualStoresSelection();this.oManualStoreSelDialog.setModel(this.contentModel,"Content");this.oManualStoreSelDialog.setModel(M.getServiceModel());this.getView().addDependent(this.oManualStoreSelDialog);var i=this.contentModel.getProperty("/IncludedStores");this.includedStoreTemp=jQuery.extend(true,[],i);this.oManualStoreSelDialog.open();},handleLocationSubgroupChange:function(e){var f=this.contentModel.getProperty("/SelectedPurpose");var g=this.contentModel.getProperty("/GroupByPurpose");var i=g[f].Filters||[];if(g[f].Scope==="2"||!this.contentModel.getProperty("/Editable")){var I=u(jQuery.extend(true,[],i),w());this.contentModel.setProperty("/TableFilters",I);}else{this.setupFilterBar(i);}var K=g[f].Locations||[];this.contentModel.setProperty("/Stores",K);this.contentModel.setProperty("/StoresLength",K.length);this.resetSearchFilter();this.showOverlay(false);},onAfterClose:function(e){this.oManualStoreSelDialog.destroy();},onClose:function(e){this.contentModel.setProperty("/IncludedStores",this.includedStoreTemp);this.oManualStoreSelDialog.close();},handleCloseDialog:function(e){e.getSource().getBinding("items").filter([]);},handleClosePurposeDialog:function(e){var g=this.contentModel.getProperty("/PurposesGlobal");g.forEach(function(f){f.SelectedKey=f.SelectedKeyTemp;});this.oSelectDialog.close();},onManualStoreAdd:function(e){if(!this.oAddManualStoreDialog){this.oAddManualStoreDialog=sap.ui.xmlfragment("retail.pmr.promotionaloffers.fragments.AddManualStoreDialog",this);this.oAddManualStoreDialog.setModel(this.contentModel,"Content");this.getView().addDependent(this.oAddManualStoreDialog);}this.oAddManualStoreDialog.open();},onManualStoreDelete:function(e){var i=this.contentModel.getProperty("/IncludedStores");var P=e.getParameter("listItem").getBindingContext("Content").getPath();var T=P.split("/");var R=T[T.length-1];i.splice(R,1);this.contentModel.updateBindings();},onManualStoreConfirm:function(e){var f=this.contentModel.getProperty("/IncludedStores");var P=this.contentModel.getProperty("/ProcessingPurposes");var g=P.map(function(I){return I.Id;});var i={};f.forEach(function(I){g.forEach(function(K){if(I[K+"Selected"]){if(!i[K]){i[K]=[];}i[K].push(m(I));}});});this.contentModel.setProperty("/FilterPurposes",i);this.oManualStoreSelDialog.close();this.searchDynamicLocation();},handleSearchPurpose:function(e){var V=e.getParameter("value");var f=["Id","Name"];var g=l(V,f);var i=e.getSource().getBinding("items");i.filter(g);},onAddManualStoreConfirm:function(e){var f=e.getParameter("selectedItems");var i=this.contentModel.getProperty("/IncludedStores");var g=[];var P=this.contentModel.getProperty("/ProcessingPurposes");var I=this.contentModel.getProperty("/GroupByPurpose");var K=P.filter(function(N){return N.Id!=="all"&&I[N.Id].Scope!=="2";}).map(function(N){return N.Id;});f.forEach(function(N){var O=N.getBindingContext("Content").getObject();g.push(O.ExtLocationId);var Q=i.filter(function(R){return R.ExtLocationId===O.ExtLocationId;}).length>0;if(!Q){K.forEach(function(R){O[R+"Selected"]=true;});O.allSelected=true;i.push(O);}});this.contentModel.setProperty("/IncludedStores",i);},onCopyAsLocalPressed:function(){var e=this.contentModel.getProperty("/SelectedPurpose");var g=this.contentModel.getProperty("/GroupByPurpose");var f=this.contentModel.getProperty("/PurposesGlobal");g[e].Scope="1";g[e].Id="";f=f.map(function(i){if(i.Id===e){i.SelectedKey="offer";}return i;});this.applyIncludedPurposes();this.setupFilterBar(g[e].Filters||[]);this.showOverlay(false);this.contentModel.refresh(true);},formatTitle:function(e,f,g,i,I){if(!g){return this.i18nBundle.getResourceBundle().getText("Purposes.Title");}else{return jQuery.sap.formatMessage.apply(jQuery.sap,arguments);}},smartFilterBarVisible:function(e,f,g){return e&&g[f].Scope!=="2";},CopyLocalLink:function(e,f,g){return e&&g[f].Scope==="2";}});});
