/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/plugins/versions/VersionsSelector","retail/pmr/promotionaloffers/utils/controls/ValueHelpDialogTokenizer","retail/pmr/promotionaloffers/plugins/versions/VersionsHelper"],function(C,J,U,V,a,b){"use strict";function g(v,e){if(v&&e){for(var i=0;i<v.length;i++){var f=v[i].LocationNodeId||v[i].LocationId||v[i].ExtLocationNodeId;var h=e.LocationNodeId||e.LocationId||e.ExtLocationNodeId;if(f===h){return i;}}}return-1;}function c(o,s,l,e,r){var f;var v=e&&e.OfferId?e.OfferId:null;var h=o.OfferId&&o.OfferId!=null?o.OfferId:null;var i=v?v:h;var j="versionDisplay";if(i&&v){if(!o.Readonly){j="versionEdit";}f=r.navTo(j,{path:U.base64ToHex(o.OfferId),id:U.base64ToHex(i)});}else if(h){if(!o.Readonly){j="versionEdit";}f=r.navTo(j,{path:U.base64ToHex(o.OfferId),id:U.base64ToHex(h)});}else{j="versionCreate";f=r.navTo(j);}var k=f.getView("retail.pmr.promotionaloffers.view.VersionTabs","XML");var m=k.getController();m.resetLocationSelected();m.setVersionData(jQuery.extend(true,{},o),s,null,e,true);}function d(p,e){var f=[];var t=null;if(e.length>=2){for(var i=0,l=e.length;i<l;i++){f.push(U.getNodeType(e[i],"NodeId","NodeType"));}var h=p.NodeId||p.LocationId;t={"ParentId":h,"Description":U.guid(),"Children":f,"HierarchyId":p.HierarchyId};}else{var j=e[0].NodeId||e[0].LocationId;t={"LocationNodeId":j,"HierarchyId":p.HierarchyId};}return t;}return C.extend("retail.pmr.promotionaloffers.plugins.versions.Versions",{constructor:function(){C.apply(this,arguments);this.dataProvider=null;this.oModel=new J();this.contentModel=new J();},onInit:function(){this.getView().setModel(this.oModel);this.i18nBundle=U.getResourceModel();this.getEventBus().subscribe("retail.pmr.promotionaloffers","launchVersionPage",this.versionPage,this);this.getEventBus().subscribe("retail.pmr.promotionaloffers","setLocationSelection",this.setLocationSelection,this);this.getEventBus().subscribe("retail.pmr.promotionaloffers","setLocationData",this.setLocationData,this);this.getEventBus().subscribe("retail.pmr.promotionaloffers","deleteInvalidVersions",this.deleteInvalidVersions,this);this.getEventBus().subscribe("retail.pmr.promotionaloffers","updateVersions",this.updateVersions,this);this.state=this.getOwnerComponent().getState();},onExit:function(){this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","launchVersionPage",this.versionPage,this);this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","setLocationSelection",this.setLocationSelection,this);this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","setLocationData",this.setLocationData,this);this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","deleteInvalidVersions",this.deleteInvalidVersions,this);this.getEventBus().unsubscribe("retail.pmr.promotionaloffers","updateVersions",this.updateVersions,this);},getEventBus:function(){return sap.ui.getCore().getEventBus();},deleteInvalidVersions:function(e,f,h){this.refreshVersions(h.versions);this.oModel.setProperty("/LocalNodes",h.localNodes);},updateVersions:function(e,f,h){this.oModel.setProperty("/VersionItems",h.versions);this.contentModel.setProperty("/VersionItems",h.versions);},refreshVersions:function(v){this.oModel.setProperty("/VersionItems",v);this.contentModel.setProperty("/VersionItems",v);var s=this.getView().byId("versions");s.rebindTable();},setLocationSelection:function(e,f,h){if(!h.isOnlyExclude){this.resetData();this.oModel.setProperty("/LocalNodes",[]);this.refreshVersions([]);this.ChangedHierarchy=true;this.contentModel.setProperty("/ParentNode",h.includeNode);this.contentModel.setProperty("/ExcludedNodes",h.excludedNodes);this.contentModel.setProperty("/Hierarchy",h.hierarchy);}},setLocationData:function(e,f,h){this.contentModel.setProperty("/LocationSet",h.locationSet);},onAfterRendering:function(){this.getView().byId("versions")._addHeaderToToolbar();},getOfferData:function(e){var v=this.oModel.getProperty("/VersionItems")||[];v.forEach(function(f){if(f.LocationId){f.LocationNodeId=f.LocationId;}delete f.LocationId;delete f.Readonly;delete f.isShowingParent;});return{Versions:v,LocalNodes:this.oModel.getProperty("/LocalNodes")||[]};},setOfferData:function(e){var v=e.Versions||[];v.forEach(function(i){delete i.locationPath;});if(e.LocationHierarchy&&e.LocationHierarchy.length>0){this.locationHierarchy=e.LocationHierarchy;}e.LocationHierarchy=this.locationHierarchy;this.oModel.setProperty("/Editable",!e.Readonly);this.oModel.setProperty("/LocalNodes",e.LocalNodes);if(!this.ChangedHierarchy){var f=new b(e);var h=f.getAvailableVersions();this.oModel.setProperty("/VersionItems",h);h.forEach(function(i){i.UnitProjection=parseFloat(i.UnitProjection)+"";});this.contentModel.setProperty("/VersionItems",h);this.contentModel.setProperty("/Hierarchy",f.getHierarchy()[0]);}var s=this.getView().byId("versions");if(s){s.rebindTable();}},setDataProvider:function(l){this.dataProvider=l;},onSelectionChange:function(e){var s=e.getSource().getSelectedContexts();var S=s.length;this.contentModel.setProperty("/DeleteEnabled",!!S);},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this);},refreshOffersTable:function(){this.versions.removeSelections();this.contentModel.setProperty("/DeleteEnabled",false);},displayVersion:function(e){var v=e.getSource().getBindingContext().getObject();this.launchVersionPage(null,v);},addReadonlyForAllVersions:function(o){var v=[];if(o.Versions){o.Versions.forEach(function(e){e.Readonly=o.Readonly;v.push(e);});}return v;},versionPage:function(e,f,h){this.launchVersionPage(null,null,h.oData);},setSaveCallback:function(s){this._callbackSave=s;},handleManageVersionPress:function(){var v=this.getView();if(this.state.getOfferData().OfferId!==null){this.launchVersionPage(null,null);return;}this._callbackSave();},resetData:function(){this.locationHierarchy=null;this.ChangedHierarchy=false;},launchVersionPage:function(l,s,D){var o=D||this.state.processor.createSavePayloadWithFinancials();var r=o.Readonly;this.state.storeTransientSnapshot(o);this.state.store(o,{});o.Readonly=r;var e=this.dataProvider.getStaticData();var f=s;if(f){var v=g(o.Versions,f);f=o.Versions[v];f.Readonly=o.Readonly;}var h=this.contentModel.getProperty("/Hierarchy");if(this.locationHierarchy&&this.locationHierarchy.length>0&&!this.ChangedHierarchy){o.LocationHierarchy=this.locationHierarchy;}else{o.LocationHierarchy=U.buildLocationHierarchyFromVH(h);this.ChangedHierarchy=false;}this.locationHierarchy=o.LocationHierarchy;o.Versions=this.addReadonlyForAllVersions(o);c(o,e,this.dataProvider,f,this.getRouter(),true);},getSelectedVersions:function(){this.versions=this.getView().byId("versionsTable");return this.versions.getSelectedItems().map(function(i){return i.getBindingContext().getObject();});},resetTermsTab:function(s,p){var v=this.oModel.getProperty("/VersionItems")||[];v.forEach(function(e){e.Terms=[];e.TermStyle=s;e.PackageOffer=p;});this.oModel.refresh(true);}});});
