/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/utils/Models","sap/ui/comp/smartfilterbar/SmartFilterBar","sap/ui/comp/smartfilterbar/ControlConfiguration","retail/pmr/promotionaloffers/utils/Constants","retail/pmr/promotionaloffers/plugins/productGroup/DefineUIBuilderHelper"],function(U,M,S,C,a,b){var D=function(s,q,r,t,u,v){var w=this;this.i18nBundle=U.getResourceModel().getResourceBundle();this.filters=[];this.sfbFilters={};this.smartFilterBar=s;this.dialog=q;this.hierarchy=u;this.intervals=v;this.filters=jQuery.extend([],this.smartFilterBar._aFields);this.setFilters=function(e,u,y){this._filters=e;this._hierarchy=u;this._filtersModified=y;function z(E){var F=w.calculateRadioSelection();for(var i=0,L=E.length;i<L;i++){var G=[];for(var H in e){G=G.concat(w.createFilterForPayload(e[H],H,E[i].Id));}if(F!==a.APPLY_CHANGES_RADIO.All_unmodified_subnodes||!E[i].filterModified){w.sfbFilters[E[i].Id]={filters:G,ParentId:E[i].ParentId};}if(F===a.APPLY_CHANGES_RADIO.All_unmodified_subnodes||F===a.APPLY_CHANGES_RADIO.All_subnodes){if(E[i].children&&E[i].children.length>0){z(E[i].children);}}}}var A=u||w.hierarchy;if(Object.keys(e).length>0&&A){if(w.calculateRadioSelection()===a.APPLY_CHANGES_RADIO.All_unmodified_subnodes){w.sfbFilters=jQuery.extend({},y);}var B=A.filterModified;delete A.filterModified;z([A]);A.filterModified=B;z([A]);}};this.getFilters=function(){var e=this.createPayload();return e;};this.getFiltersObject=function(){return{sfbFilters:this.sfbFilters,dialogRadioSelection:this.calculateRadioSelection()};};this.deleteFilter=function(i){delete this.sfbFilters[i];};var x=jQuery.extend([],this.smartFilterBar.getAggregation("controlConfiguration"));this.uiBuilderHelper=new b(x,this.filters,r,this,t);this.uiBuilderHelper.addRadioListener(function(e){this.sfbFilters={};this.setFilters(this._filters,this._hierarchy,this._filtersModified);}.bind(this));this.dialog.addContent(this.uiBuilderHelper.getCtrlsForDialog());if(t&&t.length>0){this.editModeTokenToInputs(t);}};D.prototype.editModeTokenToInputs=function(e){var t=this;var i=function(v){return{key:v.Low.replace(/[*=<>]/g,""),text:v.Text};};var r=function(v){return{exclude:v.Sign===a.SIGN_CONST.include()?false:true,operation:t.convertToOperation(v.Option,v.Low,v.High,v.Sign),keyField:v.Property,value1:v.Low.replace(/[*=<>]/g,""),value2:v.High.replace(/[*=<>]/g,""),tokenText:v.Low};};var q=function(v){return{exclude:true,operation:a.OPTION_CONST.eq(),keyField:v.Property,value1:(v.Low.replace(/[*=<>]/g,"")),value2:v.High.replace(/[*=<>]/g,""),tokenText:"!(="+v.Low+")"};};var s=function(){var v=[];t.intervals.forEach(function(x){e.forEach(function(y){if(y.Property===x.Key){v.push(y);}});});var w=t.uiBuilderHelper.controlls;if(w&&w.length>0){w.forEach(function(x){var y=x.getAggregation("content")[0].getAggregation("content")[1].searchKey;var z=x.getAggregation("content")[0].getAggregation("content")[1];if(y){v.forEach(function(A){if(A.Property===y){z.setValue(A.Low+"-"+A.High);}});}});}};var u={};e.forEach(function(v){if(v.Option!==a.OPTION_CONST.eq()){if(u[v.Property]&&Object.keys(u[v.Property]).length>0&&u[v.Property].ranges&&u[v.Property].ranges.length>0){u[v.Property].ranges.push(r(v));}else{u[v.Property]={};u[v.Property].ranges=[];u[v.Property].ranges.push(r(v));}}else if(v.Option===a.OPTION_CONST.eq()&&v.Sign===a.SIGN_CONST.exclude()){if(u[v.Property]&&Object.keys(u[v.Property]).length>0&&u[v.Property].ranges&&u[v.Property].ranges.length>0){u[v.Property].ranges.push(q(v));}else{u[v.Property]={};u[v.Property].ranges=[];u[v.Property].ranges.push(q(v));}}else{if(u[v.Property]&&Object.keys(u[v.Property]).length>0&&u[v.Property].items&&u[v.Property].items.length>0){u[v.Property].items.push(i(v));}else{u[v.Property]={};u[v.Property].items=[];u[v.Property].items.push(i(v));}}});t.smartFilterBar.setFilterData(u);s();};D.prototype.generateFiltersManually=function(v,e){var f=function(i,q,s,e){return{"keyField":e,"exclude":false,"operation":a.OPTION_CONST.bt(),"value1":i,"value2":q,"tokenText":""};};var c=function(i,q,s,e){return{"keyField":e,"exclude":false,"operation":a.OPTION_CONST.eq(),"value1":i,"value2":q,"tokenText":""};};if(v.split("-").length>0){return f(v.split("-")[0],v.split("-")[1],a.SIGN_CONST.include(),e);}else{return c(v,"",a.SIGN_CONST.include(),e);}};D.prototype.convertToOperation=function(e,i,q){var c=function(){return a.OPTION_CONST.eq();};var f=function(){return a.OPTION_CONST.bt();};var d=function(){if(i.charAt(0)==="*"&&i.slice(-1)==="*"){return a.OPTION_CONST.contains();}else if(i.charAt(0)==="*"){return a.OPTION_CONST.endswith();}else if(i.slice(-1)==="*"){return a.OPTION_CONST.startswith();}};var j=function(){return a.OPTION_CONST.ge();};var k=function(){return a.OPTION_CONST.gt();};var l=function(){return a.OPTION_CONST.le();};var m=function(){return a.OPTION_CONST.lt();};var r={"EQ":c,"BT":f,"CP":d,"GE":j,"GT":k,"LE":l,"LT":m};return r[e]();};function c(e){return{"Id":undefined,"GroupId":undefined,"NodeId":e.nodeID,"Property":e.property,"Sign":e.sign,"Option":a.OPTION_CONST.eq(),"Low":e.low||undefined,"High":e.high||undefined,"Text":e.text===""?"":e.text};}function d(e){return{"Id":undefined,"GroupId":undefined,"NodeId":e.nodeID,"Property":e.property,"Sign":e.sign,"Option":a.OPTION_CONST.cp(),"Low":"*"+(e.low||undefined)+"*","High":e.high||undefined,"Text":""};}function f(e){return{"Id":undefined,"GroupId":undefined,"NodeId":e.nodeID,"Property":e.property,"Sign":e.sign,"Option":a.OPTION_CONST.bt(),"Low":e.low||undefined,"High":e.high||undefined,"Text":""};}function g(e){return{"Id":undefined,"GroupId":undefined,"NodeId":e.nodeID,"Property":e.property,"Sign":e.sign,"Option":a.OPTION_CONST.ew(),"Low":"*"+(e.low||undefined),"High":e.high||undefined,"Text":""};}function h(e){return{"Id":undefined,"GroupId":undefined,"NodeId":e.nodeID,"Property":e.property,"Sign":e.sign,"Option":a.OPTION_CONST.sw(),"Low":(e.low||undefined)+"*","High":e.high||undefined,"Text":""};}function j(e){return{"Id":undefined,"GroupId":undefined,"NodeId":e.nodeID,"Property":e.property,"Sign":e.sign,"Option":a.OPTION_CONST.ge(),"Low":">="+(e.low||undefined),"High":e.high||undefined,"Text":""};}function k(e){return{"Id":undefined,"GroupId":undefined,"NodeId":e.nodeID,"Property":e.property,"Sign":e.sign,"Option":a.OPTION_CONST.gt(),"Low":">"+(e.low||undefined),"High":e.high||undefined,"Text":""};}function l(e){return{"Id":undefined,"GroupId":undefined,"NodeId":e.nodeID,"Property":e.property,"Sign":e.sign,"Option":a.OPTION_CONST.le(),"Low":"<="+(e.low||undefined),"High":e.high||undefined,"Text":""};};function m(e){return{"Id":undefined,"GroupId":undefined,"NodeId":e.nodeID,"Property":e.property,"Sign":e.sign,"Option":a.OPTION_CONST.lt(),"Low":"<"+(e.low||undefined),"High":e.high||undefined,"Text":""};}function n(e){var i={"BT":f,"Contains":d,"EndsWith":g,"StartsWith":h,"EQ":c,"GE":j,"GT":k,"LE":l,"LT":m};return i[e.operation](e);}function o(e,i){return function(q){return n({operation:a.OPTION_CONST.eq(),property:e,sign:a.SIGN_CONST.include(),low:q.key,high:"",nodeID:i,text:q.text});};}function p(e){return function(i){return n({operation:i.operation,property:i.keyField,sign:i.exclude?"E":"I",low:i.value1,high:i.value2,nodeID:e,text:""});};}D.prototype.createFilterForPayload=function(i,e,q){if(i.items&&i.items.length>0){return i.items.map(o(e,q));}else if(i.ranges&&i.ranges.length>0){return i.ranges.map(p(q));}else{return[];}};D.prototype.updateFilters=function(e){var t=this;var i=[];this.filters.forEach(function(r){e.forEach(function(s){if(r.fieldName===s){t.smartFilterBar.addFieldToAdvancedArea(r.fieldName);i.push(r);}});});var q=this.uiBuilderHelper.redrawFilters(i);this.dialog.addContent(this.uiBuilderHelper.getCtrlsForDialog(q));this.uiBuilderHelper.destroyDialog();};D.prototype.calculateRadioSelection=function(){return this.uiBuilderHelper.getRadioSelection();};D.prototype.createPayload=function(){var e=function(q,r){for(var s in q.filters){r.push(q.filters[s]);}return r;};var t=[];for(var i in this.sfbFilters){e(this.sfbFilters[i],t);}return t;};return D;});
