/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/m/Input","sap/m/InputRenderer","retail/pmr/promotionaloffers/utils/Models","sap/ui/comp/providers/ValueHelpProvider","sap/ui/model/json/JSONModel","sap/ui/comp/providers/ValueListProvider","retail/pmr/promotionaloffers/utils/Utils"],function(I,a,M,V,J,b,U){function c(o){this._onItemSelected=o.onItemSelected||U.identity;V.call(this,o);}c.prototype=Object.create(V.prototype);c.prototype._onOK=function(e){var d=this._onItemSelected(e);return V.prototype._onOK.call(this,d||e);};c.prototype._rebindTable=function(){var t=this.oValueHelpDialog.getTable();this.busyTable=true;if(this.sFieldName=="TargetGroup"){for(var i=0;i<t.getColumns().length;i++){if(t.getColumns()[i].getTooltip()=="GUID"){t.getColumns()[i].setVisible(false);}}}var f=this.oFilterModel.getData();var k=Object.keys(f);if(!k.length){V.prototype._rebindTable.call(this);return;}this.aSelect=this.aSelect.concat(k);var d=this;t.attachBusyStateChanged(function(e){if(d.busyTable){d.oValueHelpDialog.TableStateDataSearching();}});V.prototype._rebindTable.call(this);var g=k.map(function(e){return f[e]?(new sap.ui.model.Filter(e,"EQ",f[e])):null;}).filter(function(e){return e;});var h=t.getBinding("rows");h.attachDataReceived(function(e){if(e.getParameter("data")){d.busyTable=false;d.oValueHelpDialog.TableStateDataFilled();}});h.filter(g.concat(h.aApplicationFilters),sap.ui.model.FilterType.Application);};return I.extend("retail.pmr.promotionaloffers.utils.controls.MetadataBackedInput",{renderer:a.render,metadata:{properties:{target:{type:"string",defaultValue:null},title:{type:"string",defaultValue:null},parameters:{type:"object",defaultValue:{}}},events:{valueHelpDialogSelection:{parameters:{value:{type:"string"}}}}},init:function(){I.prototype.init.apply(this,arguments);this.initialized=false;},onAfterRendering:function(e){I.prototype.onAfterRendering.apply(this,arguments);if(this.initialized){return;}this.initAnnotation();},bindAggregation:function(n,p){p.path="Annotation>"+p.path;I.prototype.bindAggregation.call(this,n,p);},initAnnotation:function(){var t=this.getTarget();var f=t.split("/")[1];var d=this.getTitle();var D=M.getServiceModel();var i=this;this.initialized=true;M.getMetadataAnalyzer().then(function(m){i.setFilterSuggests(false);i.setModel(D,"Annotation");var A=M.getNamespace(D)+t;var v=m.getValueListAnnotation(A);i.keyField=v.primaryValueListAnnotation.keyField;var p=this.getParameters()||{};var g=new c({onItemSelected:function(e){i.fireValueHelpDialogSelection({tokens:e.getParameter("tokens")});},annotation:v.primaryValueListAnnotation,additionalAnnotations:v.additionalAnnotations,control:i,model:D,preventInitialDataFetchInValueHelpDialog:true,supportMultiSelect:false,fieldName:f,title:d,filterModel:new J(p)});i.setShowValueHelp(true);var h=new b({control:i,typeAheadEnabled:true,aggregation:"suggestionRows",loadAnnotation:true,annotation:v.primaryValueListAnnotation,model:D,filterModel:new J(p)});var k=Object.keys(p);if(k.length&&h.mInParams){h.aSelect=h.aSelect.concat(k);k.forEach(function(e){h.mInParams[e]=e;});}h._aCols.forEach(function(e){e.template="Annotation>"+e.template;});i.setShowSuggestion(true);}.bind(this));}});});
