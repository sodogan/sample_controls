/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","retail/pmr/promotionaloffers/utils/Utils","retail/pmr/promotionaloffers/utils/TreeValueHelpDialog","retail/pmr/promotionaloffers/utils/Models","retail/pmr/promotionaloffers/plugins/productGroup/ProductsCategoryHelper"],function(C,J,U,T,M,P){"use strict";var p=C.extend("retail.pmr.promotionaloffers.plugins.productGroup.ProductHierarchyExcluded",{constructor:function(){C.apply(this,arguments);this.dataProvider=null;this.oModel=new J();this.contentModel=new J();},getSmartTable:function(){return this.getView().byId("leadingCategoryExcludedSmartTable");},getTable:function(){return this.getView().byId("productHierarchyExcludedTable");},setTableState:function(b){this.getTable().setBusy(b);},onInit:function(){this.eventBus=sap.ui.getCore().getEventBus();this.getView().setModel(this.oModel);this.i18nBundle=U.getResourceModel();this.getView().setModel(this.i18nBundle,"i18n");this.getView().setModel(this.contentModel,"Content");this.state=this.getOwnerComponent().getState();this.contentModel.setProperty("/IncludedEnabled",false);this.smartTable=this.getSmartTable();this.table=this.getTable();this.table.setMinAutoRowCount(1);this.table.setVisibleRowCount(1);var s=this;var r=function(){s.table.setShowOverlay(false);};this.table.addEventDelegate({onAfterRendering:r});this.smartTable.setHeader(this.i18nBundle.getResourceBundle().getText("productHierarchy.Title"));this.masterDataSystem=this.state.offerData.MasterdataSystem;this.productCategoryHelper=new P(this.masterDataSystem,[],[]);this.oAddLeadingCategoryButton=this.getView().byId("addLeadingCategoryButtonExcluded");this.eventBus.subscribe("retail.pmr.promotionaloffers","excludedProducts",this.handleExcludedProducts,this);this.excludePGFilter=this.getView().byId("excludeProductGroupSearchId");},resetLinkAndSelection:function(){this.contentModel.setProperty("/SelectedProducts",[]);this.contentModel.setProperty("/IncludedEnabled",false);},clearTableSelections:function(){this.breakNormalSelectionFlow=true;this.table.clearSelection();this.breakNormalSelectionFlow=false;},editSetExcludeRule:function(r){var t=r.filter(function(i){return i.Sign==="E";});var a=true;this.productCategoryHelper.setExcludes(t,a);},setProductGroupData:function(d){if(!d.Display){this.oAddLeadingCategoryButton.setBusy(true);M.getLeadingCategoriesSet(this.masterDataSystem).then(function(l){this.contentModel.setProperty("/ProductsCategories",l);this.oAddLeadingCategoryButton.setBusy(false);}.bind(this));}this.productCategoryHelper.setProductsCategory(d);var h=this.productCategoryHelper.getExcludedProducts();var r=d.Rules?d.Rules.results:[];this.editSetExcludeRule(r);this.contentModel.setProperty("/ReadOnly",!!d.Display);this.oModel.setProperty("/ProductHierarchy",h);this.clearTableSelections();var a=h.length===0?1:10;this.table.setVisibleRowCount(a);this.table.rerender();},getProductGroupData:function(){var a=this.productCategoryHelper.getPayload();return a;},onExit:function(){this.eventBus.unsubscribe("retail.pmr.promotionaloffers","excludedProducts",this.handleExcludedProducts,this);},handleExcludedProducts:function(c,e,o){var a=o.excludedProducts;var b=this.productCategoryHelper.getExcludedProducts();var u=jQuery.extend([],b);for(var i=0,l=a.length;i<l;i++){var f=false;for(var j=0,L=b.length;j<L;j++){if(a[i].Id===b[j].Id||a[i].ParentId===b[j].Id){f=true;}}if(!f){u.push(a[i]);}}this.productCategoryHelper.setExcludes(u);},selectionChanged:function(e){if(this.breakNormalSelectionFlow){return;}var s=function(i){if(i.length>0){this.contentModel.setProperty("/IncludedEnabled",true);}else{this.contentModel.setProperty("/IncludedEnabled",false);}};if(e.getParameter("selectAll")){var a=[];var b=e.getParameter("rowIndices");var c=[];b.forEach(function(i){c.push(e.getSource().getContextByIndex(i).sPath);});c.forEach(function(h){var i=e.getParameter("rowContext").oModel.getProperty(h);a.push({Id:i.Id,Dimension:i.Dimension,VirtualParentId:i.virtualParentId});});this.contentModel.setProperty("/SelectedProducts",a);s.call(this,a);}else if(e.getParameter("rowIndex")===-1){this.resetLinkAndSelection();}else if(e.getParameter("rowContext")&&e.getParameter("rowIndices").length===1){var d=e.getParameter("rowContext").sPath;var f=e.getParameter("rowContext").oModel.getProperty(d);var g=this.contentModel.getProperty("/SelectedProducts")||[];var m=function(f){var h=false;for(var i=0,l=g.length;i<l;i++){if(g[i].Id===f.Id){g.splice(i,1);h=true;break;}}if(!h){g.push({Id:f.Id,Dimension:f.Dimension,VirtualParentId:f.virtualParentId});}};m(f);this.contentModel.setProperty("/SelectedProducts",g);s.call(this,g);}},handleIncludeProduct:function(e){var c=this.productCategoryHelper.getExcludedProducts();var s=this.contentModel.getProperty("/SelectedProducts")||[];for(var i=c.length-1,l=0;i>=l;i--){for(var j=0,L=s.length;j<L;j++){if(c[i].Id===s[j].Id){c.splice(i,1);break;}}}var r=true;this.productCategoryHelper.setExcludes(c,r);this.resetLinkAndSelection();this.clearTableSelections();this.eventBus.publish("retail.pmr.promotionaloffers","onAction",{isHierarchy:true});},handleAddProductHierarchy:function(E){var t=this;T.openDialog({tableFragment:"retail.pmr.promotionaloffers.plugins.general.LeadingCategoryComplexSearch",title:"{i18n>productHierarchy.Title}",filterProps:["ExtId","Name","HierarchyDescription","ExtHierarchyId"],values:U.buildHierarchy(this.contentModel.getProperty("/ProductsCategories"),"LeadingCategory"),multiselect:true,styleClass:"sapUiSizeCompact",selectionChange:jQuery.noop,ok:function(e){var a=e.getSource().getTable();var s=a.getSelectedIndices().map(function(i){return a.getContextByIndex(i).getObject();});t.productCategoryHelper.setExcludes(s);t.eventBus.publish("retail.pmr.promotionaloffers","onAction",{isHierarchy:true});e.getSource().close();}});},setSearch:function(s){var b=this.smartTable.getTable().getBinding("rows");var s=s||"";var f=["Name","ExtId","TypeName","MerchandiseCategory","Size","Color","Brand","BaseUom"];var t=U.uiFilter(f);b.filter([t(s)]);},onLiveChange:function(e){this.setSearch(e.getParameter("newValue"));},getDataExclude:function(){var h=this.oModel.getProperty("/ProductHierarchy");return this.productCategoryHelper.slimData(h,false);},resetExcludes:function(){this.oModel.setProperty("/ProductHierarchy",[]);this.productCategoryHelper=new P(this.masterDataSystem,[],[]);this.setSearch("");this.excludePGFilter.setValue("");}});return p;});
